<html layout:decorate="~{/layout/adminLayout}">
<th:block layout:fragment="css">
<style>
.review-table th:last-child,
.review-table td:last-child {
    width: 100px;   /* 버튼 들어갈 만큼 넓혀줌 */
    text-align: center; /* 선택: 버튼 가운데 정렬 */
}
</style>
</th:block>
<div layout:fragment="content">
	
	<h2>리뷰내역</h2>
	<div class="card mb-4">
		<div class="card-header">
			<i class="fas fa-table me-1"></i>
				리뷰리스트
			</div>
			<div class="card-body">
				<table id="datatablesSimple" class="review-table">
					<thead>
						<tr>
			                <th scope="col">리뷰번호</th>
			                <th scope="col">브랜드</th>
			                <th scope="col">상품명</th>
			                <th scope="col">평점</th>
			                <th scope="col">리뷰내용</th>
			                <th scope="col">작성자</th>
			                <th scope="col">작성일</th>
			                <th scope="col" style="width: 120px;">관리</th>
						</tr>
					</thead>
					<tbody >
						<tr th:each="list : ${re}" >
			                <td th:text="${list.reviewId}"></td>
			                <td th:text="${list.product.brand.brandName}"></td>
							<td th:text="${list.product.name}"></td>
			                <td th:text="${list.rating}"></td>
			                <td>
							    <a href="javascript:void(0);" 
							       class="open-review text-decoration-none text-dark"
							       th:attr="data-content=${list.content}">
							       [[${#strings.abbreviate(list.content, 40)}]]
							    </a>
							</td>
							<td>
							    <a href="javascript:void(0);" 
							       class="open-writer text-decoration-none text-dark"
							       th:attr="data-username=${list.writer.userName}, 
							                data-status=${list.writer.status}">
							       [[${list.writer.userName}]]
							    </a>
							</td>
			                <td th:text="${#temporals.format(list.createDate, 'yyyy-MM-dd HH:mm')}"></td>
			                <td>
								<button class="btn btn-sm btn-warning toggle-status-btn"
								        th:attr="data-reviewid=${list.reviewId}, data-status=${list.status}">
								  [[${list.status} == 'HIDDEN' ? '해제' : '숨김']]
								</button>
							</td>
		            	</tr>
					</tbody>
				</table>
			</div>
			<!-- 리뷰 내용 모달 -->
			<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
			  <div class="modal-dialog modal-lg">
			    <div class="modal-content">
			      <div class="modal-header">
			        <h5 class="modal-title" id="reviewModalLabel">리뷰 내용</h5>
			        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
			      </div>
			      <div class="modal-body" id="reviewModalContent">
			        <!-- 리뷰내용 들어가는 자리 -->
			      </div>
			    </div>
			  </div>
			</div>
		</div>
		<!-- 작성자 모달 -->
		<div class="modal fade" id="writerModal" tabindex="-1" aria-labelledby="writerModalLabel" aria-hidden="true">
		  <div class="modal-dialog">
		    <div class="modal-content">
		      
		      <div class="modal-header">
		        <h5 class="modal-title" id="writerModalLabel">작성자</h5>
		        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
		      </div>
		
		      <div class="modal-body">
		        <div class="mb-3">
		          <label class="form-label">아이디 :</label>
		          <span id="writerId"></span>
		        </div>
		        <div class="mb-3">
		          <label class="form-label">상태 :</label>
		          <span id="writerStatus"></span>
		        </div>
		        <div class="mb-3">
		          <label class="form-label">제재 :</label>
		          <select id="writerSanction" class="form-select">
		            <option selected disabled>선택하세요</option>
		            <option value="7d">7일 정지</option>
		            <option value="30d">30일 정지</option>
		            <option value="permanent">영구 정지</option>
		          </select>
		        </div>
		      </div>
		
		      <!-- 버튼 영역 -->
		      <div class="modal-footer">
		        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
		        <button type="button" id="writerConfirmBtn" class="btn btn-primary">확인</button>
		      </div>
		
		    </div>
		  </div>
		</div>
		
		<!-- 숨김/숨김 해제 확인 모달 -->
		<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
		  <div class="modal-dialog">
		    <div class="modal-content">
		      
		      <div class="modal-header">
		        <h5 class="modal-title" id="statusModalLabel">리뷰 상태 변경</h5>
		        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
		      </div>
		      
		      <div class="modal-body" id="statusModalMessage">
		        <!-- 메시지 들어가는 부분 -->
		      </div>
		      
		      <div class="modal-footer">
		        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
		        <button type="button" id="statusConfirmBtn" class="btn btn-primary">확인</button>
		      </div>
		      
		    </div>
		  </div>
		</div>
</div>
<script layout:fragment="script" type="text/javascript">
document.addEventListener("click", function(e) {
    if (e.target.classList.contains("open-review")) {
        let content = e.target.getAttribute("data-content");
        document.getElementById("reviewModalContent").innerText = content;
        let modal = new bootstrap.Modal(document.getElementById('reviewModal'));
        modal.show();
    }
});

document.addEventListener("click", function(e) {
    if (e.target.classList.contains("open-writer")) {
        let username = e.target.getAttribute("data-username");
        let status = e.target.getAttribute("data-status");

        document.getElementById("writerId").innerText = username;

        // 상태 변환
        let displayStatus = "";
        switch(status) {
            case "active":
                displayStatus = "정상";
                break;
            case "suspended":
                displayStatus = "일시정지";
                break;
            case "banned":
                displayStatus = "영구정지";
                break;
            default:
                displayStatus = "알 수 없음";
        }

        document.getElementById("writerStatus").innerText = displayStatus;

        let modal = new bootstrap.Modal(document.getElementById('writerModal'));
        modal.show();
    }
});


document.getElementById("writerConfirmBtn").addEventListener("click", function() {
    let username = document.getElementById("writerId").innerText;
    let sanction = document.getElementById("writerSanction").value;

    if (!sanction) {
        alert("제재 사유를 선택하세요!");
        return;
    }

    // 서버로 전송 (Ajax 예시)
    fetch("/admin/sanction", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ username: username, sanction: sanction })
    })
    .then(res => {
        if (res.ok) {
            alert("제재가 적용되었습니다.");
            location.reload(); // 필요하면 새로고침
        } else {
            alert("처리 중 오류가 발생했습니다.");
        }
    });
});

// 숨김 처리
let targetBtn = null; // 어떤 버튼 눌렀는지 저장

// 버튼 클릭 시 모달 띄우기
document.addEventListener("click", function(e) {
    if (e.target.classList.contains("toggle-status-btn")) {
        targetBtn = e.target;
        let status = targetBtn.getAttribute("data-status");
        let message = (status === "HIDDEN") ? 
            "이 리뷰를 다시 표시하시겠습니까?" : 
            "이 리뷰를 숨기시겠습니까?";

        document.getElementById("statusModalMessage").innerText = message;

        let modal = new bootstrap.Modal(document.getElementById("statusModal"));
        modal.show();
    }
});

// 모달에서 확인 버튼 누르면 서버에 요청
document.getElementById("statusConfirmBtn").addEventListener("click", function() {
    if (!targetBtn) return;

    let reviewId = targetBtn.getAttribute("data-reviewid");
    let status = targetBtn.getAttribute("data-status");
    let newStatus = (status === "HIDDEN") ? "ACTIVE" : "HIDDEN";

    fetch("/admin/reviewList/changeStatus", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ reviewId: reviewId, status: newStatus })
    })
    .then(res => {
        if (res.ok) {
            // 버튼 텍스트와 상태 즉시 반영
            targetBtn.innerText = (newStatus === "HIDDEN") ? "숨김 해제" : "숨김";
            targetBtn.setAttribute("data-status", newStatus);

            // 모달 닫기
            bootstrap.Modal.getInstance(document.getElementById("statusModal")).hide();
        } else {
            alert("처리 중 오류가 발생했습니다.");
        }
    });
});
</script>
</html>