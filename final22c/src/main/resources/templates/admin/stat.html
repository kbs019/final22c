<!-- final22c/src/main/resources/templates/admin/stat.html -->
<html layout:decorate="~{/layout/adminLayout}">
<th:block layout:fragment="css">
  <style>
    .chart-card{min-height:420px}
    .chart-wrap{position:relative; height:380px}
    .placeholder{height:420px; display:flex; align-items:center; justify-content:center; color:#888}
  </style>
</th:block>

<div layout:fragment="content">
  <div class="container my-4" 
       th:with="p=${product}">
    <h2 class="mb-3">상품 통계</h2>

    <!-- 상품 헤더 -->
    <div class="mb-3">
      <div class="d-flex align-items-center gap-3">
        <img th:src="${p.imgPath + p.imgName}" alt="" 
             style="width:64px;height:64px;object-fit:cover;border-radius:8px"
             onerror="this.style.display='none'">
        <div>
          <div class="fw-bold fs-5" th:text="${p.name}">상품명</div>
          <div class="text-muted">
            <span th:text="${p.brand != null ? p.brand.brandName : '브랜드 미지정'}"></span>
            · ID <span th:text="${p.id}"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- 라디오: 매출 / 구매자 -->
    <div class="mb-3" 
         th:attr="data-product-id=${p.id}" 
         id="statRoot">
      <div class="btn-group" role="group" aria-label="toggle">
        <input type="radio" class="btn-check" name="mode" id="modeSales" value="sales">
        <label class="btn btn-outline-dark" for="modeSales">매출</label>

        <input type="radio" class="btn-check" name="mode" id="modeBuyers" value="buyers" checked>
        <label class="btn btn-outline-dark" for="modeBuyers">구매자</label>
      </div>
    </div>

    <!-- 매출 패널 (비워둠) -->
    <div id="panel-sales" class="card chart-card d-none">
      <div class="card-header">매출</div>
      <div class="card-body placeholder">준비 중…</div>
    </div>

    <!-- 구매자 패널 -->
    <div id="panel-buyers" class="card chart-card">
      <div class="card-header">구매자</div>
      <div class="card-body">
        <div class="row g-4">
          <div class="col-md-6">
            <div class="chart-wrap">
              <canvas id="genderChart" aria-label="성별 비율"></canvas>
            </div>
          </div>
          <div class="col-md-6">
            <div class="chart-wrap">
              <canvas id="ageChart" aria-label="연령대 분포"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script layout:fragment="script" type="text/javascript">
/* Chart.js CDN (admin 레이아웃에 없다면 아래 사용) */
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script layout:fragment="script" type="text/javascript">
(() => {
  const root = document.getElementById('statRoot');
  const productId = root?.dataset?.productId;

  // 간단한 3D 느낌(그림자) 플러그인
  const shadowPlugin = {
    id: 'softShadow',
    beforeDatasetsDraw(chart, args, pluginOptions) {
      const {ctx} = chart;
      ctx.save();
      ctx.shadowColor = 'rgba(0,0,0,0.25)';
      ctx.shadowBlur = 10;
      ctx.shadowOffsetY = 6;
    },
    afterDatasetsDraw(chart, args, pluginOptions) {
      chart.ctx.restore();
    }
  };

  let genderChart, ageChart;

  function makeRadialGradient(ctx, area, from, to) {
    const r = Math.min(area.width, area.height) / 2;
    const g = ctx.createRadialGradient(area.left + area.width/2, area.top + area.height/2, r*0.1,
                                       area.left + area.width/2, area.top + area.height/2, r);
    g.addColorStop(0, from);
    g.addColorStop(1, to);
    return g;
  }

  async function loadBuyers() {
    const res = await fetch(`/admin/stats/${productId}/buyers`, { headers: { 'Accept': 'application/json' }});
    const data = await res.json();

    const gMale = data?.gender?.male ?? 0;
    const gFemale = data?.gender?.female ?? 0;
    const gUnknown = data?.gender?.unknown ?? 0;

    // ----- 성별 파이 -----
    const genderCtx = document.getElementById('genderChart').getContext('2d');
    const femaleFill = (ctx) => {
      const area = ctx.chart.chartArea;
      if (!area) return '#ffffff';
      return makeRadialGradient(ctx.ctx, area, '#ffffff', '#d9d9d9');
    };
    const maleFill = (ctx) => {
      const area = ctx.chart.chartArea;
      if (!area) return '#000000';
      return makeRadialGradient(ctx.ctx, area, '#2a2a2a', '#000000');
    };
    const unknownFill = (ctx) => {
      const area = ctx.chart.chartArea;
      if (!area) return '#9e9e9e';
      return makeRadialGradient(ctx.ctx, area, '#cfcfcf', '#9e9e9e');
    };

    genderChart?.destroy();
    genderChart = new Chart(genderCtx, {
      type: 'pie',
      data: {
        labels: (gUnknown>0) ? ['여성','남성','기타'] : ['여성','남성'],
        datasets: [{
          data: (gUnknown>0) ? [gFemale, gMale, gUnknown] : [gFemale, gMale],
          backgroundColor: (gUnknown>0) ? [femaleFill, maleFill, unknownFill] : [femaleFill, maleFill],
          borderWidth: 1,
          borderColor: '#fff'
        }]
      },
      options: {
        plugins: {
          legend: { position: 'bottom' },
          tooltip: {
            callbacks: {
              label: (ctx) => `${ctx.label}: ${ctx.formattedValue}명`
            }
          }
        }
      },
      plugins: [shadowPlugin]
    });

    // ----- 연령대 막대 (10,20,30,40,50+) -----
    const a10 = data?.age?.t10 ?? 0;
    const a20 = data?.age?.t20 ?? 0;
    const a30 = data?.age?.t30 ?? 0;
    const a40 = data?.age?.t40 ?? 0;
    const a50p = data?.age?.t50p ?? 0;

    const ageCtx = document.getElementById('ageChart').getContext('2d');
    // 밝은 -> 어두운 (흰 → 검)
    const bars = ['#ffffff','#e5e5e5','#bdbdbd','#7f7f7f','#000000'];

    ageChart?.destroy();
    ageChart = new Chart(ageCtx, {
      type: 'bar',
      data: {
        labels: ['10', '20', '30', '40', '50+'],
        datasets: [{
          label: '명',
          data: [a10,a20,a30,a40,a50p],
          backgroundColor: bars,
          borderColor: '#222',
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: { beginAtZero: true, ticks: { precision:0 } }
        },
        plugins: {
          legend: { display:false },
          tooltip: {
            callbacks: { label: (ctx) => `${ctx.parsed.y}명` }
          }
        }
      },
      plugins: [shadowPlugin]
    });
  }

  // 라디오 토글 (Ajax)
  function bindToggle() {
    const sales = document.getElementById('panel-sales');
    const buyers = document.getElementById('panel-buyers');

    document.getElementById('modeSales').addEventListener('change', async (e)=>{
      if(!e.target.checked) return;
      buyers.classList.add('d-none');
      sales.classList.remove('d-none');
      // 매출 Ajax 훅 (현재 비워둠)
      // await fetch(`/admin/stats/${productId}/sales`);
    });

    document.getElementById('modeBuyers').addEventListener('change', async (e)=>{
      if(!e.target.checked) return;
      sales.classList.add('d-none');
      buyers.classList.remove('d-none');
      await loadBuyers();
    });
  }

  bindToggle();
  // 초기 로딩은 '구매자'
  loadBuyers();
})();
</script>
</html>
