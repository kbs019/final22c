<html layout:decorate="~{/layout/adminLayout}"> 
<th:block layout:fragment="css">
  <style>
    /* 세그먼트형 라디오 (중앙 정렬) */
    .segmented .btn {
      padding: .42rem 1rem;
      border-color: #d0d3d9;
      background: #fff;
      color: #222;
      font-weight: 600;
    }

    .segmented .btn:first-of-type {
      border-top-left-radius: 999px;
      border-bottom-left-radius: 999px;
    }

    .segmented .btn:last-of-type {
      border-top-right-radius: 999px;
      border-bottom-right-radius: 999px;
    }

    .segmented .btn+.btn {
      margin-left: -1px;
    }

    .btn-check:checked+.btn {
      background: #111;
      border-color: #111;
      color: #fff;
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, .2);
    }

    /* 카드 & 차트 영역 */
    .chart-card {
      border: 1px solid #e6e8eb;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .06);
      overflow: hidden;
    }

    .chart-card .card-body {
      background: #f6f7f9;
      padding: 1.25rem;
    }

    .chart-wrap {
      position: relative;
      height: 400px;
    }

    .chart-wrap canvas {
      width: 100% !important;
      height: 100% !important;
      display: block;
    }

    .placeholder {
      height: 420px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #888
    }
  </style>
</th:block>

<div layout:fragment="content">
  <div class="container my-4" th:with="p=${product}">
    <h2 class="mb-2">상품 통계</h2>

    <!-- 상품 정보 -->
    <div class="d-flex align-items-center gap-3">
      <img th:src="${p.imgPath + p.imgName}" alt="" style="width:56px;height:56px;object-fit:cover;border-radius:10px"
        onerror="this.style.display='none'">
      <div>
        <div class="fw-semibold" th:text="${p.name}">상품명</div>
        <div class="text-muted small">
          <span th:text="${p.brand != null ? p.brand.brandName : '브랜드 미지정'}"></span>
          · ID <span th:text="${p.id}"></span>
        </div>
      </div>
    </div>

    <!-- 라디오: 상품정보 아래 + 중앙 정렬 -->
    <div class="w-100 d-flex justify-content-center my-3" id="statRoot" th:attr="data-product-id=${p.id}">
      <div class="btn-group segmented" role="group" aria-label="통계 탭">
        <input type="radio" class="btn-check" name="mode" id="modeSales" value="sales">
        <label class="btn" for="modeSales">판매량</label>

        <input type="radio" class="btn-check" name="mode" id="modeBuyers" value="buyers" checked>
        <label class="btn" for="modeBuyers">구매자</label>
      </div>
    </div>

    <!-- 매출 패널 (변경 없음) -->
    <div id="panel-sales" class="card chart-card d-none">
      <div class="card-header d-flex align-items-center justify-content-between">
        <span>판매량</span>
        <div class="d-flex align-items-center gap-2">
          <select id="unitSelect" class="form-select form-select-sm" style="width:auto">
            <option value="DAY">일간</option>
            <option value="WEEK">주간</option>
            <option value="MONTH">월간</option>
            <option value="YEAR">연간</option>
          </select>

          <!-- DAY -->
          <input type="date" id="dateInput" class="form-control form-control-sm" style="width:auto">

          <!-- WEEK (YYYY-MM) -->
          <input type="month" id="monthInput" class="form-control form-control-sm d-none" style="width:auto">

          <!-- MONTH (YYYY) -->
          <input type="number" id="yearInput" class="form-control form-control-sm d-none" style="width:110px" min="2000"
            max="2100" step="1">
        </div>
      </div>
      <div class="card-body">
        <div class="chart-wrap"><canvas id="salesChart" aria-label="판매량 추이"></canvas></div>
      </div>
    </div>

    <!-- 구매자 패널 -->
    <div id="panel-buyers" class="chart-card">
      <div class="card-body">
        <div class="row g-4">
          <div class="col-md-6">
            <div class="chart-wrap">
              <canvas id="genderChart" aria-label="성별 비율"></canvas>
            </div>
          </div>
          <div class="col-md-6">
            <div class="chart-wrap">
              <canvas id="ageChart" aria-label="연령대 분포"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script layout:fragment="script" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script layout:fragment="script" type="text/javascript">
  (() => {
    const root = document.getElementById('statRoot');
    const productId = root?.dataset?.productId;

    // 부드러운 그림자
    const shadowPlugin = {
      id: 'softShadow',
      beforeDatasetsDraw(chart) { const { ctx } = chart; ctx.save(); ctx.shadowColor = 'rgba(0,0,0,0.18)'; ctx.shadowBlur = 8; ctx.shadowOffsetY = 4; },
      afterDatasetsDraw(chart) { chart.ctx.restore(); }
    };

    // 바 범례 강제 숨김(안전장치)
    const hideLegendForBar = {
      id: 'hideLegendForBar',
      beforeInit(chart) {
        if (chart.config.type === 'bar') {
          chart.options.plugins = chart.options.plugins || {};
          chart.options.plugins.legend = chart.options.plugins.legend || {};
          chart.options.plugins.legend.display = false;
          chart.options.plugins.legend.labels = { generateLabels: () => [] };
        }
      }
    };

    /* ===== ▼ 구매자 통계: 성별(도넛) + 연령대(막대 리디자인) ▼ ===== */
    let genderChart, ageChart;

    // 도넛 중앙 합계
    const centerTotalPlugin = {
      id: 'centerTotal',
      afterDraw(chart) {
        const { ctx, chartArea } = chart;
        if (!chartArea) return;
        const total = (chart.data.datasets?.[0]?.data || []).reduce((a, b) => a + b, 0);
        const cx = (chartArea.left + chartArea.right) / 2;
        const cy = (chartArea.top + chartArea.bottom) / 2;
        ctx.save();
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = '#111';
        ctx.font = '600 20px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
        ctx.fillText(`${total}명`, cx, cy - 4);
        ctx.fillStyle = '#666';
        ctx.font = '400 12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
        ctx.fillText('총 구매자', cx, cy + 16);
        ctx.restore();
      }
    };

    // 막대 값 라벨(수평/수직 자동 대응, 정수만)
    const valueLabelPlugin = {
      id: 'valueLabel',
      afterDatasetsDraw(chart) {
        const { ctx, options } = chart;
        const meta = chart.getDatasetMeta(0);
        const values = chart.data.datasets?.[0]?.data || [];
        const horizontal = options?.indexAxis === 'y';
        ctx.save();
        ctx.textAlign = horizontal ? 'left' : 'center';
        ctx.textBaseline = horizontal ? 'middle' : 'bottom';
        ctx.font = '600 12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
        meta.data.forEach((bar, i) => {
          const v = values[i] ?? 0;
          if (v > 0) {
            ctx.fillStyle = '#111';
            // 흰 배경 글로우로 가독성 보정
            ctx.shadowColor = 'rgba(255,255,255,0.9)';
            ctx.shadowBlur = 6;
            if (horizontal) {
              ctx.fillText(String(Math.trunc(v)), bar.x + 10, bar.y);
            } else {
              ctx.fillText(String(Math.trunc(v)), bar.x, bar.y - 6);
            }
            ctx.shadowBlur = 0;
          }
        });
        ctx.restore();
      }
    };

    // 막대 그라데이션(방향 자동)
    function barGradient(context) {
      const { chart } = context;
      const area = chart.chartArea;
      if (!area) return '#686e77';
      const horizontal = chart.options?.indexAxis === 'y';
      const g = horizontal
        ? chart.ctx.createLinearGradient(area.left, 0, area.right, 0)
        : chart.ctx.createLinearGradient(0, area.top, 0, area.bottom);
      g.addColorStop(0, '#4f545c');
      g.addColorStop(1, '#c7ccd6');
      return g;
    }

    async function loadBuyers() {
      const res = await fetch(`/admin/stats/${productId}/buyers`, { headers: { Accept: 'application/json' } });
      const data = await res.json();

      /* --- 성별: 도넛 (변경 없음) --- */
      const gMale = data?.gender?.male ?? 0;
      const gFemale = data?.gender?.female ?? 0;
      const gUnknown = data?.gender?.unknown ?? 0;

      const totalG = gMale + gFemale + gUnknown;
      const genderCtx = document.getElementById('genderChart').getContext('2d');
      const femaleFill = '#ffffff', maleFill = '#111111', unknownFill = '#9e9e9e';

      const labelsG = (gUnknown > 0) ? ['여성', '남성', '기타'] : ['여성', '남성'];
      const dataG = (gUnknown > 0) ? [gFemale, gMale, gUnknown] : [gFemale, gMale];
      const colorsG = (gUnknown > 0) ? [femaleFill, maleFill, unknownFill] : [femaleFill, maleFill];

      genderChart?.destroy();
      genderChart = new Chart(genderCtx, {
        type: 'doughnut',
        data: { labels: labelsG, datasets: [{ data: dataG, backgroundColor: colorsG, borderWidth: 0, hoverOffset: 6 }] },
        options: {
          responsive: true, maintainAspectRatio: false, cutout: '60%',
          layout: { padding: { top: 6, right: 6, bottom: 6, left: 6 } },
          plugins: {
            legend: { position: 'top', labels: { usePointStyle: true } },
            tooltip: {
              callbacks: {
                label: (c) => {
                  const count = c.parsed;
                  const pct = totalG ? Math.round(count * 1000 / totalG) / 10 : 0;
                  return ` ${c.label}: ${count}명 (${pct}%)`;
                }
              }
            }
          },
          animation: { duration: 600, easing: 'easeOutCubic' }
        },
        plugins: [shadowPlugin, centerTotalPlugin]
      });

      /* --- 연령대: 막대 (수평형으로 리디자인) --- */
      const a10 = data?.age?.t10 ?? 0;
      const a20 = data?.age?.t20 ?? 0;
      const a30 = data?.age?.t30 ?? 0;
      const a40 = data?.age?.t40 ?? 0;
      const a50p = data?.age?.t50p ?? 0;

      const maxRaw = Math.max(a10, a20, a30, a40, a50p, 0);
      const step = (maxRaw <= 10) ? 1 : (maxRaw <= 50) ? 5 : (maxRaw <= 100) ? 10 : Math.ceil(maxRaw / 10);
      const axisMax = Math.max(step, Math.ceil((maxRaw || 1) / step) * step);

      const ageCtx = document.getElementById('ageChart').getContext('2d');

      ageChart?.destroy();
      ageChart = new Chart(ageCtx, {
        type: 'bar',
        data: {
          labels: ['10대', '20대', '30대', '40대', '50대+'],
          datasets: [{
            data: [a10, a20, a30, a40, a50p],
            backgroundColor: (c) => barGradient(c),
            borderWidth: 0,
            borderSkipped: false,

            /* 둥근 모서리 & 두께/간격 정제 */
            borderRadius: { topLeft: 8, topRight: 8, bottomLeft: 8, bottomRight: 8 },
            barThickness: 18,
            maxBarThickness: 18,
            categoryPercentage: 0.58,
            barPercentage: 0.9
          }]
        },
        options: {
          indexAxis: 'y',  // ▶ 수평 막대
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: { top: 8, right: 16, bottom: 12, left: 8 } },
          scales: {
            x: {
              min: 0, max: axisMax,
              grid: {
                color: 'rgba(0,0,0,0.05)',
                borderDash: [3, 3]
              },
              ticks: {
                stepSize: step,
                precision: 0,
                callback: (v) => Number.isInteger(v) ? String(v) : ''
              },
              title: { display: true, text: '명' }
            },
            y: {
              grid: { display: false },
              ticks: { font: { weight: 600 } }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: { label: (c) => ` ${Math.trunc(c.parsed.x)}명` },
              displayColors: false
            }
          },
          animation: {
            duration: 650,
            easing: 'easeOutCubic',
            delay: (ctx) => ctx.dataIndex * 60
          }
        },
        plugins: [shadowPlugin, hideLegendForBar, valueLabelPlugin]
      });
    }

    // 라디오 토글
    function bindToggle() {
      const sales = document.getElementById('panel-sales');
      const buyers = document.getElementById('panel-buyers');

      document.getElementById('modeSales').addEventListener('change', async (e) => {
        if (!e.target.checked) return;
        buyers.classList.add('d-none'); sales.classList.remove('d-none');
      });

      document.getElementById('modeBuyers').addEventListener('change', async (e) => {
        if (!e.target.checked) return;
        sales.classList.add('d-none'); buyers.classList.remove('d-none');
        await loadBuyers();
      });
    }

    bindToggle();
    loadBuyers(); // 초기: 구매자
  })();


  /* ▼ 매출 차트: 기존 그대로(수정 없음) ▼ */
  (() => {
    const productId = document.getElementById('statRoot')?.dataset?.productId;

    const unitSel = document.getElementById('unitSelect');
    const dateInp = document.getElementById('dateInput');  // DAY
    const monthInp = document.getElementById('monthInput'); // WEEK
    const yearInp = document.getElementById('yearInput');  // MONTH
    const salesCard = document.getElementById('panel-sales');

    // 초기값
    const today = new Date();
    const thisYear = today.getFullYear();
    dateInp.value = today.toISOString().slice(0, 10);
    monthInp.value = today.toISOString().slice(0, 7);
    yearInp.value = thisYear;
    yearInp.setAttribute('max', String(thisYear));
    yearInp.setAttribute('min', '2000');
    yearInp.setAttribute('step', '1');

    function clampYearInput() {
      let y = parseInt(yearInp.value, 10);
      if (Number.isNaN(y)) { yearInp.value = thisYear; return; }
      if (y > thisYear) yearInp.value = thisYear;
      if (y < 2000) yearInp.value = 2000;
    }
    yearInp.addEventListener('input', clampYearInput);
    yearInp.addEventListener('change', () => { clampYearInput(); loadAndDraw(); });

    document.getElementById('modeSales').addEventListener('change', async (e) => {
      if (!e.target.checked) return;
      document.getElementById('panel-buyers').classList.add('d-none');
      salesCard.classList.remove('d-none');
      await loadAndDraw();
    });

    unitSel.addEventListener('change', () => {
      const u = unitSel.value;
      dateInp.classList.toggle('d-none', u !== 'DAY');
      monthInp.classList.toggle('d-none', u !== 'WEEK');
      yearInp.classList.toggle('d-none', u !== 'MONTH');
      dateInp.disabled = (u === 'YEAR');
      monthInp.disabled = (u === 'YEAR');
      yearInp.disabled = (u === 'YEAR');
      loadAndDraw();
    });

    [dateInp, monthInp].forEach(el => el.addEventListener('change', loadAndDraw));

    let chart;
    async function loadAndDraw() {
      const u = unitSel.value;
      const params = new URLSearchParams({ unit: u });
      if (u === 'DAY') params.set('date', dateInp.value);
      if (u === 'WEEK') params.set('date', monthInp.value);
      if (u === 'MONTH') { clampYearInput(); params.set('year', yearInp.value); }

      const res = await fetch(`/admin/stats/${productId}/sales?` + params.toString(),
        { headers: { 'Accept': 'application/json' } });
      const json = await res.json();

      const labels = json.labels ?? [];
      const data = json.data ?? [];

      const maxVal = data.length ? Math.max(...data) : 0;
      const yScale = { min: 0, beginAtZero: true, ticks: { precision: 0 } };
      if (maxVal === 0) yScale.suggestedMax = 5;

      const ctx = document.getElementById('salesChart').getContext('2d');
      chart?.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: '판매량',
            data,
            fill: true,
            backgroundColor: 'transparent',
            borderColor: 'rgba(230, 99, 132, 1)',
            borderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 5,
            tension: 0
          }]
        },
        options: {
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales: { y: yScale },
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (c) => ` ${c.parsed.y} 개` } }
          }
        }
      });
    }
    // 기본 표시 탭: 구매자 (변경 없음)
  })();
</script>

</html>
