<!-- final22c/src/main/resources/templates/admin/stat.html -->
<html layout:decorate="~{/layout/adminLayout}">
<th:block layout:fragment="css">
  <style>
    .chart-card {
      min-height: 420px
    }

    .chart-wrap {
      position: relative;
      height: 380px
    }

    .placeholder {
      height: 420px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #888
    }
  </style>
</th:block>

<div layout:fragment="content">
  <div class="container my-4" th:with="p=${product}">
    <h2 class="mb-3">상품 통계</h2>

    <!-- 상품 헤더 -->
    <div class="mb-3">
      <div class="d-flex align-items-center gap-3">
        <img th:src="${p.imgPath + p.imgName}" alt="" style="width:64px;height:64px;object-fit:cover;border-radius:8px"
          onerror="this.style.display='none'">
        <div>
          <div class="fw-bold fs-5" th:text="${p.name}">상품명</div>
          <div class="text-muted">
            <span th:text="${p.brand != null ? p.brand.brandName : '브랜드 미지정'}"></span>
            · ID <span th:text="${p.id}"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- 라디오: 매출 / 구매자 -->
    <div class="mb-3" th:attr="data-product-id=${p.id}" id="statRoot">
      <div class="btn-group" role="group" aria-label="toggle">
        <input type="radio" class="btn-check" name="mode" id="modeSales" value="sales">
        <label class="btn btn-outline-dark" for="modeSales">판매량</label>

        <input type="radio" class="btn-check" name="mode" id="modeBuyers" value="buyers" checked>
        <label class="btn btn-outline-dark" for="modeBuyers">구매자</label>
      </div>
    </div>

    <!-- 매출 패널 -->
    <div id="panel-sales" class="card chart-card d-none">
      <div class="card-header d-flex align-items-center justify-content-between">
        <span>판매량</span>
        <div class="d-flex align-items-center gap-2">
          <select id="unitSelect" class="form-select form-select-sm" style="width:auto">
            <option value="DAY">일간</option>
            <option value="WEEK">주간</option>
            <option value="MONTH">월간</option>
            <option value="YEAR">연간</option>
          </select>

          <!-- DAY -->
          <input type="date" id="dateInput" class="form-control form-control-sm" style="width:auto">

          <!-- WEEK (YYYY-MM) -->
          <input type="month" id="monthInput" class="form-control form-control-sm d-none" style="width:auto">

          <!-- MONTH (YYYY) -->
          <input type="number" id="yearInput" class="form-control form-control-sm d-none" style="width:110px" min="2000"
            max="2100" step="1">
        </div>
      </div>
      <div class="card-body">
        <div class="chart-wrap"><canvas id="salesChart" aria-label="판매량 추이"></canvas></div>
      </div>
    </div>

    <!-- 구매자 패널 -->
    <div id="panel-buyers" class="card chart-card">
      <div class="card-header">구매자</div>
      <div class="card-body">
        <div class="row g-4">
          <div class="col-md-6">
            <div class="chart-wrap">
              <canvas id="genderChart" aria-label="성별 비율"></canvas>
            </div>
          </div>
          <div class="col-md-6">
            <div class="chart-wrap">
              <canvas id="ageChart" aria-label="연령대 분포"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script layout:fragment="script" type="text/javascript">
  /* Chart.js CDN (admin 레이아웃에 없다면 아래 사용) */
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script layout:fragment="script" type="text/javascript">
  (() => {
    const root = document.getElementById('statRoot');
    const productId = root?.dataset?.productId;

    // 간단한 3D 느낌(그림자) 플러그인
    const shadowPlugin = {
      id: 'softShadow',
      beforeDatasetsDraw(chart, args, pluginOptions) {
        const { ctx } = chart;
        ctx.save();
        ctx.shadowColor = 'rgba(0,0,0,0.25)';
        ctx.shadowBlur = 10;
        ctx.shadowOffsetY = 6;
      },
      afterDatasetsDraw(chart, args, pluginOptions) {
        chart.ctx.restore();
      }
    };

    let genderChart, ageChart;

    function makeRadialGradient(ctx, area, from, to) {
      const r = Math.min(area.width, area.height) / 2;
      const g = ctx.createRadialGradient(area.left + area.width / 2, area.top + area.height / 2, r * 0.1,
        area.left + area.width / 2, area.top + area.height / 2, r);
      g.addColorStop(0, from);
      g.addColorStop(1, to);
      return g;
    }

    async function loadBuyers() {
      const res = await fetch(`/admin/stats/${productId}/buyers`, { headers: { 'Accept': 'application/json' } });
      const data = await res.json();

      const gMale = data?.gender?.male ?? 0;
      const gFemale = data?.gender?.female ?? 0;
      const gUnknown = data?.gender?.unknown ?? 0;

      // ----- 성별 파이 -----
      const genderCtx = document.getElementById('genderChart').getContext('2d');
      const femaleFill = (ctx) => {
        const area = ctx.chart.chartArea;
        if (!area) return '#ffffff';
        return makeRadialGradient(ctx.ctx, area, '#ffffff', '#d9d9d9');
      };
      const maleFill = (ctx) => {
        const area = ctx.chart.chartArea;
        if (!area) return '#000000';
        return makeRadialGradient(ctx.ctx, area, '#2a2a2a', '#000000');
      };
      const unknownFill = (ctx) => {
        const area = ctx.chart.chartArea;
        if (!area) return '#9e9e9e';
        return makeRadialGradient(ctx.ctx, area, '#cfcfcf', '#9e9e9e');
      };

      genderChart?.destroy();
      genderChart = new Chart(genderCtx, {
        type: 'pie',
        data: {
          labels: (gUnknown > 0) ? ['여성', '남성', '기타'] : ['여성', '남성'],
          datasets: [{
            data: (gUnknown > 0) ? [gFemale, gMale, gUnknown] : [gFemale, gMale],
            backgroundColor: (gUnknown > 0) ? [femaleFill, maleFill, unknownFill] : [femaleFill, maleFill],
            borderWidth: 1,
            borderColor: '#fff'
          }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.label}: ${ctx.formattedValue}명`
              }
            }
          }
        },
        plugins: [shadowPlugin]
      });

      // ----- 연령대 막대 (10,20,30,40,50+) -----
      const a10 = data?.age?.t10 ?? 0;
      const a20 = data?.age?.t20 ?? 0;
      const a30 = data?.age?.t30 ?? 0;
      const a40 = data?.age?.t40 ?? 0;
      const a50p = data?.age?.t50p ?? 0;

      const ageCtx = document.getElementById('ageChart').getContext('2d');
      // 밝은 -> 어두운 (흰 → 검)
      const bars = ['#ffffff', '#e5e5e5', '#bdbdbd', '#7f7f7f', '#000000'];

      ageChart?.destroy();
      ageChart = new Chart(ageCtx, {
        type: 'bar',
        data: {
          labels: ['10', '20', '30', '40', '50+'],
          datasets: [{
            label: '명',
            data: [a10, a20, a30, a40, a50p],
            backgroundColor: bars,
            borderColor: '#222',
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: { beginAtZero: true, ticks: { precision: 0 } }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: { label: (ctx) => `${ctx.parsed.y}명` }
            }
          }
        },
        plugins: [shadowPlugin]
      });
    }

    // 라디오 토글 (Ajax)
    function bindToggle() {
      const sales = document.getElementById('panel-sales');
      const buyers = document.getElementById('panel-buyers');

      document.getElementById('modeSales').addEventListener('change', async (e) => {
        if (!e.target.checked) return;
        buyers.classList.add('d-none');
        sales.classList.remove('d-none');
        // 매출 Ajax 훅 (현재 비워둠)
        // await fetch(`/admin/stats/${productId}/sales`);
      });

      document.getElementById('modeBuyers').addEventListener('change', async (e) => {
        if (!e.target.checked) return;
        sales.classList.add('d-none');
        buyers.classList.remove('d-none');
        await loadBuyers();
      });
    }

    bindToggle();
    // 초기 로딩은 '구매자'
    loadBuyers();
  })();

  // 판매량 통계
  (() => {
    const productId = document.getElementById('statRoot')?.dataset?.productId;

    const unitSel = document.getElementById('unitSelect');
    const dateInp = document.getElementById('dateInput');  // DAY
    const monthInp = document.getElementById('monthInput'); // WEEK
    const yearInp = document.getElementById('yearInput');  // MONTH
    const salesCard = document.getElementById('panel-sales');

    // 초기값: 오늘/이번달/올해
    const today = new Date();
    const thisYear = today.getFullYear();

    dateInp.value = today.toISOString().slice(0, 10);
    monthInp.value = today.toISOString().slice(0, 7);
    yearInp.value = thisYear;

    // 연도 입력 제한 (최대 올해 년도)
    yearInp.setAttribute('max', String(thisYear));
    // 필요 시 최소년도도 설정
    yearInp.setAttribute('min', '2000');
    yearInp.setAttribute('step', '1');

    // 값이 범위를 넘으면 보정
    function clampYearInput() {
      let y = parseInt(yearInp.value, 10);
      if (Number.isNaN(y)) { yearInp.value = thisYear; return; }
      if (y > thisYear) yearInp.value = thisYear;
      if (y < 2000) yearInp.value = 2000;
    }
    yearInp.addEventListener('input', clampYearInput);
    yearInp.addEventListener('change', () => { clampYearInput(); loadAndDraw(); });

    // 라디오 토글에서 '매출'로 전환 시 로딩
    document.getElementById('modeSales').addEventListener('change', async (e) => {
      if (!e.target.checked) return;
      document.getElementById('panel-buyers').classList.add('d-none');
      salesCard.classList.remove('d-none');
      await loadAndDraw();
    });

    // 유닛 선택에 따라 입력 UI를 전환
    unitSel.addEventListener('change', () => {
      const u = unitSel.value;
      dateInp.classList.toggle('d-none', u !== 'DAY');
      monthInp.classList.toggle('d-none', u !== 'WEEK');
      yearInp.classList.toggle('d-none', u !== 'MONTH');

      // YEAR는 입력 없이 바로 로딩
      dateInp.disabled = (u === 'YEAR');
      monthInp.disabled = (u === 'YEAR');
      yearInp.disabled = (u === 'YEAR');

      loadAndDraw();
    });

    // 입력 변경 시 즉시 갱신
    [dateInp, monthInp].forEach(el => el.addEventListener('change', loadAndDraw));

    // // 라인+면적 스타일(은은한 그라데이션)
    // function lineFill(ctx) {
    //   const { chartArea, ctx: c } = ctx.chart;
    //   if (!chartArea) return '#fff';
    //   const g = c.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
    //   g.addColorStop(0, '#fff');
    //   g.addColorStop(1, '#fff');
    //   return g;
    // }

    let chart;
    async function loadAndDraw() {
      const u = unitSel.value;
      const params = new URLSearchParams({ unit: u });
      if (u === 'DAY') params.set('date', dateInp.value);       // YYYY-MM-DD
      if (u === 'WEEK') params.set('date', monthInp.value);      // YYYY-MM
      if (u === 'MONTH') { clampYearInput(); params.set('year', yearInp.value); } // YYYY

      const res = await fetch(`/admin/stats/${productId}/sales?` + params.toString(),
        { headers: { 'Accept': 'application/json' } });
      const json = await res.json();

      const labels = json.labels ?? [];
      const data = json.data ?? [];

      // 전부 0일 때 눈금이 사라지는 것 방지
      const maxVal = data.length ? Math.max(...data) : 0;
      const yScale = { min: 0, beginAtZero: true, ticks: { precision: 0 } };
      if (maxVal === 0) yScale.suggestedMax = 5;

      const ctx = document.getElementById('salesChart').getContext('2d');
      chart?.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: '판매량',
            data,
            fill: true,
            backgroundColor: 'transparent',    // ★ 혹시 모를 채움 제거
            borderColor: 'rgba(230, 99, 132, 1)',
            borderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 5,
            tension: 0
          }]
        },
        options: {
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales: { y: yScale },
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (c) => ` ${c.parsed.y} 개` } }
          }
        }
      });
    }

    // 페이지 첫 로드시 ‘구매자’가 기본이므로, 매출 탭으로 바꾸면 즉시 그려진다.
    // 만약 처음부터 매출을 보이게 하고 싶다면 아래 한 줄을 풀면 됨:
    // loadAndDraw();
  })();
</script>

</html>