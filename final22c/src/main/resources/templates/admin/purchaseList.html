<html layout:decorate="~{/layout/adminLayout}">
<div layout:fragment="content" class="container">
	
	<h2>발주내역</h2>
<div class="card mb-4">
	<div class="card-header">
		<i class="fas fa-table me-1"></i>
			발주리스트
		</div>
		  <!-- 🔎 기간 검색 -->
		<form id="searchForm" class="d-flex align-items-center gap-2">
		  <input type="date" id="startDate" name="startDate"
		         class="form-control form-control-sm"
		         style="width:150px;"
		         th:value="${param.startDate}">
		  <span>~</span>
		  <input type="date" id="endDate" name="endDate"
		         class="form-control form-control-sm"
		         style="width:150px;"
		         th:value="${param.endDate}">
		
		  <button type="submit" class="btn btn-sm btn-primary">검색</button>
		  <button type="button" id="resetBtn" class="btn btn-sm btn-outline-secondary">초기화</button>
		</form>
		<div class="card-body">
			<table id="datatablesSimple">
				<thead>
					<tr>
		                <th scope="col">발주번호</th>
		                <th scope="col">상품개수</th>
		                <th scope="col">총 금액(원)</th>
		                <th scope="col">발주시간</th>
		                <th scope="col">관리</th>
					</tr>
				</thead>
				<tbody >
					<tr th:each="pur : ${purList}" >
		                <td th:text="${#temporals.format(pur.reg, 'yyyyMMdd')}+'-'+${pur.purchaseId}"></td>
		                <td th:text="${pur.count}"></td>
		                <td th:text="${#numbers.formatInteger(pur.totalPrice, 1, 'COMMA')}"></td>
		                <td th:text="${#temporals.format(pur.reg, 'yyyy-MM-dd HH:mm')}"></td>
		                <td>
							<button type="button" class="btn btn-primary btn-sm open-order" th:attr="data-purid=${pur.purchaseId}">
							    상세보기
							</button>
						</td>
	            	</tr>
				</tbody>
			</table>
		</div>
	</div>
	
	<!-- 발주 상세 모달 -->
	<div class="modal fade" id="purchaseDetailModal" tabindex="-1" aria-hidden="true">
	  <div class="modal-dialog modal-lg">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title">발주 상세</h5>
	        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	      </div>
	      <div class="modal-body">
	        <!-- 발주 기본정보 -->
	        <div id="modalPurchaseInfo" class="mb-3">
	          <div>발주일: <span id="modalReg"></span></div>
	          <div>발주처: <span>홍석범부</span></div>
	        </div>
	
	        <!-- 발주상품 테이블 -->
	        <table class="table table-bordered">
	          <thead>
	            <tr>
					<th>상품ID</th>
					<th>상품명</th>
					<th>수량</th>
					<th>매입가</th>
					<th>합계</th>
	            </tr>
	          </thead>
	          <tbody id="modalPurchaseList">
	            <!-- JS에서 동적으로 삽입 -->
	          </tbody>
				<tfoot>
					<tr>
						<td colspan="4" class="text-end fw-bold">총 금액</td>
						<td id="modalTotal" class="fw-bold"></td>
					</tr>
				</tfoot>
	        </table>
	      </div>
	    </div>
	  </div>
	</div>
</div>
<script layout:fragment="script" type="text/javascript">
// 발주 기간 선택
  // 기간 검색
  document.getElementById("searchForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const start = document.getElementById("startDate").value;
    const end   = document.getElementById("endDate").value;

    if (!start || !end) {
      alert("기간을 선택하세요.");
      return;
    }
    location.href = `/admin/purchaseList?startDate=${start}&endDate=${end}`;
  });

  // ✅ 초기화: 입력값 비우고 전체목록으로 이동
  document.getElementById("resetBtn").addEventListener("click", function() {
    document.getElementById("startDate").value = "";
    document.getElementById("endDate").value = "";
    // 쿼리스트링 제거하여 전체 목록 조회
    location.href = `/admin/purchaseList`;
  });

document.addEventListener('click', e => {
    if (e.target.classList.contains('open-order')) {
        const purchaseId = e.target.dataset.purid;

        fetch(`/admin/getPurchaseDetail/${purchaseId}`)
            .then(res => {
                if (!res.ok) throw new Error("서버 오류");
                return res.json();
            })
            .then(data => {
                // 발주일만 표시
                document.getElementById('modalReg').textContent = data.reg;

                // 상품 테이블
                const tbody = document.getElementById('modalPurchaseList');
                tbody.innerHTML = '';

                const items = data.items || []; // undefined 방지
                items.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${item.productId}</td>
                        <td>${item.productName}</td>
                        <td>${item.qty}</td>
                        <td>${item.price.toLocaleString()}원</td>
                        <td>${item.total.toLocaleString()}원</td>
                    `;
                    tbody.appendChild(tr);
                });
            	// 총 금액 표시 (purchase 컬럼 값)
                document.getElementById('modalTotal').textContent = data.totalPrice.toLocaleString() + "원";

                // 모달 띄우기
                const modalEl = document.getElementById('purchaseDetailModal');
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
            })
            .catch(err => {
                console.error(err);
                alert("발주 상세 정보를 불러오는 중 오류가 발생했습니다.");
            });
    }
});
</script>
</html>