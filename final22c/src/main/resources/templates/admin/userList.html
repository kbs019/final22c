<html layout:decorate="~{/layout/adminLayout}">
<div layout:fragment="content" class="container">
<div class="container mt-4">
	<h2>회원관리</h2>
	<div class="d-flex justify-content-between align-items-center mb-3">
	    <div>
	        <input type="text" id="search_kw" class="form-control d-inline-block" th:value="${kw}" style="width: 200px;" placeholder="아이디 입력" />
	        <button class="btn btn-outline-secondary" type="button" id="btn_search">검색</button>
	    </div>
	    <div class="form-check form-switch">
	        <input class="form-check-input" type="checkbox" id="filterActive" th:checked="${filter == 'suspended'}" />
			<label class="form-check-label" for="filterActive">정지 회원</label>
	    </div>
	</div>
	
	<table class="table table-bordered text-center align-middle" id="userTable">
	    <thead class="table-light">
	        <tr>
	            <th>아이디</th>
	            <th>이름</th>
	            <th>가입날짜</th>
	            <th>email</th>
	            <th>상태</th>
	            <th>상태 변경</th>
	        </tr>
	    </thead>
		<tbody>
		    <tr th:each="list : ${user}" th:data-status="${list.status}">
		        <td th:text="${list.userName}"></td>
		        <td th:text="${list.name}"></td>
		        <td th:text="${list.reg}"></td>
		        <td th:text="${list.email}"></td>
		
		        <!-- 상태 표시 -->
		        <td th:switch="${list.status}">
		            <span th:case="'active'">정상</span>
		            <span th:case="'suspended'">일시정지([[${list.banReg}]])</span>
		            <span th:case="'banned'">영구정지</span>
		        </td>
		
		        <!-- 상태 변경 select -->
		        <td>
		            <select class="statusSelect form-select form-select-sm"
		                    th:data-username="${list.userName}">
		                <option selected disabled>선택하세요</option>
		                <option value="normal">정상</option>
		                <option value="7d">7일 정지</option>
		                <option value="30d">30일 정지</option>
		                <option value="permanent">영구 정지</option>
		            </select>
		        </td>
		    </tr>
		</tbody>
	    </table>
	</div>
		
		<div th:if="${!user.isEmpty()}">
		<ul class="pagination justify-content-center">
			<!--이전-->
			<li class="page-item" th:classappend="${!user.hasPrevious}?'disabled'">
				<a class="page-link" href="javascript:void(0);" th:data-page="${user.number-1}">
					<span>이전</span>
				</a>
			</li>
			<!--페이지 번호-->
			<li th:each="page:${#numbers.sequence(0,user.totalPages-1)}" th:classappend="${page==user.number}?'active'" class="page-item" th:if="${page>=user.number-5 and page <= user.number+5}">
				<a th:text="${page+1}" class="page-link" href="javascript:void(0);" th:data-page="${page}"></a>
			</li>
			<!--다음-->
			<li class="page-item" th:classappend="${!user.hasNext}?'disabled'">
				<a class="page-link" href="javascript:void(0);" th:data-page="${user.number+1}">
					<span>다음</span>
				</a>
			</li>
		</ul>
	</div>
	
	<form th:action="@{/admin/userList}" method="get" id="searchForm">
		<input type="hidden" id="kw" name="kw" th:value="${kw}" />
		<input type="hidden" id="page" name="page" th:value="${user.number}" />
		<input type="hidden" id="filter" name="filter" th:value="${filter}" /> 
	</form>
	<!-- 상태 변경 성공 모달 -->
	<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
	  <div class="modal-dialog modal-dialog-centered">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title" id="successModalLabel">알림</h5>
	        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
	      </div>
	      <div class="modal-body">
	        회원 상태가 성공적으로 변경되었습니다.
	      </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">확인</button>
	      </div>
	    </div>
	  </div>
	</div>
</div>


<script layout:fragment="script" type="text/javascript">
	// 검색
	const page_elements = document.getElementsByClassName("page-link");
	Array.from(page_elements).forEach(function(element){
		element.addEventListener('click',function(){
			document.getElementById('page').value = this.dataset.page;
			document.getElementById('searchForm').submit();
		});
	});
	
	const btn_search = document.getElementById("btn_search");
	btn_search.addEventListener('click',function(){
		document.getElementById('kw').value = document.getElementById('search_kw').value;
		document.getElementById('page').value = 0;
		document.getElementById('searchForm').submit();
	});
	
	// 정지 ajax
	$(document).ready(function() {
		$(".statusSelect").change(function(){
			  $.ajax({
			    url: "/admin/changeStatus",
			    type: "POST",  
			    contentType: "application/x-www-form-urlencoded; charset=UTF-8",
			    data: {
			      username: $(this).data("username"),
			      status: $(this).val()
			    },
			    success: function(response) {
					
			    	var successModal = new bootstrap.Modal(document.getElementById('successModal'));
			    	  successModal.show();
	
			    	  // 모달 닫히면 새로고침
			    	  document.getElementById('successModal').addEventListener('hidden.bs.modal', function () {
			    	    location.reload();
			    	  },{ once: true });
			    },
			    error: function(xhr){
			      alert("상태 변경에 실패했습니다.");
			    }
			  });
			});
		});
		
		// 정지 체크박스
document.getElementById('filterActive').addEventListener('change', function() {
  const filterInput = document.getElementById('filter');
  filterInput.value = this.checked ? 'suspended' : '';
  document.getElementById('page').value = 0; 
  document.getElementById('searchForm').submit();
});
</script>

</html>