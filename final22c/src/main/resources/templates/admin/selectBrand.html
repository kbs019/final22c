<html layout:decorate="~{/layout/adminLayout}">
<div layout:fragment="content" class="container">
    <div class="container my-4">
        <h2 class="text-center mb-4">브랜드 선택</h2>
        <div class="row">
            <div class="col-md-6 col-lg-5 mx-auto">

                <!-- 기존 브랜드 선택 -->
                <div class="mb-3">
                    <label class="form-label">브랜드</label>
                    <select id="brandSelect" class="form-select">
                        <option value="">브랜드 선택</option>
                        <option th:each="brand : ${brands}"
                                th:value="${brand.id}"
                                th:text="${brand.brandName}"></option>
                        <option value="new">+ 새로운 브랜드 등록</option>
                    </select>
                </div>

                <!-- 새 브랜드 입력 -->
				<form id="newBrandForm" action="/admin/save" method="post" enctype="multipart/form-data" style="display:none;">
				    <div class="mb-3">
				        <input type="text" name="brandName" id="brandNameInput" class="form-control mb-2" placeholder="새 브랜드명">
				        <div id="brandNameError" class="text-danger small" style="display:none;">이미 존재하는 브랜드명입니다.</div>
				        <input type="file" name="imgName" class="form-control" accept="image/*">
				    </div>
				    <button type="submit" class="btn btn-success w-100">새 브랜드 등록</button>
				</form>

                <!-- 기존 브랜드 선택 후 이동 버튼 -->
                <button id="goProductBtn" class="btn btn-primary w-100 mt-3" style="display:none;">
                    해당 브랜드로 상품 등록
                </button>

            </div>
        </div>
    </div>
</div>

<script layout:fragment="script" type="text/javascript">
document.getElementById("brandSelect").addEventListener("change", function() {
    const newBrandForm = document.getElementById("newBrandForm");
    const goProductBtn = document.getElementById("goProductBtn");

    if (this.value === "new") {
        newBrandForm.style.display = "block";
        goProductBtn.style.display = "none";
    } else if (this.value !== "") {
        newBrandForm.style.display = "none";
        goProductBtn.style.display = "block";
    } else {
        newBrandForm.style.display = "none";
        goProductBtn.style.display = "none";
    }
});

// 기존 브랜드 선택 후 버튼 클릭 시 상품 등록 페이지 이동
document.getElementById("goProductBtn").addEventListener("click", function() {
    const brandId = document.getElementById("brandSelect").value;
    if (brandId) {
        window.location.href = "/admin/productForm?brandId=" + brandId;
    }
});

document.getElementById("newBrandForm").addEventListener("submit", function(e) {
    e.preventDefault(); // 기본 제출 막기
    const brandName = document.getElementById("brandNameInput").value.trim();
    const errorDiv = document.getElementById("brandNameError");

    if (!brandName) {
        errorDiv.textContent = "브랜드명을 입력해주세요.";
        errorDiv.style.display = "block";
        return;
    }

    fetch(`/admin/checkBrandName?brandName=${encodeURIComponent(brandName)}`)
        .then(res => res.json())
        .then(exists => {
            if (exists) {
                errorDiv.textContent = "이미 존재하는 브랜드명입니다.";
                errorDiv.style.display = "block";
            } else {
                errorDiv.style.display = "none"; // 에러 숨기고 제출
                this.submit();
            }
        })
        .catch(() => {
            errorDiv.textContent = "서버 오류가 발생했습니다.";
            errorDiv.style.display = "block";
        });
});
</script>
</html>