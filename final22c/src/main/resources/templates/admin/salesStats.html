<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/adminLayout}">

<th:block layout:fragment="css">
    <style>
        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
        }

        .stat-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            padding: 6px 0;
        }

        /* 컨트롤 크기 업 */
        .stat-controls .form-control.form-control-sm,
        .stat-controls .form-select.form-select-sm {
            height: 38px;
            padding: 6px 10px;
            font-size: 0.95rem;
        }

        .stat-controls .btn.btn-sm {
            padding: .45rem .7rem;
            font-size: .95rem;
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 14px;
        }

        .cards .card .h2 {
            font-variant-numeric: tabular-nums;
            font-size: 1.6rem;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .table thead th,
        .table td {
            text-align: right
        }

        .table thead th:first-child,
        .table td:first-child {
            text-align: left
        }

        .stat-controls {
            justify-content: space-between;
        }

        /* 헤더 우측 컨트롤이 한 줄로 붙도록(폭 좁을 땐 자연스럽게 줄바꿈) */
        #headerCtrls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* 헤더 내부의 select/btn 높이를 카드 헤더와 맞춤 */
        #headerCtrls .form-select.form-select-sm,
        #headerCtrls .btn.btn-sm {
            height: 34px;
        }

        /* 섹션 헤더 우측 컨트롤: 버튼 줄바꿈 방지 + 최소 너비 보장 */
        #headerCtrls .btn {
            white-space: nowrap;
            /* 글자 줄바꿈 금지 */
            word-break: keep-all;
            /* 한글 단어 쪼개짐 방지 */
            display: inline-flex;
            /* 세로 중앙정렬 */
            align-items: center;
        }

        /* '적용' 버튼 둘 다 동일하게 폭 보장(원하면 값 더 키워도 됨) */
        #btnProdApply,
        #btnBrandApply {
            min-width: 56px;
            /* '적용'이 절대 두 줄로 안 깨짐 */
        }

        /* 혹시 이전에 고정 height로 눌린 경우를 방지 */
        #headerCtrls .btn.btn-sm {
            height: auto;
            /* 높이는 자동 */
            line-height: 1.2;
            /* 가독성 */
            padding: .45rem .7rem;
            /* stat-controls와 톤 맞춤 */
        }

        /* 합계 카드 그리드 전체 폭 차지 */
        .hint-full {
            grid-column: 1 / -1;
        }

        /* 날짜 부분만 작게 */
        .label-date {
            font-size: 0.8em;
            /* 부모 글자보다 작게 */
            color: #666;
            /* 옅은 회색 */
        }

        /* 합계 값 오른쪽 정렬 */
        #revSum,
        #cogsSum,
        #profitSum {
            text-align: right;
        }
    </style>
</th:block>

<div layout:fragment="content" class="container py-3">
    <h2 class="mb-2">매출 통계</h2>
    <!-- <div class="subtle small"></div> -->

    <div class="stat-controls mb-3">
        <!-- 왼쪽: 기존 기간 컨트롤 그대로 -->
        <div class="d-flex align-items-center gap-2 flex-wrap">
            <div class="btn-group" role="group" id="unitTabs">
                <button class="btn btn-outline-secondary btn-sm active" data-unit="DAY">일간</button>
                <button class="btn btn-outline-secondary btn-sm" data-unit="WEEK">주간</button>
                <button class="btn btn-outline-secondary btn-sm" data-unit="MONTH">월간</button>
                <button class="btn btn-outline-secondary btn-sm" data-unit="YEAR">연간</button>
                <button class="btn btn-outline-secondary btn-sm" data-unit="CUSTOM">범위</button>
            </div>

            <div id="pickerArea" class="d-flex align-items-center gap-2">
                <input id="pick-day-date" type="date" class="form-control form-control-sm" style="width: 160px;">
                <input id="pick-week-month" type="month" class="form-control form-control-sm d-none"
                    style="width: 160px;">
                <select id="pick-month-year" class="form-select form-select-sm d-none" style="width: 120px;"></select>
            </div>

            <!-- 기존 pickerArea 아래에 범위 입력 블록 추가 -->
            <div id="rangeArea" class="d-flex align-items-center gap-2 d-none">
                <input id="rangeStart" type="date" class="form-control form-control-sm" style="width:160px;">
                <span>~</span>
                <input id="rangeEnd" type="date" class="form-control form-control-sm" style="width:160px;">
                <button id="btnRangeApply" class="btn btn-primary btn-sm" disabled>적용</button>
            </div>

            <button id="btnSearch" class="btn btn-primary btn-sm">조회</button>
        </div>

        <!-- 오른쪽: 보기 라디오만 -->
        <div class="d-flex align-items-center gap-2 flex-wrap">
            <div class="btn-group" role="group" aria-label="보기">
                <input type="radio" class="btn-check" name="scope" id="scope-all" value="ALL" checked>
                <label class="btn btn-outline-dark btn-sm" for="scope-all">전체</label>

                <input type="radio" class="btn-check" name="scope" id="scope-brand" value="BRAND">
                <label class="btn btn-outline-dark btn-sm" for="scope-brand">브랜드</label>

                <input type="radio" class="btn-check" name="scope" id="scope-product" value="PRODUCT">
                <label class="btn btn-outline-dark btn-sm" for="scope-product">상품</label>
            </div>
        </div>
    </div>


    <!-- 합계 카드: 라벨만 교체 -->
    <div class="cards mb-3">
        <div class="card">
            <div class="card-body">
                <div id="revLabel">매출액 <span class="label-date">(yyyy-MM-dd)</span></div>
                <div id="revSum" class="h2 text-end">0</div>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
                <div id="cogsLabel">매입액 <span class="label-date">(yyyy-MM-dd)</span></div>
                <div id="cogsSum" class="h2 text-end">0</div>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
                <div id="profitLabel">순이익 <span class="label-date">(yyyy-MM-dd)</span></div>
                <div id="profitSum" class="h2 text-end">0</div>
            </div>
        </div>
        <!-- ▼ 힌트 카드(브랜드 미선택 시만 표시) -->
        <div id="brandHint" class="card d-none hint-full">
            <div class="card-body py-2 text-center text-muted small">
                브랜드를 선택하면 이 기간의 합계(매출/매입/순이익)가 표시됩니다.
            </div>
        </div>
        <!-- ▼ 힌트 카드(상품 미선택 시만 표시) -->
        <div id="productHint" class="card d-none hint-full">
            <div class="card-body py-2 text-center text-muted small">
                상품을 선택하면 이 기간의 합계(매출/매입/순이익)가 표시됩니다.
            </div>
        </div>
    </div>

    <section class="card mb-3">
        <div class="card-header h5 mb-0 d-flex align-items-center justify-content-between">
            <span id="seriesTitle">전체 매출 추이 (매출액 / 매입액 / 순이익)</span>

            <!-- 섹션 헤더 우측 컨트롤 -->
            <div id="headerCtrls" class="d-flex align-items-center gap-2 flex-wrap">
                <!-- 상품 스코프일 때 -->
                <div id="scopeProductCtrls" class="d-flex align-items-center gap-2 d-none">
                    <select id="selProdBrand" class="form-select form-select-sm" style="min-width:140px">
                        <option value="">브랜드</option>
                    </select>
                    <select id="selProdCapacity" class="form-select form-select-sm" style="min-width:120px" disabled>
                        <option value="">용량</option>
                    </select>
                    <select id="selProd" class="form-select form-select-sm" style="min-width:220px" disabled>
                        <option value="">상품</option>
                    </select>
                    <button id="btnProdApply" class="btn btn-primary btn-sm" disabled>적용</button>
                </div>

                <!-- 브랜드 스코프일 때 -->
                <div id="scopeBrandCtrls" class="d-flex align-items-center gap-2 d-none">
                    <select id="selBrand" class="form-select form-select-sm" style="min-width:160px">
                        <option value="">브랜드</option>
                    </select>
                    <button id="btnBrandApply" class="btn btn-primary btn-sm" disabled>적용</button>
                </div>
            </div>
        </div>

        <div class="card-body">
            <canvas id="unifiedSeries" height="120"></canvas>
        </div>
    </section>
</div>

<th:block layout:fragment="script">
    <script>
        /* ========= 공통(상단) : 여기 블록은 기존과 동일 ========= */
        const BASE = '/admin/salesStats/api';       // 모든 통계 API의 공통 베이스 경로

        // 색상: 매출액=빨강, 지출액=파랑, 순이익=초록
        const SALES = '#dc2626';   // 매출액 (red-600)
        const EXP = '#2563eb';   // 지출액 (blue-600)
        const PROF = '#16a34a';   // 순이익 (green-600)

        Chart.defaults.locale = 'ko-KR';                // Chart.js의 숫자/날짜 로케일을 한국어로 설정
        const KR = new Intl.NumberFormat('ko-KR'),      // 숫자 포매터(3자리 콤마 등)
            KRW = n => `${KR.format(n ?? 0)}원`;        // 원 단위로 문자열 포맷팅하는 헬퍼

        const STATE = { unit: 'DAY', from: null, to: null, scope: 'ALL', _weekYm: null, mode: 'FIXED', pivotDay: null };           // 현재 선택된 단위/조회기간 상태(전역 공유)

        // 기간 선택기 DOM 참조(일/월/연)
        const $day = document.getElementById('pick-day-date');          // 일간용 date input
        const $wmon = document.getElementById('pick-week-month');       // 주간용 month input(달 선택)
        const $year = document.getElementById('pick-month-year');       // 월간용 year select(연 선택)

        // ▼▼▼ 커스텀 범위 DOM (여기에 추가)
        const $rs = document.getElementById('rangeStart');
        const $re = document.getElementById('rangeEnd');
        const $ra = document.getElementById('btnRangeApply');
        const $rh = document.getElementById('rangeHint');

        // ===== 날짜 유틸(로컬 기준) 및 상수 =====
        const to2 = n => String(n).padStart(2, '0');
        function d2sLocal(d) { // Date -> 'YYYY-MM-DD' (로컬)
            return `${d.getFullYear()}-${to2(d.getMonth() + 1)}-${to2(d.getDate())}`;
        }
        function addDays(s, n) { // 'YYYY-MM-DD' + n일 (로컬)
            const [y, m, d] = s.split('-').map(Number);
            const dt = new Date(y, m - 1, d);
            dt.setDate(dt.getDate() + n);
            return d2sLocal(dt);
        }
        function cmpDate(a, b) { // a,b: 'YYYY-MM-DD' -> -1/0/1
            if (a === b) return 0;
            return a < b ? -1 : 1; // 'YYYY-MM-DD'는 사전식 비교가 가능
        }

        function showBrandHint(show) {
            document.getElementById('brandHint')?.classList.toggle('d-none', !show);
        }

        function showProductHint(show) {
            document.getElementById('productHint')?.classList.toggle('d-none', !show);
        }

        function renderCardsNA() {
            updateCardLabels();           // ← 날짜 라벨을 기본값으로 되돌림
            revSum.textContent = '—';
            cogsSum.textContent = '—';
            profitSum.textContent = '—';
        }

        // 기존 const d2s = ... 는 더 이상 쓰지 않음 (아래에서 d2sLocal 사용)
        const TODAY = d2sLocal(new Date());

        const $btnSearch = document.getElementById('btnSearch');

        // 단위에 따라 보일 입력 컨트롤 전환
        function showPicker(u) {
            const elDay = document.getElementById('pick-day-date');     // type=date
            const elWeek = document.getElementById('pick-week-month');   // type=month
            const elYear = document.getElementById('pick-month-year');   // <select>
            const area = document.getElementById('pickerArea');
            const rArea = document.getElementById('rangeArea');
            const btn = document.getElementById('btnSearch');

            // 모두 숨기고 시작
            elDay.classList.add('d-none');
            elWeek.classList.add('d-none');
            elYear.classList.add('d-none');

            // 범위 기간
            rArea.classList.add('d-none');
            area.classList.remove('d-none');
            btn.classList.add('d-none');

            if (u === 'DAY') elDay.classList.remove('d-none');
            if (u === 'WEEK') elWeek.classList.remove('d-none');
            if (u === 'MONTH') elYear.classList.remove('d-none');
            if (u === 'YEAR') area.classList.add('d-none');                // 입력/조회 모두 숨김
            if (u === 'CUSTOM') { area.classList.add('d-none'); rArea.classList.remove('d-none'); }
        }

        // (initPickers) 안의 date 세팅 부분
        (function initPickers() {
            const today = new Date();
            const TODAY_STR = d2sLocal(today);       // 'YYYY-MM-DD'
            const TODAY_YM = TODAY_STR.slice(0, 7);  // 'YYYY-MM'
            const yNow = today.getFullYear();

            // 각 인풋 참조
            const elDay = document.getElementById('pick-day-date');
            const elWeek = document.getElementById('pick-week-month');
            const elYear = document.getElementById('pick-month-year');

            // === 미래 선택 금지 범위 ===
            elDay.max = TODAY_STR;
            elWeek.max = TODAY_YM;

            // 기본값: 오늘 / 이번달 / 올해
            elDay.value = TODAY_STR;
            elWeek.value = d2sLocal(new Date(yNow, today.getMonth(), 1)).slice(0, 7);

            // 연도 셀렉트(과거5년~올해)
            elYear.innerHTML = '';
            for (let y = yNow - 5; y <= yNow; y++) {
                const o = document.createElement('option');
                o.value = y; o.textContent = y;
                elYear.appendChild(o);
            }
            elYear.value = String(yNow);

            // 기본 단위: DAY (-3~+3)
            applyDayRange(elDay.value);
            showPicker(STATE.unit);   // STATE.unit은 초깃값 'DAY'
        })();

        // 단위별 기간 계산(STATE 업데이트)
        function applyDayRange(d) {                     // 일간: 선택일 기준 -3~+3일
            STATE.unit = 'DAY';
            STATE.pivotDay = d;                    // ✅ 선택한 ‘그 하루’를 상태에 저장
            STATE.from = addDays(d, -3);
            STATE.to = addDays(d, +3);
        }

        // 주간 범위 계산 부분
        function applyWeekRange(ym) {
            const [y, m] = ym.split('-').map(Number);
            STATE.unit = 'WEEK';
            STATE.from = d2sLocal(new Date(y, m - 1, 1)); // 그 달 1일
            STATE.to = d2sLocal(new Date(y, m, 0));     // 그 달 말일
            STATE._weekYm = ym;
        }

        function applyMonthRange(y) {                   // 월간: 해당 연도 1/1 ~ 12/31
            STATE.unit = 'MONTH';
            STATE.from = `${y}-01-01`;
            STATE.to = `${y}-12-31`;
        }

        function applyYearRange() {                     // 연간: 최근 5년(과거→현재)
            const y = new Date().getFullYear();
            STATE.unit = 'YEAR';
            STATE.from = `${y - 4}-01-01`;
            STATE.to = `${y}-12-31`;
        }

        // 문자열 -> Date
        function toDate(s) { const [y, m, d] = s.split('-').map(Number); return new Date(y, m - 1, d); }

        // 커스텀 범위 초기화
        (function initRange() {
            $rs.removeAttribute('min');     // 시작일 하한 제한 없음
            $rs.removeAttribute('max');     // 시작일 상한 제한 없음

            $re.max = TODAY;                // 종료일은 미래 방지
            $re.value = TODAY;
            // 기본: 최근 7일
            const d7 = addDays(TODAY, -6);
            $rs.value = d7;

            validateRange();
        })();

        // 검증(버튼 활성/비활성 + 힌트)
        function validateRange() {
            const s = $rs.value, e = $re.value;
            if (!s || !e) {
                $ra.disabled = true;
                if ($rh){ $rh.textContent = '기간을 선택하세요.'; $rh.classList.remove('text-danger'); $rh.classList.add('text-muted'); }
                return;
            }

            // 미래 방지: 종료일이 오늘을 넘으면 오늘로 보정
            if (cmpDate(e, TODAY) > 0) {
                $re.value = TODAY;
            }

            // 시작 > 종료 방지
            if (cmpDate($re.value, s) < 0) {
                $ra.disabled = true;
                if ($rh){ $rh.textContent = '종료일이 시작일보다 빠릅니다.'; $rh.classList.add('text-danger'); $rh.classList.remove('text-muted'); }
                return;
            }

            // 제한 해제: 일수 제한 없음
            $ra.disabled = false;
            if ($rh){ $rh.textContent = '종료일은 오늘을 넘을 수 없습니다.'; $rh.classList.remove('text-danger'); $rh.classList.add('text-muted'); }
        }

        // 이벤트
        $rs.addEventListener('change', validateRange);
        $re.addEventListener('change', validateRange);

        // 적용
        $ra.addEventListener('click', async () => {
            STATE.mode = 'CUSTOM';
            STATE.unit = 'DAY';
            STATE.from = $rs.value;
            STATE.to = $re.value;
            await reloadUnified();
        });

        // 단위별 그래프 X축 라벨 기대값 생성(결측치를 0으로 채우기 위한 기준)
        function expectedLabels(unit) {
            if (unit === 'DAY') {
                // STATE.from/STATE.to: 'YYYY-MM-DD' → 로컬 Date로 안전하게 생성
                const [fy, fm, fd] = STATE.from.split('-').map(Number);
                const [ty, tm, td] = STATE.to.split('-').map(Number);
                const start = new Date(fy, fm - 1, fd);
                const end = new Date(ty, tm - 1, td);

                const out = [];
                for (let cur = new Date(start); cur <= end; cur.setDate(cur.getDate() + 1)) {
                    out.push(d2sLocal(cur)); // ✅ 로컬 포맷 사용
                }
                return out;
            }

            if (unit === 'WEEK') {                      // 주간: 1~5주 고정 라벨(월 단위 주버킷)
                return ['1주', '2주', '3주', '4주', '5주'];
            }

            if (unit === 'MONTH') {                     // 월간: 1~12월 라벨('YYYY-MM')
                return Array.from({ length: 12 }, (_, i) => `${STATE.from.slice(0, 4)}-${String(i + 1).padStart(2, '0')}`);
            }

            if (unit === 'YEAR') {                      // 연간: 최근 5년 (좌→우: 과거→현재)
                const yTo = +STATE.to.slice(0, 4);
                return Array.from({ length: 5 }, (_, i) => String(yTo - 4 + i));
            }

            return [];
        }

        // 'yyyy-MM-dd'가 해당 월의 몇 번째 주(0~4)에 속하는지 계산(주간 집계를 위해)
        function weekBucket(dateStr) {
            const [y, m, d] = dateStr.split('-').map(Number);
            const first = new Date(y, m - 1, 1);                                // 그 달 1일
            const cur = new Date(y, m - 1, d);                                  // 해당 날짜
            const diff = Math.floor((cur - first) / (1000 * 60 * 60 * 24));     // 1일 단위 차이
            return Math.min(4, Math.floor(diff / 7));                           // 0~4(=1~5주)
        }

        // 서버 rows를 기대 라벨에 맞춰 정규화(결측치는 0 채움, 주간은 5버킷 재집계)
        function normalizeSeries(rows) {
            const m = new Map();
            rows.forEach(r => m.set(String(r.date), {
                revenue: +r.revenue || 0,
                cogs: +r.cogs || 0,
                profit: +r.profit || 0
            }));

            const labels = expectedLabels(STATE.unit);

            if (STATE.unit === 'WEEK') {
                const buckets = Array.from({ length: 5 }, () => ({ revenue: 0, cogs: 0, profit: 0 }));
                for (const [k, v] of m) {
                    const idx = weekBucket(k); // 0~4
                    buckets[idx].revenue += v.revenue;
                    buckets[idx].cogs += v.cogs;
                    buckets[idx].profit += v.profit;
                }
                return {
                    labels,
                    revenue: buckets.map(b => b.revenue),
                    cogs: buckets.map(b => b.cogs),
                    profit: buckets.map(b => b.profit),
                };
            }

            // DAY / MONTH / YEAR
            const revenue = [], cogs = [], profit = [];
            labels.forEach(l => {
                if (STATE.unit === 'DAY' && cmpDate(l, TODAY) > 0) {
                    // 미래 구간 마스킹
                    revenue.push(null); cogs.push(null); profit.push(null);
                } else {
                    const v = m.get(l) || { revenue: 0, cogs: 0, profit: 0 };
                    revenue.push(v.revenue); cogs.push(v.cogs); profit.push(v.profit);
                }
            });

            return { labels, revenue, cogs, profit };
        }

        let unifiedChart;                         // 통합 차트 인스턴스
        const $title = document.getElementById('seriesTitle');
        const $canvas = document.getElementById('unifiedSeries');

        // 우측 라디오/선택 영역
        const scopeRadios = document.querySelectorAll('input[name="scope"]');
        const boxProd = document.getElementById('scopeProductCtrls');
        const boxBrand = document.getElementById('scopeBrandCtrls');
        const selProdBrand = document.getElementById('selProdBrand');
        const selProdCapacity = document.getElementById('selProdCapacity');
        const selProd = document.getElementById('selProd');
        const selBrand = document.getElementById('selBrand');

        // 브랜드 옵션 최초 1회 로드(두 셀렉트 공용)
        async function loadBrandOptionsOnce() {
            const list = await fetch(`${BASE}/brand/options`, { headers: { Accept: 'application/json' } }).then(r => r.json());
            const opts = '<option value="">브랜드</option>' + (list || []).map(b => `<option value="${b.brandNo}">${b.brandName}</option>`).join('');
            selProdBrand.innerHTML = opts;
            selBrand.innerHTML = opts;
        }
        loadBrandOptionsOnce();

        // 상품 선택 체인
        selProdBrand.addEventListener('change', async e => {
            selProdCapacity.disabled = true; selProdCapacity.innerHTML = '<option value="">용량</option>';
            selProd.disabled = true; selProd.innerHTML = '<option value="">상품</option>';
            const bno = e.target.value; if (!bno) return;
            const caps = await fetch(`${BASE}/product/capacities?brandNo=${bno}`, { headers: { Accept: 'application/json' } }).then(r => r.json());
            selProdCapacity.innerHTML = '<option value="">용량</option>' + (caps || []).map(c => `<option>${c}</option>`).join('');
            selProdCapacity.disabled = false;
        });

        selProdCapacity.addEventListener('change', async e => {
            selProd.disabled = true; selProd.innerHTML = '<option value="">상품</option>';
            const bno = selProdBrand.value, cap = e.target.value; if (!bno || !cap) return;
            const prods = await fetch(`${BASE}/product/byBrandCapacity?brandNo=${bno}&capacity=${encodeURIComponent(cap)}`, { headers: { Accept: 'application/json' } }).then(r => r.json());
            selProd.innerHTML = '<option value="">상품</option>' + (prods || []).map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            selProd.disabled = false;
        });

        // 제목 스위치
        function setTitle() {
            if (STATE.scope === 'ALL') $title.textContent = '전체 매출 추이 (매출액 / 매입액 / 순이익)';
            if (STATE.scope === 'PRODUCT') $title.textContent = '상품 매출 추이';
            if (STATE.scope === 'BRAND') $title.textContent = '브랜드 매출 추이';
        }

        // 선택됨 여부 헬퍼
        function hasSelection() {
            if (STATE.scope === 'BRAND') return !!selBrand.value;
            if (STATE.scope === 'PRODUCT') return !!selProd.value;
            return true; // ALL은 항상 선택된 것으로 간주
        }

        // 라벨명 정리
        function updateCardLabels() {
            const isDayFixed = (STATE.unit === 'DAY' && STATE.mode === 'FIXED' && STATE.pivotDay);

            // 날짜는 "일간+고정" 이면서, ALL이거나(=전체) BRAND/PRODUCT는 실제 선택이 있을 때만 노출
            const showDate = isDayFixed && hasSelection();

            document.getElementById('revLabel').innerHTML = showDate ? `매출액 <span class="label-date">(${STATE.pivotDay})</span>` : '매출액';
            document.getElementById('cogsLabel').innerHTML = showDate ? `매입액 <span class="label-date">(${STATE.pivotDay})</span>` : '매입액';
            document.getElementById('profitLabel').innerHTML = showDate ? `순이익 <span class="label-date">(${STATE.pivotDay})</span>` : '순이익';
        }

        // 합계 카드
        function renderCards(s) {
            updateCardLabels(); // ← 라벨 먼저 정리

            const sum = arr => arr.reduce((acc, v) => acc + (typeof v === 'number' ? v : 0), 0);

            // ✅ 일간(FIXED)일 때는 pivotDay(선택한 하루)만 집계
            if (STATE.unit === 'DAY' && STATE.mode === 'FIXED' && STATE.pivotDay) {
                const idx = s.labels.indexOf(STATE.pivotDay);   // normalizeSeries가 만든 라벨 배열에서 해당 날짜 위치
                const r = idx >= 0 && typeof s.revenue[idx] === 'number' ? s.revenue[idx] : 0;
                const c = idx >= 0 && typeof s.cogs[idx] === 'number' ? s.cogs[idx] : 0;
                const p = idx >= 0 && typeof s.profit[idx] === 'number' ? s.profit[idx] : 0;

                revSum.textContent = KRW(r);
                cogsSum.textContent = KRW(c);
                profitSum.textContent = KRW(p);
                return;
            }

            // 그 외(주간/월간/연간, 혹은 CUSTOM 범위)는 현재처럼 구간 합계
            revSum.textContent = KRW(sum(s.revenue));
            cogsSum.textContent = KRW(sum(s.cogs));
            profitSum.textContent = KRW(sum(s.profit));
        }

        function clearChart() {
            if (unifiedChart) { unifiedChart.destroy(); unifiedChart = null; }
            const ctx = $canvas.getContext?.('2d');
            if (ctx) ctx.clearRect(0, 0, $canvas.width, $canvas.height);
        }

        // 통합 차트 렌더
        function renderUnified(datasets, labels) {
            if (unifiedChart) unifiedChart.destroy();
            unifiedChart = new Chart($canvas, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${KRW(ctx.parsed.y || 0)}` } } },
                    scales: {
                        x: { ticks: { maxTicksLimit: 14 } },
                        y: { beginAtZero: true, ticks: { callback: v => KR.format(v) } }
                    }
                }
            });
        }

        // scope=ALL 데이터 로드/렌더
        async function drawAll() {
            const rows = await fetch(`${BASE}/series?from=${STATE.from}&to=${STATE.to}&unit=${STATE.unit}`, { headers: { Accept: 'application/json' } }).then(r => r.json());
            const s = normalizeSeries(rows);
            showProductHint(false);
            showBrandHint(false);
            renderCards(s);
            renderUnified([
                { label: '매출액 (원)', data: s.revenue, borderColor: SALES, backgroundColor: SALES, borderWidth: 2, pointRadius: 2, tension: 0, fill: false },
                { label: '매입액 (원)', data: s.cogs, borderColor: EXP, backgroundColor: EXP, borderWidth: 2, pointRadius: 2, tension: 0, fill: false },
                { label: '순이익 (원)', data: s.profit, borderColor: PROF, backgroundColor: PROF, borderWidth: 2, pointRadius: 2, tension: 0, fill: false }
            ], s.labels);
        }

        // scope=PRODUCT
        async function drawProduct() {
            const pid = selProd.value;
            // ▼ 상품 미선택: 차트 비우고 힌트/대시 표시
            if (!pid) {
                clearChart();                 // ← 축/그리드도 제거
                renderCardsNA();
                showProductHint(true);
                showBrandHint(false);
                return;
            }

            // ▼ 선택됨: 힌트 숨기고 정상 렌더
            showProductHint(false);
            showBrandHint(false);

            const u = new URL(`${location.origin}${BASE}/product/series`);
            u.searchParams.set('productId', pid);
            u.searchParams.set('from', STATE.from);
            u.searchParams.set('to', STATE.to);
            u.searchParams.set('unit', STATE.unit);
            const rows = await fetch(u, { headers: { Accept: 'application/json' } }).then(r => r.json());
            const s = normalizeSeries(rows);
            renderCards(s);
            renderUnified([
                { label: '매출액 (원)', data: s.revenue, borderColor: SALES, backgroundColor: SALES, borderWidth: 2, pointRadius: 2, tension: 0, fill: false },
                { label: '매입액 (원)', data: s.cogs, borderColor: EXP, backgroundColor: EXP, borderWidth: 2, pointRadius: 2, tension: 0, fill: false },
                { label: '순이익 (원)', data: s.profit, borderColor: PROF, backgroundColor: PROF, borderWidth: 2, pointRadius: 2, tension: 0, fill: false }
            ], s.labels);
        }

        // scope=BRAND
        async function drawBrand() {
            const bno = selBrand.value;

            // ▼ 브랜드 미선택: 차트 비우고 힌트/대시 표시
            if (!bno) {
                clearChart();                 // ← 축/그리드도 제거
                renderCardsNA();
                showBrandHint(true);
                showProductHint(false);
                return;
            }

            // ▼ 선택됨: 힌트 숨기고 정상 렌더
            showBrandHint(false);
            showProductHint(false);

            const u = new URL(`${location.origin}${BASE}/brand/series`);
            u.searchParams.set('brandNo', bno);
            u.searchParams.set('from', STATE.from);
            u.searchParams.set('to', STATE.to);
            u.searchParams.set('unit', STATE.unit);
            const rows = await fetch(u, { headers: { Accept: 'application/json' } }).then(r => r.json());
            const s = normalizeSeries(rows);
            renderCards(s);
            renderUnified([
                { label: '매출액 (원)', data: s.revenue, borderColor: SALES, backgroundColor: SALES, borderWidth: 2, pointRadius: 2, tension: 0, fill: false },
                { label: '매입액 (원)', data: s.cogs, borderColor: EXP, backgroundColor: EXP, borderWidth: 2, pointRadius: 2, tension: 0, fill: false },
                { label: '순이익 (원)', data: s.profit, borderColor: PROF, backgroundColor: PROF, borderWidth: 2, pointRadius: 2, tension: 0, fill: false }
            ], s.labels);
        }

        // 라디오 전환 시 UI 토글 + 재로드
        scopeRadios.forEach(r => {
            r.addEventListener('change', async e => {
                STATE.scope = e.target.value;     // ALL | PRODUCT | BRAND
                setTitle();
                boxProd.classList.toggle('d-none', STATE.scope !== 'PRODUCT');
                boxBrand.classList.toggle('d-none', STATE.scope !== 'BRAND');
                await reloadUnified();
            });
        });

        // 통합 리로더(기간/단위 변경, 조회버튼, 라디오 변경 모두 이 함수 호출)
        async function reloadUnified() {
            if (STATE.scope === 'ALL') return drawAll();
            if (STATE.scope === 'PRODUCT') return drawProduct();
            if (STATE.scope === 'BRAND') return drawBrand();
        }

        // === 기존 unit 탭/피커/조회 버튼 이벤트는 그대로 두되, 마지막 호출을 reloadUnified로만 바꿔주면 된다 ===
        document.querySelectorAll('#unitTabs [data-unit]').forEach(btn => {
            btn.addEventListener('click', e => {
                document.querySelectorAll('#unitTabs [data-unit]').forEach(b => b.classList.remove('active'));
                e.currentTarget.classList.add('active');

                const u = e.currentTarget.dataset.unit;
                showPicker(u);

                // CUSTOM 모드: 적용 버튼으로만 조회
                if (u === 'CUSTOM') {
                    STATE.mode = 'CUSTOM';
                    STATE.unit = 'DAY';      // 일간 집계 사용
                    validateRange();       // ← 버튼 상태/힌트 반영
                    return;                  // 여기서 종료(자동 조회 금지)
                }

                // FIXED 모드
                STATE.mode = 'FIXED';
                STATE.unit = u;

                const elDay = document.getElementById('pick-day-date');
                const elWeek = document.getElementById('pick-week-month');
                const elYear = document.getElementById('pick-month-year');

                const TODAY_STR = TODAY;
                const TODAY_YM = TODAY.slice(0, 7);
                const yNow = new Date().getFullYear();

                if (u === 'DAY') {
                    if (cmpDate(elDay.value || '0000-00-00', TODAY_STR) > 0) elDay.value = TODAY_STR;
                    applyDayRange(elDay.value);
                } else if (u === 'WEEK') {
                    if (cmpYm(elWeek.value || '0000-00', TODAY_YM) > 0) elWeek.value = TODAY_YM;
                    applyWeekRange(elWeek.value);
                } else if (u === 'MONTH') {
                    if ((+elYear.value || 0) > yNow) elYear.value = String(yNow);
                    applyMonthRange(elYear.value);
                } else if (u === 'YEAR') {
                    applyYearRange();
                }

                reloadUnified();
            });
        });


        // 'YYYY-MM' 비교 유틸
        function cmpYm(a, b) { if (a === b) return 0; return a < b ? -1 : 1; }

        // 일간(date)
        document.getElementById('pick-day-date').addEventListener('change', e => {
            const v = e.target.value;
            if (cmpDate(v, TODAY) > 0) e.target.value = TODAY;   // 미래 방지
            if (STATE.unit === 'DAY') { applyDayRange(e.target.value); reloadUnified(); }
        });

        // 주간(month)
        document.getElementById('pick-week-month').addEventListener('change', e => {
            const ym = e.target.value, TODAY_YM = TODAY.slice(0, 7);
            if (cmpYm(ym, TODAY_YM) > 0) e.target.value = TODAY_YM;  // 미래 방지
            if (STATE.unit === 'WEEK') { applyWeekRange(e.target.value); reloadUnified(); }
        });

        // 월간(year)
        document.getElementById('pick-month-year').addEventListener('change', e => {
            const yNow = new Date().getFullYear();
            if (+e.target.value > yNow) e.target.value = String(yNow); // 미래 방지
            if (STATE.unit === 'MONTH') { applyMonthRange(e.target.value); reloadUnified(); }
        });

        document.getElementById('btnSearch').addEventListener('click', reloadUnified);

        // ✅ 적용 버튼 참조
        const btnProdApply = document.getElementById('btnProdApply');
        const btnBrandApply = document.getElementById('btnBrandApply');

        // ✅ 선택값에 따라 버튼 활성화
        selProd.addEventListener('change', () => {
            btnProdApply.disabled = !selProd.value;
        });
        selBrand.addEventListener('change', () => {
            btnBrandApply.disabled = !selBrand.value;
        });

        // ✅ 적용 버튼 클릭 시에만 그래프 갱신
        btnProdApply.addEventListener('click', reloadUnified);
        btnBrandApply.addEventListener('click', reloadUnified);

        // 초기 세팅
        (function init() {
            // 기존 초기화 코드(피커 today 세팅 등) 그대로 유지한다고 가정
            setTitle();
            reloadUnified();
        })();
    </script>

</th:block>

</html>