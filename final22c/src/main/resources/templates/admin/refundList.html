<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{/layout/adminLayout}">
<th:block layout:fragment="css">
    <style>
        /* 모달은 기본 스크롤만 유지 */
        #refundModal .modal-body {
            overflow-y: auto;
        }

        /* 환불 목록 헤더: 화면을 따라다니지 않음(= sticky 해제) */
        #refundItemsHeader {
            position: static !important;
            top: auto !important;
            z-index: auto !important;
            /* 배경/테두리는 기존 클래스(bg-light, border, rounded)로 처리 */
        }

        /* (유지) 숫자/상품명 스타일 */
        .subtotal,
        .h4,
        .h5,
        .h6 {
            font-variant-numeric: tabular-nums;
        }

        .name {
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
    </style>
</th:block>
<div layout:fragment="content" class="container">
    <h2>환불내역</h2>
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-table me-1"></i>
            환불리스트
        </div>
        <div class="card-body">
            <table id="datatablesSimple">
                <thead>
                    <tr>
                        <th scope="col">구분</th>
                        <th scope="col">요청자ID</th>
                        <th scope="col">주문번호</th>
                        <th scope="col">환불신청날짜</th>
                        <th scope="col">상태</th>
                        <th scope="col">환급금</th>
                        <th scope="col">환불처리날짜</th>
                        <th scope="col">관리</th>
                    </tr>
                </thead>
                <tbody id="refundList">
                    <tr th:each="list : ${refundList}" th:fragment="productRow">
                        <td th:text="${list.refundId}"></td>
                        <td th:text="${list.user.userName}"></td>
                        <td th:text="${list.order.orderId}"></td>
                        <td th:text="${#temporals.format(list.createDate, 'yyyy-MM-dd HH:mm')}"></td>
                        <td>
                            <span th:if="${list.status == 'REQUESTED'}" class="text-danger fw-semibold">환불 요청</span>
                            <span th:if="${list.status == 'REFUNDED'}" class="text-success fw-semibold">환불 완료</span>
                        </td>
                        <td>
                            <span th:if="${list.totalRefundAmount == 0}"> - </span>
                            <span th:if="${list.totalRefundAmount != 0}"
                                th:text="${#numbers.formatInteger(list.totalRefundAmount, 3, 'COMMA')}"></span>
                        </td>
                        <td>
                            <span th:if="${list.status == 'REQUESTED'}"> - </span>
                            <span th:if="${list.status == 'REFUNDED'}"
                                th:text="${#temporals.format(list.updateDate, 'yyyy-MM-dd HH:mm')}"></span>
                        </td>
                        <td>
                            <!-- REQUESTED : 승인용 모달 -->
                            <button type="button" class="btn btn-sm btn-outline-secondary btnRefundShow"
                                th:if="${list.status == 'REQUESTED'}"
                                th:data-refund-id="${list.refundId}">상세내역보기</button>
                            <!-- REFUNDED : 결과 모달 -->
                            <button type="button" class="btn btn-sm btn-outline-secondary btnRefundResult"
                                th:if="${list.status == 'REFUNDED'}"
                                th:data-refund-id="${list.refundId}">환불처리결과</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 상세내역보기 버튼을 클릭했을 때, 출력되는 모달창 Refund Detail Modal -->
    <div class="modal fade" id="refundModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">환불 상세</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
                </div>

                <div class="modal-body">
                    <!-- 헤더: 신청자/주문번호/신청일/사유 -->
                    <section id="refundHeader" class="mb-3">
                        <div class="d-flex flex-wrap gap-3 small text-muted">
                            <div><strong>요청자</strong> <span id="hdrUserName"></span></div>
                            <div><strong>주문번호</strong> <span id="hdrOrderId"></span></div>
                            <div class="ms-auto"><strong>신청일시</strong> <span id="hdrCreatedAt"></span></div>
                        </div>
                        <div class="mt-2">
                            <div class="fw-semibold">환불 사유</div>
                            <div id="hdrReason" class="border rounded p-2 bg-light" style="white-space: pre-line;">
                            </div>
                        </div>
                    </section>

                    <!-- (NEW) 승인 요약 -->
                    <section id="approveSummary" class="mt-2">
                        <div class="row row-cols-2 row-cols-md-5 g-3 text-center">
                            <div>
                                <div class="small text-muted">요청수량</div>
                                <div class="h6 m-0" id="apReqQty">0</div>
                            </div>
                            <div>
                                <div class="small text-muted">승인수량</div>
                                <div class="h6 m-0" id="apApprovedQty">0</div>
                            </div>
                            <div>
                                <div class="small text-muted">상품 소계</div>
                                <div class="h6 m-0" id="apItemsSubtotal">0원</div>
                            </div>
                            <div>
                                <div class="small text-muted">배송비</div>
                                <div class="h6 m-0" id="apShipping">0원</div>
                            </div>
                            <div>
                                <div class="small text-muted">사용 마일리지</div>
                                <div class="h6 m-0" id="apUsedPoint">0P</div>
                            </div>
                        </div>
                        <hr class="my-2">
                    </section>

                    <section id="refundItemsHeader"
                        class="d-flex justify-content-between align-items-center small bg-light rounded border px-2 py-2 mt-3 mb-2">
                        <div class="fw-semibold">환불 요청 목록</div>
                        <!-- 오른쪽 요약이 싫으면 이 <div>는 지워도 됨 -->
                        <div class="text-muted">
                            <span id="itemsCount">0</span>건 · 승인 <span id="approvedQty">0</span>/<span
                                id="itemsQty">0</span>
                        </div>
                    </section>
                    <!-- 상세 라인들 -->
                    <section id="refundItems"></section>

                    <!-- 라인 템플릿 -->
                    <template id="refundItemRow">
                        <div class="refund-item d-flex align-items-center py-2 border-bottom" data-refund-detail-id=""
                            data-quantity="" data-refund-qty="">
                            <img class="rounded me-3" src="" alt="" style="width:64px;height:64px;object-fit:cover">
                            <div class="flex-grow-1">
                                <div class="fw-semibold name"></div>
                                <div class="small text-muted">단가 <span class="unit"></span> · 요청수량 <span
                                        class="requested"></span></div>
                            </div>
                            <!-- ▶ 수량 버튼 + 그 아래 금액(소계) -->
                            <div class="d-flex flex-column align-items-center ms-3 qty-col">
                                <div class="d-flex align-items-center">
                                    <button type="button" class="btn btn-outline-secondary btn-sm btnMinus">−</button>
                                    <input type="text" class="form-control form-control-sm mx-1 qtyInput text-center"
                                        style="width:64px" inputmode="numeric" aria-label="승인 수량">
                                    <button type="button" class="btn btn-outline-secondary btn-sm btnPlus">＋</button>
                                </div>
                                <div class="mt-1 fw-semibold subtotal text-center">0원</div>
                            </div>
                        </div>
                    </template>


                    <!-- 하단 합계 요약 -->
                    <div class="refund-summary bg-light rounded p-3 mt-3">
                        <div class="d-flex justify-content-between align-items-center small text-muted">
                            <span>상품 환불 합계</span>
                            <strong id="sumProductRefund">0원</strong>
                        </div>

                        <div class="d-flex justify-content-between align-items-center small text-muted mt-1">
                            <span>배송비 환급</span>
                            <strong id="sumShippingRefund">0원</strong>
                        </div>

                        <hr class="my-2">

                        <div class="d-flex justify-content-between align-items-center fs-5">
                            <span class="fw-semibold">최종 환불 금액</span>
                            <strong id="sumFinalRefund">0원</strong>
                        </div>

                        <!-- 사용 포인트 환급: 사용 이력이 없으면 숨김 -->
                        <div id="rowRefundMileage" class="d-flex justify-content-between small text-muted mt-2 d-none">
                            <span>환급 마일리지</span><strong id="sumRefundMileage">0P</strong>
                        </div>
                    </div>

                    <!-- 거절 사유 -->
                    <div id="rejectReasonWrap" class="mt-3 d-none">
                        <label for="rejectReason" class="form-label">거절 사유</label>
                        <textarea id="rejectReason" class="form-control" rows="3" placeholder="사유를 입력하세요"></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
                    <button class="btn btn-primary" id="btnRefundApprove">승인</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 결과 모달(읽기 전용) -->
    <div class="modal fade" id="refundResultModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">환불 처리 결과</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
                </div>

                <div class="modal-body">
                    <!-- 헤더 -->
                    <section class="mb-3">
                        <div class="d-flex flex-wrap gap-3 small text-muted">
                            <div><strong>요청자</strong> <span id="resUserName"></span></div>
                            <div><strong>주문번호</strong> <span id="resOrderId"></span></div>
                            <div class="ms-auto"><strong>신청일시</strong> <span id="resCreatedAt"></span></div>
                        </div>
                        <div class="mt-2">
                            <div class="fw-semibold">환불 사유</div>
                            <div id="resUserReason" class="border rounded p-2 bg-light" style="white-space:pre-line;">
                            </div>
                        </div>
                    </section>

                    <!-- 처리 요약 -->
                    <section class="mt-2">
                        <div class="row row-cols-2 row-cols-md-6 g-3 text-center">
                            <div>
                                <div class="small text-muted">요청수량</div>
                                <div class="h6 m-0" id="sumRequestedQty">0</div>
                            </div>
                            <div>
                                <div class="small text-muted">승인수량</div>
                                <div class="h6 m-0" id="sumApprovedQty">0</div>
                            </div>
                            <div>
                                <div class="small text-muted">상품 소계</div>
                                <div class="h6 m-0" id="sumItems">0원</div>
                            </div>
                            <div>
                                <div class="small text-muted">배송비 환급</div>
                                <div class="h6 m-0" id="sumShipping">0원</div>
                            </div>
                            <div>
                                <div class="small text-muted">거절수량</div>
                                <div class="h6 m-0" id="sumRejectedQty">0</div>
                            </div>
                            <!-- ▼ 신규 -->
                            <div>
                                <div class="small text-muted">환급 마일리지</div>
                                <div class="h6 m-0" id="resRefundMileage">0P</div>
                            </div>
                            <!-- ▲ 신규 -->
                        </div>
                        <hr class="my-2">
                    </section>

                    <!-- 항목별 결과 -->
                    <section class="mt-3">
                        <div
                            class="d-flex justify-content-between align-items-center small bg-light rounded border px-2 py-2">
                            <div class="fw-semibold">항목별 처리 결과</div>
                            <div class="text-muted"><span id="resItemsCount">0</span>건</div>
                        </div>
                        <div id="resItems" class="mt-2"></div>

                        <template id="resItemRow">
                            <div class="d-flex align-items-center py-2 border-bottom">
                                <img class="rounded me-3" src="" alt="" style="width:56px;height:56px;object-fit:cover">
                                <div class="flex-grow-1">
                                    <div class="fw-semibold name"></div>
                                    <div class="small text-muted">
                                        단가 <span class="unit"></span> · 환불요청 <span class="requested"></span> · 환불승인
                                        <span class="approved"></span>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <div class="fw-semibold subtotal">0원</div>
                                </div>
                            </div>
                        </template>
                    </section>

                    <!-- 하단 합계 -->
                    <section id="resFooterSum" class="mt-3">
                        <div class="p-3 bg-light rounded">
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">상품 환불 합계</span>
                                <span id="footItemsSum" class="fw-semibold">0원</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">배송비 환급</span>
                                <span id="footShipping" class="fw-semibold">0원</span>
                            </div>
                            <hr class="my-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="fw-semibold">최종 환급 금액</div>
                                <div class="h5 m-0" id="footTotal">0원</div>
                            </div>

                            <!-- ▼▼ 여기 추가: 환급/적립 마일리지 -->
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">환급 마일리지</span>
                                <span id="footRefundMileage" class="fw-semibold">0P</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">적립 마일리지</span>
                                <span id="footConfirmMileage" class="fw-semibold">0P</span>
                            </div>
                            <!-- ▲▲ 추가 끝 -->

                            <div class="small text-muted mt-1">
                                처리일시: <span id="footProcessedAt"></span>
                            </div>
                        </div>
                    </section>

                    <!-- (NEW) 공통 거절 사유: 부분 감액이 있고 사유가 있을 때만 보여줌 -->
                    <section id="resGlobalRejectionSec" class="mt-3 d-none">
                        <div class="fw-semibold">거절 사유</div>
                        <div id="resGlobalRejection" class="border rounded p-2 bg-light" style="white-space: pre-line;">
                        </div>
                    </section>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="script">
    <!-- 전역 유틸: 통화/경로 -->
    <script>
        window.__fmtKR = new Intl.NumberFormat('ko-KR');
        window.won = (n) => `${window.__fmtKR.format(n ?? 0)}원`;
        window.pt = (n) => `${window.__fmtKR.format(Number.isFinite(n) ? n : 0)}P`;
        window.joinPath = (a, b) => {
            if (!a) return b ?? '';
            if (!b) return a ?? '';
            return a.endsWith('/') ? a + b : a + '/' + b;
        };
    </script>

    <script>
        (() => {
            // 프로젝트 환경에 맞게 조정
            const ENDPOINT_DETAIL = (refundId) => `/refund/${refundId}`;                // GET
            const ENDPOINT_APPROVE = (refundId) => `/refund/${refundId}/approve`;       // POST

            // // CSRF (Spring Security 사용 시)
            // const CSRF_TOKEN = document.querySelector('meta[name="_csrf"]')?.content;
            // const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.content;

            const modalEl = document.getElementById('refundModal');
            const itemsWrap = document.getElementById('refundItems');
            const rowTpl = document.getElementById('refundItemRow');

            const MILEAGE_RATE = 0.05; // 적립률(서버와 동일하게)
            const els = {
                sumProductRefund: document.getElementById('sumProductRefund'),
                sumShippingRefund: document.getElementById('sumShippingRefund'),
                sumFinalRefund: document.getElementById('sumFinalRefund'),
                sumRefundMileage: document.getElementById('sumRefundMileage'),  // 옵션
            };
            const rejectWrap = document.getElementById('rejectReasonWrap');
            const rejectTextarea = document.getElementById('rejectReason');

            let currentRefundId = null;
            let headerCache = null; // userName, orderId, createdAt, reason
            let itemsCache = [];    // [{refundDetailId, unitRefundAmount, quantity, refundQty, product{...}}]

            // 리스트 버튼 클릭 → 모달 오픈
            document.addEventListener('click', async (e) => {
                const btn = e.target.closest('.btnRefundShow');
                if (!btn) return;

                const refundId = btn.dataset.refundId;
                currentRefundId = refundId;
                await openRefundModal(currentRefundId);
            });

            // 모달 열기 + 데이터 로드
            async function openRefundModal(refundId) {
                // 1) 상세 조회(JSON) 응답 스펙 예시
                // {
                //   header: { userName, orderId, createdAt, reason, status, paymentTid },
                //   items: [
                //     { refundDetailId, unitRefundAmount, quantity, refundQty, product:{id,name,imgPath,imgName} }
                //   ]
                // }
                const res = await fetch(ENDPOINT_DETAIL(refundId), { headers: { 'Accept': 'application/json' } });
                if (!res.ok) { alert('상세 조회 중 오류가 발생했습니다.'); return; }
                const data = await res.json();

                // 방어: 응답 형태 확인
                if (!data || !data.header || !Array.isArray(data.items)) {
                    console.warn('Unexpected response', data);
                    alert('상세 데이터가 올바르지 않습니다.');
                    return;
                }

                headerCache = data.header;
                const isRequested = headerCache.status === 'REQUESTED';

                itemsCache = data.items.map(it => {
                    // 승인수량 초기값 결정 로직
                    const initial =
                        (isRequested && (!it.refundQty || it.refundQty === 0))
                            ? it.quantity
                            : (it.refundQty ?? it.quantity);
                    return { ...it, refundQty: initial };
                });

                renderHeader(headerCache);
                renderItems(itemsCache);
                updateItemsHeader();   // 렌더 직후
                calcAll();

                // Bootstrap 5 모달 표시
                const bsModal = bootstrap.Modal.getOrCreateInstance(modalEl);
                bsModal.show();
            }

            function renderHeader(h) {
                document.getElementById('hdrUserName').textContent = h.userName ?? '';
                document.getElementById('hdrOrderId').textContent = h.orderId ?? '';
                document.getElementById('hdrCreatedAt').textContent = h.createdAt ?? '';
                const reasonEl = document.getElementById('hdrReason');
                reasonEl.textContent = h.reason ?? '';   // XSS 안전
                reasonEl.style.whiteSpace = 'pre-line';  // (CSS를 따로 못 넣는다면 JS로 지정)
            }

            function renderItems(items) {
                itemsWrap.innerHTML = '';
                items.forEach((it, idx) => {
                    const $ = rowTpl.content.firstElementChild.cloneNode(true);

                    $.dataset.refundDetailId = it.refundDetailId;
                    $.dataset.quantity = String(it.quantity ?? 0);
                    $.dataset.refundQty = String(it.refundQty ?? 0);

                    const img = $.querySelector('img');
                    img.src = joinPath(it.product?.imgPath, it.product?.imgName);
                    img.alt = it.product?.name ?? '상품';

                    $.querySelector('.name').textContent = it.product?.name ?? '';
                    $.querySelector('.unit').textContent = won(it.unitRefundAmount ?? 0);
                    $.querySelector('.requested').textContent = (it.quantity ?? 0).toLocaleString();

                    const qtyInput = $.querySelector('.qtyInput');
                    qtyInput.value = it.refundQty ?? 0;

                    // 버튼 핸들러
                    $.querySelector('.btnMinus').addEventListener('click', () => changeQty($, -1));
                    $.querySelector('.btnPlus').addEventListener('click', () => changeQty($, +1));

                    qtyInput.addEventListener('input', () => {
                        // 숫자만, 범위 0..quantity
                        let v = qtyInput.value.replace(/[^\d]/g, '');
                        if (v === '') v = '0';
                        const max = Number($.dataset.quantity);
                        v = Math.min(max, Math.max(0, Number(v)));
                        qtyInput.value = String(v);
                        $.dataset.refundQty = String(v);
                        updateRowSubtotal($, it.unitRefundAmount ?? 0);
                        calcAll();
                    });

                    updateRowSubtotal($, it.unitRefundAmount ?? 0);
                    itemsWrap.appendChild($);
                });
            }

            function changeQty(rowEl, delta) {
                const max = Number(rowEl.dataset.quantity);
                const cur = Number(rowEl.dataset.refundQty);
                const next = Math.min(max, Math.max(0, cur + delta));
                rowEl.dataset.refundQty = String(next);
                rowEl.querySelector('.qtyInput').value = String(next);

                // 단가는 rowEl에서 못 읽으니 cache에서 찾아서 적용
                const id = Number(rowEl.dataset.refundDetailId);
                const it = itemsCache.find(x => Number(x.refundDetailId) === id);
                if (it) updateRowSubtotal(rowEl, it.unitRefundAmount ?? 0);

                calcAll();
            }

            function updateRowSubtotal(rowEl, unit) {
                const qty = Number(rowEl.dataset.refundQty);
                rowEl.querySelector('.subtotal').textContent = won((unit ?? 0) * qty);

                // 요청수량보다 줄이면 강조
                const requested = Number(rowEl.dataset.quantity);
                rowEl.classList.toggle('text-danger', qty < requested);
            }

            function calcAll() {
                let total = 0;
                let anyReduced = false;

                // 라인 합산
                itemsCache.forEach(it => {
                    const row = itemsWrap.querySelector(`.refund-item[data-refund-detail-id="${it.refundDetailId}"]`);
                    const qty = Number(row?.dataset?.refundQty ?? it.refundQty ?? 0);
                    it.refundQty = qty;
                    total += (it.unitRefundAmount ?? 0) * qty;
                    if (qty < (it.quantity ?? 0)) anyReduced = true;
                });

                // 승인 수량 / 배송비 환급
                const approved = itemsCache.reduce((s, it) => s + (it.refundQty || 0), 0);
                const shipping = approved > 0 ? 3000 : 0;

                // 사용 포인트 전액 환급 규칙
                const orderUsedPoint = Number(headerCache?.usedPoint ?? 0);
                const refundMileage = (approved > 0 && orderUsedPoint > 0) ? orderUsedPoint : 0;

                // 최종 환불 금액 = 상품 환불 합계 + 배송비 환급 - 환급 마일리지
                const finalCashRefund = Math.max(0, total + shipping - refundMileage);

                // 하단 요약 갱신
                if (els.sumProductRefund) els.sumProductRefund.textContent = won(total);
                if (els.sumShippingRefund) els.sumShippingRefund.textContent = won(shipping);
                if (els.sumFinalRefund) els.sumFinalRefund.textContent = won(finalCashRefund);

                // 환급 마일리지 표시/숨김
                const rowRefund = document.getElementById('rowRefundMileage');
                const elRefund = document.getElementById('sumRefundMileage');
                if (rowRefund) rowRefund.classList.toggle('d-none', refundMileage <= 0);
                if (elRefund) elRefund.textContent = pt(refundMileage);

                // 거절 사유 노출
                rejectWrap.classList.toggle('d-none', !anyReduced);
                if (!anyReduced) rejectTextarea.value = '';

                // 상단 요약 갱신
                const reqSum = itemsCache.reduce((s, it) => s + (it.quantity || 0), 0);
                setTextSafe('apReqQty', reqSum.toLocaleString());
                setTextSafe('apApprovedQty', approved.toLocaleString());
                setTextSafe('apItemsSubtotal', won(total));
                setTextSafe('apShipping', won(shipping));
                setTextSafe('apUsedPoint', pt(orderUsedPoint));

                // 헤더 우측 승인 n/m
                const approvedEl = document.getElementById('approvedQty');
                if (approvedEl) approvedEl.textContent = approved.toLocaleString();
            }

            function updateItemsHeader() {
                const itemsCount = itemsCache.length;
                const totalRequested = itemsCache.reduce((s, it) => s + (it.quantity || 0), 0);
                const cntEl = document.getElementById('itemsCount');
                const qtyEl = document.getElementById('itemsQty');
                if (cntEl) cntEl.textContent = itemsCount;
                if (qtyEl) qtyEl.textContent = totalRequested.toLocaleString();
            }

            function setTextSafe(id, v) {
                const el = document.getElementById(id);
                if (el) el.textContent = v ?? '';
            }

            // 승인 버튼
            document.getElementById('btnRefundApprove').addEventListener('click', async () => {
                const anyReduced = itemsCache.some(it => (it.refundQty ?? 0) < (it.quantity ?? 0));
                if (anyReduced && !rejectTextarea.value.trim()) {
                    alert('거절 사유를 입력해 주세요.');
                    rejectTextarea.focus();
                    return;
                }

                const payload = {
                    refundId: currentRefundId,
                    items: itemsCache.map(it => ({
                        refundDetailId: it.refundDetailId,
                        refundQty: it.refundQty
                    })),
                    rejectionReason: anyReduced ? rejectTextarea.value.trim() : null
                };

                // const headers = { 'Content-Type': 'application/json' };
                // if (CSRF_TOKEN && CSRF_HEADER) headers[CSRF_HEADER] = CSRF_TOKEN;

                const res = await fetch(ENDPOINT_APPROVE(currentRefundId), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    alert('환불 승인 처리 완료');
                    bootstrap.Modal.getInstance(modalEl).hide();
                    location.reload();
                } else {
                    const msg = (await res.json().catch(() => ({}))).message ?? '승인 처리 중 오류가 발생했습니다.';
                    alert(msg);
                }
            });
        })();
    </script>


    <!-- 결과 모달 스크립트 -->
    <script>
        (() => {
            const ENDPOINT_RESULT = (refundId) => `/refund/${refundId}/result`;  // GET
            const resModalEl = document.getElementById('refundResultModal');

            // 리스트에서 "환불처리결과" 버튼 클릭
            document.addEventListener('click', async (e) => {
                const btn = e.target.closest('.btnRefundResult');
                if (!btn) return;
                await openRefundResultModal(btn.dataset.refundId);
            });

            async function openRefundResultModal(refundId) {
                const res = await fetch(ENDPOINT_RESULT(refundId), { headers: { 'Accept': 'application/json' } });
                if (!res.ok) { alert('결과 조회 중 오류가 발생했습니다.'); return; }
                const data = await res.json();

                renderResultHeader(data.header || {});
                renderResultSummary(data.summary || {}, data.header || {});
                renderResultItems(data.items || []);
                renderGlobalRejection(data, data.items || []);
                renderResultFooter(data.summary || {}, data.items || [], data.header || {});

                bootstrap.Modal.getOrCreateInstance(resModalEl).show();
            }

            // === 렌더러 ===
            function renderResultHeader(h) {
                setText('resUserName', h.userName);
                setText('resOrderId', h.orderId);
                setText('resCreatedAt', h.createdAt);
                document.getElementById('resUserReason').textContent = h.userReason ?? '';
            }

            function renderResultSummary(s, h = {}) {
                const num = (v, d = 0) => (v == null || v === '' || isNaN(Number(v))) ? d : Number(v);

                const req = num(s.requestedQty, 0);
                const appr = num(s.approvedQty, 0);

                // 서버가 주는 값(있으면 우선 사용) — 단, 0도 값으로 간주하되 아래에서 불일치 시 보정
                let items = (s.itemsSubtotal ?? s.itemSubtotal);
                items = (items == null ? null : num(items));

                let total = (s.totalRefundAmount != null ? num(s.totalRefundAmount) : null);

                let shipping = (s.shippingRefund != null ? num(s.shippingRefund)
                    : (s.shipping != null ? num(s.shipping) : null));

                // 사용 마일리지(차감분) – 요약에 없으면 헤더에서라도 끌어올 준비
                const usedPoint = num(s.usedPoint ?? h.usedPoint ?? 0);

                // 1) 총액·상품소계가 둘 다 있으면, 계산상 배송비 = 총액 - 상품소계
                if (total != null && items != null) {
                    const derivedRaw = total - items + usedPoint;
                    let derived = Math.max(0, derivedRaw);
                    // ▶ 정책 강제: 승인수량>0 이고 역산값이 0이면 3,000으로 보정
                    if (appr > 0 && derived === 0) derived = 3000;
                    if (shipping == null || shipping !== derived) shipping = derived;
                }

                // 2) 여전히 shipping이 null이면 정책으로 보정
                if (shipping == null) {
                    // 정책: 승인수량 > 0 이면 3,000
                    shipping = (appr > 0 ? 3000 : 0);
                }

                // 3) items가 비어있다면 역산
                if (items == null) {
                    items = Math.max(0, (total != null ? total : 0) - shipping - usedPoint);
                }

                // 4) total이 비어있다면 합으로 산출
                if (total == null) {
                    total = items - usedPoint + shipping;
                }

                setText('sumRequestedQty', req.toLocaleString());
                setText('sumApprovedQty', appr.toLocaleString());
                setText('sumItems', won(items));
                setText('sumShipping', won(shipping));
                setText('sumRejectedQty', Math.max(0, req - appr).toLocaleString());
                setText('sumTotal', won(total));
                const totalEl = document.getElementById('sumTotal');
                if (totalEl) totalEl.textContent = won(total);

                const refundMil = num(s.refundMileage, 0);
                setText('resRefundMileage', pt(refundMil));
            }

            function renderResultItems(items) {
                const wrap = document.getElementById('resItems');
                const tpl = document.getElementById('resItemRow');
                wrap.innerHTML = '';
                const cntEl = document.getElementById('resItemsCount');
                if (cntEl) cntEl.textContent = items.length;

                items.forEach(it => {
                    const $ = tpl.content.firstElementChild.cloneNode(true);
                    const img = $.querySelector('img');
                    img.src = joinPath(it.product?.imgPath, it.product?.imgName);
                    img.alt = it.product?.name ?? '상품';

                    const unit = Number(it.unitRefundAmount ?? 0);
                    const approved = Number(it.approvedQty ?? 0);
                    const line = (it.lineAmount != null) ? Number(it.lineAmount) : unit * approved;

                    $.querySelector('.name').textContent = it.product?.name ?? '';
                    $.querySelector('.unit').textContent = won(unit);
                    $.querySelector('.requested').textContent = (it.requestedQty ?? 0).toLocaleString();
                    $.querySelector('.approved').textContent = approved.toLocaleString();
                    $.querySelector('.subtotal').textContent = won(line ?? 0);

                    wrap.appendChild($);
                });
            }

            function renderGlobalRejection(data, items) {
                const sec = document.getElementById('resGlobalRejectionSec');
                const box = document.getElementById('resGlobalRejection');

                const partial =
                    (data.flags && typeof data.flags.partialRejected === 'boolean')
                        ? data.flags.partialRejected
                        : items.some(it => (it.approvedQty ?? 0) < (it.requestedQty ?? 0));

                const reason =
                    (data.header && data.header.rejectionReason) ||
                    (data.summary && data.summary.rejectionReason) ||
                    '';

                const show = partial && String(reason).trim().length > 0;
                sec.classList.toggle('d-none', !show);
                if (show) box.textContent = reason;
            }

            function renderResultFooter(s, items, h) {
                // 1) 항목 소계 합산 (단가×승인수량, lineAmount 없을 때도 안전)
                let itemsSum = 0;
                items.forEach(it => {
                    const unit = Number(it.unitRefundAmount ?? 0);
                    const approved = Number(it.approvedQty ?? 0);
                    const line = (it.lineAmount != null) ? Number(it.lineAmount) : unit * approved;
                    itemsSum += line;
                });

                // 2) 배송비/총액 보정 로직 (summary 누락·불일치 방어)
                const req = Number(s.requestedQty ?? 0);
                const appr = Number(s.approvedQty ?? 0);

                let total = (s.totalRefundAmount != null) ? Number(s.totalRefundAmount) : null;
                let shipping = (s.shippingRefund != null)
                    ? Number(s.shippingRefund)
                    : (s.shipping != null ? Number(s.shipping) : null);

                // 차감 마일리지(사용 포인트)
                const usedPoint = Number(s.usedPoint ?? h.usedPoint ?? 0);

                // 총액·소계가 있으면 배송비를 역산해 불일치 보정
                if (total != null) {
                    const derivedRaw = total - itemsSum + usedPoint;
                    let derived = Math.max(0, derivedRaw);
                    // ▶ 정책 강제
                    if (appr > 0 && derived === 0) derived = 3000;
                    if (shipping == null || shipping !== derived) shipping = derived;
                }

                // 여전히 null이면 정책으로 보정 (승인수량 > 0 이면 3,000)
                if (shipping == null) shipping = (appr > 0 ? 3000 : 0);
                if (total == null) total = itemsSum - usedPoint + shipping;

                setText('footItemsSum', won(itemsSum));
                setText('footShipping', won(shipping));
                setText('footTotal', won(total));
                setText('footProcessedAt', h.processedAt ?? '');

                // ▼▼ 추가: 마일리지 표시
                const refundMil = Number(s.refundMileage ?? 0);
                const confirmMil = Number(s.confirmMileage ?? 0);
                const rEl = document.getElementById('footRefundMileage');
                const cEl = document.getElementById('footConfirmMileage');
                if (rEl) rEl.textContent = pt(refundMil);
                if (cEl) cEl.textContent = pt(confirmMil);
                // ▲▲ 추가 끝
            }

            function setText(id, v) {
                const el = document.getElementById(id);
                if (el) el.textContent = v ?? '';
            }
        })();
    </script>
</th:block>

</html>