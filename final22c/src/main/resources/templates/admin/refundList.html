<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{/layout/adminLayout}">
<th:block layout:fragment="css">
    <style>
        .modal-body {
            position: relative;
        }

        #refundItemsHeader {
            position: sticky;
            top: 0;
            z-index: 2;
        }
    </style>
</th:block>
<div layout:fragment="content" class="container">
    <br>
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-table me-1"></i>
            환불 내역
        </div>
        <div class="card-body">
            <table id="datatablesSimple">
                <thead>
                    <tr>
                        <th scope="col">구분</th>
                        <th scope="col">요청자ID</th>
                        <th scope="col">주문번호</th>
                        <th scope="col">환불신청날짜</th>
                        <th scope="col">상태</th>
                        <th scope="col">환급된 금액</th>
                        <th scope="col">환불처리날짜</th>
                        <th scope="col">관리</th>
                    </tr>
                </thead>
                <tbody id="refundList">
                    <tr th:each="list : ${refundList}" th:fragment="productRow">
                        <td th:text="${list.refundId}"></td>
                        <td th:text="${list.user.userName}"></td>
                        <td th:text="${list.order.orderId}"></td>
                        <td th:text="${#temporals.format(list.createDate, 'yyyy-MM-dd HH:mm')}"></td>
                        <td>
                            <span th:if="${list.status == 'REQUESTED'}">환불요청됨</span>
                            <span th:if="${list.status == 'REFUNDED'}">환불처리됨</span>
                        </td>
                        <td>
                            <span th:if="${list.totalRefundAmount == 0}"> - </span>
                            <span th:if="${list.totalRefundAmount != 0}" th:text="${list.totalRefundAmount}"></span>
                        </td>
                        <td>
                            <span th:if="${list.status == 'REQUESTED'}"> - </span>
                            <span th:if="${list.status == 'REFUNDED'}" th:text="${list.updateDate}"></span>
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-secondary btnRefundShow"
                                th:data-refund-id="${list.refundId}">상세내역보기</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 상세내역보기 버튼을 클릭했을 때, 출력되는 모달창 Refund Detail Modal -->
    <div class="modal fade" id="refundModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">환불 상세</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
                </div>

                <div class="modal-body">
                    <!-- 헤더: 신청자/주문번호/신청일/사유 -->
                    <section id="refundHeader" class="mb-3">
                        <div class="d-flex flex-wrap gap-3 small text-muted">
                            <div><strong>요청자</strong> <span id="hdrUserName"></span></div>
                            <div><strong>주문번호</strong> <span id="hdrOrderId"></span></div>
                            <div class="ms-auto"><strong>신청일시</strong> <span id="hdrCreatedAt"></span></div>
                        </div>
                        <div class="mt-2">
                            <div class="fw-semibold">환불 사유</div>
                            <div id="hdrReason" class="border rounded p-2 bg-light" style="white-space: pre-line;">
                            </div>
                        </div>
                    </section>

                    <section id="refundItemsHeader"
                        class="d-flex justify-content-between align-items-center small bg-light rounded border px-2 py-2 mt-3 mb-2">
                        <div class="fw-semibold">환불 목록</div>
                        <!-- 오른쪽 요약이 싫으면 이 <div>는 지워도 됨 -->
                        <div class="text-muted">
                            <span id="itemsCount">0</span>건 · 승인 <span id="approvedQty">0</span>/<span
                                id="itemsQty">0</span>
                        </div>
                    </section>
                    <!-- 상세 라인들 -->
                    <section id="refundItems"></section>

                    <!-- 라인 템플릿 -->
                    <template id="refundItemRow">
                        <div class="refund-item d-flex align-items-center py-2 border-bottom" data-refund-detail-id=""
                            data-quantity="" data-refund-qty="">
                            <img class="rounded me-3" src="" alt="" style="width:64px;height:64px;object-fit:cover">
                            <div class="flex-grow-1">
                                <div class="fw-semibold name"></div>
                                <div class="small text-muted">단가 <span class="unit"></span> · 요청수량 <span
                                        class="requested"></span></div>
                            </div>
                            <!-- ▶ 수량 버튼 + 그 아래 금액(소계) -->
                            <div class="d-flex flex-column align-items-center ms-3 qty-col">
                                <div class="d-flex align-items-center">
                                    <button type="button" class="btn btn-outline-secondary btn-sm btnMinus">−</button>
                                    <input type="text" class="form-control form-control-sm mx-1 qtyInput text-center"
                                        style="width:64px" inputmode="numeric" aria-label="승인 수량">
                                    <button type="button" class="btn btn-outline-secondary btn-sm btnPlus">＋</button>
                                </div>
                                <div class="mt-1 fw-semibold subtotal text-center">0원</div>
                            </div>
                        </div>
                    </template>

                    <!-- 합계 -->
                    <div class="mt-3 p-3 bg-light rounded d-flex justify-content-between align-items-center">
                        <div class="fw-semibold">환급 예정 금액</div>
                        <div class="h5 m-0" id="totalRefundAmount">0</div>
                    </div>

                    <!-- 거절 사유 -->
                    <div id="rejectReasonWrap" class="mt-3 d-none">
                        <label for="rejectReason" class="form-label">거절 사유</label>
                        <textarea id="rejectReason" class="form-control" rows="3" placeholder="사유를 입력하세요"></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-outline-secondary" data-bs-dismiss="modal">닫기</button>
                    <button class="btn btn-primary" id="btnRefundApprove">승인</button>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="script">
    <script>
        (() => {
            // 프로젝트 환경에 맞게 조정
            const ENDPOINT_DETAIL = (refundId) => `/admin/refunds/${refundId}`;                // GET
            const ENDPOINT_APPROVE = (refundId) => `/admin/refunds/${refundId}/approve`;       // POST

            // CSRF (Spring Security 사용 시)
            const CSRF_TOKEN = document.querySelector('meta[name="_csrf"]')?.content;
            const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.content;

            const modalEl = document.getElementById('refundModal');
            const itemsWrap = document.getElementById('refundItems');
            const rowTpl = document.getElementById('refundItemRow');
            const totalEl = document.getElementById('totalRefundAmount');
            const rejectWrap = document.getElementById('rejectReasonWrap');
            const rejectTextarea = document.getElementById('rejectReason');

            let currentRefundId = null;
            let headerCache = null; // userName, orderId, createdAt, reason
            let itemsCache = [];    // [{refundDetailId, unitRefundAmount, quantity, refundQty, product{...}}]

            const fmt = new Intl.NumberFormat('ko-KR');
            const won = n => `${fmt.format(n)}원`;

            // 리스트 버튼 클릭 → 모달 오픈
            document.addEventListener('click', async (e) => {
                const btn = e.target.closest('.btnRefundShow');
                if (!btn) return;

                const refundId = btn.dataset.refundId;
                currentRefundId = refundId;
                await openRefundModal(refundId);
            });

            // 모달 열기 + 데이터 로드
            async function openRefundModal(refundId) {
                // 1) 상세 조회(JSON) 응답 스펙 예시
                // {
                //   header: { userName, orderId, createdAt, reason, status, paymentTid },
                //   items: [
                //     { refundDetailId, unitRefundAmount, quantity, refundQty, product:{id,name,imgPath,imgName} }
                //   ]
                // }
                const res = await fetch(ENDPOINT_DETAIL(refundId), { headers: { 'Accept': 'application/json' } });
                if (!res.ok) { alert('상세 조회 중 오류가 발생했습니다.'); return; }
                const data = await res.json();

                // 방어: 응답 형태 확인
                if (!data || !data.header || !Array.isArray(data.items)) {
                    console.warn('Unexpected response', data);
                    alert('상세 데이터가 올바르지 않습니다.');
                    return;
                }

                headerCache = data.header;
                const isRequested = headerCache.status === 'REQUESTED';

                itemsCache = data.items.map(it => {
                    // 승인수량 초기값 결정 로직
                    const initial =
                        (isRequested && (!it.refundQty || it.refundQty === 0))
                            ? it.quantity
                            : (it.refundQty ?? it.quantity);
                    return { ...it, refundQty: initial };
                });

                renderHeader(headerCache);
                renderItems(itemsCache);
                updateItemsHeader();   // 렌더 직후
                calcAll();

                // Bootstrap 5 모달 표시
                const bsModal = bootstrap.Modal.getOrCreateInstance(modalEl);
                bsModal.show();
            }

            function renderHeader(h) {
                document.getElementById('hdrUserName').textContent = h.userName;
                document.getElementById('hdrOrderId').textContent = h.orderId;
                document.getElementById('hdrCreatedAt').textContent = h.createdAt ?? '';
                const reasonEl = document.getElementById('hdrReason');
                reasonEl.textContent = h.reason ?? '';   // XSS 안전
                reasonEl.style.whiteSpace = 'pre-line';  // (CSS를 따로 못 넣는다면 JS로 지정)
            }

            function renderItems(items) {
                itemsWrap.innerHTML = '';
                items.forEach((it, idx) => {
                    const $ = rowTpl.content.firstElementChild.cloneNode(true);

                    $.dataset.refundDetailId = it.refundDetailId;
                    $.dataset.quantity = String(it.quantity);
                    $.dataset.refundQty = String(it.refundQty);

                    const img = $.querySelector('img');
                    img.src = (it.product?.imgPath ?? '') + (it.product?.imgName ?? '');
                    img.alt = it.product?.name ?? '상품';

                    $.querySelector('.name').textContent = it.product?.name ?? '';
                    $.querySelector('.unit').textContent = won(it.unitRefundAmount);
                    $.querySelector('.requested').textContent = fmt.format(it.quantity);

                    const qtyInput = $.querySelector('.qtyInput');
                    qtyInput.value = it.refundQty;

                    // 버튼 핸들러
                    $.querySelector('.btnMinus').addEventListener('click', () => changeQty($, -1));
                    $.querySelector('.btnPlus').addEventListener('click', () => changeQty($, +1));
                    qtyInput.addEventListener('input', () => {
                        // 숫자만, 범위 0..quantity
                        let v = qtyInput.value.replace(/[^\d]/g, '');
                        if (v === '') v = '0';
                        v = Math.min(it.quantity, Math.max(0, Number(v)));
                        qtyInput.value = String(v);
                        $.dataset.refundQty = String(v);
                        updateRowSubtotal($, it.unitRefundAmount);
                        calcAll();
                    });

                    updateRowSubtotal($, it.unitRefundAmount);
                    itemsWrap.appendChild($);
                });
            }

            function changeQty(rowEl, delta) {
                const max = Number(rowEl.dataset.quantity);
                const cur = Number(rowEl.dataset.refundQty);
                const next = Math.min(max, Math.max(0, cur + delta));
                rowEl.dataset.refundQty = String(next);
                rowEl.querySelector('.qtyInput').value = String(next);

                // 단가는 rowEl에서 못 읽으니 cache에서 찾아서 적용
                const id = Number(rowEl.dataset.refundDetailId);
                const it = itemsCache.find(x => Number(x.refundDetailId) === id);
                if (it) updateRowSubtotal(rowEl, it.unitRefundAmount);

                calcAll();
            }

            function updateRowSubtotal(rowEl, unit) {
                const qty = Number(rowEl.dataset.refundQty);
                rowEl.querySelector('.subtotal').textContent = won(unit * qty);

                // 요청수량보다 줄이면 강조
                const requested = Number(rowEl.dataset.quantity);
                rowEl.classList.toggle('text-danger', qty < requested);
            }

            function calcAll() {
                let total = 0;
                let anyReduced = false;

                // 캐시에도 반영
                itemsCache.forEach(it => {
                    const row = itemsWrap.querySelector(`.refund-item[data-refund-detail-id="${it.refundDetailId}"]`);
                    const qty = Number(row.dataset.refundQty);
                    it.refundQty = qty;
                    total += it.unitRefundAmount * qty;
                    if (qty < it.quantity) anyReduced = true;
                });

                totalEl.textContent = won(total);
                rejectWrap.classList.toggle('d-none', !anyReduced);
                if (!anyReduced) rejectTextarea.value = '';

                const approved = itemsCache.reduce((s, it) => s + (it.refundQty || 0), 0);
                document.getElementById('approvedQty')?.replaceChildren(approved.toLocaleString());
            }

            function updateItemsHeader() {
                const itemsCount = itemsCache.length;
                const totalRequested = itemsCache.reduce((s, it) => s + (it.quantity || 0), 0);
                document.getElementById('itemsCount')?.replaceChildren(itemsCount);
                document.getElementById('itemsQty')?.replaceChildren(totalRequested.toLocaleString());
            }

            // 승인 버튼
            document.getElementById('btnRefundApprove').addEventListener('click', async () => {
                // 줄인 항목이 있으면 거절사유 필수
                const anyReduced = itemsCache.some(it => it.refundQty < it.quantity);
                if (anyReduced && !rejectTextarea.value.trim()) {
                    alert('거절 사유를 입력해 주세요.');
                    rejectTextarea.focus();
                    return;
                }

                const payload = {
                    refundId: currentRefundId,
                    items: itemsCache.map(it => ({
                        refundDetailId: it.refundDetailId,
                        refundQty: it.refundQty
                    })),
                    rejectionReason: anyReduced ? rejectTextarea.value.trim() : null
                };

                const headers = { 'Content-Type': 'application/json' };
                if (CSRF_TOKEN && CSRF_HEADER) headers[CSRF_HEADER] = CSRF_TOKEN;

                const res = await fetch(ENDPOINT_APPROVE(currentRefundId), {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    alert('환불 승인 처리 완료');
                    // 필요 시: 모달 닫고 리스트 새로고침
                    bootstrap.Modal.getInstance(modalEl).hide();
                    location.reload();
                } else {
                    const msg = (await res.json().catch(() => ({}))).message ?? '승인 처리 중 오류가 발생했습니다.';
                    alert(msg);
                }
            });
        })();
    </script>
</th:block>

</html>