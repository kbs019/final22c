<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<head>
  <meta charset="UTF-8" />
  <title>22Â°C - MyType</title>

  <!-- í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ -->
  <th:block layout:fragment="css">
    <style>
      :root { scrollbar-gutter: stable; }
      html { overflow-y: scroll; }

      /* ë‚ ì”¨ ë°°ë„ˆ */
      .weather-banner{
        background: linear-gradient(135deg, #f8fafc 0%, #eef2f7 100%);
        border: 1px solid rgba(0,0,0,.06);
      }
      .weather-icon{
        width:64px;height:64px;display:flex;align-items:center;justify-content:center;
        border-radius:18px;background:rgba(255,255,255,.7);
      }
      .wx-temp{ font-size:42px; font-weight:800; line-height:1; }
      .wx-meta{ color:#6b7280; }

      /* â˜… ë³€ê²½: í•´ì‹œíƒœê·¸ë¥¼ a íƒœê·¸ë¡œ ì‚¬ìš©í•˜ë¯€ë¡œ ë²„íŠ¼ ëŠë‚Œ ìŠ¤íƒ€ì¼ */
      .tag-badge{
        display:inline-block;                /* â˜… ë³€ê²½ */
        padding:.35rem .7rem; 
        border-radius:999px;
        background:#f3f4f6;
        border:1px solid #e5e7eb;           /* â˜… ë³€ê²½ */
        text-decoration:none;                /* â˜… ë³€ê²½ */
        color:#111;                          /* â˜… ë³€ê²½ */
      }
      .tag-badge:hover{ background:#eef2ff; border-color:#c7d2fe; } /* â˜… ì¶”ê°€ */

      .hover-up{ transition:transform .15s ease; }
      .hover-up:hover{ transform:translateY(-2px); }
    </style>
  </th:block>
</head>

<body>
<div layout:fragment="content" class="container py-4">

  <!-- ===== ë‚ ì”¨ ë°°ë„ˆ ===== -->
  <div id="wx-card" class="weather-banner rounded-4 shadow-sm p-4 mb-4">
    <div class="d-flex align-items-center gap-3 flex-wrap">

      <!-- ì•„ì´ì½˜ -->
      <div class="weather-icon fs-2" id="wx-icon">â˜€ï¸</div>

      <!-- ì˜¨ë„/ìƒíƒœ -->
      <div class="me-auto">
        <div class="d-flex align-items-baseline gap-2">
          <div id="wx-temp" class="wx-temp">--Â°C</div>
          <span id="wx-cond" class="badge text-bg-secondary">--</span>
        </div>
        <!-- ìˆ¨ê¹€: JSê°€ ì°¸ì¡°í•˜ë¯€ë¡œ DOMì€ ìœ ì§€ -->
        <div class="wx-meta small mt-1 d-none">
          ìŠµë„ <span id="wx-hum">--</span>% Â· ê°•ìˆ˜ëŸ‰ <span id="wx-pr">--</span>mm Â· ìš´ëŸ‰ <span id="wx-cloud">--</span>%
        </div>
      </div>

      <!-- ì¶”ì²œ ìš”ì•½ -->
      <div class="text-end">
        <div class="fw-semibold mb-1">ì˜¤ëŠ˜ì€ ì´ë ‡ê²Œ ë¿Œë ¤ìš”~</div>
        <div id="wx-tags" class="d-flex flex-wrap gap-2 justify-content-end"><!-- JSê°€ ì±„ì›€ --></div>
      </div>

    </div>
  </div>

</div> <!-- /content -->

<!-- ===== ìŠ¤í¬ë¦½íŠ¸ ===== -->
<th:block layout:fragment="script">
<script>
(function(){
  const $id = (x)=>document.getElementById(x);
  const root = $id('wx-card'); if(!root) return;

  const iconEl = $id('wx-icon');
  const tempEl = $id('wx-temp');
  const condEl = $id('wx-cond');
  const humEl  = $id('wx-hum');
  const prEl   = $id('wx-pr');
  const cloudEl= $id('wx-cloud');
  const tagsBox= $id('wx-tags');

  /* â˜… ì¶”ê°€: ë©”ì¸ë…¸íŠ¸ í•œê¸€ëª… -> ID ë§¤í•‘ (ìš”ì²­ ë¼ìš°íŒ… ê·œê²©) */
  const NOTE_ID_BY_NAME = {
    'ìŠ¤íŒŒì´ì‹œ':1, 'ìš°ë””':2, 'í—ˆë²Œ':3, 'í”„ë£¨í‹°':4,
    'êµ¬ë¥´ë§':5, 'í”Œë¡œë„':6, 'ì‹œíŠ¸ëŸ¬ìŠ¤':7, 'ë°”ë‹ë¼':8
  };

  /* ----- ìƒíƒœ/ì•„ì´ì½˜ ----- */
  function condKo(c){
    const k = (c||'').toUpperCase();
    if (/RAIN|DRIZZLE|SHOWER/.test(k)) return 'ë¹„';
    if (/SNOW/.test(k)) return 'ëˆˆ';
    if (/CLOUD/.test(k)) return 'êµ¬ë¦„';
    if (/HOT/.test(k)) return 'ë”ì›€';
    if (/COLD/.test(k)) return 'ì¶”ì›€';
    return 'ì˜¨í™”';
  }
  function condIcon(c){
    const k = (c||'').toUpperCase();
    if (/RAIN|DRIZZLE|SHOWER/.test(k)) return 'ğŸŒ§ï¸';
    if (/SNOW/.test(k)) return 'â„ï¸';
    if (/CLOUD/.test(k)) return 'â›…';
    return 'â˜€ï¸';
  }
  function badgeClassByCond(c){
    const k = (c||'').toUpperCase();
    if (/RAIN|DRIZZLE|SHOWER/.test(k)) return 'text-bg-primary';
    if (/SNOW/.test(k)) return 'text-bg-info';
    if (/HOT/.test(k)) return 'text-bg-warning text-dark';
    if (/COLD/.test(k)) return 'text-bg-dark';
    if (/CLOUD/.test(k)) return 'text-bg-secondary';
    return 'text-bg-success';
  }

  /* ----- ë‚ ì”¨ í˜¸ì¶œ ----- */
  async function fetchNow(lat, lon){
    const q = new URLSearchParams({lat, lon});
    const r = await fetch('/api/weather/now?' + q);
    if(!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }

  /* ----- ë‚ ì”¨ â†’ ë©”ì¸ë…¸íŠ¸(ìš°ë¦¬ 8ì¢…) ë§¤í•‘ ----- */
  function toRec(wx){
    const t = Number(wx.tempC ?? wx.temp ?? 0);
    const hum = Number(wx.humidity ?? 0);
    const pr  = Number(wx.precipitation ?? 0);
    const cloud = Number(wx.cloud ?? 0);
    const rainy = pr >= 0.1 || /rain|snow/i.test(wx.condition||'');
    const hot   = t >= 28;
    const cold  = t <= 12;
    const humid = hum >= 70;
    const cloudy= cloud >= 70;

    if (hot && humid)  return { key:'hot_humid', notes:['ì‹œíŠ¸ëŸ¬ìŠ¤','í”Œë¡œë„','í—ˆë²Œ'] };
    if (hot)           return { key:'hot',       notes:['í”„ë£¨í‹°','ì‹œíŠ¸ëŸ¬ìŠ¤','ìš°ë””'] };
    if (cold)          return { key:'cold',      notes:['ë°”ë‹ë¼','êµ¬ë¥´ë§','ìŠ¤íŒŒì´ì‹œ'] };
    if (rainy || cloudy) return { key:'rainy',   notes:['ìš°ë””','ìŠ¤íŒŒì´ì‹œ'] };
    return                             { key:'mild',      notes:['í”Œë¡œë„','í”„ë£¨í‹°','í—ˆë²Œ'] };
  }

  /* ----- ìƒë‹¨ ë°°ë„ˆ ë Œë” ----- */
  function renderWeather(wx){
    const t = Number(wx.tempC ?? wx.temp ?? 0);
    const cko = wx.conditionKo || condKo(wx.condition);
    const cls = badgeClassByCond(wx.condition);

    iconEl.textContent = condIcon(wx.condition);
    tempEl.textContent = (t.toFixed ? t.toFixed(1) : Math.round(t)) + 'Â°C';
    condEl.className = 'badge ' + cls;
    condEl.textContent = cko;

    humEl.textContent   = wx.humidity ?? '--';
    prEl.textContent    = (wx.precipitation ?? 0).toFixed ? (wx.precipitation).toFixed(1) : (wx.precipitation ?? 0);
    cloudEl.textContent = wx.cloud ?? '--';
  }

  /* ----- ì¶”ì²œ íƒœê·¸ ë Œë”: ê° íƒœê·¸ë¥¼ /main/list?mainNoteIds={id} ë§í¬ë¡œ ----- */
  function renderTags(notes, recKey){
    tagsBox.innerHTML = '';
    notes.forEach(name=>{
      const id = NOTE_ID_BY_NAME[name];           // â˜… ë³€ê²½: ì´ë¦„â†’ID
      if (!id) return;
      const a  = document.createElement('a');     // â˜… ë³€ê²½: a íƒœê·¸ë¡œ ë§í¬
      a.className   = 'tag-badge';
      a.href        = `/main/list?mainNoteIds=${id}`;         // â˜… ë³€ê²½: ëª©ì ì§€
      a.textContent = `#${name}`;
      a.setAttribute('aria-label', `${name} í–¥ìˆ˜ ë³´ëŸ¬ê°€ê¸°`);
      tagsBox.appendChild(a);
    });
  }

  /* ----- (ì„ íƒ) ì¶”ì²œ ìƒí’ˆ API: ë©”ì¸ë…¸íŠ¸ ë°°ì—´ë¡œ ì¡°íšŒ (ê·¸ëŒ€ë¡œ ìœ ì§€) ----- */
  async function fetchRecoByNotes(notes){
    try{
      const qs = new URLSearchParams();
      notes.forEach(n => qs.append('mainNote', n));
      const r = await fetch('/api/reco?' + qs.toString());
      if(!r.ok) return [];
      return r.json(); // [{id,name,brand,price,imageUrl}, ...]
    }catch(_){ return []; }
  }
  function renderReco(items){
    const recGrid  = document.getElementById('rec-grid');
    const recItems = document.getElementById('rec-items');
    if(!recGrid || !recItems) return; // í˜ì´ì§€ì— ì—†ìœ¼ë©´ ìŠ¤í‚µ

    if(!items || items.length === 0) return;
    recItems.innerHTML = '';
    items.forEach(p=>{
      const col = document.createElement('div');
      col.className = 'col';
      col.innerHTML = `
        <div class="card h-100 hover-up">
          <a href="/product/${p.id}" class="ratio ratio-1x1 d-block">
            <img src="${p.imageUrl}" alt="${p.name}" class="w-100 h-100 p-3" style="object-fit:contain;">
          </a>
          <div class="card-body">
            <div class="fw-semibold text-truncate">${p.name}</div>
            <div class="small text-secondary">${p.brand ?? ''}</div>
            <div class="fw-bold mt-1">${(p.price ?? 0).toLocaleString()}ì›</div>
          </div>
        </div>`;
      recItems.appendChild(col);
    });
    recGrid.style.display = '';
  }

  async function boot(lat, lon){
    const wx = await fetchNow(lat, lon);
    renderWeather(wx);

    const {key, notes} = toRec(wx);
    renderTags(notes, key);

    // (ì„ íƒ) ì¶”ì²œ ì¹´ë“œê°€ ìˆë‹¤ë©´ ì‚¬ìš©
    const items = await fetchRecoByNotes(notes).catch(()=>[]);
    if (items.length) renderReco(items);
  }

  // ì¢Œí‘œ: ì§€ì˜¤ë¡œì¼€ì´ì…˜ â†’ ì‹¤íŒ¨ ì‹œ ì„œìš¸
  const fallback = () => boot(37.5665,126.9780);
  if ('geolocation' in navigator){
    navigator.geolocation.getCurrentPosition(
      p => boot(p.coords.latitude, p.coords.longitude),
      _ => fallback(),
      { timeout: 5000 }
    );
  } else fallback();

  // (ì˜µì…˜) íƒ­ ë³µê·€ ì‹œ ê°±ì‹ 
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) fallback(); });
  // setInterval(fallback, 10*60*1000); // í•„ìš” ì‹œ ì£¼ê¸° ê°±ì‹ 
})();
</script>
</th:block>

</body>
</html>
