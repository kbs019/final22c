<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<head>
  <meta charset="UTF-8" />
  <title>22°C - MyType</title>

  <!-- 페이지 전용 스타일 -->
  <th:block layout:fragment="css">
    <style>
      :root { scrollbar-gutter: stable; }
      html { overflow-y: scroll; }

      /* 날씨 배너 */
      .weather-banner{
        background: linear-gradient(135deg, #f8fafc 0%, #eef2f7 100%);
        border: 1px solid rgba(0,0,0,.06);
      }
      .weather-icon{
        width:64px;height:64px;display:flex;align-items:center;justify-content:center;
        border-radius:18px;background:rgba(255,255,255,.7);
      }
      .wx-temp{ font-size:42px; font-weight:800; line-height:1; }
      .wx-meta{ color:#6b7280; }

      .tag-badge{ padding:.35rem .7rem; border-radius:999px; background:#f3f4f6; }

      .hover-up{ transition:transform .15s ease; }
      .hover-up:hover{ transform:translateY(-2px); }
    </style>
  </th:block>
</head>

<body>
<div layout:fragment="content" class="container py-4">

  <!-- ===== 날씨 배너 ===== -->
  <div id="wx-card" class="weather-banner rounded-4 shadow-sm p-4 mb-4">
    <div class="d-flex align-items-center gap-3 flex-wrap">

      <!-- 아이콘 -->
      <div class="weather-icon fs-2" id="wx-icon">☀️</div>

      <!-- 온도/상태 -->
      <div class="me-auto">
        <div class="d-flex align-items-baseline gap-2">
          <div id="wx-temp" class="wx-temp">--°C</div>
          <span id="wx-cond" class="badge text-bg-secondary">--</span>
        </div>
        <!-- 숨김: JS가 참조하므로 DOM은 유지 -->
        <div class="wx-meta small mt-1 d-none">
          습도 <span id="wx-hum">--</span>% · 강수량 <span id="wx-pr">--</span>mm · 운량 <span id="wx-cloud">--</span>%
        </div>
      </div>

      <!-- 추천 요약 -->
      <div class="text-end">
        <div class="fw-semibold mb-1">오늘의 추천</div>
        <div id="wx-tags" class="d-flex flex-wrap gap-2 justify-content-end"><!-- JS가 채움 --></div>
        <a id="rec-more" href="/list" class="btn btn-sm btn-outline-dark mt-2">추천 상품 보기</a>
      </div>

    </div>
  </div>

  <!-- ===== (선택) 추천 상품 그리드: /api/reco 있으면 표시 ===== -->
  <div id="rec-grid" style="display:none">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h5 class="m-0">오늘의 추천 향수</h5>
      <a class="text-decoration-none small" id="rec-more-2" href="/list">더 보기</a>
    </div>
    <div class="row row-cols-2 row-cols-md-3 row-cols-lg-5 g-3" id="rec-items"><!-- JS가 삽입 --></div>
  </div>

</div> <!-- /content -->

<!-- ===== 스크립트 ===== -->
<th:block layout:fragment="script">
<script>
(function(){
  const $id = (x)=>document.getElementById(x);
  const root = $id('wx-card'); if(!root) return;

  const iconEl = $id('wx-icon');
  const tempEl = $id('wx-temp');
  const condEl = $id('wx-cond');
  const humEl  = $id('wx-hum');
  const prEl   = $id('wx-pr');
  const cloudEl= $id('wx-cloud');
  const tagsBox= $id('wx-tags');
  const recMore= $id('rec-more');
  const recMore2= $id('rec-more-2');
  const recGrid= $id('rec-grid');
  const recItems= $id('rec-items');

  /* ----- 상태/아이콘 ----- */
  function condKo(c){
    const k = (c||'').toUpperCase();
    if (/RAIN|DRIZZLE|SHOWER/.test(k)) return '비';
    if (/SNOW/.test(k)) return '눈';
    if (/CLOUD/.test(k)) return '구름';
    if (/HOT/.test(k)) return '더움';
    if (/COLD/.test(k)) return '추움';
    return '온화';
  }
  function condIcon(c){
    const k = (c||'').toUpperCase();
    if (/RAIN|DRIZZLE|SHOWER/.test(k)) return '🌧️';
    if (/SNOW/.test(k)) return '❄️';
    if (/CLOUD/.test(k)) return '⛅';
    return '☀️';
  }
  function badgeClassByCond(c){
    const k = (c||'').toUpperCase();
    if (/RAIN|DRIZZLE|SHOWER/.test(k)) return 'text-bg-primary';
    if (/SNOW/.test(k)) return 'text-bg-info';
    if (/HOT/.test(k)) return 'text-bg-warning text-dark';
    if (/COLD/.test(k)) return 'text-bg-dark';
    if (/CLOUD/.test(k)) return 'text-bg-secondary';
    return 'text-bg-success';
  }

  /* ----- 날씨 호출 ----- */
  async function fetchNow(lat, lon){
    const q = new URLSearchParams({lat, lon});
    const r = await fetch('/api/weather/now?' + q);
    if(!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }

  /* ----- 날씨 → 메인노트(우리 8종) 매핑 ----- */
  function toRec(wx){
    const t = Number(wx.tempC ?? wx.temp ?? 0);
    const hum = Number(wx.humidity ?? 0);
    const pr  = Number(wx.precipitation ?? 0);
    const cloud = Number(wx.cloud ?? 0);
    const rainy = pr >= 0.1 || /rain|snow/i.test(wx.condition||'');
    const hot   = t >= 28;
    const cold  = t <= 12;
    const humid = hum >= 70;
    const cloudy= cloud >= 70;

    if (hot && humid)  return { key:'hot_humid', notes:['시트러스','플로랄','허벌'] };
    if (hot)           return { key:'hot',       notes:['프루티','시트러스','우디'] };
    if (cold)          return { key:'cold',      notes:['바닐라','구르망','스파이시'] };
    if (rainy || cloudy) return { key:'rainy',   notes:['우디','스파이시'] };
    return                             { key:'mild',      notes:['플로랄','프루티','허벌'] };
  }

  /* ----- 상단 배너 렌더 ----- */
  function renderWeather(wx){
    const t = Number(wx.tempC ?? wx.temp ?? 0);
    const cko = wx.conditionKo || condKo(wx.condition);
    const cls = badgeClassByCond(wx.condition);

    iconEl.textContent = condIcon(wx.condition);
    tempEl.textContent = (t.toFixed ? t.toFixed(1) : Math.round(t)) + '°C';
    condEl.className = 'badge ' + cls;
    condEl.textContent = cko;

    humEl.textContent   = wx.humidity ?? '--';
    prEl.textContent    = (wx.precipitation ?? 0).toFixed ? (wx.precipitation).toFixed(1) : (wx.precipitation ?? 0);
    cloudEl.textContent = wx.cloud ?? '--';
  }

  /* ----- 추천 태그(메인노트명) 렌더 + 링크 ----- */
  function renderTags(notes, recKey){
    tagsBox.innerHTML = '';
    notes.forEach(name=>{
      const s = document.createElement('span');
      s.className = 'tag-badge';
      s.textContent = '#' + name;
      tagsBox.appendChild(s);
    });

    // 리스트 페이지로 메인노트를 직접 전달 (다중 파라미터)
    const qs = new URLSearchParams();
    notes.forEach(n => qs.append('mainNote', n));   // /list?mainNote=시트러스&mainNote=플로랄...
    const href = '/list?' + qs.toString();
    recMore.href = href;
    if (recMore2) recMore2.href = href;
  }

  /* ----- (선택) 추천 상품 API: 메인노트 배열로 조회 ----- */
  async function fetchRecoByNotes(notes){
    try{
      const qs = new URLSearchParams();
      notes.forEach(n => qs.append('mainNote', n));
      const r = await fetch('/api/reco?' + qs.toString());
      if(!r.ok) return [];
      return r.json(); // [{id,name,brand,price,imageUrl}, ...]
    }catch(_){ return []; }
  }
  function renderReco(items){
    if(!items || items.length === 0) return;
    recItems.innerHTML = '';
    items.forEach(p=>{
      const col = document.createElement('div');
      col.className = 'col';
      col.innerHTML = `
        <div class="card h-100 hover-up">
          <a href="/product/${p.id}" class="ratio ratio-1x1 d-block">
            <img src="${p.imageUrl}" alt="${p.name}" class="w-100 h-100 p-3" style="object-fit:contain;">
          </a>
          <div class="card-body">
            <div class="fw-semibold text-truncate">${p.name}</div>
            <div class="small text-secondary">${p.brand ?? ''}</div>
            <div class="fw-bold mt-1">${(p.price ?? 0).toLocaleString()}원</div>
          </div>
        </div>`;
      recItems.appendChild(col);
    });
    recGrid.style.display = '';
  }

  async function boot(lat, lon){
    const wx = await fetchNow(lat, lon);
    renderWeather(wx);

    const {key, notes} = toRec(wx);
    renderTags(notes, key);

    // 추천 API가 구현되어 있다면 주석 해제
    const items = await fetchRecoByNotes(notes).catch(()=>[]);
    if (items.length) renderReco(items);
  }

  // 좌표: 지오로케이션 → 실패 시 서울
  const fallback = () => boot(37.5665,126.9780);
  if ('geolocation' in navigator){
    navigator.geolocation.getCurrentPosition(
      p => boot(p.coords.latitude, p.coords.longitude),
      _ => fallback(),
      { timeout: 5000 }
    );
  } else fallback();

  // (옵션) 탭 복귀 시 갱신
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) fallback(); });
  // setInterval(fallback, 10*60*1000); // 필요 시 주기 갱신
})();
</script>
</th:block>

</body>
</html>
