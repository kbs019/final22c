<html layout:decorate="~{layout/layout}">
<!-- 개인적으로 넣을 css 부분 추가 시작 -->
<th:block layout:fragment="css">
    <link rel="stylesheet" href="/css/content.css">
</th:block>

<!-- body 시작 -->
<div layout:fragment="content">
    <div class="productInfoWrap">
        <!-- 좌측의 향수 이미지 -->
        <div class="slideWrap">
            <img th:src="@{|${product.imgPath}${product.imgName}|}">
        </div>
        <!-- 우측의 상단에 존재하는  판매 / 구매 페이지 선택 버튼 -->
        <div class="productInfo">
            <!-- <div class="d-flex justify-content-center gap-2 mb-3">
                <button id="btn-buy" class="btn btn-outline-secondary active">구매</button>
                <button id="btn-sell" class="btn btn-outline-secondary">판매</button>
            </div> -->

            <!-- 내용 영역: 두 블록을 미리 렌더링해둠 -->
            <div id="product-detail">

                <!-- 구매 섹션: 기본 표시
                <div id="section-buy">
                    <th:block th:replace="~{main/content-buy :: buyFragment}"></th:block>
                </div>-->

                <!-- 판매 섹션: 기본은 숨김
                <div id="section-sell" style="display:none;">
                    <th:block th:replace="~{main/content-sell :: sellFragment}"></th:block>
                </div> -->
                <div class="my-3 py-3 border-bottom">
                    <h3>판매가 : <span th:text="${#numbers.formatInteger(product.sellPrice, 3, 'COMMA')}"></span> 원</h3>
                    <h5>정가 : <span th:text="${#numbers.formatInteger(product.price, 3, 'COMMA')}"></span> 원</h5>
                </div>
                <div class="my-3 py-3 border-bottom">
                    <div>
                        <h3 th:text="${product.name}"></h3>
                    </div>
                    <div th:text="${product.brand.brandName}"></div>
                </div>
                <div class="my-3 py-3 border-bottom">
                    <div>배송 정보</div>
                    <div>
                        <h5>배송비 3,000 원</h5>
                    </div>
                    <div>
                        <h5>예상 배송일 1~3 일</h5>
                    </div>
                </div>
                <div class="my-3 py-3 border-bottom">
                    <div>구매 확정 시, 결제금액의 5% 적립</div>
                    <form id="buy-form" method="post">
                        <!-- 상품번호 히든으로 전달 -->
                        <input type="hidden" name="id" th:value="${product.id}">

                        <!-- CSRF (Spring Security 사용 시) -->
                        <!-- <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"> -->

                        <div class="d-flex align-items-center gap-2" id="buy-qty-wrap">
                            <button type="button" class="btn btn-outline-secondary btn-sm btn-minus">-</button>

                            <!-- 수량 입력: min=1, max=재고 -->
                            <input type="number" class="form-control text-center qty-input" style="width:80px;"
                                name="quantity" th:attr="max=${product.count}" min="1" value="1">

                            <button type="button" class="btn btn-outline-secondary btn-sm btn-plus">+</button>

                            <div class="ms-3">
                                <div class="fw-semibold">합계: <span class="total-amount">0</span> 원</div>
                                <div class="text-muted small">적립 예정(5%): <span class="reward-amount">0</span> P</div>
                            </div>
                        </div>

                        <div class="mt-3 d-flex gap-2">
                            <!-- 장바구니 버튼 -->
                            <button type="submit" class="btn btn-outline-secondary" formaction="/cart/add"
                                formmethod="post" id="btn-add-cart">장바구니</button>

                            <!-- 바로결제(주문 요약/결제 페이지로) -->
                            <button type="submit" class="btn btn-secondary" formaction="/checkout/order"
                                formmethod="post" id="btn-buy-now">바로 결제</button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
    <!-- 하단의 향 소개 부분 시작 -->
    <div class="productDescription">
        <h2>향 소개</h2>
        <div>
            <span>부향률</span>
            <div>
                - <span th:text="${product.grade.gradeName}"></span>
            </div>
        </div>
        <div>
            <span>메인 어코드</span>
            <div>
                - <span th:text="${product.mainNote.mainNoteName}"></span>
            </div>
        </div>
        <div>
            <span>메인 노트</span>
            <div th:if="${product.singleNote != null}">
                - <span>싱글 노트 : </span>
                <span th:text="${product.singleNote}"></span>
            </div>
            <div th:if="${product.singleNote == null}">
                <div>
                    - <span>탑 노트 : </span>
                    <span th:text="${product.topNote}"></span>
                </div>
                <div>
                    - <span>미들 노트 : </span>
                    <span th:text="${product.middleNote}"></span>
                </div>
                <div>
                    - <span>베이스 노트 : </span>
                    <span th:text="${product.baseNote}"></span>
                </div>
            </div>
        </div>
        <div>
            <span>향 설명</span>
            <div>
                - <span th:text="${product.description}"></span>
            </div>
        </div>
        <!-- 하단의 향 소개 부분 끝 -->

        <!-- 리뷰 통계 부분 시작 -->
        <!-- 리뷰 통계 부분 끝 -->

        <!-- 리뷰 리스트 시작 -->
        <!-- <div>
            <h2>리뷰 리스트</h2>
            <div th:if="${#lists.isEmpty(product.reviewList)}">
                <h3>작성된 리뷰가 없습니다.</h3>
            </div>
            <div th:unless="${#lists.isEmpty(product.reviewList)}">
                <div th:each="review : ${product.reviewList}">
                    <div th:text="${review.gradePoint}"></div>
                    <div th:text="${review.content}"></div>
                    <div th:text="${review.user.username}"></div>
                    <span th:text="${#temporals.format( review.createDate, 'yy-MM-dd HH:mm' )}"></span>
                    <span th:text="${#lists.size(review.recs)}"></span>
                </div>
            </div>
        </div> -->
        <!-- 리뷰 리스트 끝 -->
    </div>

</div>
<!-- ajax 부분 설정 추가  -->
<th:block layout:fragment="script">
    <!-- 상단의 구매 / 판매 버튼 클릭하여 뷰 변경 -->
    <!-- <script>
        const btnBuy = document.getElementById('btn-buy');
        const btnSell = document.getElementById('btn-sell');
        const secBuy = document.getElementById('section-buy');
        const secSell = document.getElementById('section-sell');

        function show(type) {
            const isBuy = type === 'buy';
            secBuy.style.display = isBuy ? '' : 'none';
            secSell.style.display = isBuy ? 'none' : '';
            btnBuy.classList.toggle('active', isBuy);
            btnSell.classList.toggle('active', !isBuy);
        }

        btnBuy.addEventListener('click', () => show('buy'));
        btnSell.addEventListener('click', () => show('sell'));

        // URL로 진입 시 ?view=sell 지원하고 싶으면:
        (function initFromURL() {
            const v = new URL(location.href).searchParams.get('view');
            if (v === 'sell') show('sell');
        })();
    </script> -->

    <style>
        /* Chrome, Edge, Safari(웹킷 계열)에서 공통 스피너 제거 */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>

    <script>
        document.getElementById('buy-form').addEventListener('submit', (e) => {
            const btn = e.submitter;    // 눌린 버튼
            btn.disabled = true;        // 클릭 시 disabled 로 변경됨 - 더블클릭 방지
            setTimeout(() => btn.disabled = false, 2000);       // 2 초 뒤에 비활성화 해제
        });
    </script>

    <script th:inline="javascript">
        document.querySelectorAll('#buy-qty-wrap, #sell-qty-wrap').forEach(container => {
            // 컨테이너별 DOM 잡기
            const minusBtn = container.querySelector('.btn-minus');
            const plusBtn = container.querySelector('.btn-plus');
            const input = container.querySelector('.qty-input');
            const totalEl = container.querySelector('.total-amount');
            const rewardEl = container.querySelector('.reward-amount');

            // 컨테이너별 상수 (min/max는 인풋 속성에서, price는 구매/판매에 따라)
            const MIN = parseInt(input.getAttribute('min')) || 1;
            const MAX = parseInt(input.getAttribute('max')) || 0;
            const PRICE = /*[[${product.price}]]*/ 0;
            const SELLPRICE = /*[[${product.sellPrice}]]*/ 0;
            const RATE = 0.05; // 구매/판매 공통 5% 

            // 숫자 포맷
            const fmt = n => Number(n || 0).toLocaleString('ko-KR');

            // 값 범위 강제
            function clamp(v) {
                if (isNaN(v)) v = MIN;
                v = Math.floor(v);
                if (v < MIN) v = MIN;
                if (v > MAX) v = MAX;
                return v;
            }

            // 합계/적립 계산 + UI 반영
            function recalcAndRender(qty) {
                const total = SELLPRICE * qty;
                // 금액/포인트 반올림 규칙: 금액은 정수, 포인트는 내림(원단위 포인트 가정)
                const point = Math.floor(total * RATE);
                totalEl.textContent = fmt(total);
                rewardEl.textContent = fmt(point);
            }

            function updateUI() {
                const v = parseInt(input.value, 10);

                // 재고 0이면 모두 비활성화 + 값 0 고정
                if (MAX < 1) {
                    input.value = 0;
                    input.disabled = true;
                    minusBtn.disabled = true;
                    plusBtn.disabled = true;
                    // 재고 0 일 때, 장바구니 / 바로결제 버튼 불가능
                    document.querySelectorAll('#btn-add-cart, #btn-buy-now').forEach(b => b.disabled = true);
                    recalcAndRender(0);
                    return;
                }

                // 정상 재고
                input.value = clamp(v);
                minusBtn.disabled = (parseInt(input.value, 10) <= MIN);
                plusBtn.disabled = (parseInt(input.value, 10) >= MAX);
                // input 요소의 max 속성도 동기화(옵션)
                input.max = String(MAX);

                recalcAndRender(parseInt(input.value, 10));
                document.querySelectorAll('#btn-add-cart, #btn-buy-now').forEach(b => b.disabled = false);
            }

            // 초기 상태
            updateUI();

            // 버튼 이벤트
            minusBtn.addEventListener('click', function () {
                if (this.disabled) return;
                input.value = clamp(parseInt(input.value, 10) - 1);
                updateUI();
            });

            plusBtn.addEventListener('click', function () {
                if (this.disabled) return;
                input.value = clamp(parseInt(input.value, 10) + 1);
                updateUI();
            });

            // 직접 입력 시(붙여넣기 포함)도 범위 강제
            input.addEventListener('input', function () {
                this.value = this.value.replace(/[^0-9]/g, ''); // 숫자만
                updateUI();
            });

            // 포커스 아웃 시 최종 보정
            input.addEventListener('blur', function () {
                this.value = clamp(parseInt(this.value, 10));
                updateUI();
            });
        })();
    </script>
</th:block>

</html>