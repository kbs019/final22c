<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
  xmlns:sec="https://www.thymeleaf.org/extras/spring-security" layout:decorate="~{layout/layout}">

<head>
  <title>상품 상세</title>
  <!-- 개인적으로 넣을 css 부분 추가 시작 -->
  <th:block layout:fragment="css">
    <link rel="stylesheet" href="/css/content.css">

    <!-- 필요 클래스만 최소치로 보강(원하시면 content.css로 이동하세요) -->
    <style>
      /* 우측 날짜/액션 컬럼: 줄바꿈 최소화용 폭 */
      .review-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        min-width: 116px;
      }

      /* 액션 공통(크기/간격) - 요청대로 작게(11px) */
      .review-actions {
        line-height: 1;
      }

      .review-actions .ra-link,
      .review-actions .ra-box {
        font-size: 11px;
        margin-left: 8px;
      }

      /* 언더라인 호버형(흑/백/회색만) */
      .ra-link {
        appearance: none;
        background: none;
        border: 0;
        padding: 0;
        color: #666;
        text-decoration: none;
        cursor: pointer;
        background-image: linear-gradient(currentColor, currentColor);
        background-position: 0 100%;
        background-size: 0% 1px;
        background-repeat: no-repeat;
        transition: background-size .18s ease, color .18s ease;
      }

      .ra-link:hover {
        color: #111;
        background-size: 100% 1px;
      }

      .ra-danger {
        color: #b55;
      }

      .ra-danger:hover {
        color: #922;
        background-size: 100% 1px;
      }

      /* 좋아요 UI(무채색) */
      .like-wrap {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: #666;
      }

      .like-wrap .btn-like {
        appearance: none;
        border: 0;
        background: none;
        padding: 0 2px;
        cursor: pointer;
        line-height: 1;
        color: inherit;
        background-image: linear-gradient(currentColor, currentColor);
        background-position: 0 100%;
        background-size: 0% 1px;
        background-repeat: no-repeat;
        transition: background-size .18s ease, color .18s ease, transform .06s ease;
        font-size: 12px;
      }

      .like-wrap .btn-like:hover {
        color: #111;
        background-size: 100% 1px;
      }

      .like-wrap .btn-like:active {
        transform: scale(0.96);
      }

      .like-wrap .like-count {
        font-size: 12px;
        color: #444;
      }

      .like-wrap.is-liked {
        color: #111;
      }

      .like-wrap.is-liked .btn-like i {
        font-weight: 900;
      }
    </style>
  </th:block>
</head>

<body>
  <div layout:fragment="content">
    <div class="productInfoWrap">
      <!-- 좌측의 향수 이미지 -->
      <div class="slideWrap" th:classappend="${product.count == 0} ? ' soldout'">
        <img th:src="@{|${product.imgPath}${product.imgName}|}" alt="상품 이미지">
        <div class="overlay" aria-hidden="true"></div>
      </div>

      <!-- 우측 상품 정보 -->
      <div class="productInfo">
        <div id="product-detail">
          <div class="mb-3 py-3 border-bottom pd-head">
            <div class="brand-row bm-wrap">
              <a class="brand-link" th:href="@{|/main/brand/${product.brand.id}|}">
                <span th:text="${product.brand.brandName}"></span>
              </a>
              <button type="button" class="bm-btn" th:attr="aria-pressed=${zzimedByMe} ? 'true' : 'false',
                data-logged-in=${loggedIn}" th:title="${zzimedByMe} ? '관심 해제' : '관심 등록'">
                <svg class="bm-icon" viewBox="0 0 24 24" aria-hidden="true">
                  <!-- ↓ 흔한 북마크 실루엣(아래가 뾰족) -->
                  <path class="bm-shape" d="M6 3h12a1 1 0 0 1 1 1v16l-7-4-7 4V4a1 1 0 0 1 1-1z" />
                </svg>
              </button>
            </div>
            <div>
              <strong class="title" th:text="${product.name}"></strong>
            </div>

            <div class="mb-3 pt-3 price-area">
              <div>
                <strong class="rate"
                  th:text="${#numbers.formatDecimal(T(java.lang.Math).floor(product.discount), 0, 0)} + '%'"></strong>
                <span class="sale" th:text="${#numbers.formatInteger(product.sellPrice,3,'COMMA')} + '원'"></span>
              </div>
              <div>
                <del class="list" th:if="${product.price > product.sellPrice}"
                  th:text="${#numbers.formatInteger(product.price,3,'COMMA')} + '원'"></del>
              </div>
            </div>
          </div>

          <div class="mb-3 pb-3 border-bottom">
            <div>배송 정보</div><br>
            <div>
              <h5>배송비 3,000 원</h5>
            </div>
            <div>
              <h5>예상 배송일 3 일</h5>
            </div>
          </div>

          <div class="my-3 py-3 border-bottom">
            <div>구매 확정 시, 결제금액의 5% 적립</div>
            <form id="buy-form" method="post">
              <input type="hidden" name="id" th:value="${product.id}">

              <div class="d-flex align-items-center gap-2" id="buy-qty-wrap">
                <button type="button" class="btn btn-outline-secondary btn-sm btn-minus">-</button>

                <!-- 수량 입력: min=1, max=재고 -->
                <input type="number" class="form-control text-center qty-input" style="width:80px;" name="quantity"
                  th:attr="max=${product.count}" min="1" value="1">

                <button type="button" class="btn btn-outline-secondary btn-sm btn-plus">+</button>

                <div class="ms-3">
                  <div class="fw-semibold">합계: <span class="total-amount">0</span> 원</div>
                  <div class="text-muted small">적립 예정(5%): <span class="reward-amount">0</span> P</div>
                </div>
              </div>

              <div class="mt-3 d-flex gap-2">
                <button type="button" class="btn btn-outline-secondary" id="btn-add-cart">장바구니</button>
                <button type="submit" class="btn btn-secondary" formaction="/checkout/order" formmethod="post"
                  id="btn-buy-now">바로 결제</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- 장바구니 모달 -->
    <div class="modal fade" id="cartModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">장바구니 담기</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
          </div>
          <div class="modal-body">
            <div id="cartModalMsg">장바구니에 제품이 등록되었습니다.</div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-outline-secondary" data-bs-dismiss="modal">계속 쇼핑</button>
            <span sec:authorize="isAuthenticated()">
              <a th:href="@{/cart/list}" class="btn btn-secondary" id="goCartBtn">장바구니로 이동</a>
            </span>
            <span sec:authorize="isAnonymous()">
              <a th:href="@{/user/login}" class="btn btn-secondary" id="goCartBtn">로그인하기</a>
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- [신규] 찜 로그인 안내 모달 -->
    <div class="modal fade" id="zzimLoginModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">관심등록</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
          </div>
          <div class="modal-body">로그인이 되어있지 않습니다. 로그인하시겠습니까?</div>
          <div class="modal-footer">
            <button class="btn btn-outline-secondary" data-bs-dismiss="modal">취소</button>
            <a th:href="@{/user/login}" class="btn btn-secondary">로그인하기</a>
          </div>
        </div>
      </div>
    </div>

    <!-- 찜 등록 완료 모달(문구 정정) -->
    <div class="modal fade" id="zzimDoneModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">관심등록</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
          </div>
          <div class="modal-body">관심등록이 되었습니다.</div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">확인</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 찜 해제 확인 모달(기존 문구 유지) -->
    <div class="modal fade" id="zzimConfirmModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">관심등록 해제</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
          </div>
          <div class="modal-body">
            이미 관심등록이 된 상품입니다.<br>관심등록을 해제하시겠습니까?
          </div>
          <div class="modal-footer">
            <button class="btn btn-outline-secondary" data-bs-dismiss="modal">취소</button>
            <button class="btn btn-danger btn-confirm">확인</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 비로그인 전용: 바로결제 로그인 안내 모달 -->
    <div class="modal fade" id="loginRequiredModal" tabindex="-1" aria-hidden="true" sec:authorize="isAnonymous()">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">바로결제</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
          </div>
          <div class="modal-body">로그인이 필요합니다.</div>
          <div class="modal-footer">
            <button class="btn btn-outline-secondary" data-bs-dismiss="modal">계속 쇼핑</button>
            <a th:href="@{/user/login}" class="btn btn-secondary">로그인하기</a>
          </div>
        </div>
      </div>
    </div>

    <!-- 하단의 향 소개 -->
    <div class="productDescription">
      <h2>향 소개</h2>
      <br>
      <div>
        <span>[부향률]</span>
        <div>- <span th:text="${product.grade.gradeName}"></span></div>
      </div>
      <br>
      <div>
        <span>[메인 어코드]</span>
        <div>- <span th:text="${product.mainNote.mainNoteName}"></span></div>
      </div>
      <br>
      <div>
        <span>[메인 노트]</span>
        <div th:if="${product.singleNote != null}">
          - <span>싱글 노트 : </span><span th:text="${product.singleNote}"></span>
        </div>
        <div th:if="${product.singleNote == null}">
          <div>- <span>탑 노트 : </span><span th:text="${product.topNote}"></span></div>
          <div>- <span>미들 노트 : </span><span th:text="${product.middleNote}"></span></div>
          <div>- <span>베이스 노트 : </span><span th:text="${product.baseNote}"></span></div>
        </div>
      </div>
      <br>
      <div>
        <span>[향 설명]</span>
        <div>- <span th:text="${product.description}"></span></div>
      </div>

      <!-- 구매자 통계 (명수, 인구피라미드) -->
      <div id="buyer-stats" class="mt-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="mb-0">구매자 통계</h2>
          <div class="text-muted small">구매자 수(명) · 확정 수량 존재 기준</div>
        </div>

        <div class="card p-3">
          <div class="d-flex justify-content-between small text-muted mb-1">
            <span>WOMAN</span>
            <span>MAN</span>
          </div>
          <div style="height:300px;">
            <canvas id="buyerStatChart" aria-label="나이/성별별 구매자 수 피라미드 차트"></canvas>
          </div>
          <div id="buyerStatEmpty" class="text-muted small mt-2" style="display:none;">데이터가 없습니다.</div>
        </div>
      </div>

      <!-- 리뷰 섹션 -->
      <div id="review-section" class="mt-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="mb-0">Review</h2>
          <div>
            <a class="btn btn-outline-dark" th:href="@{|/main/etc/review/new?productId=${product.id}|}"
              sec:authorize="isAuthenticated()">리뷰 작성</a>

            <button class="btn btn-outline-dark" id="btn-review-need-login" sec:authorize="isAnonymous()">리뷰 작성</button>
          </div>
        </div>

        <!-- 평균 평점 -->
        <div class="mb-4">
          <div class="mb-2 fw-semibold">평균 평점</div>
          <div class="d-flex align-items-center gap-3">
            <div class="rating-bars" th:with="filled=${T(java.lang.Math).round(reviewAvg)}">
              <div th:each="i : ${#numbers.sequence(1,5)}" th:class="'cell' + (${i} <= ${filled} ? ' filled' : '')">
              </div>
            </div>
            <span th:text="${#numbers.formatDecimal(reviewAvg,1,1)}">0.0</span>
          </div>
        </div>

        <hr class="my-4">

        <!-- 전체 개수 + 정렬 -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="fw-semibold">전체 리뷰 <span th:text="${reviewCount}">0</span>개</div>
          <form method="get" th:action="@{|/main/content/${product.id}|}">
            <select class="form-select form-select-sm w-auto d-inline-block" name="sort" onchange="this.form.submit()">
              <option value="best" th:selected="${sort=='best'}">추천순</option>
              <option value="recent" th:selected="${sort=='recent'}">최신순</option>
            </select>
          </form>
        </div>

        <!-- 리스트 -->
        <div th:if="${#lists.isEmpty(reviews)}" class="text-muted py-4">작성된 리뷰가 없습니다.</div>

        <div th:each="rv : ${reviews}" class="py-4 border-top">
          <div class="d-flex align-items-start justify-content-between">
            <!-- 좌측: 메타 + 본문 -->
            <div class="d-flex align-items-start gap-3 flex-grow-1">
              <div class="review-meta">
                <div class="user-mask fw-semibold" th:with="len=${#strings.length(rv.userName)}"
                  th:text="${len <= 3} ? ${rv.userName} : ${#strings.substring(rv.userName,0,2)} + ${'*'.repeat(len-2)}">
                  kv**</div>

                <div class="rating-bars rating-bars--item mt-1" th:with="filled=${rv.rating}">
                  <div th:each="i : ${#numbers.sequence(1,5)}" th:class="'cell' + (${i} <= ${filled} ? ' filled' : '')">
                  </div>
                </div>
              </div>

              <!-- 본문 영역 -->
              <div class="flex-grow-1">
                <div class="mb-2 text-break" th:text="${rv.content}">내용</div>

                <!-- 좋아요 -->
                <div class="like-wrap" th:attr="data-id=${rv.reviewId}"
                  th:classappend="${likedReviewIds.contains(rv.reviewId)} ? ' is-liked'">
                  <button type="button" class="btn-like" aria-label="공감" title="공감" sec:authorize="isAuthenticated()">
                    <i class="fa-regular fa-thumbs-up"></i>
                  </button>
                  <button type="button" class="btn-like need-login" aria-label="로그인 필요" sec:authorize="isAnonymous()">
                    <i class="fa-regular fa-thumbs-up"></i>
                  </button>
                  <span class="like-count" th:text="${#lists.size(rv.likers)}">0</span>
                </div>
              </div>
            </div>

            <!-- 우측: 날짜 + 액션(날짜 바로 아래) — 날짜 위치는 그대로 유지 -->
            <div class="review-right ms-3">
              <div class="review-date text-muted small text-nowrap"
                th:text="${#temporals.format(rv.createDate, 'yy/MM/dd HH:mm')}">25/08/22 14:00</div>

              <!-- 로그인 + (소유자 또는 관리자)만 노출 -->
              <div class="review-actions mt-1" sec:authorize="isAuthenticated()"
                th:with="isOwner=${#authentication.name == rv.userName}">
                <div th:if="${isOwner or #authorization.expression('hasRole(''ADMIN'')')}">
                  <a class="ra-link" th:href="@{|/main/etc/review/${rv.reviewId}/edit?productId=${product.id}|}">수정</a>

                  <form th:action="@{|/main/etc/review/${rv.reviewId}/delete|}" method="post" class="d-inline"
                    onsubmit="return confirm('후기를 삭제하시겠습니까?');">
                    <input type="hidden" name="productId" th:value="${product.id}">
                    <button type="submit" class="ra-link ra-danger">삭제</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 리뷰 끝 -->
      </div>
    </div>
  </div>

  <!-- 스크립트 -->
  <th:block layout:fragment="script">
    <script th:inline="javascript">
      // === CSRF: 메타 태그 또는 Thymeleaf 인라인 값 둘 다 지원 ===
      function getCsrfPair() {
        const metaToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
        const metaHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
        const inlineHeader = /*[[${_csrf?.headerName}]]*/ 'X-CSRF-TOKEN';
        const inlineToken = /*[[${_csrf?.token}]]*/ '';
        return {
          header: metaHeader || inlineHeader || 'X-CSRF-TOKEN',
          token: metaToken || inlineToken || ''
        };
      }

      // 비로그인자가 '리뷰 작성' 클릭 시
      document.getElementById('btn-review-need-login')?.addEventListener('click', function () {
        alert('로그인이 필요한 서비스입니다.');
        location.href = '/user/login';
      });

      // Bootstrap Modal 준비
      const cartModalEl = document.getElementById('cartModal');
      const cartModal = cartModalEl ? new bootstrap.Modal(cartModalEl) : null;

      // 공통 DOM
      const btnAddCart = document.getElementById('btn-add-cart');
      const buyForm = document.getElementById('buy-form');
      const qtyInput = document.querySelector('.qty-input');
      const msgBox = document.getElementById('cartModalMsg');
      const badgeEl = document.getElementById('cart-count');

      // 상품 정보(템플릿 값 주입)
      const PRODUCT_ID = /*[[${product.id}]]*/ 0;
      const PRODUCT_NAME = /*[[${product.name}]]*/ '';
      const MAX_STOCK = parseInt(qtyInput?.getAttribute('max') || '0', 10);

      // 더블클릭 방지
      function withButtonLock(btn, fn) {
        if (!btn || btn.disabled) return;
        btn.disabled = true;
        Promise.resolve(fn()).finally(() => setTimeout(() => btn.disabled = false, 800));
      }

      // 장바구니 추가
      btnAddCart?.addEventListener('click', () => withButtonLock(btnAddCart, async () => {
        let qty = parseInt(qtyInput.value, 10);
        if (isNaN(qty) || qty < 1) qty = 1;
        if (MAX_STOCK > 0) qty = Math.min(qty, MAX_STOCK);

        // 1) 사전 카운트 체크 (UX)
        try {
          const cRes = await fetch('/cart/count', { credentials: 'same-origin' });
          const cData = await cRes.json().catch(() => ({}));
          if (Number(cData.count) >= 20) {
            if (msgBox) msgBox.textContent = '장바구니에 담을 수 있는 최대 수량은 20개 입니다.';
            cartModal?.show();
            return;
          }
        } catch (_) {
          // 사전 체크 실패해도 /cart/add 단계에서 다시 막힘
        }

        try {
          const res = await fetch('/cart/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ productId: PRODUCT_ID, qty })
          });

          const data = await res.json().catch(() => ({}));

          if (res.ok) {
            if (badgeEl && typeof data.count === 'number') {
              badgeEl.textContent = String(data.count);
            }
            if (msgBox) msgBox.textContent = `“${PRODUCT_NAME}” ${qty}개가 장바구니에 담겼습니다.`;
            cartModal?.show();
          } else {
            if (msgBox) msgBox.textContent = (data && data.message) ? data.message : '처리 중 오류가 발생했습니다.';
            cartModal?.show();
          }
        } catch (e) {
          if (msgBox) msgBox.textContent = '네트워크 오류가 발생했습니다.';
          cartModal?.show();
        }
      }));

      // 바로결제 더블클릭 방지
      document.getElementById('buy-form')?.addEventListener('submit', (e) => {
        const btn = e.submitter;
        if (!btn) return;
        btn.disabled = true;
        setTimeout(() => btn.disabled = false, 2000);
      });

      // 비로그인일 때 buy-form 제출 막고 모달 오픈
    </script>

    <script sec:authorize="isAnonymous()">
      (function () {
        const form = document.getElementById('buy-form');
        const modalEl = document.getElementById('loginRequiredModal');
        if (!form || !modalEl || typeof bootstrap === 'undefined') return;
        const modal = new bootstrap.Modal(modalEl);

        form.addEventListener('submit', function (e) {
          e.preventDefault();
          const btn = e.submitter;
          if (btn) { btn.disabled = true; setTimeout(() => btn.disabled = false, 1200); }
          modal.show();
        });
      })();
    </script>

    <script th:inline="javascript">
      // 수량/합계 계산
      document.querySelectorAll('#buy-qty-wrap').forEach(container => {
        const minusBtn = container.querySelector('.btn-minus');
        const plusBtn = container.querySelector('.btn-plus');
        const input = container.querySelector('.qty-input');
        const totalEl = container.querySelector('.total-amount');
        const rewardEl = container.querySelector('.reward-amount');

        const MIN = parseInt(input.getAttribute('min')) || 1;
        const MAX = parseInt(input.getAttribute('max')) || 0;
        const SELLPRICE = /*[[${product.sellPrice}]]*/ 0;
        const RATE = 0.05;

        const fmt = n => Number(n || 0).toLocaleString('ko-KR');
        function clamp(v) {
          if (isNaN(v)) v = MIN;
          v = Math.floor(v);
          if (v < MIN) v = MIN;
          if (v > MAX) v = MAX;
          return v;
        }
        function recalcAndRender(qty) {
          const total = SELLPRICE * qty;
          const point = Math.floor(total * RATE);
          totalEl.textContent = fmt(total);
          rewardEl.textContent = fmt(point);
        }
        function updateUI() {
          const v = parseInt(input.value, 10);
          if (MAX < 1) {
            input.value = 0;
            input.disabled = true;
            minusBtn.disabled = true;
            plusBtn.disabled = true;
            document.querySelectorAll('#btn-add-cart, #btn-buy-now').forEach(b => b.disabled = true);
            recalcAndRender(0);
            return;
          }
          input.value = clamp(v);
          minusBtn.disabled = (parseInt(input.value, 10) <= MIN);
          plusBtn.disabled = (parseInt(input.value, 10) >= MAX);
          input.max = String(MAX);
          recalcAndRender(parseInt(input.value, 10));
          document.querySelectorAll('#btn-add-cart, #btn-buy-now').forEach(b => b.disabled = false);
        }
        updateUI();
        minusBtn.addEventListener('click', function () {
          if (this.disabled) return;
          input.value = clamp(parseInt(input.value, 10) - 1);
          updateUI();
        });
        plusBtn.addEventListener('click', function () {
          if (this.disabled) return;
          input.value = clamp(parseInt(input.value, 10) + 1);
          updateUI();
        });
        input.addEventListener('input', function () {
          this.value = this.value.replace(/[^0-9]/g, '');
          updateUI();
        });
        input.addEventListener('blur', function () {
          this.value = clamp(parseInt(this.value, 10));
          updateUI();
        });
      });

      // ===== 좋아요(공감) 토글 =====
      // 비로그인: 로그인 안내
      document.querySelectorAll('.like-wrap .need-login')?.forEach(b => {
        b.addEventListener('click', () => {
          alert('로그인이 필요한 서비스입니다.');
          location.href = '/user/login';
        });
      });

      // 로그인: Ajax 토글
      document.querySelectorAll('.like-wrap .btn-like:not(.need-login)')?.forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const wrap = e.currentTarget.closest('.like-wrap');
          if (!wrap) return;
          const id = wrap.getAttribute('data-id');
          const { header, token } = getCsrfPair();

          try {
            const res = await fetch(`/main/etc/review/${id}/like`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                ...(token ? { [header]: token } : {})   // CSRF 헤더
              },
              credentials: 'same-origin'
            });

            // 권한/세션 만료 처리
            if (res.status === 401 || res.status === 403) {
              alert('로그인이 필요합니다.');
              location.href = '/user/login';
              return;
            }
            const ct = res.headers.get('content-type') || '';
            if (!ct.includes('application/json')) {
              alert('세션이 만료되었습니다. 다시 로그인해 주세요.');
              location.href = '/user/login';
              return;
            }

            const data = await res.json();
            if (res.ok) {
              wrap.classList.toggle('is-liked', !!data.liked);
              const cnt = wrap.querySelector('.like-count');
              if (cnt) cnt.textContent = String(data.count ?? 0);
            } else {
              alert(data?.message || `처리 중 오류가 발생했습니다. [${res.status}]`);
            }
          } catch (err) {
            alert('네트워크 오류가 발생했습니다.');
          }
        });
      });
    </script>

    <script th:inline="javascript">
    (function(){
      const bmBtn = document.querySelector('.bm-btn');
      if(!bmBtn) return;

      const PRODUCT_ID = /*[[${product.id}]]*/ 0;

      const zzimLoginModal  = document.getElementById('zzimLoginModal');
      const confirmModalEl  = document.getElementById('zzimConfirmModal');
      const doneModalEl     = document.getElementById('zzimDoneModal');

      const loginModal  = zzimLoginModal ? new bootstrap.Modal(zzimLoginModal) : null;
      const confirmModal= confirmModalEl ? new bootstrap.Modal(confirmModalEl) : null;
      const doneModal   = doneModalEl ? new bootstrap.Modal(doneModalEl) : null;

      function withLock(btn, fn){
        if(!btn || btn.disabled) return;
        btn.disabled = true;
        return Promise.resolve(fn()).finally(()=> setTimeout(()=> btn.disabled=false, 600));
      }

      // 공통 fetch(JSON) + CSRF
      async function fetchJSON(url, opt={}){
        const { header, token } = getCsrfPair();
        const base = {
          credentials:'same-origin',
          headers: { 'Accept':'application/json', ...(opt.body ? {'Content-Type':'application/json'}:{}), ...(token ? {[header]:token}:{}) }
        };
        const res = await fetch(url, {...base, ...opt});
        if(res.status===401 || res.status===403){ throw { auth:true }; }
        const ct = res.headers.get('content-type') || '';
        const data = ct.includes('application/json') ? await res.json() : {};
        if(!res.ok) throw { status:res.status, data };
        return data;
      }

      // 서버에서 실시간 상태 확인(= product_zzimers 테이블 조회 반영)
      const checkState = ()=> fetchJSON(`/zzim/state?productId=${PRODUCT_ID}`, { method:'GET' })
                                .then(d => !!d.zzimed);

      const addZzim    = ()=> fetchJSON(`/zzim/add`,    { method:'POST', body: JSON.stringify({ productId: PRODUCT_ID })});
      const removeZzim = ()=> fetchJSON(`/zzim/remove?productId=${PRODUCT_ID}`, { method:'POST' });

      bmBtn.addEventListener('click', ()=> withLock(bmBtn, async ()=>{
        try {
          // 서버에 실제 상태 질의 (비로그인 시 401 → catch에서 처리)
          const already = await checkState();

          if (already) {
            confirmModal?.show();
            const okBtn = confirmModalEl?.querySelector('.btn-confirm');
            const handler = async ()=>{
              await withLock(okBtn, async ()=>{
                await removeZzim();
                bmBtn.setAttribute('aria-pressed','false');
                bmBtn.title = '관심 등록';
                confirmModal?.hide();
              });
            };
            okBtn?.addEventListener('click', handler, { once:true });
          } else {
            await addZzim();
            bmBtn.setAttribute('aria-pressed','true');
            bmBtn.title = '관심 해제';
            doneModal?.show();
          }
        } catch (e) {
          if (e && e.auth) { loginModal?.show(); return; }  // 401/403
          alert('처리 중 오류가 발생했습니다.');
        }
      }));
    })();
    </script>

    <!-- Chart.js + 구매자 피라미드 렌더 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script th:inline="javascript">
      (function() {
        const productId = /*[[${product.id}]]*/ 0;
        const api = `/main/api/product/${productId}/buyer-stats`;
        const $canvas = document.getElementById('buyerStatChart');
        const $empty  = document.getElementById('buyerStatEmpty');
        if (!$canvas) return;

        // 중앙 라벨 + 중앙 여백(막대 잘라내기) 플러그인
        const centerPlugin = {
          id: 'pyramidCenter',
          beforeDatasetsDraw(chart) {
            const {ctx, chartArea} = chart;
            const midX = (chartArea.left + chartArea.right) / 2;
            const gutter = 64; // 중앙 여백(px) — 필요시 조절
            const leftW  = midX - gutter/2 - chartArea.left;
            const rightW = chartArea.right - (midX + gutter/2);

            ctx.save();
            ctx.beginPath();
            // 왼쪽 영역
            ctx.rect(chartArea.left, chartArea.top, Math.max(0,leftW), chartArea.bottom - chartArea.top);
            // 오른쪽 영역
            ctx.rect(midX + gutter/2, chartArea.top, Math.max(0,rightW), chartArea.bottom - chartArea.top);
            ctx.clip(); // 막대는 중앙여백을 비우고 그려짐
          },
          afterDatasetsDraw(chart) {
            const {ctx, chartArea, scales} = chart;
            const y = scales.y;
            const midX = (chartArea.left + chartArea.right) / 2;

            ctx.restore(); // 클리핑 해제

            // (요청) 중앙 세로선 제거: 아무 것도 그리지 않음

            // 가운데 축 라벨(10대/20대 …)
            const labels = chart.data.labels || [];
            ctx.save();
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#333';
            ctx.font = getComputedStyle($canvas).font || '12px system-ui';
            labels.forEach((lab, i) => {
              const py = y.getPixelForTick(i);
              ctx.fillText(lab, midX, py);
            });
            ctx.restore();
          }
        };

        fetch(api, { credentials: 'same-origin' })
          .then(r => r.json())
          .then(data => {
            const labels = data?.labels || [];
            const ds = data?.datasets || [];
            const male   = (ds.find(v => v.label === '남성')?.data || []).map(Number);
            const female = (ds.find(v => v.label === '여성')?.data || []).map(Number);

            const hasData = (male.concat(female)).some(v => v > 0);
            if (!hasData) { $empty.style.display = 'block'; return; }

            const femaleNeg = female.map(v => -v);
            const maxAbs = Math.max(...male.map(Math.abs), ...femaleNeg.map(Math.abs), 1);

            new Chart($canvas.getContext('2d'), {
              type: 'bar',
              data: {
                labels,
                datasets: [
                  { label: '여성', data: femaleNeg, stack: 'gender' },
                  { label: '남성', data: male,      stack: 'gender' }
                ]
              },
              options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { position: 'top' },
                  tooltip: {
                    callbacks: {
                      label: (ctx) => {
                        const v = Math.abs(ctx.raw ?? 0);
                        return `${ctx.dataset.label}: ${v.toLocaleString('ko-KR')}명`;
                      }
                    }
                  }
                },
                scales: {
                  y: {
                    stacked: true,
                    ticks: { display: false },
                    grid: {
                      display: false,       // 가로선 전부 제거
                      drawBorder: false     // 왼쪽 세로선 제거
                    }
                  },
                  x: {
                    stacked: true,
                    min: -maxAbs,
                    max:  maxAbs,
                    grid: {
                      drawBorder: true,         // 맨 아래 축선은 표시
                      drawOnChartArea: false,   // 차트 안쪽 세로/가로선은 전부 제거
                      color: '#bbb'             // 아래 축선 색상
                    },
                    ticks: {
                      callback: (v) => Math.abs(v).toLocaleString('ko-KR')
                    }
                  }
                }
              },
              plugins: [centerPlugin]
            });
          })
          .catch(() => { if ($empty) $empty.style.display = 'block'; });
      })();
    </script>


  </th:block>
</body>

</html>
