<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/layout}">

<!-- í˜ì´ì§€ ì „ìš© CSS -->
<th:block layout:fragment="css">
  <style>
    /* ì¹´ë“œ ì´ë¯¸ì§€ ë¹„ìœ¨ ê³ ì • */
    .product-thumb { aspect-ratio: 1/1; object-fit: cover; width: 100%; }
    .card.position-relative { position: relative; }
    .card .ratio { position: relative; z-index: 0; overflow: hidden; }
    /* stretched-link ì˜¤ë²„ë ˆì´ê°€ ì´ë¯¸ì§€ ìœ„ì— ì˜¤ë„ë¡ */
    .card .stretched-link::after { z-index: 10; }
    /* ê´€ì‹¬(ë¶ë§ˆí¬) ë²„íŠ¼ ì˜¤ë²„ë ˆì´ */
    .wish-btn { position: absolute; top: .5rem; right: .5rem; }
    .wish-btn .icon { font-size: 1.25rem; }
    /* ì¢Œì¸¡ ê°€ì´ë“œ/ë©”ëª¨ ì‚¬ì´ë“œ */
    .list-sidebar { position: sticky; top: 88px; }
    /* ê²°ê³¼ ì—†ìŒ ì˜ì—­ */
    .empty { padding: 4rem 0; text-align: center; color: var(--bs-secondary-color); }
  </style>
</th:block>

<div layout:fragment="content">
  <main class="container py-4">

    <!-- ìƒë‹¨ ê²€ìƒ‰ì˜ì—­ -->
    <section class="mb-4">
      <div class="d-flex align-items-center justify-content-between gap-3">

        <!-- ê²€ìƒ‰: /main/list ê³ ì • + í˜„ì¬ í•„í„° ìœ ì§€ -->
        <form class="flex-grow-1" th:action="@{/main/list}" method="get" role="search" aria-label="í†µí•©ê²€ìƒ‰(ë¸Œëœë“œ+ìƒí’ˆëª…)">
          <div class="input-group input-group-lg">
            <input type="search" name="q" th:value="${param.q}" class="form-control"
                   placeholder="ë¸Œëœë“œ/ìƒí’ˆëª…ì„ ê²€ìƒ‰í•˜ì„¸ìš”" autocomplete="off">
            <button class="btn btn-outline-secondary" type="submit" aria-label="ê²€ìƒ‰">ğŸ”</button>
          </div>

          <!-- í˜„ì¬ í•„í„° ë™ì‹œ ì „ì†¡(ìœ ì§€) -->
          <th:block th:if="${param.grades != null}" th:each="g : ${param.grades}">
            <input type="hidden" name="grades" th:value="${g}">
          </th:block>
          <th:block th:if="${param.accords != null}" th:each="a : ${param.accords}">
            <input type="hidden" name="accords" th:value="${a}">
          </th:block>
          <th:block th:if="${param.brands != null}" th:each="b : ${param.brands}">
            <input type="hidden" name="brands" th:value="${b}">
          </th:block>
          <th:block th:if="${param.volumes != null}" th:each="v : ${param.volumes}">
            <input type="hidden" name="volumes" th:value="${v}">
          </th:block>
        </form>

        <!-- ê²°ê³¼ ìˆ˜ í‘œì‹œ -->
        <div class="text-nowrap ms-2">
          <span class="small text-secondary">ê²€ìƒ‰ê²°ê³¼</span>
          <strong th:text="${#lists.isEmpty(list) ? 0 : #lists.size(list)}">0</strong>
        </div>
      </div>
    </section>

    <div class="row g-4">
      <!-- ì¢Œì¸¡ ì‚¬ì´ë“œ: í•„í„° -->
      <aside class="col-lg-3 d-none d-lg-block">
        <div class="list-sidebar">
          <!-- í•„í„° í¼ -->
          <form th:action="@{/main/list}" method="get" id="filterForm" class="card mb-3">
            <div class="card-body">
              <h6 class="card-title mb-3">í•„í„°</h6>

              <!-- í˜„ì¬ ê²€ìƒ‰ì–´ ë™ì‹œ ì „ì†¡ -->
              <input type="hidden" name="q" th:value="${param.q}"/>

              <!-- ë¸Œëœë“œ -->
              <div class="mb-3">
                <div class="small fw-semibold mb-2">ë¸Œëœë“œ</div>
                <div class="vstack gap-2">
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="brands" value="í‚¬ë¦¬ì•ˆ"
                           th:checked="${param.brands != null and #lists.contains(param.brands, 'í‚¬ë¦¬ì•ˆ')}">
                    <span class="form-check-label">í‚¬ë¦¬ì•ˆ</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="brands" value="ë©”ì¢… ë§ˆë¥´ì§€ì—˜ë¼"
                           th:checked="${param.brands != null and #lists.contains(param.brands, 'ë©”ì¢… ë§ˆë¥´ì§€ì—˜ë¼')}">
                    <span class="form-check-label">ë©”ì¢… ë§ˆë¥´ì§€ì—˜ë¼</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="brands" value="í†° í¬ë“œ"
                           th:checked="${param.brands != null and #lists.contains(param.brands, 'í†° í¬ë“œ')}">
                    <span class="form-check-label">í†° í¬ë“œ</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="brands" value="ì•„ì¿ ì•„ ë”” íŒŒë¥´ë§ˆ"
                           th:checked="${param.brands != null and #lists.contains(param.brands, 'ì•„ì¿ ì•„ ë”” íŒŒë¥´ë§ˆ')}">
                    <span class="form-check-label">ì•„ì¿ ì•„ ë”” íŒŒë¥´ë§ˆ</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="brands" value="ë°”ì´ë ˆë„"
                           th:checked="${param.brands != null and #lists.contains(param.brands, 'ë°”ì´ë ˆë„')}">
                    <span class="form-check-label">ë°”ì´ë ˆë„</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="brands" value="í”„ë ˆë°ë¦­ ë§"
                           th:checked="${param.brands != null and #lists.contains(param.brands, 'í”„ë ˆë°ë¦­ ë§')}">
                    <span class="form-check-label">í”„ë ˆë°ë¦­ ë§</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="brands" value="ë¥´ ë¼ë³´"
                           th:checked="${param.brands != null and #lists.contains(param.brands, 'ë¥´ ë¼ë³´')}">
                    <span class="form-check-label">ë¥´ ë¼ë³´</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="brands" value="ìƒ¤ë„¬"
                           th:checked="${param.brands != null and #lists.contains(param.brands, 'ìƒ¤ë„¬')}">
                    <span class="form-check-label">ìƒ¤ë„¬</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="brands" value="ë”¥í‹°í¬"
                           th:checked="${param.brands != null and #lists.contains(param.brands, 'ë”¥í‹°í¬')}">
                    <span class="form-check-label">ë”¥í‹°í¬</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="brands" value="ì¡° ë§ë¡ "
                           th:checked="${param.brands != null and #lists.contains(param.brands, 'ì¡° ë§ë¡ ')}">
                    <span class="form-check-label">ì¡° ë§ë¡ </span>
                  </label>
                </div>
              </div>

              <!-- ê·¸ë ˆì´ë“œ -->
              <div class="mb-3">
                <div class="small fw-semibold mb-2">ê·¸ë ˆì´ë“œ</div>
                <div class="vstack gap-2">
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="grades"
                           value="í¼í“¸"
                           th:checked="${param.grades != null and #lists.contains(param.grades, 'í¼í“¸')}">
                    <span class="form-check-label">í¼í“¸</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="grades"
                           value="ì˜¤ ë“œ ì½”ë¡±"
                           th:checked="${param.grades != null and #lists.contains(param.grades, 'ì˜¤ ë“œ ì½”ë¡±')}">
                    <span class="form-check-label">ì˜¤ ë“œ ì½”ë¡±</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="grades"
                           value="ì˜¤ ë“œ í¼í“¸"
                           th:checked="${param.grades != null and #lists.contains(param.grades, 'ì˜¤ ë“œ í¼í“¸')}">
                    <span class="form-check-label">ì˜¤ ë“œ í¼í“¸</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="grades"
                           value="ì˜¤ ë“œ ëšœì™ˆë ›"
                           th:checked="${param.grades != null and #lists.contains(param.grades, 'ì˜¤ ë“œ ëšœì™ˆë ›')}">
                    <span class="form-check-label">ì˜¤ ë“œ ëšœì™ˆë ›</span>
                  </label>
                </div>
              </div>

              <!-- ë©”ì¸ ì–´ì½”ë“œ -->
              <div class="mb-1">
                <div class="small fw-semibold mb-2">ë©”ì¸ ì–´ì½”ë“œ</div>
                <div class="vstack gap-2">
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="accords"
                           value="ì‹œíŠ¸ëŸ¬ìŠ¤"
                           th:checked="${param.accords != null and #lists.contains(param.accords, 'ì‹œíŠ¸ëŸ¬ìŠ¤')}">
                    <span class="form-check-label">ì‹œíŠ¸ëŸ¬ìŠ¤</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="accords"
                           value="ìŠ¤íŒŒì´ì‹œ"
                           th:checked="${param.accords != null and #lists.contains(param.accords, 'ìŠ¤íŒŒì´ì‹œ')}">
                    <span class="form-check-label">ìŠ¤íŒŒì´ì‹œ</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="accords"
                           value="ìš°ë””"
                           th:checked="${param.accords != null and #lists.contains(param.accords, 'ìš°ë””')}">
                    <span class="form-check-label">ìš°ë””</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="accords"
                           value="í”Œë¡œë„"
                           th:checked="${param.accords != null and #lists.contains(param.accords, 'í”Œë¡œë„')}">
                    <span class="form-check-label">í”Œë¡œë„</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="accords"
                           value="í—ˆë²Œ"
                           th:checked="${param.accords != null and #lists.contains(param.accords, 'í—ˆë²Œ')}">
                    <span class="form-check-label">í—ˆë²Œ</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="accords"
                           value="í”„ë£¨í‹°"
                           th:checked="${param.accords != null and #lists.contains(param.accords, 'í”„ë£¨í‹°')}">
                    <span class="form-check-label">í”„ë£¨í‹°</span>
                  </label>
                </div>
              </div>

              <!-- ìš©ëŸ‰ -->
              <div class="mb-1">
                <div class="small fw-semibold mb-2">ìš©ëŸ‰</div>
                <div class="vstack gap-2">
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="volumes" value="15ml"
                           th:checked="${param.volumes != null and #lists.contains(param.volumes, '15ml')}">
                    <span class="form-check-label">15ml</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="volumes" value="30ml"
                           th:checked="${param.volumes != null and #lists.contains(param.volumes, '30ml')}">
                    <span class="form-check-label">30ml</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="volumes" value="50ml"
                           th:checked="${param.volumes != null and #lists.contains(param.volumes, '50ml')}">
                    <span class="form-check-label">50ml</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="volumes" value="75ml"
                           th:checked="${param.volumes != null and #lists.contains(param.volumes, '75ml')}">
                    <span class="form-check-label">75ml</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="volumes" value="100ml"
                           th:checked="${param.volumes != null and #lists.contains(param.volumes, '100ml')}">
                    <span class="form-check-label">100ml</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="volumes" value="150ml"
                           th:checked="${param.volumes != null and #lists.contains(param.volumes, '150ml')}">
                    <span class="form-check-label">150ml</span>
                  </label>
                </div>
              </div>
            </div>

            <div class="card-footer bg-body text-end">
              <button type="submit" class="btn btn-sm btn-primary">ì ìš©</button>
              <a th:href="@{/main/list}" class="btn btn-sm btn-outline-secondary">ì´ˆê¸°í™”</a>
            </div>
          </form>
        </div>
      </aside>

      <!-- ë¦¬ìŠ¤íŠ¸ ì˜ì—­ -->
      <section class="col-lg-9">
        <!-- ê²°ê³¼ ì—†ìŒ -->
        <div th:if="${#lists.isEmpty(list)}" class="empty border rounded bg-body">
          í‘œì‹œí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.
        </div>

        <!-- ê²°ê³¼ ê·¸ë¦¬ë“œ -->
        <div th:unless="${#lists.isEmpty(list)}"
             class="row row-cols-2 row-cols-md-3 row-cols-xl-4 g-3 g-md-4">
          <!-- ì¹´ë“œ -->
          <div class="col" th:each="product : ${list}">
            <div class="card h-100 position-relative shadow-sm">

              <!-- ê´€ì‹¬(ë¶ë§ˆí¬) ë²„íŠ¼ -->
              <div class="wish-btn">
                <!-- ë¡œê·¸ì¸ ìƒíƒœ -->
                <!--
                <button type="button"
                        class="btn btn-light border-subtle rounded-circle shadow-sm btn-sm"
                        sec:authorize="isAuthenticated()"
                        th:classappend="${product.wished} ? ' active' : ''"
                        th:attr="data-id=${product.id}"
                        aria-pressed="false" title="ê´€ì‹¬ ë“±ë¡/í•´ì œ">
                  <span class="icon" th:text="${product.wished} ? 'ğŸ”–' : 'ğŸ·ï¸'">ğŸ”–</span>
                </button>
                -->
                <!-- ë¹„ë¡œê·¸ì¸ ì•ˆë‚´ -->
                <button type="button"
                        class="btn btn-light border-subtle rounded-circle shadow-sm btn-sm"
                        sec:authorize="isAnonymous()"
                        data-bs-toggle="tooltip" data-bs-title="ë¡œê·¸ì¸ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤">
                  <span class="icon">ğŸ·ï¸</span>
                </button>
              </div>

              <div class="ratio ratio-1x1">
                <img class="product-thumb rounded-top"
                     th:src="${product.imgPath != null and product.imgName != null ? (product.imgPath + product.imgName) : '/img/noimg.png'}"
                     th:alt="${product.name}">
              </div>

              <!-- ë³¸ë¬¸ -->
              <div class="card-body">
                <div class="small text-secondary text-truncate" th:text="${product.brand.brandName}">Brand</div>
                <h6 class="card-title mb-1 text-truncate" th:text="${product.name}">ìƒí’ˆëª…</h6>
                <div class="small text-secondary">
                  <span th:text="${product.grade.gradeName}">ë“±ê¸‰</span>
                  Â· <span th:text="${product.mainNote.mainNoteName}">ë©”ì¸ë…¸íŠ¸</span>
                  Â· <span th:text="${product.volume.volumeName}">ìš©ëŸ‰</span>
                </div>
                <div class="fw-semibold mt-1"
                     th:text="${product.sellprice != null ? #numbers.formatInteger(product.sellprice, 3, 'COMMA') + 'ì›' : '-'}">00,000ì›</div>
              </div>

              <!-- ì¹´ë“œ ì „ì²´ í´ë¦­ -->
              <a class="stretched-link"
                 th:href="@{/main/content/{id}(id=${product.id})}"
                 th:aria-label="|${product.name} ìƒì„¸ë¡œ ì´ë™|"></a>
            </div>
          </div>
          <!-- /ì¹´ë“œ -->
        </div>
      </section>
    </div>
  </main>
</div>

<!-- í˜ì´ì§€ ì „ìš© ìŠ¤í¬ë¦½íŠ¸ -->
<th:block layout:fragment="script">
  <script th:inline="javascript">
    // ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ ìë™ ì œì¶œ â†’ /main/list
    document.querySelectorAll('#filterForm input[type="checkbox"]').forEach(chk => {
      chk.addEventListener('change', () => {
        document.getElementById('filterForm').submit();
      });
    });

    // Bootstrap Tooltip (ë¹„ë¡œê·¸ì¸ ì•ˆë‚´)
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    [...tooltipTriggerList].forEach(el => new bootstrap.Tooltip(el));

    // CSRF (Spring Security ì‚¬ìš© ì‹œ)
    /*<![CDATA[*/
    const csrfHeader = /*[[${_csrf?.headerName}]]*/ 'X-CSRF-TOKEN';
    const csrfToken  = /*[[${_csrf?.token}]]*/ '';
    /*]]>*/

    // ê´€ì‹¬ í† ê¸€(Ajax) â€” product ê¸°ì¤€
    $(document).on('click', '.wish-btn [sec\\:authorize="isAuthenticated()"], .wish-btn button[sec\\:authorize]', function () {
      const $btn = $(this);
      const productId = $btn.data('id');
      if (!productId) return;

      $.ajax({
        url: /*[@{/wish/toggle}]*/ '/wish/toggle',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ productId: productId }),
        beforeSend: function (xhr) {
          if (csrfToken) xhr.setRequestHeader(csrfHeader, csrfToken);
        }
      }).done(function (res) {
        const wished = !!(res && res.wished);
        $btn.toggleClass('active', wished);
        $btn.find('.icon').text(wished ? 'ğŸ”–' : 'ğŸ·ï¸');
      }).fail(function () {
        alert('ìš”ì²­ì„ ì²˜ë¦¬í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
      });
    });
  </script>
</th:block>
</html>
