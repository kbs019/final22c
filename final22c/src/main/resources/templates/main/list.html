<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
  <title>22°C</title>
  <th:block layout:fragment="css">
    <!-- 페이지 전용 CSS -->
    <link rel="stylesheet" th:href="@{/css/list.css}">
  </th:block>
</head>


<body>
<th:block layout:fragment="content">

  <div class="row g-4">

    <!-- 좌측 필터(Sticky) -->
    <aside class="col-12 col-md-3 col-lg-2">
      <div class="filter-panel position-sticky" style="top: 1rem;">
        <h6 class="mb-3 fw-semibold">필터</h6>

        <div class="accordion" id="filterAccordion">

          <!-- Brand -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingBrand">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBrand" aria-expanded="false" aria-controls="collapseBrand">
                Brand
              </button>
            </h2>
            <div id="collapseBrand" class="accordion-collapse collapse" aria-labelledby="headingBrand" data-bs-parent="#filterAccordion">
              <div class="accordion-body p-2">
                <div class="filter-list">
                  <div class="form-check" th:each="b : ${brands}">
                    <input class="form-check-input filter-check" type="checkbox" name="brand"
                           th:id="${'brand-'+b['id']}" th:value="${b['id']}">
                    <label class="form-check-label small" th:for="${'brand-'+b['id']}">
                      <span th:text="${b['name']}">Brand</span>
                      <span class="text-secondary" th:text="' (' + ${b['count']} + ')'"> (0)</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Grade -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingGrade">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGrade" aria-expanded="false" aria-controls="collapseGrade">
                Grade
              </button>
            </h2>
            <div id="collapseGrade" class="accordion-collapse collapse" aria-labelledby="headingGrade" data-bs-parent="#filterAccordion">
              <div class="accordion-body p-2">
                <div class="filter-list">
                  <div class="form-check" th:each="g : ${grades}">
                    <input class="form-check-input filter-check" type="checkbox" name="grade"
                           th:id="${'grade-'+g['id']}" th:value="${g['id']}">
                    <label class="form-check-label small" th:for="${'grade-'+g['id']}">
                      <span th:text="${g['name']}">Grade</span>
                      <span class="text-secondary" th:text="' (' + ${g['count']} + ')'"> (0)</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Main Note -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingMainNote">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMainNote" aria-expanded="false" aria-controls="collapseMainNote">
                Main Note
              </button>
            </h2>
            <div id="collapseMainNote" class="accordion-collapse collapse" aria-labelledby="headingMainNote" data-bs-parent="#filterAccordion">
              <div class="accordion-body p-2">
                <div class="filter-list">
                  <div class="form-check" th:each="m : ${mainNotes}">
                    <input class="form-check-input filter-check" type="checkbox" name="mainNote"
                           th:id="${'mainNote-'+m['id']}" th:value="${m['id']}">
                    <label class="form-check-label small" th:for="${'mainNote-'+m['id']}">
                      <span th:text="${m['name']}">MainNote</span>
                      <span class="text-secondary" th:text="' (' + ${m['count']} + ')'"> (0)</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Volume -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingVolume">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVolume" aria-expanded="false" aria-controls="collapseVolume">
                Volume
              </button>
            </h2>
            <div id="collapseVolume" class="accordion-collapse collapse" aria-labelledby="headingVolume" data-bs-parent="#filterAccordion">
              <div class="accordion-body p-2">
                <div class="filter-list">
                  <div class="form-check" th:each="v : ${volumes}">
                    <input class="form-check-input filter-check" type="checkbox" name="volume"
                           th:id="${'volume-'+v['id']}" th:value="${v['id']}">
                    <label class="form-check-label small" th:for="${'volume-'+v['id']}">
                      <span th:text="${v['name']}">Volume</span>
                      <span class="text-secondary" th:text="' (' + ${v['count']} + ')'"> (0)</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>

        <div class="d-grid mt-3">
          <button id="btn-reset" class="btn btn-outline-dark btn-sm">필터 초기화</button>
        </div>
      </div>
    </aside>

    <!-- 중앙 리스트 -->
    <section class="col-12 col-md-9 col-lg-10">

      <!-- 결과영역(Fragment로 교체) -->
      <div id="list-body" th:fragment="listBody">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <div class="small text-secondary">검색결과 <span id="result-count" th:text="${total}">0</span>개</div>
        </div>

        <div id="product-grid" class="row row-cols-2 row-cols-sm-3 row-cols-lg-4 g-3">
          <div class="col" th:each="p : ${products}">
            <div class="card h-100 shadow-sm" style="border-radius: 1rem;">
              <img th:src="${p['imgUrl']}" th:alt="${p['name']}" class="w-100" style="aspect-ratio:3/4;object-fit:cover;border-top-left-radius:1rem;border-top-right-radius:1rem;">
              <div class="card-body p-2">
                <div class="small text-secondary" th:text="${p['brandName']}">Brand</div>
                <div class="fw-semibold text-truncate" th:title="${p['name']}" th:text="${p['name']}">Name</div>
                <div class="d-flex justify-content-between align-items-center mt-1">
                  <div class="fw-bold" th:text="${#numbers.formatInteger(p['sellPrice'],3,'COMMA')} + '원'">0원</div>
                  <a class="stretched-link" th:href="@{'/main/content/' + ${p['id']}}"></a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </section>

  </div>

</th:block>

<!-- jQuery만 사용 -->
<th:block layout:fragment="script">
<script>
(function(){

  // jQuery 로드될 때까지 기다렸다가 초기화
  function waitForjQuery(init){
    if (window.jQuery) { init(); return; }
    var tries = 0;
    (function poll(){
      if (window.jQuery) return init();
      if (++tries > 200) { console.error('[product-list] jQuery 미로드'); return; } // 10초 타임아웃
      setTimeout(poll, 50);
    })();
  }

  waitForjQuery(function init(){
    var $ = window.jQuery;
    console.log('[product-list] init');

    // 체크된 값 수집
    function collect(name){
      return $("input[name='" + name + "']:checked")
              .map(function(){ return this.value; }).get();
    }

    // GET 쿼리스트링 생성 (다중 파라미터)
    function buildQS(){
      var q = [];
      var brand = collect("brand");
      var grade = collect("grade");
      var mn    = collect("mainNote");
      var vol   = collect("volume");
      if (brand.length) q.push(brand.map(v => "brandIds="    + encodeURIComponent(v)).join("&"));
      if (grade.length) q.push(grade.map(v => "gradeIds="    + encodeURIComponent(v)).join("&"));
      if (mn.length)    q.push(mn.map(v    => "mainNoteIds=" + encodeURIComponent(v)).join("&"));
      if (vol.length)   q.push(vol.map(v   => "volumeIds="   + encodeURIComponent(v)).join("&"));
      return q.length ? ("?" + q.join("&")) : "";
    }

    // 부분 갱신 (항상 GET, 프래그먼트 내부만 교체)
    function reload(){
      var url = "/main/list/partial" + buildQS();
      console.log('[product-list] reload ->', url);
      $("#list-body").load(url + " #list-body>*", function(response, status, xhr){
        if(status !== "success"){
          console.error("[product-list] 부분 로드 실패:", xhr.status, xhr.statusText);
        }
      });
    }

    // 이벤트 바인딩 (아코디언 이벤트와 충돌 방지)
    $(document).on("change", ".filter-check", function(e){
      e.stopPropagation();
      console.log('[product-list] changed:', this.name, this.value, this.checked);
      reload();
    });

    $("#btn-reset").on("click", function(e){
      e.preventDefault();
      e.stopPropagation();
      $(".filter-check").prop("checked", false);
      reload();
    });

    // (선택) 최초 진입 시 한번 갱신하고 싶으면 주석 해제
    // reload();
  });

})();
</script>
</th:block>

</body>
</html>
