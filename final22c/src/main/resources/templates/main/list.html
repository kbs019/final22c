<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
  <title>22°C</title>
  <th:block layout:fragment="css">
    <link rel="stylesheet" th:href="@{/css/list.css}">
  </th:block>
</head>

<body>
<th:block layout:fragment="content">

  <div class="row g-4">

    <!-- 좌측 필터(기존 유지) -->
    <aside class="col-12 col-md-3 col-lg-2">
      <div class="filter-panel position-sticky" style="top: 1rem;">
        <h6 class="mb-3 fw-semibold">필터</h6>

        <div class="accordion" id="filterAccordion">

          <!-- Brand -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingBrand">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBrand" aria-expanded="false" aria-controls="collapseBrand">
                Brand
              </button>
            </h2>
            <div id="collapseBrand" class="accordion-collapse collapse" aria-labelledby="headingBrand" data-bs-parent="#filterAccordion">
              <div class="accordion-body p-2">
                <div class="filter-list">
                  <div class="form-check" th:each="b : ${brands}">
                    <input class="form-check-input filter-check" type="checkbox" name="brand"
                          th:id="${'brand-'+b['id']}" th:value="${b['id']}">
                    <label class="form-check-label small" th:for="${'brand-'+b['id']}">
                      <span th:text="${b['name']}">Brand</span>
                      <span class="text-secondary" th:text="' (' + ${b['count']} + ')'"> (0)</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Grade -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingGrade">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGrade" aria-expanded="false" aria-controls="collapseGrade">
                Grade
              </button>
            </h2>
            <div id="collapseGrade" class="accordion-collapse collapse" aria-labelledby="headingGrade" data-bs-parent="#filterAccordion">
              <div class="accordion-body p-2">
                <div class="filter-list">
                  <div class="form-check" th:each="g : ${grades}">
                    <input class="form-check-input filter-check" type="checkbox" name="grade"
                          th:id="${'grade-'+g['id']}" th:value="${g['id']}">
                    <label class="form-check-label small" th:for="${'grade-'+g['id']}">
                      <span th:text="${g['name']}">Grade</span>
                      <span class="text-secondary" th:text="' (' + ${g['count']} + ')'"> (0)</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Main Note -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingMainNote">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMainNote" aria-expanded="false" aria-controls="collapseMainNote">
                Main Note
              </button>
            </h2>
            <div id="collapseMainNote" class="accordion-collapse collapse" aria-labelledby="headingMainNote" data-bs-parent="#filterAccordion">
              <div class="accordion-body p-2">
                <div class="filter-list">
                  <div class="form-check" th:each="m : ${mainNotes}">
                    <input class="form-check-input filter-check" type="checkbox" name="mainNote"
                          th:id="${'mainNote-'+m['id']}" th:value="${m['id']}">
                    <label class="form-check-label small" th:for="${'mainNote-'+m['id']}">
                      <span th:text="${m['name']}">MainNote</span>
                      <span class="text-secondary" th:text="' (' + ${m['count']} + ')'"> (0)</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Volume -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingVolume">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVolume" aria-expanded="false" aria-controls="collapseVolume">
                Volume
              </button>
            </h2>
            <div id="collapseVolume" class="accordion-collapse collapse" aria-labelledby="headingVolume" data-bs-parent="#filterAccordion">
              <div class="accordion-body p-2">
                <div class="filter-list">
                  <div class="form-check" th:each="v : ${volumes}">
                    <input class="form-check-input filter-check" type="checkbox" name="volume"
                            th:id="${'volume-'+v['id']}" th:value="${v['id']}">
                    <label class="form-check-label small" th:for="${'volume-'+v['id']}">
                      <span th:text="${v['name']}">Volume</span>
                      <span class="text-secondary" th:text="' (' + ${v['count']} + ')'"> (0)</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>

        <div class="d-grid mt-3">
          <button id="btn-reset" class="btn btn-outline-dark btn-sm">필터 초기화</button>
        </div>
      </div>
    </aside>

    <!-- 중앙 리스트 -->
    <section class="col-12 col-md-9 col-lg-10">
      
      <!-- 상단 검색창 -->
      <div class="search-wrap my-2">
        <form id="search-form" class="search-box" action="javascript:void(0);" role="search">
          <input id="keyword" name="q" type="search" placeholder="상품명을 입력하세요"
                 th:value="${keyword}" autocomplete="off">
          <button id="btn-search" aria-label="검색">
            <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
          </button>
          <button id="btn-clear" type="button" aria-label="지우기" hidden>&times;</button>
        </form>
      </div>

      <!-- 결과영역(Fragment로 교체) -->
      <div id="list-body" th:fragment="listBody" th:attr="data-page=${page}">
        <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
          <div class="small text-secondary">검색결과 <span id="result-count" th:text="${total}">0</span>개</div>

          <!-- 정렬 드롭다운 -->
          <div class="sort-wrap ms-auto">
            <select id="sort-select" class="form-select form-select-sm sort-select">
              <option th:value="'id'"         th:selected="${sort == 'id'}">기본순</option>
              <option th:value="'popular'"    th:selected="${sort == 'popular'}">인기순</option>
              <option th:value="'priceAsc'"   th:selected="${sort == 'priceAsc'}">가격</option>
              <option th:value="'priceDesc'"  th:selected="${sort == 'priceDesc'}">가격 높은 순</option>
              <option th:value="'reviewDesc'" th:selected="${sort == 'reviewDesc'}">리뷰 많은 순</option>
            </select>
          </div>
        </div>

        <div id="product-grid" class="row row-cols-2 row-cols-sm-3 row-cols-lg-4 g-3">
          <div class="col" th:each="p : ${products}">
            <div class="card product-card h-100 shadow-sm">
              <!-- 이미지 영역: 축소 + 화이트 여백 -->
              <div class="card-media">
                <img th:src="${p['imgUrl']}" th:alt="${p['name']}">
              </div>

              <div class="card-body p-2">
                <div class="small text-secondary brand-compact" th:text="${p['brandName']}">Brand</div>
                <div class="fw-semibold name-compact text-truncate" th:title="${p['name']}" th:text="${p['name']}">Name</div>

                <!-- 가격영역 -->
                <div class="price-row mt-1">
                  <span class="disc"
                        th:if="${p['discount'] != null and p['discount'] > 0}"
                        th:text="${#numbers.formatInteger(p['discount'],0)} + '%'">10%</span>

                  <span class="sale"
                        th:text="${#numbers.formatInteger(p['sellPrice'],3,'COMMA')} + '원'">0원</span>

                  <span class="list"
                        th:if="${p['price'] != null and p['price'] > p['sellPrice']}"
                        th:text="${#numbers.formatInteger(p['price'],3,'COMMA')} + '원'">0원</span>

                  <a class="stretched-link" th:href="@{'/main/content/' + ${p['id']}}"></a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 페이지네이션 -->
        <nav class="mt-3" aria-label="상품 목록 페이지">
          <ul class="pagination pagination-sm justify-content-center pager-rounded">
            <li class="page-item" th:classappend="${page <= 1} ? ' disabled'">
              <a class="page-link" href="#" data-page="1" aria-label="처음">«</a>
            </li>
            <li class="page-item" th:classappend="${page <= 1} ? ' disabled'">
              <a class="page-link" href="#" th:attr="data-page=${page-1}" aria-label="이전">‹</a>
            </li>

            <!-- 페이지 숫자 (최대 7개 윈도우) -->
            <th:block th:with="
              tp=${totalPages.intValue()},
              pg=${page},

              _start=${T(java.lang.Math).max(1, pg-2)},
              _end=${T(java.lang.Math).min(tp, pg+2)},
              start=${T(java.lang.Math).max(1, T(java.lang.Math).min(_start, tp-4))},
              end=${T(java.lang.Math).min(tp, T(java.lang.Math).max(_end, 5))}
            ">
              <li class="page-item" th:each="i : ${#numbers.sequence(start, end)}"
                  th:classappend="${i == page} ? ' active'">
                <a class="page-link" href="#" th:text="${i}" th:attr="data-page=${i}">1</a>
              </li>
            </th:block>

            <li class="page-item" th:classappend="${page >= totalPages} ? ' disabled'">
              <a class="page-link" href="#" th:attr="data-page=${page+1}" aria-label="다음">›</a>
            </li>
            <li class="page-item" th:classappend="${page >= totalPages} ? ' disabled'">
              <a class="page-link" href="#" th:attr="data-page=${totalPages}" aria-label="마지막">»</a>
            </li>
          </ul>
        </nav>

      </div>

    </section>

  </div>

</th:block>

<!-- jQuery만 사용 -->
<th:block layout:fragment="script">
<script>
(function(){
  function waitForjQuery(init){
    if (window.jQuery) { init(); return; }
    var tries = 0;
    (function poll(){
      if (window.jQuery) return init();
      if (++tries > 200) { console.error('[product-list] jQuery 미로드'); return; }
      setTimeout(poll, 50);
    })();
  }

  waitForjQuery(function init(){
    var $ = window.jQuery;
    console.log('[product-list] init');

    $("#keyword").focus();

    function collect(name){
      return $("input[name='" + name + "']:checked")
              .map(function(){ return this.value; }).get();
    }

    function currentSort(){ return $("#sort-select").val() || "id"; }
    function currentPage(){ return Number($("#list-body").data("page")) || 1; }

    function buildQS(opts){
      opts = opts || {};
      var q = [];
      var brand = collect("brand");
      var grade = collect("grade");
      var mn    = collect("mainNote");
      var vol   = collect("volume");
      var kw    = $.trim($("#keyword").val() || "");
      var sort  = opts.sort || currentSort();
      var page  = opts.page || 1;
      var size  = 24;

      if (brand.length) q.push(brand.map(v => "brandIds="    + encodeURIComponent(v)).join("&"));
      if (grade.length) q.push(grade.map(v => "gradeIds="    + encodeURIComponent(v)).join("&"));
      if (mn.length)    q.push(mn.map(v    => "mainNoteIds=" + encodeURIComponent(v)).join("&"));
      if (vol.length)   q.push(vol.map(v   => "volumeIds="   + encodeURIComponent(v)).join("&"));
      if (kw)           q.push("q=" + encodeURIComponent(kw));
      if (sort)         q.push("sort=" + encodeURIComponent(sort));
      if (page)         q.push("page=" + encodeURIComponent(page));
      if (size)         q.push("size=" + encodeURIComponent(size));
      return q.length ? ("?" + q.join("&")) : "";
    }

    function reload(opts){
      opts = opts || {};
      if (typeof opts.page === "undefined") opts.page = 1;

      var url = "/main/list/partial" + buildQS(opts);
      console.log('[product-list] reload ->', url);
      $("#list-body").load(url + " #list-body>*", function(response, status, xhr){
        if(status !== "success"){
          console.error("[product-list] 부분 로드 실패:", xhr.status, xhr.statusText);
          return;
        }
        history.replaceState(null, "", "/main/list" + buildQS(opts));
      });
    }

    $(document).on("change", ".filter-check", function(e){
      e.stopPropagation();
      reload({ page: 1 });
    });

    $("#search-form").on("submit", function(e){ e.preventDefault(); reload({ page: 1 }); });
    $("#btn-search").on("click", function(e){ e.preventDefault(); reload({ page: 1 }); });

    const $kw = $("#keyword"), $clear = $("#btn-clear");
    function toggleClear(){ $clear.prop("hidden", !$.trim($kw.val()).length); }
    $kw.on("input", toggleClear);
    $clear.on("click", function(){ $kw.val(""); toggleClear(); reload({ page: 1 }); });
    toggleClear();

    $("#btn-reset").on("click", function(e){
      e.preventDefault();
      e.stopPropagation();
      $(".filter-check").prop("checked", false);
      $("#keyword").val("");
      toggleClear();
      reload({ page: 1 });
    });

    $(document).on("change", "#sort-select", function(){
      reload({ page: 1, sort: $(this).val() });
    });

    $(document).on("click", ".pagination .page-link", function(e){
      e.preventDefault();
      var p = Number($(this).attr("data-page"));
      if (!p || $(this).closest(".page-item").hasClass("disabled")) return;
      reload({ page: p });
    });
  });
})();
</script>
</th:block>

</body>
</html>
