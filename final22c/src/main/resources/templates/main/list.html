<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/layout}">

<!-- 페이지 전용 CSS -->
<th:block layout:fragment="css">
  <style>
    /* 카드 이미지 비율 고정 */
    .product-thumb { aspect-ratio: 1/1; object-fit: cover; width: 100%; }
    .card.position-relative { position: relative; }
    .card .ratio { position: relative; z-index: 0; overflow: hidden; }
    /* stretched-link 오버레이가 이미지 위에 오도록 */
    .card .stretched-link::after { z-index: 10; }
    /* 관심(북마크) 버튼 오버레이 */
    .wish-btn { position: absolute; top: .5rem; right: .5rem; }
    .wish-btn .icon { font-size: 1.25rem; }
    /* 좌측 가이드/메모 사이드 */
    .list-sidebar { position: sticky; top: 88px; }
    /* 결과 없음 영역 */
    .empty { padding: 4rem 0; text-align: center; color: var(--bs-secondary-color); }
  </style>
</th:block>

<div layout:fragment="content">
  <main class="container py-4">

    <!-- 상단 검색영역 -->
    <section class="mb-4">
      <div class="d-flex align-items-center justify-content-between gap-3">

        <!-- 검색: /main/list 고정 + 현재 필터 유지 -->
        <form class="flex-grow-1" th:action="@{/main/list}" method="get" role="search" aria-label="통합검색(브랜드+상품명)">
          <div class="input-group input-group-lg">
            <input type="search" name="q" th:value="${param.q}" class="form-control"
                   placeholder="브랜드/상품명을 검색하세요" autocomplete="off">
            <button class="btn btn-outline-secondary" type="submit" aria-label="검색">🔍</button>
          </div>

          <!-- 현재 필터 동시 전송(유지) -->
          <th:block th:if="${param.grades != null}" th:each="g : ${param.grades}">
            <input type="hidden" name="grades" th:value="${g}">
          </th:block>
          <th:block th:if="${param.accords != null}" th:each="a : ${param.accords}">
            <input type="hidden" name="accords" th:value="${a}">
          </th:block>
          <th:block th:if="${param.brands != null}" th:each="b : ${param.brands}">
            <input type="hidden" name="brands" th:value="${b}">
          </th:block>
          <th:block th:if="${param.volumes != null}" th:each="v : ${param.volumes}">
            <input type="hidden" name="volumes" th:value="${v}">
          </th:block>
        </form>

        <!-- 결과 수 표시 -->
        <div class="text-nowrap ms-2">
          <span class="small text-secondary">검색결과</span>
          <strong th:text="${#lists.isEmpty(list) ? 0 : #lists.size(list)}">0</strong>
        </div>
      </div>
    </section>

    <div class="row g-4">
      <!-- 좌측 사이드: 필터 -->
      <aside class="col-lg-3 d-none d-lg-block">
        <div class="list-sidebar">
          <!-- 필터 폼 -->
          <form th:action="@{/main/list}" method="get" id="filterForm" class="card mb-3">
            <div class="card-body">
              <h6 class="card-title mb-3">필터</h6>

              <!-- 현재 검색어 동시 전송 -->
              <input type="hidden" name="q" th:value="${param.q}"/>

              <!-- 브랜드 -->
              <div class="mb-3">
                <div class="small fw-semibold mb-2">브랜드</div>
                <div class="vstack gap-2">
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="brands" value="킬리안"
                           th:checked="${param.brands != null and #lists.contains(param.brands, '킬리안')}">
                    <span class="form-check-label">킬리안</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="brands" value="메종 마르지엘라"
                           th:checked="${param.brands != null and #lists.contains(param.brands, '메종 마르지엘라')}">
                    <span class="form-check-label">메종 마르지엘라</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="brands" value="톰 포드"
                           th:checked="${param.brands != null and #lists.contains(param.brands, '톰 포드')}">
                    <span class="form-check-label">톰 포드</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="brands" value="아쿠아 디 파르마"
                           th:checked="${param.brands != null and #lists.contains(param.brands, '아쿠아 디 파르마')}">
                    <span class="form-check-label">아쿠아 디 파르마</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="brands" value="바이레도"
                           th:checked="${param.brands != null and #lists.contains(param.brands, '바이레도')}">
                    <span class="form-check-label">바이레도</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="brands" value="프레데릭 말"
                           th:checked="${param.brands != null and #lists.contains(param.brands, '프레데릭 말')}">
                    <span class="form-check-label">프레데릭 말</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="brands" value="르 라보"
                           th:checked="${param.brands != null and #lists.contains(param.brands, '르 라보')}">
                    <span class="form-check-label">르 라보</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="brands" value="샤넬"
                           th:checked="${param.brands != null and #lists.contains(param.brands, '샤넬')}">
                    <span class="form-check-label">샤넬</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="brands" value="딥티크"
                           th:checked="${param.brands != null and #lists.contains(param.brands, '딥티크')}">
                    <span class="form-check-label">딥티크</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="brands" value="조 말론"
                           th:checked="${param.brands != null and #lists.contains(param.brands, '조 말론')}">
                    <span class="form-check-label">조 말론</span>
                  </label>
                </div>
              </div>

              <!-- 그레이드 -->
              <div class="mb-3">
                <div class="small fw-semibold mb-2">그레이드</div>
                <div class="vstack gap-2">
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="grades"
                           value="퍼퓸"
                           th:checked="${param.grades != null and #lists.contains(param.grades, '퍼퓸')}">
                    <span class="form-check-label">퍼퓸</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="grades"
                           value="오 드 코롱"
                           th:checked="${param.grades != null and #lists.contains(param.grades, '오 드 코롱')}">
                    <span class="form-check-label">오 드 코롱</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="grades"
                           value="오 드 퍼퓸"
                           th:checked="${param.grades != null and #lists.contains(param.grades, '오 드 퍼퓸')}">
                    <span class="form-check-label">오 드 퍼퓸</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="grades"
                           value="오 드 뚜왈렛"
                           th:checked="${param.grades != null and #lists.contains(param.grades, '오 드 뚜왈렛')}">
                    <span class="form-check-label">오 드 뚜왈렛</span>
                  </label>
                </div>
              </div>

              <!-- 메인 어코드 -->
              <div class="mb-1">
                <div class="small fw-semibold mb-2">메인 어코드</div>
                <div class="vstack gap-2">
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="accords"
                           value="시트러스"
                           th:checked="${param.accords != null and #lists.contains(param.accords, '시트러스')}">
                    <span class="form-check-label">시트러스</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="accords"
                           value="스파이시"
                           th:checked="${param.accords != null and #lists.contains(param.accords, '스파이시')}">
                    <span class="form-check-label">스파이시</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="accords"
                           value="우디"
                           th:checked="${param.accords != null and #lists.contains(param.accords, '우디')}">
                    <span class="form-check-label">우디</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="accords"
                           value="플로랄"
                           th:checked="${param.accords != null and #lists.contains(param.accords, '플로랄')}">
                    <span class="form-check-label">플로랄</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="accords"
                           value="허벌"
                           th:checked="${param.accords != null and #lists.contains(param.accords, '허벌')}">
                    <span class="form-check-label">허벌</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="accords"
                           value="프루티"
                           th:checked="${param.accords != null and #lists.contains(param.accords, '프루티')}">
                    <span class="form-check-label">프루티</span>
                  </label>
                </div>
              </div>

              <!-- 용량 -->
              <div class="mb-1">
                <div class="small fw-semibold mb-2">용량</div>
                <div class="vstack gap-2">
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="volumes" value="15ml"
                           th:checked="${param.volumes != null and #lists.contains(param.volumes, '15ml')}">
                    <span class="form-check-label">15ml</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="volumes" value="30ml"
                           th:checked="${param.volumes != null and #lists.contains(param.volumes, '30ml')}">
                    <span class="form-check-label">30ml</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="volumes" value="50ml"
                           th:checked="${param.volumes != null and #lists.contains(param.volumes, '50ml')}">
                    <span class="form-check-label">50ml</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="volumes" value="75ml"
                           th:checked="${param.volumes != null and #lists.contains(param.volumes, '75ml')}">
                    <span class="form-check-label">75ml</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="volumes" value="100ml"
                           th:checked="${param.volumes != null and #lists.contains(param.volumes, '100ml')}">
                    <span class="form-check-label">100ml</span>
                  </label>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="volumes" value="150ml"
                           th:checked="${param.volumes != null and #lists.contains(param.volumes, '150ml')}">
                    <span class="form-check-label">150ml</span>
                  </label>
                </div>
              </div>
            </div>

            <div class="card-footer bg-body text-end">
              <button type="submit" class="btn btn-sm btn-primary">적용</button>
              <a th:href="@{/main/list}" class="btn btn-sm btn-outline-secondary">초기화</a>
            </div>
          </form>
        </div>
      </aside>

      <!-- 리스트 영역 -->
      <section class="col-lg-9">
        <!-- 결과 없음 -->
        <div th:if="${#lists.isEmpty(list)}" class="empty border rounded bg-body">
          표시할 항목이 없습니다.
        </div>

        <!-- 결과 그리드 -->
        <div th:unless="${#lists.isEmpty(list)}"
             class="row row-cols-2 row-cols-md-3 row-cols-xl-4 g-3 g-md-4">
          <!-- 카드 -->
          <div class="col" th:each="product : ${list}">
            <div class="card h-100 position-relative shadow-sm">

              <!-- 관심(북마크) 버튼 -->
              <div class="wish-btn">
                <!-- 로그인 상태 -->
                <!--
                <button type="button"
                        class="btn btn-light border-subtle rounded-circle shadow-sm btn-sm"
                        sec:authorize="isAuthenticated()"
                        th:classappend="${product.wished} ? ' active' : ''"
                        th:attr="data-id=${product.id}"
                        aria-pressed="false" title="관심 등록/해제">
                  <span class="icon" th:text="${product.wished} ? '🔖' : '🏷️'">🔖</span>
                </button>
                -->
                <!-- 비로그인 안내 -->
                <button type="button"
                        class="btn btn-light border-subtle rounded-circle shadow-sm btn-sm"
                        sec:authorize="isAnonymous()"
                        data-bs-toggle="tooltip" data-bs-title="로그인 후 사용 가능합니다">
                  <span class="icon">🏷️</span>
                </button>
              </div>

              <div class="ratio ratio-1x1">
                <img class="product-thumb rounded-top"
                     th:src="${product.imgPath != null and product.imgName != null ? (product.imgPath + product.imgName) : '/img/noimg.png'}"
                     th:alt="${product.name}">
              </div>

              <!-- 본문 -->
              <div class="card-body">
                <div class="small text-secondary text-truncate" th:text="${product.brand.brandName}">Brand</div>
                <h6 class="card-title mb-1 text-truncate" th:text="${product.name}">상품명</h6>
                <div class="small text-secondary">
                  <span th:text="${product.grade.gradeName}">등급</span>
                  · <span th:text="${product.mainNote.mainNoteName}">메인노트</span>
                  · <span th:text="${product.volume.volumeName}">용량</span>
                </div>
                <div class="fw-semibold mt-1"
                     th:text="${product.sellprice != null ? #numbers.formatInteger(product.sellprice, 3, 'COMMA') + '원' : '-'}">00,000원</div>
              </div>

              <!-- 카드 전체 클릭 -->
              <a class="stretched-link"
                 th:href="@{/main/content/{id}(id=${product.id})}"
                 th:aria-label="|${product.name} 상세로 이동|"></a>
            </div>
          </div>
          <!-- /카드 -->
        </div>
      </section>
    </div>
  </main>
</div>

<!-- 페이지 전용 스크립트 -->
<th:block layout:fragment="script">
  <script th:inline="javascript">
    // 체크박스 변경 시 자동 제출 → /main/list
    document.querySelectorAll('#filterForm input[type="checkbox"]').forEach(chk => {
      chk.addEventListener('change', () => {
        document.getElementById('filterForm').submit();
      });
    });

    // Bootstrap Tooltip (비로그인 안내)
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    [...tooltipTriggerList].forEach(el => new bootstrap.Tooltip(el));

    // CSRF (Spring Security 사용 시)
    /*<![CDATA[*/
    const csrfHeader = /*[[${_csrf?.headerName}]]*/ 'X-CSRF-TOKEN';
    const csrfToken  = /*[[${_csrf?.token}]]*/ '';
    /*]]>*/

    // 관심 토글(Ajax) — product 기준
    $(document).on('click', '.wish-btn [sec\\:authorize="isAuthenticated()"], .wish-btn button[sec\\:authorize]', function () {
      const $btn = $(this);
      const productId = $btn.data('id');
      if (!productId) return;

      $.ajax({
        url: /*[@{/wish/toggle}]*/ '/wish/toggle',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ productId: productId }),
        beforeSend: function (xhr) {
          if (csrfToken) xhr.setRequestHeader(csrfHeader, csrfToken);
        }
      }).done(function (res) {
        const wished = !!(res && res.wished);
        $btn.toggleClass('active', wished);
        $btn.find('.icon').text(wished ? '🔖' : '🏷️');
      }).fail(function () {
        alert('요청을 처리하지 못했습니다. 잠시 후 다시 시도해 주세요.');
      });
    });
  </script>
</th:block>
</html>
