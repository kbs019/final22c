<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
  <title>22Â°C</title>
  <th:block layout:fragment="css">
    <link rel="stylesheet" th:href="@{/css/list.css}">
  </th:block>
</head>

<body>
<th:block layout:fragment="content">

  <div class="row g-4">

    <!-- ì¢Œì¸¡ í•„í„°(ê¸°ì¡´ ìœ ì§€) -->
    <aside class="col-12 col-md-3 col-lg-2">
      <div class="filter-panel position-sticky" style="top: 1rem;">
        <h6 class="mb-3 fw-semibold">í•„í„°</h6>

        <div class="accordion" id="filterAccordion">

          <!-- Brand -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingBrand">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBrand" aria-expanded="false" aria-controls="collapseBrand">
                Brand
              </button>
            </h2>
            <div id="collapseBrand" class="accordion-collapse collapse" aria-labelledby="headingBrand" data-bs-parent="#filterAccordion">
              <div class="accordion-body p-2">
                <div class="filter-list">
                  <div class="form-check" th:each="b : ${brands}">
                    <input class="form-check-input filter-check" type="checkbox" name="brand"
                          th:id="${'brand-'+b['id']}" th:value="${b['id']}">
                    <label class="form-check-label small" th:for="${'brand-'+b['id']}">
                      <span th:text="${b['name']}">Brand</span>
                      <span class="text-secondary" th:text="' (' + ${b['count']} + ')'"> (0)</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Grade -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingGrade">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGrade" aria-expanded="false" aria-controls="collapseGrade">
                Grade
              </button>
            </h2>
            <div id="collapseGrade" class="accordion-collapse collapse" aria-labelledby="headingGrade" data-bs-parent="#filterAccordion">
              <div class="accordion-body p-2">
                <div class="filter-list">
                  <div class="form-check" th:each="g : ${grades}">
                    <input class="form-check-input filter-check" type="checkbox" name="grade"
                          th:id="${'grade-'+g['id']}" th:value="${g['id']}">
                    <label class="form-check-label small" th:for="${'grade-'+g['id']}">
                      <span th:text="${g['name']}">Grade</span>
                      <span class="text-secondary" th:text="' (' + ${g['count']} + ')'"> (0)</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Main Note -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingMainNote">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMainNote" aria-expanded="false" aria-controls="collapseMainNote">
                Main Note
              </button>
            </h2>
            <div id="collapseMainNote" class="accordion-collapse collapse" aria-labelledby="headingMainNote" data-bs-parent="#filterAccordion">
              <div class="accordion-body p-2">
                <div class="filter-list">
                  <div class="form-check" th:each="m : ${mainNotes}">
                    <input class="form-check-input filter-check" type="checkbox" name="mainNote"
                          th:id="${'mainNote-'+m['id']}" th:value="${m['id']}">
                    <label class="form-check-label small" th:for="${'mainNote-'+m['id']}">
                      <span th:text="${m['name']}">MainNote</span>
                      <span class="text-secondary" th:text="' (' + ${m['count']} + ')'"> (0)</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Volume -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingVolume">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVolume" aria-expanded="false" aria-controls="collapseVolume">
                Volume
              </button>
            </h2>
            <div id="collapseVolume" class="accordion-collapse collapse" aria-labelledby="headingVolume" data-bs-parent="#filterAccordion">
              <div class="accordion-body p-2">
                <div class="filter-list">
                  <div class="form-check" th:each="v : ${volumes}">
                    <input class="form-check-input filter-check" type="checkbox" name="volume"
                            th:id="${'volume-'+v['id']}" th:value="${v['id']}">
                    <label class="form-check-label small" th:for="${'volume-'+v['id']}">
                      <span th:text="${v['name']}">Volume</span>
                      <span class="text-secondary" th:text="' (' + ${v['count']} + ')'"> (0)</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>

        <div class="d-grid mt-3">
          <button id="btn-reset" class="btn btn-outline-dark btn-sm">í•„í„° ì´ˆê¸°í™”</button>
        </div>
      </div>
    </aside>

    <!-- ì¤‘ì•™ ë¦¬ìŠ¤íŠ¸ -->
    <section class="col-12 col-md-9 col-lg-10">

 
	<!-- ğŸ”µ [ì¶”ê°€] ë‚ ì”¨ ì¹´ë“œ ì‹œì‘ -->
<!--       <div id="wx-card" class="card shadow-sm mb-3" style="max-width:620px;">
        <div class="card-body">
          <div id="wx-status" class="text-muted">í˜„ì¬ ìœ„ì¹˜ë¡œ ë‚ ì”¨ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

          <div id="wx-data" style="display:none">
            <div class="d-flex align-items-baseline gap-2">
              <div id="wx-temp" style="font-size:38px;font-weight:700">--Â°C</div>
              <span id="wx-cond" class="badge text-bg-secondary">--</span>
            </div>
            <div class="mt-2 small text-secondary">
              ìŠµë„ <span id="wx-hum">--</span>% Â· ê°•ìˆ˜ëŸ‰ <span id="wx-pr">--</span>mm Â· ìš´ëŸ‰ <span id="wx-cloud">--</span>%
            </div>
          </div>
        </div>
      </div> -->
 
    
      <!-- ìƒë‹¨ ê²€ìƒ‰ì°½ ì¶”ê°€ -->
      <div class="search-wrap my-2">
        <form id="search-form" class="search-box" action="javascript:void(0);" role="search">
          <input id="keyword" name="q" type="search" placeholder="ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                 th:value="${keyword}" autocomplete="off">
          <button id="btn-search" aria-label="ê²€ìƒ‰">
            <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
          </button>
          <button id="btn-clear" type="button" aria-label="ì§€ìš°ê¸°" hidden>&times;</button>
        </form>
      </div>

      <!-- ê²°ê³¼ì˜ì—­(Fragmentë¡œ êµì²´) -->
      <div id="list-body" th:fragment="listBody">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <div class="small text-secondary">ê²€ìƒ‰ê²°ê³¼ <span id="result-count" th:text="${total}">0</span>ê°œ</div>
        </div>

        <div id="product-grid" class="row row-cols-2 row-cols-sm-3 row-cols-lg-4 g-3">
          <div class="col" th:each="p : ${products}">
            <div class="card h-100 shadow-sm" style="border-radius: 1rem;">
              <img th:src="${p['imgUrl']}" th:alt="${p['name']}" class="w-100" style="aspect-ratio:3/4;object-fit:cover;border-top-left-radius:1rem;border-top-right-radius:1rem;">
              <div class="card-body p-2">
                <div class="small text-secondary" th:text="${p['brandName']}">Brand</div>
                <div class="fw-semibold text-truncate" th:title="${p['name']}" th:text="${p['name']}">Name</div>
                <div class="d-flex justify-content-between align-items-center mt-1">
                  <div class="fw-bold" th:text="${#numbers.formatInteger(p['sellPrice'],3,'COMMA')} + 'ì›'">0ì›</div>
                  <a class="stretched-link" th:href="@{'/main/content/' + ${p['id']}}"></a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </section>

  </div>

</th:block>

<!-- jQueryë§Œ ì‚¬ìš© -->
<th:block layout:fragment="script">


<!-- ğŸ”µ [ì¶”ê°€] ë‚ ì”¨ ìœ„ì ¯ ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ : jQueryì™€ ë…ë¦½
<script>
(function(){
  const statusEl = document.getElementById('wx-status');
  const dataBox  = document.getElementById('wx-data');
  const els = {
    temp:  document.getElementById('wx-temp'),
    cond:  document.getElementById('wx-cond'),
    hum:   document.getElementById('wx-hum'),
    pr:    document.getElementById('wx-pr'),
    cloud: document.getElementById('wx-cloud'),
  };

  function condKo(c){
    switch((c||'').toUpperCase()){
      case 'RAIN':   return 'ë¹„';
      case 'HOT':    return 'ë”ì›€';
      case 'COLD':   return 'ì¶”ì›€';
      case 'HUMID':  return 'ìŠµí•¨';
      case 'CLOUDY': return 'êµ¬ë¦„';
      case 'MILD':   return 'ì˜¨í™”';
      default:       return c || '--';
    }
  }

  async function load(lat, lon){
    try{
      const res = await fetch(`/api/weather/now?lat=${lat}&lon=${lon}`);
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const d = await res.json();

      els.temp.textContent  = (d.tempC ?? 0).toFixed(1) + 'Â°C';
      els.cond.textContent  = condKo(d.condition);
      els.hum.textContent   = d.humidity ?? '--';
      els.pr.textContent    = (d.precipitation ?? 0).toFixed(1);
      els.cloud.textContent = d.cloud ?? '--';

      statusEl.style.display = 'none';
      dataBox.style.display  = '';
    }catch(e){
      statusEl.textContent = 'ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
      console.error('[weather]', e);
    }
  }

  // ë¸Œë¼ìš°ì € ìœ„ì¹˜ ê¶Œí•œ ìš”ì²­ â†’ ì‹¤íŒ¨ ì‹œ ì„œìš¸ ì‹œì²­ ì¢Œí‘œ í´ë°±
  const fallback = () => load(37.5665, 126.9780);
  if ('geolocation' in navigator){
    navigator.geolocation.getCurrentPosition(
      p => load(p.coords.latitude, p.coords.longitude),
      _ => fallback(),
      { timeout: 5000 }
    );
  } else {
    fallback();
  }
})();
</script> -->



<script>
(function(){

  // jQuery ë¡œë“œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¸ë‹¤ê°€ ì´ˆê¸°í™”
  function waitForjQuery(init){
    if (window.jQuery) { init(); return; }
    var tries = 0;
    (function poll(){
      if (window.jQuery) return init();
      if (++tries > 200) { console.error('[product-list] jQuery ë¯¸ë¡œë“œ'); return; } // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
      setTimeout(poll, 50);
    })();
  }

  waitForjQuery(function init(){
    var $ = window.jQuery;
    console.log('[product-list] init');

    $("#keyword").focus();

    // ì²´í¬ëœ ê°’ ìˆ˜ì§‘
    function collect(name){
      return $("input[name='" + name + "']:checked")
              .map(function(){ return this.value; }).get();
    }

    // GET ì¿¼ë¦¬ìŠ¤íŠ¸ë§ ìƒì„± (ë‹¤ì¤‘ íŒŒë¼ë¯¸í„° + í‚¤ì›Œë“œ)
    function buildQS(){
      var q = [];
      var brand = collect("brand");
      var grade = collect("grade");
      var mn    = collect("mainNote");
      var vol   = collect("volume");
      var kw    = $.trim($("#keyword").val() || "");
      if (brand.length) q.push(brand.map(v => "brandIds="    + encodeURIComponent(v)).join("&"));
      if (grade.length) q.push(grade.map(v => "gradeIds="    + encodeURIComponent(v)).join("&"));
      if (mn.length)    q.push(mn.map(v    => "mainNoteIds=" + encodeURIComponent(v)).join("&"));
      if (vol.length)   q.push(vol.map(v   => "volumeIds="   + encodeURIComponent(v)).join("&"));
      if (kw)           q.push("q=" + encodeURIComponent(kw));
      return q.length ? ("?" + q.join("&")) : "";
    }

    // ë¶€ë¶„ ê°±ì‹  (í•­ìƒ GET, í”„ë˜ê·¸ë¨¼íŠ¸ ë‚´ë¶€ë§Œ êµì²´)
    function reload(){
      var url = "/main/list/partial" + buildQS();
      console.log('[product-list] reload ->', url);
      $("#list-body").load(url + " #list-body>*", function(response, status, xhr){
        if(status !== "success"){
          console.error("[product-list] ë¶€ë¶„ ë¡œë“œ ì‹¤íŒ¨:", xhr.status, xhr.statusText);
        }
      });
      // ì£¼ì†Œ í‘œì‹œ ë™ê¸°í™”
      history.replaceState(null, "", "/main/list" + buildQS());
    }

    // í•„í„° ë³€ê²½ ì‹œ ê°±ì‹ 
    $(document).on("change", ".filter-check", function(e){
      e.stopPropagation();
      reload();
    });

    // ê²€ìƒ‰ ì‹¤í–‰
    $("#search-form").on("submit", function(e){ e.preventDefault(); reload(); });
    $("#btn-search").on("click", function(e){ e.preventDefault(); reload(); });

    // ì…ë ¥ X ë²„íŠ¼
    const $kw = $("#keyword"), $clear = $("#btn-clear");
    function toggleClear(){ $clear.prop("hidden", !$.trim($kw.val()).length); }
    $kw.on("input", toggleClear);
    $clear.on("click", function(){ $kw.val(""); toggleClear(); reload(); });
    toggleClear();

    // ì´ˆê¸°í™” ë²„íŠ¼: í•„í„° + í‚¤ì›Œë“œ ëª¨ë‘ í•´ì œ
    $("#btn-reset").on("click", function(e){
      e.preventDefault();
      e.stopPropagation();
      $(".filter-check").prop("checked", false);
      $("#keyword").val("");
      toggleClear();
      reload();
    });
  });

})();
</script>
</th:block>

</body>
</html>
