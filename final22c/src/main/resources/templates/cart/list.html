<html layout:decorate="~{layout/layout}">
<th:block layout:fragment="css">
    <link rel="stylesheet" href="/css/cart.css">
</th:block>

<th:block layout:fragment="content">
    <div class="container cart-wrap" style="margin-top:16px">

        <!-- 좌측: 리스트 -->
        <section>
            <div class="actions" th:if="${products != null and !products.isEmpty()}">
                <label><input type="checkbox" id="checkAll">전체선택</label>
                <button type="button" id="btnRemove" class="btn btn-outline-secondary btn-sm">선택 삭제</button>
            </div>

            <div id="cartList">
                <!-- 비어있을 때 -->
                <div class="empty" th:if="${products == null or products.isEmpty()}">
                    장바구니가 비어 있습니다.
                </div>

                <!-- 라인 렌더 -->
                <div th:each="cartItem : ${products}" class="cart-row" th:data-id="${cartItem.cartDetailId}"
                    th:data-unit-price="${cartItem.unitPrice}" th:data-list-price="${cartItem.listPrice}"
                    th:data-stock="${cartItem.stock}">
                    <!-- 체크 -->
                    <input type="checkbox" class="row-check" th:disabled="${cartItem.stock == 0}">

                    <!-- 이미지/링크 -->
                    <a th:href="@{|/main/content/${cartItem.id}|}">
                        <img th:src="@{|${cartItem.imgPath}${cartItem.imgName}|}" alt="향수 이미지" width="96" height="96"
                            style="object-fit:cover;border-radius:8px">
                    </a>

                    <!-- 정보 -->
                    <div>
                        <a th:href="@{|/main/content/${cartItem.id}|}" style="text-decoration:none;color:inherit">
                            <div th:text="${cartItem.name}"></div>
                            <div class="muted" th:text="${cartItem.brand}"></div>
                        </a>
                        <span class="muted">
                            <del th:text="${#numbers.formatInteger(cartItem.listPrice, 3, 'COMMA')} + '원'"></del>
                        </span>
                        <span>
                            <strong class="muted" th:text="${cartItem.discountPercent} + '%'"
                                style="color:#d33;"></strong>
                        </span>
                        <div>
                            <strong th:text="${#numbers.formatInteger(cartItem.unitPrice, 3, 'COMMA')} + '원'"></strong>
                        </div>
                    </div>

                    <!-- 수량/금액 -->
                    <div style="text-align:right">
                        <div class="qty-wrap">
                            <button type="button" class="qty-btn btnMinus">-</button>
                            <input type="number" class="qty-input" th:value="${cartItem.quantity}" min="1"
                                th:attr="max=${cartItem.stock}">
                            <button type="button" class="qty-btn btnPlus">+</button>
                        </div>

                        <div class="muted" th:if="${cartItem.stock == 0}" style="color:#d33; margin-top:4px;">
                            품절되어 수량 변경 및 결제가 제한됩니다.
                        </div>

                        <div style="margin-top:6px">
                            <strong class="line-total"
                                th:text="${#numbers.formatInteger(cartItem.unitPrice * cartItem.quantity,3,'COMMA')} + '원'"></strong>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 우측: 합계/결제 -->
        <aside class="sidebar">
            <div style="display:flex;justify-content:space-between;margin-top:8px">
                <div>내 보유 마일리지</div>
                <div><strong th:text="${#numbers.formatInteger(userMileage ?: 0, 1, 'COMMA')} + '원'"></strong></div>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:8px">
                <div>선택 상품</div>
                <div><strong id="selCount">0</strong>개</div>
            </div>
            <hr>
            <div style="display:flex;justify-content:space-between;margin-top:8px">
                <div>정가 합계</div>
                <div><strong id="selListTotal">0원</strong></div>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:8px">
                <div>할인 금액</div>
                <div><strong id="selDiscount">0원</strong></div>
            </div>
            <hr>
            <div style="display:flex;justify-content:space-between;margin-top:8px">
                <div>최종 결제 합계</div>
                <div><strong id="selTotal">0원</strong></div>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:8px">
                <div>적립 마일리지</div>
                <div><strong id="getMileage">0원</strong></div>
            </div>
            <hr>
            <form id="checkoutForm" th:action="@{/checkout/order/cart}" method="post">
                <!-- CSRF (폼용) -->
                <!-- <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"> -->
                <!-- 동적 hidden은 JS가 채움 -->
                <button type="button" id="btnCheckout" class="btn btn-secondary" style="width:100%">결제하기</button>
            </form>
            <div class="muted" style="margin-top:8px">선택된 상품만 결제 페이지로 이동합니다.</div>
        </aside>
    </div>
</th:block>


<th:block layout:fragment="script">
    <!-- 페이지 전용 JS -->
    <script th:inline="javascript">
        // ---------- 유틸 ----------
        const fmt = n => (n || 0).toLocaleString('ko-KR') + '원';       // 1000 단위로 , 를 연결해주고, '원' 을 붙여주는 작업을 도와줌
        const getMax = (row) => Number(row?.dataset?.stock ?? 1);       // 최대 재고 가져오기
        const isSellable = (row) => getMax(row) > 0;                    // 최대 재고가 0 보다 크다면 true (판매가능)
        // const getCsrf = () => ({
        //     token: document.querySelector('meta[name="_csrf"]').content,
        //     header: document.querySelector('meta[name="_csrf_header"]').content
        // });

        const $list = document.getElementById('cartList');
        const $checkAll = document.getElementById('checkAll');
        const $selCount = document.getElementById('selCount');          // 선택된 상품의 갯수 ( 구매하려는 상품의 갯수 -- 우측 사이드바에 출력되는 값 )
        const $selTotal = document.getElementById('selTotal');          // 선택된 상품의 판매가의 총 합
        const $getMileage = document.getElementById('getMileage');      // 선택된 상품의 판매가에 적립률 계산

        // 버튼 상태 갱신 (수량 == 최대일 때 + 비활성화)
        function toggleButtons(row) {
            const qtyInput = row.querySelector('.qty-input');
            const btnPlus = row.querySelector('.btnPlus');
            const btnMinus = row.querySelector('.btnMinus');
            const cb = row.querySelector('.row-check');
            const qty = Number(qtyInput.value || 1);
            const max = getMax(row);

            if (btnPlus) { btnPlus.disabled = qty >= max || max <= 0; }
            if (btnMinus) { btnMinus.disabled = qty <= 1 || max <= 0; }

            // 품절이면 입력 자체를 막는다.
            qtyInput.disabled = (max <= 0);

            // 품절이면 체크박스도 막고 체크 해제
            if (cb) {
                cb.disabled = !isSellable(row);
                if (cb.disabled) { cb.checked = false; }
            }
        }

        function refreshSummary() {
            const rows = Array.from($list.querySelectorAll('.cart-row'));
            let total = 0, cnt = 0, mileage = 0, listTotal = 0;

            rows.forEach(r => {
                const sellable = isSellable(r);
                const cb = r.querySelector('.row-check');

                const checked = cb?.checked && sellable;

                const qty = Number(r.querySelector('.qty-input')?.value || 1);
                const unit = Number(r.dataset.unitPrice || 0);
                const listPrice = Number(r.dataset.listPrice || 0);
                const lineUnit = unit * qty;
                const lineList = listPrice * qty;

                const $line = r.querySelector('.line-total');

                if ($line) {
                    $line.textContent = fmt(lineUnit);
                }

                if (checked) {
                    total += lineUnit;
                    listTotal += lineList;
                    cnt++;
                }
                toggleButtons(r);
            });

            const discountPrice = listTotal - total;            // 할인 금액
            mileage = total * 0.05;                             // 적립 마일리지

            $selCount.textContent = cnt;                        // 선택된 상품의 갯수를 출력
            $selTotal.textContent = fmt(total);
            $getMileage.textContent = fmt(mileage);

            // 선택된 상품들의 정가의 합
            const $listTotal = document.getElementById('selListTotal');
            if ($listTotal) {
                $listTotal.textContent = fmt(listTotal);
            }

            // 할인금액 표시 추가
            const $discountPrice = document.getElementById('selDiscount');
            if ($discountPrice) {
                $discountPrice.textContent = fmt(discountPrice);
            }
        }

        // 디바운스 PATCH
        const debounce = (fn, ms) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };
        const syncQty = debounce(async (row) => {
            const id = row.dataset.id;
            const qty = row.querySelector('.qty-input').value;

            // const { token, header } = getCsrf();

            const res = await fetch(`/cart/check/${id}/qty?qty=${qty}`, { method: 'PATCH' });
            let data = {};
            try { data = await res.json(); } catch (_) { }

            // 확인용 로그
            console.log('[PATCH /cart/check/{id}/qty]', { id, req: qty, status: res.status, data });

            // 서버가 보정했다면 클라이언트도 동기화
            if (data && typeof data.qty !== 'undefined') {
                row.querySelector('.qty-input').value = data.qty;
                if (typeof data.max !== 'undefined') {
                    row.dataset.stock = data.max;
                }
                if (!data.ok) {
                    alert('선택 수량이 재고를 초과하여 최대 수량으로 조정되었습니다.');
                    refreshSummary();
                }
            }
        }, 250);

        // ---------- 이벤트 ----------
        if ($list) {
            $list.addEventListener('click', e => {
                const row = e.target.closest('.cart-row'); if (!row) return;
                const qtyInput = row.querySelector('.qty-input');
                const max = getMax(row);
                if (e.target.classList.contains('btnMinus')) {
                    qtyInput.value = Math.max(1, Number(qtyInput.value || 1) - 1);
                    syncQty(row); refreshSummary();
                }
                if (e.target.classList.contains('btnPlus')) {
                    qtyInput.value = Math.min(max, Number(qtyInput.value || 1) + 1);
                    syncQty(row); refreshSummary();
                }
            });
            $list.addEventListener('input', e => {
                if (e.target.classList.contains('qty-input')) {
                    const row = e.target.closest('.cart-row');
                    const max = getMax(row);
                    let v = Number(e.target.value || 1);
                    if (Number.isNaN(v)) { v = 1; }
                    v = Math.max(1, Math.min(v, max));        // 1 ~ max 로 범위 지정
                    e.target.value = v;
                    syncQty(row);
                    refreshSummary();
                }
            });
            $list.addEventListener('change', e => {
                if (e.target.classList.contains('row-check')) {
                    const rows = Array.from($list.querySelectorAll('.cart-row'))
                        .filter(isSellable);
                    const allChecked = rows.length > 0 && rows.every(r => r.querySelector('.row-check')?.checked);
                    if ($checkAll) $checkAll.checked = allChecked;
                    refreshSummary();
                }
            });
        }

        // 전체 선택
        if ($checkAll) {
            $checkAll.addEventListener('change', e => {
                $list.querySelectorAll('.row-check:not([disabled])')
                    .forEach(cb => cb.checked = e.target.checked);
                refreshSummary();
            });
        }

        // 선택 삭제
        const $btnRemove = document.getElementById('btnRemove');
        if ($btnRemove) {
            $btnRemove.addEventListener('click', () => {
                const ids = Array.from($list.querySelectorAll('.cart-row'))
                    .filter(r => r.querySelector('.row-check')?.checked)
                    .map(r => r.dataset.id);
                if (ids.length === 0) { alert('선택된 항목이 없습니다.'); return; }
                // const { token, header } = getCsrf();
                fetch('/cart/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids })
                }).then(res => {
                    if (res.ok) { location.reload(); }
                    else { alert('삭제 중 문제가 발생했습니다.'); }
                });
            });
        }

        // 결제하기
        const $btnCheckout = document.getElementById('btnCheckout');
        if ($btnCheckout) {
            $btnCheckout.addEventListener('click', () => {
                const rows = Array.from($list.querySelectorAll('.cart-row'));
                const selectedRows = rows.filter(r => r.querySelector('.row-check')?.checked);
                if (selectedRows.length === 0) { alert('선택된 상품이 없습니다.'); return; }

                // 품절 선택 여부 검사
                const invalid = selectedRows.filter(r => !isSellable(r));
                if (invalid.length > 0) {
                    // 안전하게 체크 해제
                    invalid.forEach(r => { const cb = r.querySelector('.row-check'); if (cb) cb.checked = false; });
                    refreshSummary();
                    alert('품절된 상품이 포함되어 있어 결제할 수 없습니다.');
                    return;
                }

                const selected = selectedRows.map(r => ({ id: r.dataset.id, qty: r.querySelector('.qty-input').value }));
                const form = document.getElementById('checkoutForm');
                // 기존 동적 hidden 제거
                Array.from(form.querySelectorAll('input.dyn')).forEach(n => n.remove());

                // Spring 바인딩 규칙: items[0].cartDetailId, items[0].quantity
                selected.forEach((s, i) => {
                    const h1 = document.createElement('input');
                    h1.type = 'hidden'; h1.className = 'dyn';
                    h1.name = `items[${i}].cartDetailId`; h1.value = s.id; form.appendChild(h1);

                    const h2 = document.createElement('input');
                    h2.type = 'hidden'; h2.className = 'dyn';
                    h2.name = `items[${i}].quantity`; h2.value = s.qty; form.appendChild(h2);
                });

                form.submit();
            });
        }

        // 초기 합계
        refreshSummary();
    </script>
</th:block>

</html>