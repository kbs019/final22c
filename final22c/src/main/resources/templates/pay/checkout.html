<!-- templates/order/checkout.html -->
<html layout:decorate="~{layout/layout}">
  <!-- head 슬롯: 페이지 전용 CSS -->
  <th:block layout:fragment="css">
    <link rel="stylesheet" href="/css/content.css">
    <style>
      .to-top { display: none !important; }
      .checkout-wrap {
        max-width:1100px; margin:24px auto;
        display:grid; grid-template-columns:1fr; gap:16px;
      }
      .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px;background:#fff}
      .muted{color:#6b7280}
      .summary-row{display:flex;justify-content:space-between;margin:6px 0}
      .btn{width:100%;padding:14px;border-radius:10px;border:0;background:#111;color:#fff;font-weight:700}
      .btn:disabled{opacity:.4}
      .point-box{display:flex;align-items:center;gap:12px}
      .point-box input{width:160px;max-width:40%;border:1px solid #ddd;border-radius:8px;padding:8px 10px}
      .point-badge{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:8px;padding:6px 10px}
      .point-use{padding:8px 12px;border:1px solid #d1d5db;border-radius:8px;background:#f9fafb}

      /* 화면을 어둡게 하는 오버레이 (모달 느낌) */
      #payOverlay{
        display:none; position:fixed; inset:0; z-index:9998;
        background:rgba(0,0,0,.5);
      }
      body.modal-open{overflow:hidden;}
    </style>
  </th:block>

  <!-- 본문 -->
  <div layout:fragment="content" th:with="shipping=${3000}, payTotal=${lineTotal + shipping}">
    <div class="checkout-wrap">
      <!-- 배송지 -->
      <div class="card">
        <div class="summary-row"><strong>배송지 주소</strong></div>
        <div><!-- TODO: 배송지 표시/선택 --></div>
      </div>

      <!-- 주문상품 -->
      <div class="card">
        <div class="summary-row">
          <strong>주문상품</strong>
          <span class="muted">총 1개</span>
        </div>
        <div style="display:flex;gap:14px;align-items:center;margin-top:10px">
          <div style="width:60px;height:60px;border:1px solid #eee;border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center">
            <img th:src="@{|${product.imgPath}${product.imgName}|}" alt="thumb" style="max-width:100%;max-height:100%;object-fit:cover">
          </div>
          <div style="flex:1">
            <div class="muted" th:text="${'수량 ' + qty}">수량</div>
            <div th:text="${product.name}">상품명</div>
          </div>
          <div style="font-weight:800" th:text="${#numbers.formatInteger(lineTotal,0)}+'원'">0</div>
        </div>
      </div>

      <!-- 포인트 -->
      <div class="card">
        <div class="point-box">
          <strong>포인트</strong>
          <span class="point-badge">
            보유 <span id="ownedPoint" th:text="${#numbers.formatInteger(user.mileage,0)}"></span> 원
          </span>
          <input id="usePoint" type="text" placeholder="사용할 포인트" value="0" th:attr="max=${user.mileage}">
          <button type="button" class="point-use" id="btnUseAllPoint">전액사용</button>
        </div>
      </div>

      <!-- 결제 상세 -->
      <div class="card">
        <div class="summary-row">
          <span class="muted">상품금액</span>
          <span th:text="${#numbers.formatInteger(lineTotal,0)}+'원'">0</span>
        </div>
        <div class="summary-row">
          <span class="muted">배송비</span>
          <span th:text="${#numbers.formatInteger(shipping,0)}+'원'">3,000</span>
        </div>
        <div class="summary-row">
          <span class="muted">사용 마일리지</span>
          <span id="usedPointLabel">0원</span>
        </div>
        <hr style="border:none;border-top:1px solid #eee;margin:10px 0">
        <div class="summary-row" style="font-weight:800">
          <span>결제금액</span>
          <span id="payTotalLabel" th:text="${#numbers.formatInteger(payTotal,0)}+'원'"></span>
        </div>
        <div class="summary-row" style="font-weight:800">
          <span>적립마일리지</span>
          <span id="rewardLabel" th:text="${#numbers.formatInteger(payTotal*0.05,0)}+'원'"></span>
        </div>

        <!-- 서버 전송 값 -->
        <input type="hidden" id="product_id" th:value="${product.id}">
        <input type="hidden" id="qty"        th:value="${qty}">
        <input type="hidden" id="payTotal"   th:value="${payTotal}">
        <input type="hidden" id="usedPoint"  value="0">

        <button id="payBtn" class="btn" type="button">결제하기</button>
      </div>
    </div>

    <!-- 배경 오버레이 -->
    <div id="payOverlay"></div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- 페이지 스크립트 -->
	<script th:inline="javascript">
	$(function(){
	  // ----- 금액/포인트 계산 -----
	  const owned   = /*[[${user.mileage}]]*/ 0 || 0;
	  const lineSum = (/*[[${lineTotal}]]*/ 0) + (/*[[${shipping}]]*/ 0);
	  const fmt = n => (Math.max(0, Math.trunc(n))).toLocaleString() + '원';

	  $("#usePoint").on("input", function(){ this.value = this.value.replace(/[^\d]/g, ''); });

	  function recalc(use){
	    use = Math.min(Math.max(0, Number(use)||0), owned, lineSum);
	    $("#usePoint").val(use);
	    $("#usedPoint").val(use);
	    $("#usedPointLabel").text(use.toLocaleString() + '원');
	    const pay = Math.max(0, lineSum - use);
	    $("#payTotal").val(pay);
	    $("#payTotalLabel").text(fmt(pay));
	    $("#rewardLabel").text(fmt(Math.trunc(pay * 0.05)));
	  }
	  recalc(0);
	  $("#btnUseAllPoint").on("click", ()=> recalc(Math.min(owned, lineSum)));
	  $("#usePoint").on("input change", function(){ recalc(this.value); });

	  // ----- 오버레이 컨트롤 -----
	  function showOverlay(){ $("#payOverlay").show(); $("body").addClass("modal-open"); }
	  function hideOverlay(){ $("#payOverlay").hide(); $("body").removeClass("modal-open"); }
	  $("#payOverlay").on("click", hideOverlay);

	  // ----- 가운데 팝업 열기 (모달처럼 보이게) -----
	  function openCenteredPopup(url, w=520, h=720){
	    const dualScreenLeft = (window.screenLeft !== undefined ? window.screenLeft : window.screenX) || 0;
	    const dualScreenTop  = (window.screenTop  !== undefined ? window.screenTop  : window.screenY) || 0;
	    const width  = window.outerWidth  || document.documentElement.clientWidth  || screen.width;
	    const height = window.outerHeight || document.documentElement.clientHeight || screen.height;

	    const left = dualScreenLeft + Math.max(0, (width  - w) / 2);
	    const top  = dualScreenTop  + Math.max(0, (height - h) / 2);

	    const features =
	      `popup=yes,width=${w},height=${h},left=${left},top=${top},` +
	      `resizable=yes,scrollbars=yes,status=no,toolbar=no,menubar=no,location=no`;

	    return window.open(url, "kakaopay_popup", features);
	  }

	  // ----- 팝업에서 오는 성공/취소/실패 신호 수신 -----
	  window.addEventListener('message', function (e) {
	    if (e.origin !== window.location.origin) return;
	    const d = e.data || {};
	    if (d.type !== 'PAY_RESULT') return;

	    hideOverlay();

	    if (d.status === 'success') {
	      window.location.href = '/main/list';
	    } else if (d.status === 'cancel') {
	      alert('결제가 취소되었습니다.');
	    } else {
	      alert('결제에 실패했습니다.');
	    }
	  });

	  // ----- 팝업 닫힘 감시 → 유예 → 서버 상태 조회 후 분기 -----
	  function watchPopupClose(win, orderId){
	    const timer = setInterval(function(){
	      if (!win || win.closed) {
	        clearInterval(timer);

	        // postMessage가 늦게 도착할 수 있으니 잠깐 유예
	        setTimeout(function(){
	          $.get('/pay/order/' + orderId + '/status')
	            .done(function(res){
	              const st = (res && res.status || '').toUpperCase();
	              hideOverlay();
	              if (st === 'PAID') {
	                // 실제로 결제 완료
	                window.location.href = '/main/list';
	              } else if (st === 'PENDING') {
	                // 자동 취소하지 말고 안내 (원하면 버튼으로 /pay/cancel-pending 호출)
	                alert('결제가 완료되지 않았습니다. 다시 시도하거나 취소할 수 있어요.');
	                // 원하면 자동취소:
	                // $.post('/pay/cancel-pending', { orderId }).always(() => alert('결제가 취소되었습니다.'));
	              } else {
	                alert('결제가 취소되었습니다.');
	              }
	            })
	            .fail(function(){
	              hideOverlay();
	              alert('결제 결과 확인에 실패했습니다. 잠시 후 새로고침해 주세요.');
	            });
	        }, 1000); // 1초 유예
	      }
	    }, 300);
	  }

	  // ----- 결제 버튼 -----
	  $("#payBtn").on("click", function(e){
	    e.preventDefault();

	    const productId = Number($("#product_id").val());
	    const qty       = Number($("#qty").val());
	    const usedPoint = Number($("#usedPoint").val());

	    const token  = $('meta[name="_csrf"]').attr('content');
	    const header = $('meta[name="_csrf_header"]').attr('content');

	    $.ajax({
	      type: "POST",
	      url:  "/pay/ready",
	      data: { productId, qty, usedPoint },
	      beforeSend: function(xhr){ if (token && header) xhr.setRequestHeader(header, token); },
	      success: function(res){
	        const url     = res && res.next_redirect_pc_url;
	        const orderId = res && res.orderId;     // ✅ 서버가 넣어준 orderId 사용
	        if (!url || !orderId) {
	          alert("응답 형식이 올바르지 않습니다.");
	          console.log(res);
	          return;
	        }

	        showOverlay();

	        const win = openCenteredPopup(url, 520, 720);
	        if (win && !win.closed) {
	          try { win.focus(); } catch(_) {}
	          watchPopupClose(win, orderId);        // ✅ orderId 전달
	        } else {
	          // 팝업 차단 시 동일 탭 이동
	          hideOverlay();
	          window.location.href = url;
	        }
	      },
	      error: function(xhr){
	        hideOverlay();
	        alert("결제 준비 실패 (" + xhr.status + ")\n" + (xhr.responseText||""));
	      }
	    });
	  });

	  // 혹시 남아있을 오버레이 제거
	  hideOverlay();
	});
	</script>
  </div>
</html>
