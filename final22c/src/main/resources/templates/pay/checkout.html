<!-- templates/order/checkout.html -->
<html layout:decorate="~{layout/layout}">
  <th:block layout:fragment="css">
    <link rel="stylesheet" href="/css/content.css">
    <style>
      .to-top { display: none !important; }
      .checkout-wrap { max-width:1100px; margin:24px auto; display:grid; grid-template-columns:1fr; gap:16px; }
      .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px;background:#fff}
      .muted{color:#6b7280}
      .summary-row{display:flex;justify-content:space-between;margin:6px 0}
      .btn{width:100%;padding:14px;border-radius:10px;border:0;background:#111;color:#fff;font-weight:700}
      .btn:disabled{opacity:.4}
      .point-box{display:flex;align-items:center;gap:12px}
      .point-box input{width:160px;max-width:40%;border:1px solid #ddd;border-radius:8px;padding:8px 10px}
      .point-badge{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:8px;padding:6px 10px}
      .point-use{padding:8px 12px;border:1px solid #d1d5db;border-radius:8px;background:#f9fafb}
      .addr-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
      .addr-title{font-size:18px;font-weight:700;margin:0}
      .addr-dl{display:grid;row-gap:10px}
      .addr-row{display:grid;grid-template-columns:120px 1fr;align-items:start}
      .addr-row dt{color:#9ca3af;font-size:14px;margin:0}
      .addr-row dd{margin:0;font-size:14px;line-height:1.6;word-break:keep-all}
      .addr-inline{display:flex;align-items:center;justify-content:space-between;gap:10px}
      .addr-inline span{font-weight:500}
      .addr-card .btn{width:auto;padding:3px 30px;font-size:12px;line-height:1.2;border:1px solid #d1d5db;border-radius:4px;background:#f9fafb;color:#333;}
      .addr-card .btn:hover{ background:#f3f4f6; }
      @media (max-width:640px){.addr-row{grid-template-columns:90px 1fr}}
      #payOverlay{ display:none; position:fixed; inset:0; z-index:9998; background:rgba(0,0,0,.5); }
      body.overlay-lock{ overflow:hidden; }
      .line{display:flex;gap:14px;align-items:center;margin-top:10px}
      .thumb{width:60px;height:60px;border:1px solid #eee;border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center}
    </style>
  </th:block>

  <!-- model:
       - 장바구니 모드: items(List<CartLine>), summary(CartView: subtotal, grandTotal), user, defaultAddr
       - 단건 모드: product, qty, lineTotal, user, defaultAddr
  -->
  <div layout:fragment="content"
       th:with="
         isCartMode=${items != null},
         shippingCart=${items != null ? (summary.grandTotal - summary.subtotal) : 0},
         shippingSingle=${3000},
         payTotalSingle=${(lineTotal != null ? lineTotal : 0) + 3000}
       ">

    <div class="checkout-wrap">
      <!-- 배송지 -->
      <div class="card addr-card">
        <div class="addr-head">
          <h3 class="addr-title">배송정보</h3>
        </div>

        <div th:if="${defaultAddr == null}" class="text-muted">
          기본 배송지가 없습니다. <a th:href="@{/mypage/address}">여기</a>에서 등록해 주세요.
        </div>

        <div th:if="${defaultAddr != null}">
          <dl class="addr-dl">
            <div class="addr-row">
              <dt>배송지 이름</dt>
              <dd>
                <div class="addr-inline">
                  <span id="addrName" th:text="${defaultAddr.addressName}">우리집</span>
                  <a href="#" class="btn btn-sm btn-outline-secondary"
                     data-bs-toggle="modal" data-bs-target="#addrModal">변경</a>
                </div>
              </dd>
            </div>

            <div class="addr-row"><dt>받는 분</dt><dd id="addrRecipient" th:text="${defaultAddr.recipient}">홍길동</dd></div>
            <div class="addr-row"><dt>휴대폰 번호</dt><dd id="addrPhone" th:text="${defaultAddr.phone}">01012345678</dd></div>
            <div class="addr-row">
              <dt>주소</dt>
              <dd>
                (<span id="addrZone" th:text="${defaultAddr.zonecode}">14616</span>)
                <span id="addrRoad" th:text="${defaultAddr.roadAddress}">경기 부천시 …</span>
                <span id="addrDetail" th:text="${defaultAddr.detailAddress}">602호</span>
              </dd>
            </div>
          </dl>

          <input type="hidden" id="currentAddressNo" th:value="${defaultAddr.addressNo}">

          <!-- 배송시 요청사항 -->
          <div class="addr-memo mt-3">
            <div class="d-flex gap-2 flex-wrap align-items-center">
              <label class="addr-label d-block mb-1" style="min-width:120px;">배송 시 요청사항</label>
              <select id="deliveryMemoSelect" class="form-select form-select-sm" style="max-width: 240px;">
                <option value="" selected>없음</option>
                <option value="문 앞에 놓아주세요">문 앞에 놓아주세요</option>
                <option value="경비실에 맡겨주세요">경비실에 맡겨주세요</option>
                <option value="자유입력">자유입력</option>
              </select>
              <input type="text" id="deliveryMemoInput" class="form-control form-control-sm"
                     placeholder="요청사항을 입력하세요" style="max-width:420px; display:none;">
            </div>
          </div>
        </div>
      </div>

      <!-- 주문상품 (장바구니 모드) -->
      <div class="card" th:if="${isCartMode}">
        <div class="summary-row">
          <strong>주문상품</strong>
          <span class="muted" th:text="${'총 ' + items.size() + '개'}">총 n개</span>
        </div>0

        <div th:each="it : ${items}" class="line">
          <div class="thumb">
            <img th:src="@{|${it.imgPath}${it.imgName}|}" alt="thumb" style="max-width:100%;max-height:100%;object-fit:cover">
          </div>
          <div style="flex:1">
            <div class="muted" th:text="${'수량 ' + it.quantity}"></div>
            <div th:text="${it.name}">상품명</div>
          </div>
          <div style="font-weight:800" th:text="${#numbers.formatInteger(it.lineTotal,0)} + '원'">0원</div>
        </div>
      </div>

      <!-- 주문상품 (단건 모드) -->
      <div class="card" th:if="${!isCartMode}">
        <div class="summary-row">
          <strong>주문상품</strong><span class="muted">총 1개</span>
        </div>
        <div class="line">
          <div class="thumb">
            <img th:src="@{|${product.imgPath}${product.imgName}|}" alt="thumb" style="max-width:100%;max-height:100%;object-fit:cover">
          </div>
          <div style="flex:1">
            <div class="muted" th:text="${'수량 ' + qty}">수량</div>
            <div th:text="${product.name}">상품명</div>
          </div>
          <div style="font-weight:800" th:text="${#numbers.formatInteger(lineTotal,0)}+'원'">0</div>
        </div>
      </div>

      <!-- 마일리지 -->
      <div class="card">
        <div class="point-box">
          <strong>마일리지</strong>
          <span class="point-badge">보유 <span id="ownedPoint" th:text="${#numbers.formatInteger(user.mileage,0)}"></span> 원</span>
        </div>
        <div class="point-box" style="margin-top:8px;">
          <input id="usePoint" type="text" placeholder="사용할 마일리지" value="0" th:attr="max=${user.mileage}">
          <button type="button" class="point-use" id="btnUseAllPoint">전액사용</button>
        </div>
      </div>

      <!-- 결제 상세 (장바구니 모드) -->
      <div class="card" th:if="${isCartMode}">
        <div class="summary-row">
          <span class="muted">상품금액</span>
          <span th:text="${#numbers.formatInteger(summary.subtotal,0)}+'원'">0원</span>
        </div>
        <div class="summary-row">
          <span class="muted">배송비</span>
          <span th:text="${#numbers.formatInteger(shippingCart,0)}+'원'">3,000원</span>
        </div>
        <div class="summary-row"><span class="muted">사용 마일리지</span><span id="usedPointLabel">0원</span></div>
        <hr style="border:none;border-top:1px solid #eee;margin:10px 0">
        <div class="summary-row" style="font-weight:800"><span>결제금액</span><span id="payTotalLabel" th:text="${#numbers.formatInteger(summary.grandTotal,0)}+'원'"></span></div>
        <div class="summary-row" style="font-weight:800"><span>적립마일리지</span><span id="rewardLabel" th:text="${#numbers.formatInteger(summary.grandTotal*0.05,0)}+'원'"></span></div>

        <input type="hidden" id="mode" value="cart">
        <button id="payBtn" class="btn" type="button">결제하기</button>
      </div>

      <!-- 결제 상세 (단건 모드) -->
      <div class="card" th:if="${!isCartMode}">
        <div class="summary-row"><span class="muted">상품금액</span><span th:text="${#numbers.formatInteger(lineTotal,0)}+'원'">0</span></div>
        <div class="summary-row"><span class="muted">배송비</span><span th:text="${#numbers.formatInteger(shippingSingle,0)}+'원'">3,000</span></div>
        <div class="summary-row"><span class="muted">사용 마일리지</span><span id="usedPointLabel">0원</span></div>
        <hr style="border:none;border-top:1px solid #eee;margin:10px 0">
        <div class="summary-row" style="font-weight:800"><span>결제금액</span><span id="payTotalLabel" th:text="${#numbers.formatInteger(payTotalSingle,0)}+'원'"></span></div>
        <div class="summary-row" style="font-weight:800"><span>적립마일리지</span><span id="rewardLabel" th:text="${#numbers.formatInteger(payTotalSingle*0.05,0)}+'원'"></span></div>

        <input type="hidden" id="mode" value="single">
        <input type="hidden" id="product_id" th:value="${product.id}">
        <input type="hidden" id="qty"        th:value="${qty}">
        <input type="hidden" id="lineTotal"  th:value="${lineTotal}">
        <button id="payBtn" class="btn" type="button">결제하기</button>
      </div>
    </div>

    <!-- 주소 선택 모달 -->
    <div class="modal fade" id="addrModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">배송지 선택</h5>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-secondary" type="button"
                      data-bs-toggle="modal" data-bs-target="#addAddrModal">
                새 주소 등록
              </button>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
          </div>
          <div class="modal-body">
            <div id="addrDefaultBox" class="border rounded p-3 mb-3 bg-light"></div>
            <div id="addrList"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">취소</button>
            <button type="button" id="addrModalApply" class="btn btn-dark">선택한 주소 사용</button>
            <button type="button" id="addrModalSet" class="btn btn-outline-secondary">기본 배송지로 설정</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 새 주소 등록 모달 -->
    <div class="modal fade" id="addAddrModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content">
          <form id="addAddrForm">
            <div class="modal-header">
              <h5 class="modal-title">새 주소 등록</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>

            <div class="modal-body">
              <div class="row g-2">
                <div class="col-sm-6">
                  <label class="form-label form-label-sm">배송지명</label>
                  <input type="text" class="form-control form-control-sm" id="f_addressName" required>
                </div>
                <div class="col-sm-3">
                  <label class="form-label form-label-sm">받는 사람</label>
                  <input type="text" class="form-control form-control-sm" id="f_recipient" required>
                </div>
                <div class="col-sm-3">
                  <label class="form-label form-label-sm">전화번호</label>
                  <input type="text" class="form-control form-control-sm" id="f_phone" maxlength="11" placeholder="010..." required>
                </div>

                <div class="col-12 d-flex gap-2">
                  <button type="button" class="btn btn-sm btn-outline-secondary" id="btnFindZip2">주소 찾기</button>
                  <input type="text" class="form-control form-control-sm" id="f_zonecode" placeholder="우편번호" readonly required>
                </div>

                <div class="col-12">
                  <input type="text" class="form-control form-control-sm" id="f_roadAddress" placeholder="도로명" readonly required>
                </div>

                <div class="col-12">
                  <input type="text" class="form-control form-control-sm" id="f_detailAddress" placeholder="상세주소" required>
                </div>

                <!-- 기본배송지 저장 옵션 -->
                <div class="col-12 form-check mt-2">
                  <input class="form-check-input" type="checkbox" id="f_isDefault">
                  <label class="form-check-label" for="f_isDefault">이 주소를 기본 배송지로 저장</label>
                </div>

                <div id="postcodeLayer2" style="display:none; position:relative; height:400px; margin-top:8px; border:1px solid #eee; border-radius:10px;"></div>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">취소</button>
              <button type="submit" class="btn btn-dark">등록</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- 결제 오버레이 -->
    <div id="payOverlay"></div>

    <!-- jQuery / Bootstrap / 다음 우편번호 -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <!-- ✅ 전역: 모달이 모두 닫히면 스크롤 잠금/백드롭 확실히 해제 -->
    <script>
      (function(){
        function fullyUnlockScroll(){
          if ($('.modal.show').length === 0) {
            $('body').removeClass('modal-open overlay-lock')
                     .css({ overflow: '', 'padding-right': '' });
            $('.modal-backdrop').remove();
            $('#payOverlay').hide();
          }
        }
        document.addEventListener('hidden.bs.modal', fullyUnlockScroll);
        window.addEventListener('resize', function(){ setTimeout(fullyUnlockScroll, 0); });
        window._unlockAfterAddressChange = function(){ setTimeout(fullyUnlockScroll, 50); };
      })();
    </script>

    <script th:inline="javascript">
    $(function(){
      /* ================== 안전한 서버 변수 바인딩 ================== */
      const isCartMode = /*[[${#ctx.containsVariable('isCartMode') ? isCartMode : false}]]*/ false;
      const owned = /*[[${#ctx.containsVariable('user') && user.mileage != null ? user.mileage : 0}]]*/ 0;
      const cartSubtotal  = /*[[${#ctx.containsVariable('summary') ? summary.subtotal : 0}]]*/ 0;
      const singleLineSum = /*[[${#ctx.containsVariable('lineTotal') ? lineTotal : 0}]]*/ 0;
      const shippingCart   = /*[[${#ctx.containsVariable('shippingCart') ? shippingCart : 3000}]]*/ 3000;
      const shippingSingle = /*[[${#ctx.containsVariable('shippingSingle') ? shippingSingle : 3000}]]*/ 3000;

      const subtotal = isCartMode ? cartSubtotal : singleLineSum;
      const shipping = isCartMode ? shippingCart : shippingSingle;
      const baseSum  = Math.max(0, subtotal + shipping);

      const cartItems = /*[[${#ctx.containsVariable('items') ? items : null}]]*/ null;
      const safeCartItems = Array.isArray(cartItems) ? cartItems : [];

      const $productId = $("#product_id");
      const $qty       = $("#qty");

      /* ================== 포인트 UI ================== */
      const fmt = n => (Math.max(0, Math.trunc(n))).toLocaleString('ko-KR') + '원';
      $("#usePoint").on("input", function(){ this.value = this.value.replace(/[^\d]/g, ''); });

      if ($("#_usedPoint").length === 0) {
        $("body").append('<input type="hidden" id="_usedPoint" value="0"><input type="hidden" id="_pay" value="'+baseSum+'">');
      }

      function recalc(use){
        use = Math.min(Math.max(0, Number(use)||0), owned, baseSum);
        $("#usePoint").val(use);
        $("#usedPointLabel").text(use.toLocaleString('ko-KR') + '원');
        const pay = Math.max(0, baseSum - use);
        $("#payTotalLabel").text(fmt(pay));
        $("#rewardLabel").text(fmt(Math.trunc(pay * 0.05)));
        $("#_usedPoint").val(use);
        $("#_pay").val(pay);
      }
      recalc(0);

      $("#btnUseAllPoint").on("click", ()=> recalc(Math.min(owned, baseSum)));
      $("#usePoint").on("input change", function(){ recalc(this.value); });

      /* ================== 배송요청사항 ================== */
      const $memoSel = $("#deliveryMemoSelect");
      const $memoInp = $("#deliveryMemoInput");
      function currentMemo(){                         // ★
        const v = $memoSel.val();
        return (v === "자유입력") ? ($memoInp.val() || "") : (v || "");
      }
      function syncDeliveryMemo(){
        if (!$memoSel.length) return;
        const v = $memoSel.val();
        if (v === "자유입력") { $memoInp.show().focus(); }
        else { $memoInp.hide().val(""); }
      }
      if ($memoSel.length) {
        $memoSel.on("change", syncDeliveryMemo);
        syncDeliveryMemo();
      }

      /* ================== 공통: 주소 뷰 반영/캐시 ================== */
      let __addrCache = [];
      function applyAddressToView(a){
        if (!a) return;
        $("#currentAddressNo").val(a.addressNo);
        $("#addrName").text(a.addressName || '');
        $("#addrRecipient").text(a.recipient || '');
        $("#addrPhone").text(a.phone || '');
        $("#addrZone").text(a.zonecode || '');
        $("#addrRoad").text(a.roadAddress || '');
        $("#addrDetail").text(a.detailAddress || '');
      }

      /* ================== 주소 모달 ================== */
      const addrModalEl = document.getElementById('addrModal');
      if (addrModalEl) {
        const addrModal   = new bootstrap.Modal(addrModalEl);
        addrModalEl.addEventListener('show.bs.modal', () => { loadAddressList(); });
        addrModalEl.addEventListener('hidden.bs.modal', () => {
          document.body.classList.remove('modal-open');
          document.body.style.removeProperty('padding-right');
          $('.modal-backdrop').remove();
        });

        function loadAddressList(){
          const currentNo = $("#currentAddressNo").val();
          $("#addrList").html('<div class="text-muted">불러오는 중…</div>');
          $("#addrDefaultBox").empty();
          $.get("/mypage/address/list")
            .done(function(res){
              const arr = (res && res.addresses) || [];
              __addrCache = arr;

              const def = arr.find(a => a.isDefault === 'Y');
              if (def) {
                $("#addrDefaultBox").html(`
                  <div class="fw-bold mb-1">기본 배송지</div>
                  <div>${esc(def.addressName||'')}</div>
                  <div>${esc(def.recipient||'')} / ${esc(def.phone||'')}</div>
                  <div>(${esc(def.zonecode||'')}) ${esc(def.roadAddress||'')} ${esc(def.detailAddress||'')}</div>
                `);
              }
              if (arr.length === 0) { $("#addrList").html('<div class="text-muted">등록된 배송지가 없습니다.</div>'); return; }

              const html = arr.map(a => {
                const checked = String(a.addressNo) === String(currentNo) ? 'checked' : '';
                return `
                  <div class="form-check border rounded p-3 mb-2">
                    <input class="form-check-input" type="radio" name="addrChoice" id="addr_${a.addressNo}"
                           value="${a.addressNo}" ${checked}>
                    <label class="form-check-label w-100" for="addr_${a.addressNo}">
                      <div class="fw-semibold">${esc(a.addressName||'')}</div>
                      <div class="text-muted">수령인 ${esc(a.recipient||'')} / ${esc(a.phone||'')}</div>
                      <div>주소 (${esc(a.zonecode||'')}) ${esc(a.roadAddress||'')} ${esc(a.detailAddress||'')}</div>
                    </label>
                  </div>`;
              }).join("");
              $("#addrList").html(html);
            })
            .fail(() => { $("#addrList").html('<div class="text-danger">주소를 불러오지 못했습니다.</div>'); });
        }

        // 이번 주문만 적용
        $("#addrModalApply").on("click", function(){
          const $sel = $("input[name=addrChoice]:checked");
          if ($sel.length === 0) { alert("주소를 선택해 주세요."); return; }
          const no = String($sel.val());
          const a  = (__addrCache || []).find(x => String(x.addressNo) === no);
          if (!a) { alert("주소 정보를 찾을 수 없습니다."); return; }
          applyAddressToView(a);
          bootstrap.Modal.getInstance(addrModalEl).hide();
          window._unlockAfterAddressChange(); // 스크롤 복구
        });

        // 기본 배송지로 설정(서버)
        $("#addrModalSet").on("click", function(){
          const $sel = $("input[name=addrChoice]:checked");
          if ($sel.length === 0) { alert("주소를 선택해 주세요."); return; }
          const addressNo = Number($sel.val());
          const token  = $('meta[name="_csrf"]').attr('content');
          const header = $('meta[name="_csrf_header"]').attr('content');
          $.ajax({
            type: "POST",
            url:  "/mypage/address/default",
            data: JSON.stringify({ addressNo }),
            contentType: "application/json; charset=UTF-8",
            dataType: "json",
            beforeSend: function(xhr){ if (token && header) xhr.setRequestHeader(header, token); }
          })
          .done(function(res){
            if (!res || !res.ok || !res.address) { alert("설정에 실패했습니다."); return; }
            const a = res.address;
            applyAddressToView(a);
            bootstrap.Modal.getInstance(addrModalEl).hide();
            window._unlockAfterAddressChange(); // 스크롤 복구
          })
          .fail(function(xhr){ alert("설정에 실패했습니다. ("+xhr.status+")"); });
        });
      }

      /* ================== 다음(카카오) 우편번호 모달 ================== */
      const addAddrModalEl = document.getElementById('addAddrModal');
      if (addAddrModalEl) {
        const addAddrModal   = new bootstrap.Modal(addAddrModalEl);
        addAddrModalEl.addEventListener('show.bs.modal', () => {
          $("#f_addressName,#f_recipient,#f_phone,#f_zonecode,#f_roadAddress,#f_detailAddress").val('');
          $("#f_isDefault").prop("checked", false);
          $("#postcodeLayer2").hide().empty();
        });
        addAddrModalEl.addEventListener('hidden.bs.modal', () => { $('.modal-backdrop').each(function(i, el){ if (i) $(el).remove(); }); });

        function openPostcodeIn(layerId, zoneInput, roadInput) {
          const $ly = $(layerId);
          new daum.Postcode({
            oncomplete: function(data){
              $(zoneInput).val(data.zonecode || '');
              $(roadInput).val(data.roadAddress || data.jibunAddress || '');
              $ly.hide().empty();
              $("#f_detailAddress").focus();
            },
            onresize : function(size){ $ly.height(size.height); }
          }).embed($ly.get(0));
          $ly.show();
        }
        $("#btnFindZip2").on("click", function(){ openPostcodeIn("#postcodeLayer2", "#f_zonecode", "#f_roadAddress"); });

        // 새 주소 저장
        $("#addAddrForm").on("submit", function(e){
          e.preventDefault();
          const data = {
            addressName:   $("#f_addressName").val().trim(),
            recipient:     $("#f_recipient").val().trim(),
            phone:         $("#f_phone").val().trim(),
            zonecode:      $("#f_zonecode").val().trim(),
            roadAddress:   $("#f_roadAddress").val().trim(),
            detailAddress: $("#f_detailAddress").val().trim(),
            isDefault:     $("#f_isDefault").is(":checked")
          };
          if (!data.addressName || !data.recipient || !data.phone || !data.zonecode || !data.roadAddress) {
            alert("필수 항목을 입력해 주세요."); return;
          }
          const token  = $('meta[name="_csrf"]').attr('content');
          const header = $('meta[name="_csrf_header"]').attr('content');
          $.ajax({
            type: "POST",
            url:  "/mypage/address/new",
            data,
            beforeSend: function(xhr){ if (token && header) xhr.setRequestHeader(header, token); },
            dataType: "json"
          })
          .done(function(res){
            if (!res || !res.ok || !res.address) { alert("등록에 실패했습니다."); return; }
            const a = res.address;

            // 기본 체크 여부와 무관하게 이번 주문 화면엔 즉시 적용
            applyAddressToView(a);

            const addModalInst  = bootstrap.Modal.getInstance(addAddrModalEl);
            if (addModalInst) addModalInst.hide();
            const addrModalInst = bootstrap.Modal.getInstance(document.getElementById('addrModal'));
            if (addrModalInst) addrModalInst.hide();

            window._unlockAfterAddressChange(); // 스크롤 복구
          })
          .fail(function(xhr){ alert("등록 실패 ("+xhr.status+")"); });
        });
      }

      /* ================== 결제 팝업/오버레이 ================== */
      function showOverlay(){ $("#payOverlay").show(); $("body").addClass("overlay-lock"); }
      function hideOverlay(){ $("#payOverlay").hide(); $("body").removeClass("overlay-lock"); }
      $("#payOverlay").on("click", hideOverlay);

      function openCenteredPopup(url, w=520, h=720){
        const dualScreenLeft = (window.screenLeft ?? window.screenX) || 0;
        const dualScreenTop  = (window.screenTop  ?? window.screenY) || 0;
        const width  = window.outerWidth  || document.documentElement.clientWidth  || screen.width;
        const height = window.outerHeight || document.documentElement.clientHeight || screen.height;
        const left = dualScreenLeft + Math.max(0, (width  - w) / 2);
        const top  = dualScreenTop  + Math.max(0, (height - h) / 2);
        const features = `popup=yes,width=${w},height=${h},left=${left},top=${top},resizable=yes,scrollbars=yes,status=no,toolbar=no,menubar=no,location=no`;
        return window.open(url, "kakaopay_popup", features);
      }

      function watchPopupClose(win, orderId){
        const timer = setInterval(function(){
          if (!win || win.closed) {
            clearInterval(timer);
            setTimeout(function(){
              $.get('/pay/order/' + orderId + '/status')
                .done(function(res){
                  const st = (res && res.status || '').toUpperCase();
                  hideOverlay();
                  if (st === 'PAID')           window.location.href = '/main/list';
                  else if (st === 'PENDING')   alert('결제가 완료되지 않았습니다. 다시 시도하거나 취소할 수 있어요.');
                  else                         alert('결제가 취소되었습니다.');
                })
                .fail(function(){ hideOverlay(); alert('결과 확인 실패. 잠시 후 새로고침해 주세요.'); });
            }, 1000);
          }
        }, 300);
      }

      /* ================== ★ 배송지 스냅샷 헬퍼 ================== */
      function getShipSnapshot(){                               // ★ 추가
        return {
          addressNo:     Number($("#currentAddressNo").val()) || null,
          addressName:   $("#addrName").text().trim(),
          recipient:     $("#addrRecipient").text().trim(),
          phone:         $("#addrPhone").text().trim(),
          zonecode:      $("#addrZone").text().trim(),
          roadAddress:   $("#addrRoad").text().trim(),
          detailAddress: $("#addrDetail").text().trim(),
          memo:          currentMemo()
        };
      }

      /* ================== 결제 버튼 ================== */
      $("#payBtn").on("click", function(e){
        e.preventDefault();
        const usedPoint = Number($("#_usedPoint").val()) || 0;
        const token  = $('meta[name="_csrf"]').attr('content');
        const header = $('meta[name="_csrf_header"]').attr('content');
        const ship   = getShipSnapshot();                        // ★ 추가

        if (isCartMode) {
          const payload = (safeCartItems || []).map(it => ({
            cartDetailId: it.cartDetailId,
            quantity: Math.max(1, Number(it.quantity)||1),
          }));
          if (payload.length === 0) { alert("선택된 상품이 없습니다."); return; }

          $.ajax({
            type: "POST",
            url:  "/pay/ready/cart",
            data: JSON.stringify({ usedPoint, items: payload, ship }), // ★ ship 포함
            contentType: "application/json; charset=UTF-8",
            beforeSend: function(xhr){ if (token && header) xhr.setRequestHeader(header, token); },
            success: onReadyOk,
            error: onReadyErr
          });
        } else {
          const productId = Number($productId.val());
          const qty       = Math.max(1, Number($qty.val())||1);

          $.ajax({
            type: "POST",
            url:  "/pay/ready/single",
            data: JSON.stringify({ productId, quantity: qty, usedPoint, ship }), // ★ ship 포함
            contentType: "application/json; charset=UTF-8",
            beforeSend: function(xhr){ if (token && header) xhr.setRequestHeader(header, token); },
            success: onReadyOk,
            error: onReadyErr
          });
        }

        function onReadyOk(res){
          const payUrl  = res && res.next_redirect_pc_url;
          const orderId = res && res.orderId;
          if (!payUrl || !orderId) { alert("응답 형식이 올바르지 않습니다."); console.log(res); return; }
          showOverlay();
          const win = openCenteredPopup(payUrl, 520, 720);
          if (win && !win.closed) { try { win.focus(); } catch(_) {} watchPopupClose(win, orderId); }
          else { hideOverlay(); window.location.href = payUrl; }
        }
        function onReadyErr(xhr){ hideOverlay(); alert("결제 준비 실패 (" + xhr.status + ")\n" + (xhr.responseText||"")); }
      });

      function esc(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
      $("#payOverlay").hide(); $("body").removeClass("overlay-lock");
    });
    </script>
  </div>
</html>
