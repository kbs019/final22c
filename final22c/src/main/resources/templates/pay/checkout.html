<!-- templates/order/checkout.html -->
<html layout:decorate="~{layout/layout}">
  <th:block layout:fragment="css">
    <link rel="stylesheet" href="/css/content.css">
    <style>
      .to-top { display: none !important; }
      .checkout-wrap { max-width:1100px; margin:24px auto; display:grid; grid-template-columns:1fr; gap:16px; }
      .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px;background:#fff}
      .muted{color:#6b7280}
      .summary-row{display:flex;justify-content:space-between;margin:6px 0}
      .btn{width:100%;padding:14px;border-radius:10px;border:0;background:#111;color:#fff;font-weight:700}
      .btn:disabled{opacity:.4}
      .point-box{display:flex;align-items:center;gap:12px}
      .point-box input{width:160px;max-width:40%;border:1px solid #ddd;border-radius:8px;padding:8px 10px}
      .point-badge{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:8px;padding:6px 10px}
      .point-use{padding:8px 12px;border:1px solid #d1d5db;border-radius:8px;background:#f9fafb}
      .addr-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
      .addr-title{font-size:18px;font-weight:700;margin:0}
      .addr-dl{display:grid;row-gap:10px}
      .addr-row{display:grid;grid-template-columns:120px 1fr;align-items:start}
      .addr-row dt{color:#9ca3af;font-size:14px;margin:0}
      .addr-row dd{margin:0;font-size:14px;line-height:1.6;word-break:keep-all}
      .addr-inline{display:flex;align-items:center;justify-content:space-between;gap:10px}
      .addr-inline span{font-weight:500}
      .addr-card .btn{width:auto;padding:3px 30px;font-size:12px;line-height:1.2;border:1px solid #d1d5db;border-radius:4px;background:#f9fafb;color:#333;}
      .addr-card .btn:hover{ background:#f3f4f6; }
      @media (max-width:640px){.addr-row{grid-template-columns:90px 1fr}}
      #payOverlay{ display:none; position:fixed; inset:0; z-index:9998; background:rgba(0,0,0,.5); }
      body.overlay-lock{ overflow:hidden; }
      .line{display:flex;gap:14px;align-items:center;margin-top:10px}
      .thumb{width:60px;height:60px;border:1px solid #eee;border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center}
    </style>
  </th:block>

  <!-- model:
       - ì¥ë°”êµ¬ë‹ˆ ëª¨ë“œ: items(List<CartLine>), summary(CartView: subtotal, grandTotal), user, defaultAddr
       - ë‹¨ê±´ ëª¨ë“œ: product, qty, lineTotal, user, defaultAddr
  -->
  <div layout:fragment="content"
       th:with="
         isCartMode=${items != null},
         shippingCart=${items != null ? (summary.grandTotal - summary.subtotal) : 0},
         shippingSingle=${3000},
         payTotalSingle=${(lineTotal != null ? lineTotal : 0) + 3000}
       ">

    <div class="checkout-wrap">
      <!-- ë°°ì†¡ì§€ -->
      <div class="card addr-card">
        <div class="addr-head">
          <h3 class="addr-title">ë°°ì†¡ì •ë³´</h3>
        </div>

        <div th:if="${defaultAddr == null}" class="text-muted">
          ê¸°ë³¸ ë°°ì†¡ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. <a th:href="@{/mypage/address}">ì—¬ê¸°</a>ì—ì„œ ë“±ë¡í•´ ì£¼ì„¸ìš”.
        </div>

        <div th:if="${defaultAddr != null}">
          <dl class="addr-dl">
            <div class="addr-row">
              <dt>ë°°ì†¡ì§€ ì´ë¦„</dt>
              <dd>
                <div class="addr-inline">
                  <span id="addrName" th:text="${defaultAddr.addressName}">ìš°ë¦¬ì§‘</span>
                  <a href="#" class="btn btn-sm btn-outline-secondary"
                     data-bs-toggle="modal" data-bs-target="#addrModal">ë³€ê²½</a>
                </div>
              </dd>
            </div>

            <div class="addr-row"><dt>ë°›ëŠ” ë¶„</dt><dd id="addrRecipient" th:text="${defaultAddr.recipient}">í™ê¸¸ë™</dd></div>
            <div class="addr-row"><dt>íœ´ëŒ€í° ë²ˆí˜¸</dt><dd id="addrPhone" th:text="${defaultAddr.phone}">01012345678</dd></div>
            <div class="addr-row">
              <dt>ì£¼ì†Œ</dt>
              <dd>
                (<span id="addrZone" th:text="${defaultAddr.zonecode}">14616</span>)
                <span id="addrRoad" th:text="${defaultAddr.roadAddress}">ê²½ê¸° ë¶€ì²œì‹œ â€¦</span>
                <span id="addrDetail" th:text="${defaultAddr.detailAddress}">602í˜¸</span>
              </dd>
            </div>
          </dl>

          <input type="hidden" id="currentAddressNo" th:value="${defaultAddr.addressNo}">

          <!-- ë°°ì†¡ì‹œ ìš”ì²­ì‚¬í•­ (í‘œì‹œë§Œ) -->
          <div class="addr-memo mt-3">
            <div class="d-flex gap-2 flex-wrap align-items-center">
              <label class="addr-label d-block mb-1" style="min-width:120px;">ë°°ì†¡ ì‹œ ìš”ì²­ì‚¬í•­</label>
              <select id="deliveryMemoSelect" class="form-select form-select-sm" style="max-width: 240px;">
                <option value="" selected>ì„ íƒí•´ ì£¼ì„¸ìš”</option>
                <option value="ë¬¸ ì•ì— ë†“ì•„ì£¼ì„¸ìš”">ë¬¸ ì•ì— ë†“ì•„ì£¼ì„¸ìš”</option>
                <option value="ê²½ë¹„ì‹¤ì— ë§¡ê²¨ì£¼ì„¸ìš”">ê²½ë¹„ì‹¤ì— ë§¡ê²¨ì£¼ì„¸ìš”</option>
                <option value="ììœ ì…ë ¥">ììœ ì…ë ¥</option>
              </select>
              <input type="text" id="deliveryMemoInput"
                     class="form-control form-control-sm"
                     placeholder="ìš”ì²­ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”"
                     style="max-width:420px; display:none;">
            </div>
          </div>
        </div>
      </div>

      <!-- ì£¼ë¬¸ìƒí’ˆ (ì¥ë°”êµ¬ë‹ˆ ëª¨ë“œ) -->
      <div class="card" th:if="${isCartMode}">
        <div class="summary-row">
          <strong>ì£¼ë¬¸ìƒí’ˆ</strong>
          <span class="muted" th:text="${'ì´ ' + items.size() + 'ê°œ'}">ì´ nê°œ</span>
        </div>

        <div th:each="it : ${items}" class="line">
          <div class="thumb">
            <img th:src="@{|${it.imgPath}${it.imgName}|}" alt="thumb" style="max-width:100%;max-height:100%;object-fit:cover">
          </div>
          <div style="flex:1">
            <div class="muted" th:text="${'ìˆ˜ëŸ‰ ' + it.quantity}"></div>
            <div th:text="${it.name}">ìƒí’ˆëª…</div>
          </div>
          <div style="font-weight:800"
               th:text="${#numbers.formatInteger(it.lineTotal,0)} + 'ì›'">0ì›</div>
        </div>
      </div>

      <!-- ì£¼ë¬¸ìƒí’ˆ (ë‹¨ê±´ ëª¨ë“œ) -->
      <div class="card" th:if="${!isCartMode}">
        <div class="summary-row">
          <strong>ì£¼ë¬¸ìƒí’ˆ</strong><span class="muted">ì´ 1ê°œ</span>
        </div>
        <div class="line">
          <div class="thumb">
            <img th:src="@{|${product.imgPath}${product.imgName}|}" alt="thumb" style="max-width:100%;max-height:100%;object-fit:cover">
          </div>
          <div style="flex:1">
            <div class="muted" th:text="${'ìˆ˜ëŸ‰ ' + qty}">ìˆ˜ëŸ‰</div>
            <div th:text="${product.name}">ìƒí’ˆëª…</div>
          </div>
          <div style="font-weight:800" th:text="${#numbers.formatInteger(lineTotal,0)}+'ì›'">0</div>
        </div>
      </div>

      <!-- ë§ˆì¼ë¦¬ì§€ -->
      <div class="card">
        <div class="point-box">
          <strong>ë§ˆì¼ë¦¬ì§€</strong>
          <span class="point-badge">ë³´ìœ  <span id="ownedPoint" th:text="${#numbers.formatInteger(user.mileage,0)}"></span> ì›</span>
        </div>
        <div class="point-box" style="margin-top:8px;">
          <input id="usePoint" type="text" placeholder="ì‚¬ìš©í•  ë§ˆì¼ë¦¬ì§€" value="0" th:attr="max=${user.mileage}">
          <button type="button" class="point-use" id="btnUseAllPoint">ì „ì•¡ì‚¬ìš©</button>
        </div>
      </div>

      <!-- ê²°ì œ ìƒì„¸ (ì¥ë°”êµ¬ë‹ˆ ëª¨ë“œ) -->
      <div class="card" th:if="${isCartMode}">
        <div class="summary-row">
          <span class="muted">ìƒí’ˆê¸ˆì•¡</span>
          <span th:text="${#numbers.formatInteger(summary.subtotal,0)}+'ì›'">0ì›</span>
        </div>
        <div class="summary-row">
          <span class="muted">ë°°ì†¡ë¹„</span>
          <span th:text="${#numbers.formatInteger(shippingCart,0)}+'ì›'">3,000ì›</span>
        </div>
        <div class="summary-row"><span class="muted">ì‚¬ìš© ë§ˆì¼ë¦¬ì§€</span><span id="usedPointLabel">0ì›</span></div>
        <hr style="border:none;border-top:1px solid #eee;margin:10px 0">
        <div class="summary-row" style="font-weight:800"><span>ê²°ì œê¸ˆì•¡</span><span id="payTotalLabel" th:text="${#numbers.formatInteger(summary.grandTotal,0)}+'ì›'"></span></div>
        <div class="summary-row" style="font-weight:800"><span>ì ë¦½ë§ˆì¼ë¦¬ì§€</span><span id="rewardLabel" th:text="${#numbers.formatInteger(summary.grandTotal*0.05,0)}+'ì›'"></span></div>

        <!-- ë‹¤ê±´ ê²°ì œìš© hidden (JSì—ì„œ payload êµ¬ì„±) -->
        <input type="hidden" id="mode" value="cart">
        <button id="payBtn" class="btn" type="button">ê²°ì œí•˜ê¸°</button>
      </div>

      <!-- ê²°ì œ ìƒì„¸ (ë‹¨ê±´ ëª¨ë“œ) -->
      <div class="card" th:if="${!isCartMode}">
        <div class="summary-row"><span class="muted">ìƒí’ˆê¸ˆì•¡</span><span th:text="${#numbers.formatInteger(lineTotal,0)}+'ì›'">0</span></div>
        <div class="summary-row"><span class="muted">ë°°ì†¡ë¹„</span><span th:text="${#numbers.formatInteger(shippingSingle,0)}+'ì›'">3,000</span></div>
        <div class="summary-row"><span class="muted">ì‚¬ìš© ë§ˆì¼ë¦¬ì§€</span><span id="usedPointLabel">0ì›</span></div>
        <hr style="border:none;border-top:1px solid #eee;margin:10px 0">
        <div class="summary-row" style="font-weight:800"><span>ê²°ì œê¸ˆì•¡</span><span id="payTotalLabel" th:text="${#numbers.formatInteger(payTotalSingle,0)}+'ì›'"></span></div>
        <div class="summary-row" style="font-weight:800"><span>ì ë¦½ë§ˆì¼ë¦¬ì§€</span><span id="rewardLabel" th:text="${#numbers.formatInteger(payTotalSingle*0.05,0)}+'ì›'"></span></div>

        <!-- ë‹¨ê±´ hidden -->
        <input type="hidden" id="mode" value="single">
        <input type="hidden" id="product_id" th:value="${product.id}">
        <input type="hidden" id="qty"        th:value="${qty}">
        <input type="hidden" id="lineTotal"  th:value="${lineTotal}">
        <button id="payBtn" class="btn" type="button">ê²°ì œí•˜ê¸°</button>
      </div>
    </div>

    <!-- ì£¼ì†Œ ì„ íƒ ëª¨ë‹¬ -->
    <div class="modal fade" id="addrModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ë°°ì†¡ì§€ ì„ íƒ</h5>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-secondary" type="button"
                      data-bs-toggle="modal" data-bs-target="#addAddrModal">
                ìƒˆ ì£¼ì†Œ ë“±ë¡
              </button>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
            </div>
          </div>
          <div class="modal-body">
            <div id="addrDefaultBox" class="border rounded p-3 mb-3 bg-light"></div>
            <div id="addrList"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
            <!-- âœ… ì´ë²ˆ ì£¼ë¬¸ë§Œ ì ìš© -->
            <button type="button" id="addrModalApply" class="btn btn-dark">ì„ íƒí•œ ì£¼ì†Œ ì‚¬ìš©</button>
            <!-- ê¸°ì¡´: ê¸°ë³¸ë°°ì†¡ì§€ ë³€ê²½ -->
            <button type="button" id="addrModalSet" class="btn btn-outline-secondary">ê¸°ë³¸ ë°°ì†¡ì§€ë¡œ ì„¤ì •</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ìƒˆ ì£¼ì†Œ ë“±ë¡ ëª¨ë‹¬ (ê¸°ë³¸ë°°ì†¡ì§€ ì €ì¥ì€ ì˜µì…˜) -->
    <div class="modal fade" id="addAddrModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content">
          <form id="addAddrForm">
            <div class="modal-header">
              <h5 class="modal-title">ìƒˆ ì£¼ì†Œ ë“±ë¡</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
            </div>

            <div class="modal-body">
              <div class="row g-2">
                <div class="col-sm-6">
                  <label class="form-label form-label-sm">ë°°ì†¡ì§€ëª…</label>
                  <input type="text" class="form-control form-control-sm" id="f_addressName" required>
                </div>
                <div class="col-sm-3">
                  <label class="form-label form-label-sm">ë°›ëŠ” ì‚¬ëŒ</label>
                  <input type="text" class="form-control form-control-sm" id="f_recipient" required>
                </div>
                <div class="col-sm-3">
                  <label class="form-label form-label-sm">ì „í™”ë²ˆí˜¸</label>
                  <input type="text" class="form-control form-control-sm" id="f_phone" maxlength="11" placeholder="010..." required>
                </div>

                <div class="col-12 d-flex gap-2">
                  <button type="button" class="btn btn-sm btn-outline-secondary" id="btnFindZip2">ì£¼ì†Œ ì°¾ê¸°</button>
                  <input type="text" class="form-control form-control-sm" id="f_zonecode" placeholder="ìš°í¸ë²ˆí˜¸" readonly required>
                </div>

                <div class="col-12">
                  <input type="text" class="form-control form-control-sm" id="f_roadAddress" placeholder="ë„ë¡œëª…" readonly required>
                </div>

                <div class="col-12">
                  <input type="text" class="form-control form-control-sm" id="f_detailAddress" placeholder="ìƒì„¸ì£¼ì†Œ" required>
                </div>

                <!-- âœ… ê¸°ë³¸ë°°ì†¡ì§€ ì €ì¥ ì˜µì…˜ -->
                <div class="col-12 form-check mt-2">
                  <input class="form-check-input" type="checkbox" id="f_isDefault">
                  <label class="form-check-label" for="f_isDefault">ì´ ì£¼ì†Œë¥¼ ê¸°ë³¸ ë°°ì†¡ì§€ë¡œ ì €ì¥</label>
                </div>

                <div id="postcodeLayer2" style="display:none; position:relative; height:400px; margin-top:8px; border:1px solid #eee; border-radius:10px;"></div>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
              <button type="submit" class="btn btn-dark">ë“±ë¡</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ê²°ì œ ì˜¤ë²„ë ˆì´ -->
    <div id="payOverlay"></div>

    <!-- jQuery / Bootstrap / ë‹¤ìŒ ìš°í¸ë²ˆí˜¸ -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <script th:inline="javascript">
    $(function(){
      /* ================== ì•ˆì „í•œ ì„œë²„ ë³€ìˆ˜ ë°”ì¸ë”© ================== */
      const isCartMode = /*[[${#ctx.containsVariable('isCartMode') ? isCartMode : false}]]*/ false;
      const owned = /*[[${#ctx.containsVariable('user') && user.mileage != null ? user.mileage : 0}]]*/ 0;
      const cartSubtotal  = /*[[${#ctx.containsVariable('summary') ? summary.subtotal : 0}]]*/ 0;
      const singleLineSum = /*[[${#ctx.containsVariable('lineTotal') ? lineTotal : 0}]]*/ 0;
      const shippingCart   = /*[[${#ctx.containsVariable('shippingCart') ? shippingCart : 3000}]]*/ 3000;
      const shippingSingle = /*[[${#ctx.containsVariable('shippingSingle') ? shippingSingle : 3000}]]*/ 3000;

      const subtotal = isCartMode ? cartSubtotal : singleLineSum;
      const shipping = isCartMode ? shippingCart : shippingSingle;
      const baseSum  = Math.max(0, subtotal + shipping);

      const cartItems = /*[[${#ctx.containsVariable('items') ? items : null}]]*/ null;
      const safeCartItems = Array.isArray(cartItems) ? cartItems : [];

      const $productId = $("#product_id");
      const $qty       = $("#qty");

      /* ================== í¬ì¸íŠ¸ UI ================== */
      const fmt = n => (Math.max(0, Math.trunc(n))).toLocaleString('ko-KR') + 'ì›';
      $("#usePoint").on("input", function(){ this.value = this.value.replace(/[^\d]/g, ''); });

      if ($("#_usedPoint").length === 0) {
        $("body").append('<input type="hidden" id="_usedPoint" value="0"><input type="hidden" id="_pay" value="'+baseSum+'">');
      }

      function recalc(use){
        use = Math.min(Math.max(0, Number(use)||0), owned, baseSum);
        $("#usePoint").val(use);
        $("#usedPointLabel").text(use.toLocaleString('ko-KR') + 'ì›');
        const pay = Math.max(0, baseSum - use);
        $("#payTotalLabel").text(fmt(pay));
        $("#rewardLabel").text(fmt(Math.trunc(pay * 0.05)));
        $("#_usedPoint").val(use);
        $("#_pay").val(pay);
      }
      recalc(0);

      $("#btnUseAllPoint").on("click", ()=> recalc(Math.min(owned, baseSum)));
      $("#usePoint").on("input change", function(){ recalc(this.value); });

      /* ================== (ì„ íƒ) ë°°ì†¡ìš”ì²­ì‚¬í•­ UI ================== */
      const $memoSel = $("#deliveryMemoSelect");
      const $memoInp = $("#deliveryMemoInput");
      const $memoPreview = $("#deliveryMemoPreview");
      function syncDeliveryMemo(){
        if (!$memoSel.length) return;
        const v = $memoSel.val();
        if (v === "ììœ ì…ë ¥") { $memoInp.show().focus(); $memoPreview.text($memoInp.val()?.trim() ? $memoInp.val() : "(ì§ì ‘ ì…ë ¥)"); }
        else { $memoInp.hide().val(""); $memoPreview.text(v ? v : "(ìš”ì²­ì‚¬í•­ ì—†ìŒ)"); }
      }
      if ($memoSel.length) {
        $memoSel.on("change", syncDeliveryMemo);
        $memoInp.on("input", function(){ if ($memoSel.val() === "ììœ ì…ë ¥") $memoPreview.text(this.value.trim() ? this.value : "(ì§ì ‘ ì…ë ¥)"); });
        syncDeliveryMemo();
      }

      /* ================== ê³µí†µ: ì£¼ì†Œ ë·° ë°˜ì˜/ìºì‹œ ================== */
      let __addrCache = [];
      function applyAddressToView(a){
        if (!a) return;
        $("#currentAddressNo").val(a.addressNo);
        $("#addrName").text(a.addressName || '');
        $("#addrRecipient").text(a.recipient || '');
        $("#addrPhone").text(a.phone || '');
        $("#addrZone").text(a.zonecode || '');
        $("#addrRoad").text(a.roadAddress || '');
        $("#addrDetail").text(a.detailAddress || '');
      }

      /* ================== ì£¼ì†Œ ëª¨ë‹¬ ================== */
      const addrModalEl = document.getElementById('addrModal');
      if (addrModalEl) {
        const addrModal   = new bootstrap.Modal(addrModalEl);
        addrModalEl.addEventListener('show.bs.modal', () => { loadAddressList(); });
        addrModalEl.addEventListener('hidden.bs.modal', () => {
          document.body.classList.remove('modal-open');
          document.body.style.removeProperty('padding-right');
          $('.modal-backdrop').remove();
        });

        function loadAddressList(){
          const currentNo = $("#currentAddressNo").val();
          $("#addrList").html('<div class="text-muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>');
          $("#addrDefaultBox").empty();
          $.get("/mypage/address/list")
            .done(function(res){
              const arr = (res && res.addresses) || [];
              __addrCache = arr; // âœ… ìºì‹œ

              const def = arr.find(a => a.isDefault === 'Y');
              if (def) {
                $("#addrDefaultBox").html(`
                  <div class="fw-bold mb-1">ê¸°ë³¸ ë°°ì†¡ì§€</div>
                  <div>${esc(def.addressName||'')}</div>
                  <div>${esc(def.recipient||'')} / ${esc(def.phone||'')}</div>
                  <div>(${esc(def.zonecode||'')}) ${esc(def.roadAddress||'')} ${esc(def.detailAddress||'')}</div>
                `);
              }
              if (arr.length === 0) { $("#addrList").html('<div class="text-muted">ë“±ë¡ëœ ë°°ì†¡ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'); return; }

              const html = arr.map(a => {
                const checked = String(a.addressNo) === String(currentNo) ? 'checked' : '';
                return `
                  <div class="form-check border rounded p-3 mb-2">
                    <input class="form-check-input" type="radio" name="addrChoice" id="addr_${a.addressNo}"
                           value="${a.addressNo}" ${checked}>
                    <label class="form-check-label w-100" for="addr_${a.addressNo}">
                      <div class="fw-semibold">${esc(a.addressName||'')}</div>
                      <div class="text-muted">ìˆ˜ë ¹ì¸ ${esc(a.recipient||'')} / ${esc(a.phone||'')}</div>
                      <div>ì£¼ì†Œ (${esc(a.zonecode||'')}) ${esc(a.roadAddress||'')} ${esc(a.detailAddress||'')}</div>
                    </label>
                  </div>`;
              }).join("");
              $("#addrList").html(html);
            })
            .fail(() => { $("#addrList").html('<div class="text-danger">ì£¼ì†Œë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>'); });
        }

        // âœ… ì´ë²ˆ ì£¼ë¬¸ë§Œ ì ìš© (ê¸°ë³¸ë°°ì†¡ì§€ ë³€ê²½ ì—†ìŒ)
        $("#addrModalApply").on("click", function(){
          const $sel = $("input[name=addrChoice]:checked");
          if ($sel.length === 0) { alert("ì£¼ì†Œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”."); return; }
          const no = String($sel.val());
          const a  = (__addrCache || []).find(x => String(x.addressNo) === no);
          if (!a) { alert("ì£¼ì†Œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
          applyAddressToView(a);
          bootstrap.Modal.getInstance(addrModalEl).hide();
        });

        // ê¸°ì¡´: ê¸°ë³¸ ë°°ì†¡ì§€ë¡œ ì„¤ì •(ì„œë²„ í˜¸ì¶œ)
        $("#addrModalSet").on("click", function(){
          const $sel = $("input[name=addrChoice]:checked");
          if ($sel.length === 0) { alert("ì£¼ì†Œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”."); return; }
          const addressNo = Number($sel.val());
          const token  = $('meta[name="_csrf"]').attr('content');
          const header = $('meta[name="_csrf_header"]').attr('content');
          $.ajax({
            type: "POST",
            url:  "/mypage/address/default",
            data: JSON.stringify({ addressNo }),
            contentType: "application/json; charset=UTF-8",
            dataType: "json",
            beforeSend: function(xhr){ if (token && header) xhr.setRequestHeader(header, token); }
          })
          .done(function(res){
            if (!res || !res.ok || !res.address) { alert("ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); return; }
            const a = res.address;
            applyAddressToView(a); // ê¸°ë³¸ë„ ë°”ë€Œì—ˆìœ¼ë‹ˆ í™”ë©´ ë°˜ì˜
            bootstrap.Modal.getInstance(addrModalEl).hide();
          })
          .fail(function(xhr){ alert("ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ("+xhr.status+")"); });
        });
      }

      /* ================== ë‹¤ìŒ(ì¹´ì¹´ì˜¤) ìš°í¸ë²ˆí˜¸ ëª¨ë‹¬ ================== */
      const addAddrModalEl = document.getElementById('addAddrModal');
      if (addAddrModalEl) {
        const addAddrModal   = new bootstrap.Modal(addAddrModalEl);
        addAddrModalEl.addEventListener('show.bs.modal', () => {
          $("#f_addressName,#f_recipient,#f_phone,#f_zonecode,#f_roadAddress,#f_detailAddress").val('');
          $("#f_isDefault").prop("checked", false);
          $("#postcodeLayer2").hide().empty();
        });
        addAddrModalEl.addEventListener('hidden.bs.modal', () => { $('.modal-backdrop').each(function(i, el){ if (i) $(el).remove(); }); });

        function openPostcodeIn(layerId, zoneInput, roadInput) {
          const $ly = $(layerId);
          new daum.Postcode({
            oncomplete: function(data){
              $(zoneInput).val(data.zonecode || '');
              $(roadInput).val(data.roadAddress || data.jibunAddress || '');
              $ly.hide().empty();
              $("#f_detailAddress").focus();
            },
            onresize : function(size){ $ly.height(size.height); }
          }).embed($ly.get(0));
          $ly.show();
        }
        $("#btnFindZip2").on("click", function(){ openPostcodeIn("#postcodeLayer2", "#f_zonecode", "#f_roadAddress"); });

        // ìƒˆ ì£¼ì†Œ ì €ì¥
        $("#addAddrForm").on("submit", function(e){
          e.preventDefault();
          const data = {
            addressName:   $("#f_addressName").val().trim(),
            recipient:     $("#f_recipient").val().trim(),
            phone:         $("#f_phone").val().trim(),
            zonecode:      $("#f_zonecode").val().trim(),
            roadAddress:   $("#f_roadAddress").val().trim(),
            detailAddress: $("#f_detailAddress").val().trim(),
            isDefault:     $("#f_isDefault").is(":checked") // âœ… ì²´í¬ì‹œì—ë§Œ ê¸°ë³¸ ë³€ê²½
          };
          if (!data.addressName || !data.recipient || !data.phone || !data.zonecode || !data.roadAddress) {
            alert("í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return;
          }
          const token  = $('meta[name="_csrf"]').attr('content');
          const header = $('meta[name="_csrf_header"]').attr('content');
          $.ajax({
            type: "POST",
            url:  "/mypage/address/new",
            data, // x-www-form-urlencoded ë¡œ ì „ì†¡ (ë°±ì—”ë“œ í¼ ë°”ì¸ë”© ê°€ì •)
            beforeSend: function(xhr){ if (token && header) xhr.setRequestHeader(header, token); },
            dataType: "json"
          })
          .done(function(res){
            if (!res || !res.ok || !res.address) { alert("ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); return; }
            const a = res.address;

            // ğŸ‘‰ ê¸°ë³¸ì²´í¬ ì—¬ë¶€ì™€ ë¬´ê´€í•˜ê²Œ, ì´ë²ˆ ì£¼ë¬¸ í™”ë©´ì—ëŠ” ë°©ê¸ˆ ì£¼ì†Œë¥¼ ì¦‰ì‹œ ë°˜ì˜
            applyAddressToView(a);

            // ëª¨ë‹¬ ë‹«ê¸°
            const addModalInst  = bootstrap.Modal.getInstance(addAddrModalEl);
            if (addModalInst) addModalInst.hide();
            const addrModalInst = bootstrap.Modal.getInstance(document.getElementById('addrModal'));
            if (addrModalInst) addrModalInst.hide();
          })
          .fail(function(xhr){ alert("ë“±ë¡ ì‹¤íŒ¨ ("+xhr.status+")"); });
        });
      }

      /* ================== ê²°ì œ íŒì—…/ì˜¤ë²„ë ˆì´ ================== */
      function showOverlay(){ $("#payOverlay").show(); $("body").addClass("overlay-lock"); }
      function hideOverlay(){ $("#payOverlay").hide(); $("body").removeClass("overlay-lock"); }
      $("#payOverlay").on("click", hideOverlay);

      function openCenteredPopup(url, w=520, h=720){
        const dualScreenLeft = (window.screenLeft ?? window.screenX) || 0;
        const dualScreenTop  = (window.screenTop  ?? window.screenY) || 0;
        const width  = window.outerWidth  || document.documentElement.clientWidth  || screen.width;
        const height = window.outerHeight || document.documentElement.clientHeight || screen.height;
        const left = dualScreenLeft + Math.max(0, (width  - w) / 2);
        const top  = dualScreenTop  + Math.max(0, (height - h) / 2);
        const features = `popup=yes,width=${w},height=${h},left=${left},top=${top},resizable=yes,scrollbars=yes,status=no,toolbar=no,menubar=no,location=no`;
        return window.open(url, "kakaopay_popup", features);
      }

      function watchPopupClose(win, orderId){
        const timer = setInterval(function(){
          if (!win || win.closed) {
            clearInterval(timer);
            setTimeout(function(){
              $.get('/pay/order/' + orderId + '/status')
                .done(function(res){
                  const st = (res && res.status || '').toUpperCase();
                  hideOverlay();
                  if (st === 'PAID')           window.location.href = '/main/list';
                  else if (st === 'PENDING')   alert('ê²°ì œê°€ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ì·¨ì†Œí•  ìˆ˜ ìˆì–´ìš”.');
                  else                         alert('ê²°ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                })
                .fail(function(){ hideOverlay(); alert('ê²°ê³¼ í™•ì¸ ì‹¤íŒ¨. ì ì‹œ í›„ ìƒˆë¡œê³ ì¹¨í•´ ì£¼ì„¸ìš”.'); });
            }, 1000);
          }
        }, 300);
      }

      /* ================== ê²°ì œ ë²„íŠ¼ ================== */
      $("#payBtn").on("click", function(e){
        e.preventDefault();
        const usedPoint = Number($("#_usedPoint").val()) || 0;
        const token  = $('meta[name="_csrf"]').attr('content');
        const header = $('meta[name="_csrf_header"]').attr('content');

        if (isCartMode) {
          const payload = (safeCartItems || []).map(it => ({
            cartDetailId: it.cartDetailId,
            quantity: Math.max(1, Number(it.quantity)||1),
          }));
          if (payload.length === 0) { alert("ì„ íƒëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤."); return; }

          $.ajax({
            type: "POST",
            url:  "/pay/ready/cart",
            data: JSON.stringify({ usedPoint, items: payload }),
            contentType: "application/json; charset=UTF-8",
            beforeSend: function(xhr){ if (token && header) xhr.setRequestHeader(header, token); },
            success: onReadyOk,
            error: onReadyErr
          });
        } else {
          const productId = Number($productId.val());
          const qty       = Math.max(1, Number($qty.val())||1);

          $.ajax({
            type: "POST",
            url:  "/pay/ready/single",
            data: JSON.stringify({ productId, quantity: qty, usedPoint }),
            contentType: "application/json; charset=UTF-8",
            beforeSend: function(xhr){ if (token && header) xhr.setRequestHeader(header, token); },
            success: onReadyOk,
            error: onReadyErr
          });
        }

        function onReadyOk(res){
          const payUrl  = res && res.next_redirect_pc_url;
          const orderId = res && res.orderId;
          if (!payUrl || !orderId) { alert("ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); console.log(res); return; }
          showOverlay();
          const win = openCenteredPopup(payUrl, 520, 720);
          if (win && !win.closed) { try { win.focus(); } catch(_) {} watchPopupClose(win, orderId); }
          else { hideOverlay(); window.location.href = payUrl; }
        }
        function onReadyErr(xhr){ hideOverlay(); alert("ê²°ì œ ì¤€ë¹„ ì‹¤íŒ¨ (" + xhr.status + ")\n" + (xhr.responseText||"")); }
      });

      function esc(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
      $("#payOverlay").hide(); $("body").removeClass("overlay-lock");
    });
    </script>
  </div>
</html>
