<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/layout}">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- _csrf 메타는 없을 수도 있으니 조건부로 -->
  <meta name="_csrf" th:if="${_csrf}" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:if="${_csrf}" th:content="${_csrf.headerName}" />

  <title>마이페이지 - 활동내역</title>
</head>

<body>
  <div layout:fragment="content">

    <style>
      /* =================== 타이포그래피(공통) - order.html 기준 =================== */
      :root {
        scrollbar-gutter: stable;
        --font-sans: system-ui, -apple-system, "Noto Sans KR", "Malgun Gothic",
          "Segoe UI", Roboto, "Helvetica Neue", Arial,
          "Apple SD Gothic Neo", "Apple Color Emoji", "Segoe UI Emoji";
      }
      html { overflow-y: scroll; }

      .mypage-wrap,
      .amodal {
        font-family: var(--font-sans);
        font-size: 14px;
        line-height: 1.6;
        color: #111827;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        margin: -1px;
        padding: 0;
        overflow: hidden;
        clip: rect(0 0 0 0);
        border: 0;
      }

      /* =================== 공통 버튼 스타일 (order.html 통일) =================== */
      .cm-btn {
        appearance: none;
        border: 1px solid #e5e7eb;
        background: #fff;
        color: #111827;
        padding: 8px 14px;
        border-radius: 12px;
        font-weight: 600;
        line-height: 1;
        cursor: pointer;
        transition: background .15s ease, border-color .15s ease, opacity .15s ease, box-shadow .15s ease;
        min-height: 36px;
        min-width: 84px;
        white-space: nowrap;
      }

      .cm-btn:hover {
        background: #f3f4f6;
      }

      .cm-btn:active {
        opacity: .95;
      }

      .cm-btn:focus-visible {
        outline: 0;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, .15);
      }

      .cm-btn[disabled] {
        opacity: .6;
        cursor: not-allowed;
      }

      .cm-btn--primary {
        background: #111827;
        color: #fff;
        border-color: #111827;
      }

      .cm-btn--primary:hover {
        opacity: .92;
      }

      .cm-btn--primary:active {
        opacity: .88;
      }

      /* =================== activity 레이아웃 =================== */
      .mypage-body {
        max-width: 900px;
        margin: 0 auto;
      }

      .pill-tabs {
        display: inline-flex;
        border: 1px solid #e5e7eb;
        border-radius: 9999px;
        overflow: hidden;
        background: #fff;
      }

      .pill-tabs button {
        border: 0;
        background: #fff;
        padding: 10px 18px;
        cursor: pointer;
        font-weight: 700;
      }

      .pill-tabs button:hover {
        background: #e8f0ff;
      }

      .pill-tabs button.is-active {
        background: #2563eb;
        color: #fff;
      }

      .list-wrap {
        margin-top: 16px;
        display: grid;
        gap: 14px;
      }

      .card {
        display: grid;
        grid-template-columns: 88px 1fr auto;
        gap: 16px;
        align-items: start;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 14px 16px;
      }

      .thumb {
        width: 88px;
        height: 88px;
        border-radius: 10px;
        object-fit: cover;
        background: #f3f4f6;
      }

      .title {
        font-weight: 800;
      }

      .meta {
        color: #6b7280;
        font-size: 13px;
        margin-top: 2px;
      }

      .rating {
        font-weight: 700;
        color: #2563eb;
        margin-left: 6px;
      }

      .content {
        margin-top: 8px;
        line-height: 1.55;
        white-space: pre-wrap;
      }

      .actions a,
      .actions button {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 6px 10px;
        background: #fff;
        cursor: pointer;
      }

      .actions a:hover,
      .actions button:hover {
        background: #f3f7ff;
      }

      .empty {
        padding: 36px 12px;
        text-align: center;
        color: #9ca3af;
        border: 1px dashed #e5e7eb;
        border-radius: 12px;
        background: #fafafa;
      }

      .pager {
        display: flex;
        gap: 6px;
        align-items: center;
        justify-content: center;
        margin: 16px 0;
      }

      .pager .page-btn {
        border: 1px solid #e5e7eb;
        background: #fff;
        padding: 6px 10px;
        border-radius: 8px;
        cursor: pointer;
      }

      .pager .page-btn[aria-current="page"] {
        background: #2563eb;
        color: #fff;
      }

      .pager .status {
        margin-right: 8px;
        color: #6b7280;
        font-size: 13px;
      }

      /* =================== 모달 (amodal) =================== */
      .amodal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }

      .amodal.is-open {
        display: flex;
      }

      .amodal__backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, .45);
      }

      .amodal__box {
        position: relative;
        width: min(92vw, 520px);
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, .25);
        padding: 16px;
        z-index: 1;
      }

      .amodal__head {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 10px;
      }

      .amodal__thumb {
        width: 72px;
        height: 72px;
        border-radius: 10px;
        overflow: hidden;
        background: #f3f4f6;
        flex: 0 0 72px;
      }

      .amodal__thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .amodal__title {
        font-weight: 800;
        line-height: 1.3;
      }

      .amodal__body {
        margin-top: 8px;
      }

      .amodal__actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 12px;
      }

      /* ===사이드박스/그리드 레이아웃 복구===*/
      .mp-grid {
        display: grid;
        grid-template-columns: 260px minmax(0, 1fr);
        gap: 24px;
        align-items: start;
      }

      .mp-col-left {
        position: sticky;
        top: 24px;
        /* 스크롤 시 고정되는 위치 */
        align-self: start;
        z-index: 1;
      }

      .mp-col-right {
        min-width: 0;
        /* 긴 내용 줄바꿈을 위해 */
      }

      /* === 사이드박스/그리드 레이아웃 === */
      .mp-grid {
        display: grid;
        grid-template-columns: 260px minmax(0, 1fr);
        gap: 24px;
        align-items: start;
      }

      .mp-col-left {
        position: sticky;
        top: 24px;
        align-self: start;
        z-index: 1;
      }

      .mp-col-right {
        min-width: 0;
      }

      /* 사이드박스 내부 스타일 */
      .mp-sidebox__title {
        font-size: 20px;
        font-weight: 800;
        margin: 0 0 12px;
      }

      .mp-sidebox__nav {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .mp-sidebox__link {
        display: block;
        padding: 8px 10px;
        border-radius: 10px;
        text-decoration: none;
        color: #111827;
        border: 1px solid #e5e7eb;
        background: #fff;
      }

      .mp-sidebox__link:hover {
        background: #f3f7ff;
      }

      .mp-sidebox__link.is-active {
        background: #111827;
        color: #fff;
        border-color: #111827;
      }

      /* 모바일 대응 */
      @media (max-width: 860px) {
        .mp-grid {
          grid-template-columns: 1fr;
        }

        .mp-col-left {
          position: static;
        }
      }
    </style>

    <section class="mypage-wrap">
      <div class="mp-grid">
        <!-- 좌측: 사이드박스 -->
        <div class="mp-col-left" th:replace="~{fragments/mypageSidebox :: mypageSidebox(${section})}"></div>

        <!-- 우측: 본문 -->
        <div class="mp-col-right">
          <section class="mypage-body" role="region" aria-labelledby="pageTitle">
            <h1 id="pageTitle" class="sr-only">마이페이지 - 활동내역</h1>
            <h2 style="font-size:20px;font-weight:800;margin-bottom:12px">활동내역</h2>

            <!-- 탭 -->
            <div class="pill-tabs" role="tablist" aria-label="활동 분류">
              <button id="tab-reviews" class="is-active" role="tab" aria-selected="true" aria-controls="panel-reviews"
                data-tab="reviews">리뷰</button>
              <button id="tab-likes" role="tab" aria-selected="false" aria-controls="panel-likes"
                data-tab="likes">공감</button>
            </div>

            <!-- 탭패널: 리뷰 -->
            <div id="panel-reviews" role="tabpanel" tabindex="0" aria-labelledby="tab-reviews">
              <div id="list" class="list-wrap" aria-live="polite"></div>
              <nav id="pager" class="pager" aria-label="페이지네이션" hidden>
                <span class="status" id="pagerStatus"></span>
                <div id="pagerBtns"></div>
              </nav>
            </div>

            <!-- 탭패널: 공감(초기 비표시) -->
            <div id="panel-likes" role="tabpanel" tabindex="0" aria-labelledby="tab-likes" hidden></div>
          </section>

          <!-- 수정 모달 -->
          <div id="editModal" class="amodal" aria-hidden="true">
            <div class="amodal__backdrop" data-close></div>
            <div class="amodal__box" role="dialog" aria-modal="true" aria-labelledby="editTitle">
              <div class="amodal__head">
                <div class="amodal__thumb"><img id="emImg" src="/img/noimg.png" alt=""></div>
                <div>
                  <div class="amodal__title" id="editTitle">상품명</div>
                  <div class="meta" id="emBrand">브랜드</div>
                </div>
              </div>
              <div class="amodal__body">
                <textarea id="emContent" rows="6"
                  style="width:100%; border:1px solid #e5e7eb; border-radius:10px; padding:10px; resize:none"
                  placeholder="리뷰 내용을 입력하세요"></textarea>
              </div>
              <div class="amodal__actions">
                <button class="cm-btn" data-close>닫기</button>
                <button class="cm-btn cm-btn--primary" id="emSave">수정</button>
              </div>
            </div>
          </div>

          <!-- 삭제 모달 (버튼 순서: 예 → 아니요) -->
          <div id="deleteModal" class="amodal" aria-hidden="true">
            <div class="amodal__backdrop" data-close></div>
            <div class="amodal__box" role="dialog" aria-modal="true" aria-labelledby="delTitle">
              <div class="amodal__body" id="delTitle" style="font-weight:700; margin-bottom:8px;">리뷰를 삭제하시겠습니까?</div>
              <div class="amodal__actions">
                <button class="cm-btn cm-btn--primary" id="dmYes">예</button>
                <button class="cm-btn" data-close>아니요</button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- ===== 스크립트: 목록/탭/페이지네이션 ===== -->
    <script>
      (function () {
        const listEl = document.getElementById('list');
        const pagerEl = document.getElementById('pager');
        const pagerBtns = document.getElementById('pagerBtns');
        const pagerStatus = document.getElementById('pagerStatus');
        const tabs = document.querySelectorAll('.pill-tabs button');

        // --- 상태
        const state = { tab: 'reviews', page: 0, size: 10, totalPages: 0 };

        function getInitialTab() {
          const params = new URLSearchParams(location.search);
          const p = (params.get('tab') || '').toLowerCase();
          return (p === 'likes' || p === 'reviews') ? p : 'reviews';
        }

        function setActiveTab(tab) {
          state.tab = (tab === 'likes') ? 'likes' : 'reviews';
          tabs.forEach(b => {
            const on = (b.dataset.tab === state.tab);
            b.classList.toggle('is-active', on);
            b.setAttribute('aria-selected', on ? 'true' : 'false');
          });
          const url = new URL(location.href);
          url.searchParams.set('tab', state.tab);
          history.replaceState({}, '', url);
        }

        function fetchAndRender() {
          const url = state.tab === 'reviews'
            ? `/mypage/reviews?page=${state.page}&size=${state.size}`
            : `/mypage/likes?page=${state.page}&size=${state.size}`;

          fetch(url)
            .then(r => {
              const ct = r.headers.get('content-type') || '';
              if (!ct.includes('application/json')) throw new Error('NOT_JSON');
              return r.json();
            })
            .then(data => {
              state.totalPages = data.totalPages || 0;
              if (state.tab === 'reviews') renderReviewCards(data.content || []);
              else renderLikeCards(data.content || []);
              renderPager(data);
            })
            .catch(err => {
              console.error(err);
              if (listEl) listEl.innerHTML = `<div class="empty">목록을 불러오지 못했습니다.</div>`;
              if (pagerEl) pagerEl.hidden = true;
            });
        }

        tabs.forEach(btn => {
          btn.addEventListener('click', () => {
            state.page = 0;
            setActiveTab(btn.dataset.tab);
            fetchAndRender();
          });
        });

        function renderReviewCards(items) {
          if (!listEl) return;
          if (!items.length) {
            listEl.innerHTML = `<div class="empty">작성한 리뷰가 없습니다.</div>`;
            return;
          }
          listEl.innerHTML = items.map(it => {
            const href = it.productId ? (`/main/content/${it.productId}`) : '#';
            const img = it.imageUrl || '/img/noimg.png';
            const name = it.productName || '상품명';
            const brand = it.brandName || '브랜드';
            const date = it.createDate || '';
            const rating = (it.rating ?? 0);
            const content = esc(it.content || '');
            return `
            <article class="card" data-id="${it.reviewId}">
              <img class="thumb" src="${esc(img)}" alt="">
              <div>
                <div class="title"><a href="${href}">${esc(name)}</a></div>
                <div class="meta">${esc(brand)} <span class="rating">★ ${rating}</span> <span style="margin-left:6px">${esc(date)}</span></div>
                <div class="content">${content}</div>
              </div>
              <div class="actions">
                <a class="btn-edit" href="/review/${it.reviewId}/edit">수정</a>
                <a class="btn-delete" href="/review/${it.reviewId}/delete">삭제</a>
              </div>
            </article>
          `;
          }).join('');
        }

        function renderLikeCards(items) {
          if (!listEl) return;
          if (!items.length) {
            listEl.innerHTML = `<div class="empty">공감한 리뷰가 없습니다.</div>`;
            return;
          }
          listEl.innerHTML = items.map(it => {
            const href = it.productId ? (`/main/content/${it.productId}`) : '#';
            const img = it.imageUrl || '/img/noimg.png';
            const name = it.productName || '상품명';
            const brand = it.brandName || '브랜드';
            const rating = (it.rating ?? 0);
            const date = it.createDate || '';
            const content = esc(it.content || '');
            return `
            <article class="card" data-id="${it.reviewId}">
              <img class="thumb" src="${esc(img)}" alt="">
              <div>
                <div class="title"><a href="${href}">${esc(name)}</a></div>
                <div class="meta">${esc(brand)}<span class="rating">★ ${rating}</span><span style="margin-left:6px">${esc(date)}</span></div>
                <div class="content">${content}</div>
              </div>
              <div class="actions">
                <button type="button" class="btn-unlike" data-id="${it.reviewId}">공감 취소</button>
              </div>
            </article>
          `;
          }).join('');

          // 공감 취소 이벤트 바인딩
          listEl.querySelectorAll('.btn-unlike').forEach(btn => {
            btn.addEventListener('click', async () => {
              const id = btn.dataset.id;
              try {
                const res = await fetch(`/mypage/likes/${id}`, { method: 'DELETE', credentials: 'same-origin' });
                if (!res.ok) throw new Error();
                fetchAndRender();
              } catch (e) { alert('공감 취소 중 오류가 발생했습니다.'); }
            });
          });
        }

        function renderPager(data) {
          if (!pagerEl || !pagerBtns || !pagerStatus) return;
          const total = Math.max(0, Number(data.totalPages) || 0);
          const page = Math.min(Math.max(0, Number(data.page) || 0), Math.max(0, total - 1));
          if (total <= 1) { pagerEl.hidden = true; return; }
          pagerEl.hidden = false;
          pagerStatus.textContent = `현재 ${page + 1} / ${total} 페이지`;
          const isFirst = page === 0;
          const isLast = page === total - 1;
          const pagesHtml = Array.from({ length: total }, (_, i) => {
            const currentAttr = i === page ? ' aria-current="page"' : '';
            return `<button type="button" class="page-btn"${currentAttr} data-page="${i}">${i + 1}</button>`;
          }).join('');
          pagerBtns.innerHTML = `
          <button type="button" class="page-btn nav-first" data-nav="first" ${isFirst ? 'disabled aria-disabled="true"' : ''} aria-label="첫 페이지">«</button>
          <button type="button" class="page-btn nav-prev"  data-nav="prev"  ${isFirst ? 'disabled aria-disabled="true"' : ''} aria-label="이전 페이지">‹</button>
          ${pagesHtml}
          <button type="button" class="page-btn nav-next"  data-nav="next"  ${isLast ? 'disabled aria-disabled="true"' : ''} aria-label="다음 페이지">›</button>
          <button type="button" class="page-btn nav-last"  data-nav="last"  ${isLast ? 'disabled aria-disabled="true"' : ''} aria-label="마지막 페이지">»</button>
        `;
          pagerBtns.querySelectorAll('.page-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              if (btn.disabled) return;
              const nav = btn.dataset.nav;
              let next = page;
              if (nav === 'first') next = 0;
              else if (nav === 'prev') next = Math.max(0, page - 1);
              else if (nav === 'next') next = Math.min(total - 1, page + 1);
              else if (nav === 'last') next = total - 1;
              else if (btn.dataset.page != null) next = Number(btn.dataset.page);
              if (next === page) return;
              const keepFocus = () => {
                const selector = `.page-btn[data-page="${next}"]`;
                const nextBtn = pagerBtns.querySelector(selector) || pagerBtns.querySelector('.nav-next');
                nextBtn?.focus();
              };
              state.page = next;
              fetchAndRender();
              setTimeout(keepFocus, 0);
            });
          });
        }

        function esc(s) {
          return String(s || '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
        }

        // --- 초기 실행
        setActiveTab(getInitialTab());
        fetchAndRender();

        // 다른 스크립트에서 재호출 가능하도록 공개
        window.fetchAndRender = fetchAndRender;
      })();
    </script>

    <!-- ===== 스크립트: 수정/삭제 모달 & 액션 ===== -->
    <script>
      (function () {
        const listEl = document.getElementById('list');

        function getCsrf() {
          const t = document.querySelector('meta[name="_csrf"]')?.content || '';
          const h = document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN';
          return { header: h, token: t };
        }

        function openModal(el) { el?.classList.add('is-open'); }
        function closeModal(el) { el?.classList.remove('is-open'); }

        document.addEventListener('click', (e) => {
          if (e.target.matches('[data-close], .amodal__backdrop')) {
            const m = e.target.closest('.amodal'); closeModal(m);
          }
        });

        // ====== 수정 모달 ======
        const em = document.getElementById('editModal');
        const emImg = document.getElementById('emImg');
        const editTitle = document.getElementById('editTitle');
        const emBrand = document.getElementById('emBrand');
        const emContent = document.getElementById('emContent');
        const emSave = document.getElementById('emSave');
        let currentReviewId = null;

        listEl.addEventListener('click', async (e) => {
          const a = e.target.closest('.btn-edit');
          if (!a) return;
          e.preventDefault();

          const card = a.closest('.card');
          const reviewId = card?.dataset.id;
          if (!reviewId) return;

          try {
            const res = await fetch(`/mypage/reviews/${reviewId}`, {
              headers: { 'Accept': 'application/json' },
              credentials: 'same-origin'
            });

            if (res.status === 401 || res.status === 403) {
              alert('로그인이 필요합니다.');
              location.href = '/user/login';
              return;
            }

            const ct = res.headers.get('content-type') || '';
            if (!ct.includes('application/json')) { throw new Error('NOT_JSON'); }

            const d = await res.json();

            emImg.src = d.imageUrl || '/img/noimg.png';
            editTitle.textContent = d.productName || '상품명';
            emBrand.textContent = d.brandName || '';
            emContent.value = d.content || '';
            currentReviewId = reviewId;
            openModal(em);
          } catch (err) {
            console.error(err);
            alert('리뷰 정보를 불러오지 못했습니다.');
          }
        });

        emSave.addEventListener('click', async () => {
          if (!currentReviewId) return;
          const content = emContent.value.trim();
          if (!content) { alert('내용을 입력해 주세요.'); emContent.focus(); return; }

          const { header, token } = getCsrf();
          try {
            const res = await fetch(`/mypage/reviews/${currentReviewId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json', ...(token ? { [header]: token } : {}) },
              body: JSON.stringify({ content })
            });
            const d = await res.json().catch(() => ({}));
            if (!res.ok || !d.ok) { throw new Error(d.message || '수정 실패'); }
            closeModal(em);
            if (typeof fetchAndRender === 'function') fetchAndRender();
            else location.reload();
          } catch (err) {
            alert(err.message || '수정 중 오류가 발생했습니다.');
          }
        });

        // ====== 삭제 모달 ======
        const dm = document.getElementById('deleteModal');
        const dmYes = document.getElementById('dmYes');

        listEl.addEventListener('click', (e) => {
          const a = e.target.closest('.btn-delete');
          if (!a) return;
          e.preventDefault();
          const card = a.closest('.card');
          const reviewId = card?.dataset.id;
          if (!reviewId) return;
          currentReviewId = reviewId;
          openModal(dm);
        });

        dmYes.addEventListener('click', async () => {
          if (!currentReviewId) return;
          const { header, token } = getCsrf();
          try {
            const res = await fetch(`/mypage/reviews/${currentReviewId}`, {
              method: 'DELETE',
              headers: token ? { [header]: token } : {},
            });
            const d = await res.json().catch(() => ({}));
            if (!res.ok || d.ok !== true) throw new Error(d.message || '삭제 실패');
            closeModal(dm);
            if (typeof fetchAndRender === 'function') fetchAndRender();
            else location.reload();
          } catch (err) {
            alert(err.message || '삭제 중 오류가 발생했습니다.');
          }
        });
      })();
    </script>

  </div>
</body>

</html>