<!-- templates/mypage/orderDetail.html -->
<style>
  /* ✅ 상품/총 주문 금액 행만 선 표시, 배송비 행은 선 제거 */
  .table-summary tr { border-top: none; }

  .table-summary tr:first-child {
    border-top: 1px solid var(--bs-border-color); /* 상품 합계 위 */
  }

  .table-summary tr:last-child {
    border-top: 1px solid var(--bs-border-color); /* 총 주문 금액 위 */
  }

  .table-summary tr:nth-child(2) {
    border-top: none !important;  /* 배송비 위 선 제거 */
    border-bottom: none !important; /* 배송비 아래 선 제거 */
  }
</style>

<div th:fragment="items">

  <!-- 상단: 주문일시 · 주문번호 -->
  <div class="fw-semibold mb-2">
    <span th:text="${#temporals.format(order.regDate,'yyyy.MM.dd HH:mm')}">2025.09.15 12:34</span>
    <span class="mx-2">·</span>
    <span>주문번호</span>
    <span th:text="${order.orderId}">1000001</span>
  </div>

  <hr class="my-3"/>

  <!-- 주문 상품 정보 -->
  <h5 class="mb-3">주문상품 정보</h5>
  <div class="table-responsive">
    <table class="table align-middle">
      <thead class="table-light">
      <tr>
        <th style="width:100px">이미지</th>
        <th>상품</th>
        <th class="text-center" style="width:90px">수량</th>
        <th class="text-end" style="width:140px">단가</th>
        <th class="text-end" style="width:160px">합계</th>
      </tr>
      </thead>

      <tbody>
      <tr th:each="d : ${order.details}">
        <td>
          <a th:href="@{|/main/content/${d.product.id}|}">
            <img class="rounded"
                 th:if="${!#strings.isEmpty(d.product.imgName)}"
                 th:src="@{|${ #strings.endsWith(d.product.imgPath,'/') ? d.product.imgPath : d.product.imgPath + '/' }${d.product.imgName}|}"
                 alt="" style="width:72px;height:72px;object-fit:cover">
            <img class="rounded"
                 th:if="${#strings.isEmpty(d.product.imgName)}"
                 th:src="@{/img/noimage.png}" alt=""
                 style="width:72px;height:72px;object-fit:cover">
          </a>
        </td>
        <td>
          <div class="fw-semibold">
            <a class="m-link" th:href="@{|/main/content/${d.product.id}|}" th:text="${d.product.name}">상품명</a>
          </div>
          <div class="small text-muted">
            <span>개당 </span>
            <span th:text="${#numbers.formatInteger((d.sellPrice != null ? d.sellPrice : 0),1,'COMMA')}">0</span>
            <span>원</span>

            <span th:if="${order.status=='REQUESTED' and d.refundDetail != null}">
              · 환불요청 <span th:text="${d.refundDetail.quantity}">0</span>
            </span>
            <span th:if="${order.status=='REFUNDED' and d.refundDetail != null}">
              · 환불승인 <span th:text="${d.refundDetail.refundQty}">0</span>
            </span>
          </div>
        </td>
        <td class="text-center" th:text="${d.quantity}">1</td>
        <td class="text-end">
          <span th:text="${#numbers.formatInteger((d.sellPrice != null ? d.sellPrice : 0),1,'COMMA')}">0</span>원
        </td>
        <td class="text-end fw-semibold">
          <span th:text="${#numbers.formatInteger((d.totalPrice != null ? d.totalPrice : 0),1,'COMMA')}">0</span>원
        </td>
      </tr>
      </tbody>

      <!-- ✅ 요약부: 배송비 표시 + 중간 줄 제거 -->
      <tfoot class="table-light table-summary"
            th:with="
              productSum=${#aggregates.sum(order.details.?[totalPrice != null].![totalPrice]) ?: 0},
              paySum=${(payments != null) ? (#aggregates.sum(payments.![amount]) ?: 0) : 0},
              used=${usedMileage != null ? usedMileage : 0},
              shippingFee=${(paySum + used) - productSum}
            ">
        <tr>
          <th colspan="4" class="text-end">상품 합계</th>
          <th class="text-end">
            <span th:text="${#numbers.formatInteger(productSum, 1, 'COMMA')}">0</span>원
          </th>
        </tr>

        <tr th:if="${shippingFee > 0}">
          <th colspan="4" class="text-end">배송비</th>
          <th class="text-end">
            <span th:text="${#numbers.formatInteger(shippingFee, 1, 'COMMA')}">0</span>원
          </th>
        </tr>

        <tr>
          <th colspan="4" class="text-end">총 주문 금액</th>
          <th class="text-end fw-semibold">
            <span th:text="${#numbers.formatInteger(productSum + (shippingFee > 0 ? shippingFee : 0), 1, 'COMMA')}">0</span>원
          </th>
        </tr>
      </tfoot>
    </table>
  </div>

  <hr class="my-3"/>

  <!-- 배송지 -->
  <h5 class="mb-3">배송지</h5>
  <div th:if="${order.shippingSnapshot != null}">
    <div class="fw-semibold" th:text="${order.shippingSnapshot.addressName}">배송지명</div>
    <div class="mb-1">
      <span th:text="${order.shippingSnapshot.recipient}">받는분</span>
      <span class="mx-1">/</span>
      <span th:text="${order.shippingSnapshot.phone}">010-...</span>
    </div>
    <div class="mb-1">
      (<span th:text="${order.shippingSnapshot.zonecode}">00000</span>)
      <span th:text="${order.shippingSnapshot.roadAddress}">도로명</span>
      <span th:text="${order.shippingSnapshot.detailAddress}">상세</span>
    </div>
    <div class="text-muted"
         th:if="${order.shippingSnapshot.memo != null and !#strings.isEmpty(order.shippingSnapshot.memo)}">
      요청사항: <span th:text="${order.shippingSnapshot.memo}">문 앞</span>
    </div>
  </div>
  <div th:if="${order.shippingSnapshot == null}" class="text-muted">배송지 정보가 없습니다.</div>

  <hr class="my-3"/>

  <!-- 결제 정보 -->
  <h5 class="mb-3">결제 정보</h5>

  <div th:if="${payments != null and !payments.isEmpty()}">
    <div class="table-responsive">
      <table class="table align-middle">
        <thead class="table-light">
        <tr>
          <th style="width:200px">결제수단</th>
          <th style="width:200px">사용 마일리지</th>
          <th class="text-end" style="width:160px">결제금액</th>
        </tr>
        </thead>

        <tbody>
          <tr th:each="p,iter : ${payments}">
            <td th:text="${(p.tid != null or p.aid != null) ? '카카오페이' : (!#strings.isEmpty(p.status) ? p.status : '-')}">
              카카오페이
            </td>
            <td th:text="${iter.index == 0 ? #numbers.formatInteger((usedMileage != null ? usedMileage : 0), 1, 'COMMA') + 'P' : '-'}">
              0P
            </td>
            <td class="text-end">
              <span th:text="${#numbers.formatInteger((p.amount != null ? p.amount : 0), 1, 'COMMA')}">0</span>원
            </td>
          </tr>
        </tbody>

        <tfoot class="table-light">
          <tr>
            <th colspan="2" class="text-end">결제 합계</th>
            <th class="text-end">
              <span th:text="${#numbers.formatInteger((#aggregates.sum(payments.![amount]) ?: 0), 1, 'COMMA')}">0</span>원
            </th>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
  <div th:if="${payments == null or payments.isEmpty()}" class="text-muted">결제 내역이 없습니다.</div>

  <!-- 포인트/마일리지 -->
  <div class="row g-3 mt-1">
    <div class="col-md-6">
      <div class="border rounded-3 p-3 bg-light">
        <div class="small text-muted">적립 마일리지</div>
        <div class="fs-5 fw-bold text-end">
          <span th:text="${#numbers.formatInteger((order.confirmMileage != null ? order.confirmMileage : 0), 1, 'COMMA')}">0</span>P
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="border rounded-3 p-3 bg-light">
        <div class="small text-muted">사용 마일리지</div>
        <div class="fs-5 fw-bold text-end">
          <span th:text="${#numbers.formatInteger((usedMileage != null ? usedMileage : 0), 1, 'COMMA')}">0</span>P
        </div>
      </div>
    </div>
  </div>

</div>
