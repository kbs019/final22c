<html layout:decorate="~{layout/layout}">
<div layout:fragment="content">
    <!-- 1) 공통 스타일 -->
<div th:replace="~{fragments/mypageSideBox :: styles}"></div>

<section class="mypage-grid">
  <!-- 2) 사이드박스 -->
  <div th:replace="~{fragments/mypageSideBox :: sidebox(${section})}"></div>

  <!-- 3) 우측 본문 -->
  <div class="mypage-body">
    <!-- 여기 기존 페이지 내용(주문리스트/주소폼/활동내역/위시리스트/프로필폼 등) -->
  </div>
</section>

<!-- 4) 공통 모달 + 공통 스크립트 -->
<div th:replace="~{fragments/mypageSideBox :: modals}"></div>
<div th:replace="~{fragments/mypageSideBox :: scripts}"></div>

<style>
  .to-top { display: none !important; }

  /* ===== Modal 기본 스타일 ===== */
  .modal-backdrop{  position:fixed;
                    inset:0;
                    background:rgba(0,0,0,.45);
                    display:none;
                    z-index:9998;
                  }
  .modal{
    position:fixed;
    left:50%;top:50%;
    transform:translate(-50%,-50%);
    background:#fff;
    border-radius:14px;
    min-width:420px;
    max-width:580px;
    padding: 28px 20px 20px;
    display:none;
    z-index:9999;
    box-shadow:0 10px 30px rgba(0,0,0,.2);
    height: auto !important;
    max-height: 90vh; /* 화면 기준 최대 높이 */
    overflow-y: auto; /* 내용 스크롤 */
    box-sizing: border-box; /* 패딩 포함 계산 */
  }

  .modal > form{
    height: auto !important;
    max-height: inherit;
  }

  .modal.open,.modal-backdrop.open{display:block}

  .row{ display:flex;
        gap:8px;
        align-items:center
      }
  .btn{ padding:8px 12px;
        border-radius:8px;
        border:1px solid #ddd;
        cursor:pointer
      }
  .btn.primary{ background:#111;
                color:#fff;
                border-color:#111
              }
  .field{ margin:10px 0}
  .field > label{ display:block;
                  margin-bottom:6px;
                  font-weight:600
                }
  .field > input{ width:100%;
                  padding:10px;
                  border:1px solid #ddd;
                  border-radius:10px
                }

  /* X버튼 1시 방향 */
  .x-close{
    position:absolute; 
    top:0px; 
    right:0px;
    width:36px; 
    height:36px; 
    border-radius:50%;
    border:none; 
    background:transparent; 
    color:#000; 
    cursor:pointer;
    display:flex; 
    align-items:center; 
    justify-content:center;
    font-size:20px; 
  }

  .addr-card{
    display:grid;
    grid-template-columns: 28px 1fr auto; /* 라디오 | 본문 | 버튼 */
    align-items:center;                    /* 세로 정렬 통일 */
    gap:12px;
    padding:12px;
    border:1px solid #ddd;
    border-radius:12px;
  }

  .addr-radio-wrap{ width:28px; 
                    display:flex; 
                    justify-content:center; }

  .addr-body{ min-width:0; }  /* 긴 텍스트 줄바꿈 허용 */

  .addr-row{  display:flex; 
              flex-wrap:wrap; 
              gap:6px; }

  .badge{ font-size:12px;
          padding:2px 6px;
          border-radius:6px;
          background:#222;
          color:#fff;
          margin-left:6px}
</style>
<!-- 임시 나중에 지우셈 -->
<a href="/mypage/order" class="btn btn-outline-secondary">
  주문내역 보기
</a>
<h5>배송지 등록</h5>
<!-- 주소 등록 모달 창 버튼 -->
<button class="btn primary" id="btnOpenModal" >주소지 등록</button>

<!-- 주소 등록 모달 창 구성 시작 -->
<div id="modalBackdrop" class="modal-backdrop"></div>
<div id="addressModal" class="modal" aria-modal="true" role="dialog">
  <button class="x-close" id="btnCloseModal">×</button>
  <form th:action="@{/mypage/address}" method="post" th:object="${usersAddressForm}" id="addressForm">
    <div class="field"><input type="text" th:field="*{addressName}" placeholder="배송지명" required /></div>
    <div class="field"><input type="text" th:field="*{recipient}" placeholder="받는 사람" required /></div>
    <div class="field"><input type="text" th:field="*{phone}" maxlength="11" placeholder="전화번호" required /></div>
    <div class="field row">
      <button type="button" class="btn" id="btnFindZip">주소 찾기</button>
      <input style="flex:1" type="text" th:field="*{zonecode}" placeholder="우편번호" readonly required />
    </div>
    <div class="field"><input type="text" th:field="*{roadAddress}" placeholder="도로명" readonly required /></div>
    <div class="field"><input type="text" th:field="*{detailAddress}" placeholder="상세주소" required /></div>
    <div class="row" style="justify-content:flex-end;gap:8px">
      <button type="button" class="btn" id="btnCancel">취소</button>
      <button type="submit" class="btn primary">등록</button>
    </div>
    <div id="postcodeLayer" style="display:none; position:relative; height:400px; margin-top:10px; border:1px solid #eee; border-radius:10px;"></div>
  </form>
</div>
<!-- 주소 등록 모달 창 구성 끝-->

<!-- 기본 배송지 출력란 -->
<div id="defaultAddressBox" style="border:1px solid #ccc; padding:12px; border-radius:8px; margin:12px 0 16px;">
  <strong>기본 배송지</strong><br>
  <div><span id="outAddrName">-</span></div>
  <div><span id="outRecipient">-</span> / <span id="outPhone">-</span></div>
  <div><span id="outZonecode">-</span> / <span id="outRoadAddress">-</span> <span id="outDetailAddress">-</span></div>
</div>
<!-- 기본 배송지 출력란 끝 -->

<section class="addr-list">
<!-- 주소 목록 -->
<ul class="addr-list" th:if="${#lists.isEmpty(userAddresses) == false}">
  <li class="addr-card" th:each="a : ${userAddresses}">

  <label class="addr-radio-wrap">
    <input  type="radio" name="defaultAddress"
            class="addr-radio"
            th:value="${a.addressNo}"
            th:checked="${a.isDefault == 'Y'}"
            th:attr="data-addrname=${a.addressName},
                    data-recipient=${a.recipient},
                    data-phone=${a.phone},
                    data-zonecode=${a.zonecode},
                    data-road=${a.roadAddress},
                    data-detail=${a.detailAddress}">
    <span class="dot"></span>
  </label>


    <div class="addr-body">
      <div class="addr-top">
        <div class="addr-name-line">
          <strong class="addr-name" th:text="${a.addressName}">주소</strong>
          <span class="addr-chip" th:if="${a.isDefault == 'Y'}"></span>
        </div>
      </div>

      <div class="addr-row">
        <span class="label">수령인</span>
        <span th:text="${a.recipient}"></span>
        <span class="divider">/</span>
        <span th:text="${a.phone}">전화번호</span>
      </div>

      <div class="addr-row">
        <span class="label">주소</span>
        <span class="zip" th:text="${a.zonecode}">우편번호</span>
        <span class="slash">/</span>
        <span th:text="${a.roadAddress}">도로명</span>
        <span th:text="${a.detailAddress}">상세주소</span>
      </div>
    </div>

    <div class="addr-side">
      <span class="addr-index" th:text="${aStat.index + 1}" th:if="${false}"></span>
    </div>
  </li>
</ul>

<p th:if="${#lists.isEmpty(userAddresses)}">등록된 배송지가 없습니다.</p>
</section>

<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
  // ===== 모달 열고 닫기 =====
  const modal = document.getElementById('addressModal');
  const backdrop = document.getElementById('modalBackdrop');
  function openModal(){ modal.classList.add('open'); backdrop.classList.add('open'); }
  function closeModal(){ modal.classList.remove('open'); backdrop.classList.remove('open'); }
  document.getElementById('btnOpenModal')?.addEventListener('click', openModal);
  document.getElementById('btnCloseModal')?.addEventListener('click', closeModal);
  document.getElementById('btnCancel')?.addEventListener('click', closeModal);
  backdrop?.addEventListener('click', closeModal);

  // ===== 다음 주소 레이어 =====
  const layer = document.getElementById('postcodeLayer');
  function openDaumLayer(){
    new daum.Postcode({
      oncomplete: function(data) {
        var addr = (data.userSelectedType === "R") ? data.roadAddress : data.jibunAddress;
        document.getElementById("zonecode").value = data.zonecode;
        document.getElementById("roadAddress").value = addr;
        layer.style.display='none';
        document.getElementById("detailAddress").focus();
      }, width:'100%', height:'100%'
    }).embed(layer);
    layer.style.display='block';
  }
  document.getElementById('btnFindZip').addEventListener('click', openDaumLayer);

  // ===== 기본배송지 출력란 요소 =====
  const out = {
    addrName : document.getElementById('outAddrName'),
    recipient: document.getElementById('outRecipient'),
    phone    : document.getElementById('outPhone'),
    zonecode : document.getElementById('outZonecode'),
    road     : document.getElementById('outRoadAddress'),
    detail   : document.getElementById('outDetailAddress')
  };

  function fillOutputFrom(el){
    // el은 { dataset: {...} } 형태면 됨
    out.addrName.textContent = el?.dataset?.addrname  || '-';
    out.recipient.textContent= el?.dataset?.recipient || '-';
    out.phone.textContent    = el?.dataset?.phone     || '-';
    out.zonecode.textContent = el?.dataset?.zonecode  || '-';
    out.road.textContent     = el?.dataset?.road      || '-';
    out.detail.textContent   = el?.dataset?.detail    || '-';
  }

  // ===== 라디오 및 UI 갱신 =====
  const radios = document.querySelectorAll('input.addr-radio[name="defaultAddress"]');

  function applyDefaultUI(newId) {
    document.querySelectorAll('li.addr-card').forEach(li => {
      const r = li.querySelector('input.addr-radio');
      const chip = li.querySelector('.addr-chip'); // 기본뱃지
      if (!r) return;
      const isNew = String(r.value) === String(newId);
      r.checked = isNew;
      if (chip) chip.style.display = isNew ? '' : 'none';
    });
  }

  // ===== 서버 저장 (CSRF 없음 가정) =====
  function persistDefault(addressNo) {
    return fetch('/mypage/address/default', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ addressNo: Number(addressNo) })
    });
  }

  // 현재 기본 ID 추적
  let currentDefaultId = ([...radios].find(r => r.checked) || {}).value ?? null;

  // 처음 로드시 현재 기본배송지로 출력란 채우기
  window.addEventListener('DOMContentLoaded', () => {
    const cur = [...radios].find(r => r.checked);
    if (cur) fillOutputFrom({ dataset: cur.dataset });
  });

  // 라디오 클릭 → 즉시 반영(낙관적) → 서버 저장 → 실패 시 롤백
  radios.forEach(r => {
    r.addEventListener('change', async (e) => {
      const selected = e.currentTarget;
      if (!selected.checked) return;

      const prevId = currentDefaultId;
      const newId  = selected.value;

      // 1) 즉시 화면 반영
      currentDefaultId = newId;
      applyDefaultUI(newId);
      fillOutputFrom({ dataset: selected.dataset });

      // 2) 서버 반영
      try {
        const res = await persistDefault(newId);
        if (!res.ok) throw new Error('save failed');
      } catch (err) {
        // 3) 실패 시 롤백
        currentDefaultId = prevId;
        applyDefaultUI(prevId);
        const prevRadio = [...radios].find(r => String(r.value) === String(prevId));
        fillOutputFrom(prevRadio ? { dataset: prevRadio.dataset } : { dataset: {} });
        alert('기본 배송지 저장에 실패했습니다. 다시 시도해 주세요.');
      }
    });
  });
</script>
</div>
</html>
