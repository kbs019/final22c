<!DOCTYPE html>
<html layout:decorate="~{layout/layout}">
<div layout:fragment="content">
  <style>
    :root {
      --font-sans: system-ui, -apple-system, "Noto Sans KR", "Malgun Gothic",
        "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    html {
      overflow-y: scroll;
    }

    /* 공통 래퍼 */
    .m-wrap {
      font-family: var(--font-sans);
      font-size: 14px;
      line-height: 1.6;
      color: #111827;
    }

    .muted {
      color: #6b7280;
      font-size: 12px;
    }

    /* 사이드박스 */
    .mp-grid {
      display: grid;
      grid-template-columns: 260px minmax(0, 1fr);
      gap: 24px;
      align-items: start;
    }

    .mp-col-left {
      position: sticky;
      top: 24px;
      align-self: start;
      z-index: 1;
    }

    /* 헤더 */
    .m-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .m-title {
      font-size: 22px;
      font-weight: 800;
      margin: 0;
    }

    /* 보유 포인트 칩 */
    .m-chip {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-width: 160px;
      height: 64px;
      padding: 8px 14px;
      border-radius: 14px;
      color: #fff;
      background: linear-gradient(135deg, #5b67ff, #8a48d9);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.08);
    }

    .m-chip b {
      font-size: 22px;
      line-height: 1;
      letter-spacing: 0.5px;
    }

    /* 테이블 */
    .m-table {
      table-layout: fixed;
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    .m-table th,
    .m-table td {
      padding: 14px 12px;
      border-bottom: 1px solid #e5e7eb;
    }

    .m-table thead th {
      background: #f8fafc;
      font-weight: 800;
    }

    .m-table th:first-child,
    .m-table td:first-child {
      padding-left: 16px;
    }

    .m-table th:last-child,
    .m-table td:last-child {
      white-space: nowrap;
      text-align: center;
      padding-right: 16px;
    }

    .m-link {
      color: #2563eb;
      text-decoration: none;
    }

    .m-link:hover {
      text-decoration: underline;
    }

    .pt-use {
      color: #ef4444;
      font-weight: 800;
    }

    /* 사용 */
    .pt-earn {
      color: #16a34a;
      font-weight: 800;
    }

    /* 적립 */

    .m-empty {
      padding: 48px 0;
      text-align: center;
      color: #9ca3af;
    }

    /* 페이징 */
    .pager {
      display: flex;
      gap: 6px;
      align-items: center;
      justify-content: center;
      margin: 16px 0;
    }

    .pager .page-btn {
      border: 1px solid #e5e7eb;
      background: #fff;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      color: #111827;
    }

    .pager .page-btn:hover {
      background: #f3f7ff;
    }

    .pager .page-btn[aria-current="page"] {
      background: #2563eb;
      color: #fff;
      border-color: #2563eb;
    }

    .pager .page-btn[aria-disabled="true"],
    .pager .page-btn.disabled {
      opacity: 0.5;
      pointer-events: none;
      cursor: not-allowed;
    }

    /* 사이드박스 (공통) */
    .mp-sidebox__title {
      font-size: 20px;
      font-weight: 800;
      margin: 0 0 12px;
    }

    .mp-sidebox__nav {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .mp-sidebox__link {
      display: block;
      padding: 8px 10px;
      border-radius: 10px;
      text-decoration: none;
      color: #111827;
      border: 1px solid #e5e7eb;
      background: #fff;
    }

    .mp-sidebox__link:hover {
      background: #f3f7ff;
    }

    .mp-sidebox__link.is-active {
      background: #111827;
      color: #fff;
      border-color: #111827;
    }

    /* 모달 */
    .m-modal {position:fixed;inset:0;display:none;z-index:1000}
    .m-modal.is-open {display:block}
    .m-modal__backdrop {position:absolute;inset:0;background:rgba(0,0,0,.42)}
    .m-modal__dialog {position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      width:min(920px,92vw);max-height:80vh;overflow:auto;background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .m-modal__close {position:absolute;right:8px;top:8px;border:0;background:transparent;font-size:26px;cursor:pointer}
    .m-modal__body {padding:20px}
    .od-title{margin:0 0 6px}
    .od-meta{color:#6b7280;margin-bottom:10px}
    .od-table{width:100%;border-collapse:separate;border-spacing:0}
    .od-table th,.od-table td{padding:10px 8px;border-bottom:1px solid #e5e7eb}
    .rf-box{padding:10px;border:1px solid #e5e7eb;border-radius:10px;margin:8px 0}
  </style>

  <section class="m-wrap">
    <div class="mp-grid">
      <!-- 사이드박스 -->
      <div class="mp-col-left" th:replace="~{fragments/mypageSidebox :: mypageSidebox('mileage')}"></div>

      <div class="mp-col-right">
        <header class="m-header" role="region" aria-labelledby="pageTitle">
          <h1 id="pageTitle" class="m-title">마일리지 내역</h1>
          <div class="m-chip" aria-label="보유 마일리지" th:attr="data-now-balance=${mileage ?: 0}">
            <span class="muted" style="color: #e5e7ff">보유 마일리지</span>
            <b>
              <span th:text="${#numbers.formatInteger(mileage ?: 0, 1, 'COMMA')}">0</span>P
            </b>
          </div>
        </header>

        <hr style="border:0;border-top:1px solid #e5e7eb;margin:12px 0 16px;" />

        <!-- 비어있을 때 -->
        <div th:if="${mileagePage.empty}" class="m-empty">
          마일리지 사용/적립 내역이 없습니다.
        </div>

        <!-- 목록 -->
        <table th:if="${!mileagePage.empty}" class="m-table" aria-describedby="pageTitle">
          <colgroup>
            <col style="width: 160px" />
            <col style="width: 200px" />
            <col style="width: 200px" />
            <col style="width: 200px" />
            <col style="width: 160px" />
            <col style="width: 110px" />
          </colgroup>
          <thead>
            <tr>
              <th scope="col">주문번호</th>
              <th scope="col">처리일시</th>
              <th scope="col">사용포인트</th>
              <th scope="col">적립포인트</th>
              <th scope="col">환급포인트</th>
              <th scope="col">보유마일리지</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="r : ${mileagePage}">
              <td>
                <a class="m-link js-order-link"
                   th:href="@{|/mypage/order/${r.description}|}"
                   th:attr="data-order-id=${r.description}"
                   th:text="'#' + ${r.description}">#0</a>
              </td>
              <td th:text="${#dates.format(r.regDate,'yyyy-MM-dd HH:mm')}">2025-01-01 12:00</td>

              <td>
                <span th:if="${r.usedPoint > 0}" class="pt-use"
                      th:text="${'-' + #numbers.formatInteger(r.usedPoint,1,'COMMA') + 'P'}">-0P</span>
                <span th:if="${r.usedPoint == 0}" class="muted">-</span>
              </td>

              <td>
                <span th:if="${r.refundMileage > 0}" class="pt-earn"
                      th:text="${'+' + #numbers.formatInteger(r.refundMileage,1,'COMMA') + 'P'}">+0P</span>
                <span th:if="${r.refundMileage == 0 and r.confirmedMileage > 0}" class="pt-earn"
                      th:text="${'+' + #numbers.formatInteger(r.confirmedMileage,1,'COMMA') + 'P'}">+0P</span>
                <span th:if="${r.refundMileage == 0 and r.confirmedMileage == 0}" class="muted">-</span>
              </td>

              <td>
                <span th:if="${r.refundRebate > 0}" class="pt-earn"
                      th:text="${'+' + #numbers.formatInteger(r.refundRebate,1,'COMMA') + 'P'}">+0P</span>
                <span th:if="${r.refundRebate == 0}" class="muted">-</span>
              </td>

              <td>
                <span th:text="${#numbers.formatInteger(r.balance,1,'COMMA') + 'P'}">0P</span>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- 페이저 -->
        <nav class="pager" aria-label="페이지네이션" th:if="${mileagePage.totalPages > 1}">
          <a class="page-btn"
             th:classappend="${mileagePage.first} ? ' disabled'"
             th:attr="aria-disabled=${mileagePage.first}"
             th:href="@{|/mypage/mileage?page=1&size=${mileagePage.size}|}">«</a>

          <a class="page-btn"
             th:classappend="${!mileagePage.hasPrevious} ? ' disabled'"
             th:attr="aria-disabled=${!mileagePage.hasPrevious}"
             th:href="@{|/mypage/mileage?page=${mileagePage.number}&size=${mileagePage.size}|}">‹</a>

          <a class="page-btn"
             th:each="i : ${#numbers.sequence(1, mileagePage.totalPages)}"
             th:text="${i}"
             th:href="@{|/mypage/mileage?page=${i}&size=${mileagePage.size}|}"
             th:attr="aria-current=${i == mileagePage.number + 1} ? 'page' : null"></a>

          <a class="page-btn"
             th:classappend="${!mileagePage.hasNext} ? ' disabled'"
             th:attr="aria-disabled=${!mileagePage.hasNext}"
             th:href="@{|/mypage/mileage?page=${mileagePage.number + 2}&size=${mileagePage.size}|}">›</a>

          <a class="page-btn"
             th:classappend="${mileagePage.last} ? ' disabled'"
             th:attr="aria-disabled=${mileagePage.last}"
             th:href="@{|/mypage/mileage?page=${mileagePage.totalPages}&size=${mileagePage.size}|}">»</a>
        </nav>
      </div>
    </div>
  </section>

  <!-- 주문 상세 모달 -->
  <div id="orderModal" class="m-modal" aria-hidden="true">
    <div class="m-modal__backdrop" data-close="1"></div>
    <div class="m-modal__dialog" role="dialog" aria-modal="true" aria-label="주문 상세">
      <button type="button" class="m-modal__close" data-close="1" aria-label="닫기">×</button>
      <div class="m-modal__body"><!-- JS로 채움 --></div>
    </div>
  </div>

  <script>
    (function () {
      const modal = document.getElementById('orderModal');
      const body  = modal.querySelector('.m-modal__body');
      const open  = () => { modal.classList.add('is-open'); document.documentElement.style.overflow = 'hidden'; };
      const close = () => { modal.classList.remove('is-open'); document.documentElement.style.overflow = ''; };

      modal.addEventListener('click', (e) => {
        if (e.target.matches('[data-close], .m-modal__backdrop')) close();
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('is-open')) close();
      });

      // 주문번호 클릭 → 프래그먼트 로드
      document.addEventListener('click', (e) => {
        const a = e.target.closest('.js-order-link');
        if (!a) return;
        e.preventDefault();

        const orderId = a.getAttribute('data-order-id');
        if (!orderId) return;

        body.innerHTML = '불러오는 중…';
        open();

        fetch(`/mypage/order/${orderId}/fragment`, {
          method: 'GET',
          headers: { 'Accept': 'text/html', 'X-Requested-With': 'XMLHttpRequest' },
          credentials: 'same-origin'
        })
        .then(async (res) => {
          const html = await res.text();
          if (!res.ok) throw new Error(`HTTP ${res.status}\n${html}`);
          body.innerHTML = html;
        })
        .catch((err) => {
          console.error('[order fragment]', err);
          body.innerHTML = '<div style="color:#ef4444">상세를 불러오지 못했습니다.</div>';
        });
      });
    })();
  </script>
</div>
</html>
