<!-- src/main/resources/templates/mypage/orders.html -->
<html layout:decorate="~{layout/layout}">
<div layout:fragment="content">

  <!-- 페이지 전용 스타일 -->
  <style>
    /* 카드 레이아웃 */
    .order-card{
      position: relative;
      display: grid;
      grid-template-columns: 1fr auto;   /* 좌:정보 / 우:버튼 */
      grid-template-rows: auto 52px;     /* 2행: 진행바 높이 */
      grid-template-areas:
        "info actions"
        "stepper stepper";
      column-gap: 24px;
      align-items: start;
      padding: 16px 56px 16px 16px;      /* 우측 > 아이콘 공간 */
      border:1px solid #e5e7eb; border-radius:12px; background:#fff;
    }
    .order-info   { grid-area: info; }
    .stepper      { grid-area: stepper; }
    .order-actions{ grid-area: actions; }

    /* 진행바 */
    .stepper{
      justify-self: stretch;
      align-self: end;
      padding-right: 40px;
      margin: 0;
      display:grid; grid-template-columns:repeat(3,1fr); gap:8px; align-items:center;
    }
    .step{position:relative;text-align:center;font-size:12px;color:#9ca3af}
    .step::before{content:"";position:absolute;top:10px;left:-50%;right:50%;height:2px;background:#e5e7eb}
    .step:first-child::before{display:none}
    .step .dot{width:10px;height:10px;border-radius:50%;background:#e5e7eb;margin:0 auto}
    .step.active{color:#111827}
    .step.active .dot{background:#111827}
    .step.active::before{background:#111827}

    /* 버튼들 */
    .order-actions{ align-self: start; display:flex; gap:8px; }
    .order-btn, .refund-btn, .cancel-btn{
      border:none; border-radius:12px; padding:8px 14px; cursor:pointer; white-space:nowrap;
    }
    .order-btn{background:#111827;color:#fff}
    .order-btn:hover{opacity:.9}
    .refund-btn{background:#f3f4f6;color:#111827}
    .refund-btn:hover{background:#e5e7eb}
    .cancel-btn{background:#fee2e2;color:#991b1b}
    .cancel-btn:hover{background:#fecaca}

    /* 우측 중앙 '>' 아이콘 */
    .more{
      position:absolute; right:16px; top:50%; transform:translateY(-50%);
      width:28px; height:28px; display:inline-flex; justify-content:center; align-items:center;
      font-size:20px; font-weight:700; color:#111827; text-decoration:none; z-index:1;
    }
    .more:hover{opacity:.8}

    /* 배지 */
    .badge-canceled{display:inline-block;padding:4px 8px;border-radius:8px;background:#fee2e2;color:#991b1b;font-weight:600;font-size:12px;margin-left:8px}
    .badge-confirmed{display:inline-block;padding:4px 8px;border-radius:8px;background:#e5f3ff;color:#1d4ed8;font-weight:600;font-size:12px;margin-left:8px}
    .order-card.is-canceled{opacity:.9}

    .muted{ color:#6b7280; font-size:12px; }

    /* 간단 모달 스타일(공통 CSS 없을 때 대비) */
    .cm-modal{position:fixed;inset:0;display:none;background:rgba(0,0,0,.35);z-index:1000}
    .cm-modal.is-open{display:block}
    .cm-modal__content{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      background:#fff;border-radius:12px;min-width:320px;max-width:90vw;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.2)}

    /* 반응형 */
    @media (max-width: 900px){
      .order-card{ grid-template-columns: 1fr auto; grid-template-rows: auto auto; }
      .order-actions{ align-self:center; }
    }
  </style>

  <!-- 주문 리스트 -->
  <section>
    <h2>주문내역</h2>

    <div th:if="${orders.content.isEmpty()}">주문 내역이 없습니다.</div>

    <div th:each="o : ${orders.content}"
         class="order-card"
         th:classappend="${o.status=='CANCELED'} ? ' is-canceled'"
         th:attr="data-order-id=${o.orderId}"
         th:with="
           first=${#lists.isEmpty(o.details) ? null : o.details[0]},
           restCnt=${#lists.isEmpty(o.details) ? 0 : #lists.size(o.details)-1},
           step=${
             #strings.equalsIgnoreCase(o.deliveryStatus,'DELIVERED') ? 3 :
             (#strings.equalsIgnoreCase(o.deliveryStatus,'SHIPPING')  ? 2 : 1)
           }">

      <!-- 좌: 주문정보 -->
      <div class="order-info">
        <div class="muted" th:text="${#temporals.format(o.regDate,'yyyy.MM.dd')}"></div>
        <div class="order-title">
          <span th:text="${first != null ? first.product.name : '상품'}">상품명</span>
          <span th:if="${restCnt>0}" th:text="${' 외 ' + restCnt + '건'}"></span>
          <span th:if="${restCnt==0 && first != null}" th:text="${' ' + first.quantity + '개'}"></span>

          <span th:if="${o.status=='CANCELED'}" class="badge-canceled">주문취소</span>
          <span th:if="${o.status=='PAID' and o.deliveryStatus=='CONFIRMED'}" class="badge-confirmed">주문확정</span>
        </div>

        <div class="order-amount" th:text="${#numbers.formatInteger(o.totalAmount,0)} + '원'">0원</div>
      </div>

      <!-- 우측 상단 버튼: ORDERED & PAID → 결제취소 -->
      <div class="order-actions" th:if="${o.status=='PAID' and o.deliveryStatus=='ORDERED'}">
        <button class="cancel-btn btn-cancel" type="button">결제취소</button>
      </div>

      <!-- 하단 진행바 -->
      <div class="stepper"
           th:if="${o.status=='PAID' and (o.deliveryStatus=='ORDERED' or o.deliveryStatus=='SHIPPING' or o.deliveryStatus=='DELIVERED')}"
           th:attr="data-step=${step}, data-max=3, data-autoplay='false'">
        <div class="step"><div class="dot"></div><div>주문접수</div></div>
        <div class="step"><div class="dot"></div><div>배송 중</div></div>
        <div class="step"><div class="dot"></div><div>배송완료</div></div>
      </div>

      <!-- 우측 상단 버튼(배송완료): 주문확정 / 환불요청 -->
      <div class="order-actions" th:if="${o.status=='PAID' and o.deliveryStatus=='DELIVERED'}">
        <button class="order-btn  btn-confirm" type="button">주문확정</button>
        <button class="refund-btn btn-refund"  type="button">환불요청</button>
      </div>

      <!-- 우측 중앙 > (상세보기) -->
      <a class="more" th:href="@{/mypage/order/{id}(id=${o.orderId})}">&gt;</a>
    </div>

    <!-- 페이지네이션 -->
    <div style="margin-top:12px" th:if="${orders.totalPages > 1}">
      <a th:each="i : ${#numbers.sequence(0, orders.totalPages - 1)}"
         th:href="@{/mypage/order(page=${i}, size=${orders.size})}"
         th:text="${i + 1}"
         th:classappend="${i == orders.number} ? ' active' : ''"
         style="margin-right:8px"></a>
    </div>
  </section>

  <!-- 주문 상세 모달 (데모) -->
  <div id="orderDetailModal" class="cm-modal" aria-hidden="true">
    <div class="cm-modal__content">
      <button type="button" id="orderDetailClose" style="float:right;">X</button>
      <h3>주문 상세</h3>
      <div id="od-date"></div>
      <div id="od-body"></div>
    </div>
  </div>

  <!-- 확인/결과 모달 -->
  <div id="confirmModal" class="cm-modal" aria-hidden="true">
    <div class="cm-modal__content">
      <h3>확인</h3>
      <p id="confirmText" style="margin:12px 0;"></p>
      <div style="display:flex;gap:8px;justify-content:flex-end;">
        <button type="button" id="confirmNo"  class="btn btn-outline-secondary">취소</button>
        <button type="button" id="confirmYes" class="btn btn-secondary">예</button>
      </div>
    </div>
  </div>
  <div id="resultModal" class="cm-modal" aria-hidden="true">
    <div class="cm-modal__content">
      <h3>알림</h3>
      <p id="resultText" style="margin:12px 0;"></p>
      <div style="display:flex;justify-content:flex-end;">
        <button type="button" id="resultOk" class="btn btn-secondary">닫기</button>
      </div>
    </div>
  </div>

  <!-- 페이지 전용 스크립트 -->
  <script>
    /* ===== 스텝퍼 표시(고정) ===== */
    (function(){
      function render(stepper, n){
        const steps = stepper.querySelectorAll('.step');
        steps.forEach((el, idx) => el.classList.toggle('active', idx < n));
        stepper.dataset.step = String(n);
      }
      document.querySelectorAll('.stepper').forEach(stepper=>{
        const n = parseInt(stepper.dataset.step || '1', 10);
        render(stepper, n);
      });
      window.stepperRender = render;
    })();

    /* ===== 모달 공통 (스크롤 잠금 없음) ===== */
    const $confirm     = document.getElementById('confirmModal');
    const $confirmText = document.getElementById('confirmText');
    const $confirmYes  = document.getElementById('confirmYes');
    const $confirmNo   = document.getElementById('confirmNo');

    const $result      = document.getElementById('resultModal');
    const $resultText  = document.getElementById('resultText');
    const $resultOk    = document.getElementById('resultOk');

    function openModal(el){ if(el){ el.classList.add('is-open'); } }
    function closeModal(el){ if(el){ el.classList.remove('is-open'); } }

    function openConfirm(orderId, action, message){
      window.targetOrderId = orderId;
      window.pendingAction = action; // 'cancel' | 'confirm' | 'refund'
      if ($confirmText) $confirmText.textContent = message || '';
      openModal($confirm);
    }
    function closeConfirm(){ closeModal($confirm); }
    function openResult(msg){ if($resultText) $resultText.textContent = msg || ''; openModal($result); }
    function closeResult(){ closeModal($result); }

    $confirmNo?.addEventListener('click', closeConfirm);
    $resultOk?.addEventListener('click', closeResult);

    /* ===== CSRF (레이아웃 <head>에 메타 필요)
       <meta name="_csrf" th:content="${_csrf.token}">
       <meta name="_csrf_header" th:content="${_csrf.headerName}">
    ===== */
    const CSRF_TOKEN  = document.querySelector('meta[name="_csrf"]')?.content;
    const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.content;

    /* ===== 카드별 버튼 이벤트 ===== */
    document.querySelectorAll('.order-card').forEach(card=>{
      const id = card.dataset.orderId;
      const btnCancel  = card.querySelector('.btn-cancel');  // 결제취소(ORDERED)
      const btnConfirm = card.querySelector('.btn-confirm'); // 주문확정(DELIVERED)
      const btnRefund  = card.querySelector('.btn-refund');  // 환불요청(DELIVERED)

      btnCancel?.addEventListener('click', ()=>openConfirm(id,'cancel','주문을 취소하시겠습니까?'));
      btnConfirm?.addEventListener('click', ()=>openConfirm(id,'confirm','주문을 확정하시겠습니까?'));
      btnRefund?.addEventListener('click', ()=>openConfirm(id,'refund','환불을 요청하시겠습니까?'));
    });

    /* ===== 확인 모달 '예' 처리 ===== */
    $confirmYes?.addEventListener('click', async () => {
      closeConfirm();
      try {
        let url;
        if (window.pendingAction === 'cancel')  url = `/pay/cancel-paid/${window.targetOrderId}`;
        if (window.pendingAction === 'confirm') url = `/pay/${window.targetOrderId}/confirm`;
        if (window.pendingAction === 'refund')  url = `/pay/${window.targetOrderId}/refund`;
        if (!url) throw new Error('지원하지 않는 작업입니다.');

        $confirmYes.disabled = true; // 중복 클릭 방지

        const headers = {'Content-Type':'application/json'};
        if (CSRF_TOKEN && CSRF_HEADER) headers[CSRF_HEADER] = CSRF_TOKEN;

        const res = await fetch(url, { method:'POST', headers, body:'{}', credentials:'same-origin' });

        if (res.status === 401) { window.location.href = '/user/login'; return; }

        let data = {};
        try { data = await res.json(); } catch(_) {}
        if (!res.ok) throw new Error(data.message || `HTTP ${res.status}`);

        const card = document.querySelector(`.order-card[data-order-id="${window.targetOrderId}"]`);

        if (window.pendingAction === 'cancel') {
          card?.classList.add('is-canceled');
          card?.querySelectorAll('.order-actions')?.forEach(el => el.style.display = 'none');
          card?.querySelectorAll('.stepper')?.forEach(el => el.remove());
          const title = card?.querySelector('.order-title');
          if (title && !title.querySelector('.badge-canceled')) {
            const b = document.createElement('span');
            b.className='badge-canceled'; b.textContent='주문취소';
            title.appendChild(b);
          }
          openResult(data.message || '주문이 취소되었습니다.');
          return;
        }

        if (window.pendingAction === 'confirm') {
          card?.querySelectorAll('.order-actions')?.forEach(el => el.style.display = 'none');
          card?.querySelectorAll('.stepper')?.forEach(el => el.remove());
          const title = card?.querySelector('.order-title') || card?.querySelector('.order-info');
          if (title && !title.querySelector('.badge-confirmed')) {
            const b = document.createElement('span');
            b.className = 'badge-confirmed';
            b.textContent = '주문확정';
            title.appendChild(b);
          }
          const added   = (data && typeof data.mileage === 'number') ? data.mileage : 0;
          const balance = (data && typeof data.pointBalance === 'number') ? data.pointBalance : null;

          let msg = data.message || '주문이 확정되었습니다.';
          if (added > 0)       msg += ` (+${added}P 적립)`;
          if (balance != null) msg += ` / 보유 포인트: ${balance}P`;

          openResult(msg);
          return;
        }

        // 환불요청 등
        openResult(data.message || '처리가 완료되었습니다.');
      } catch (e) {
        console.error(e);
        openResult(e.message || '처리 중 오류가 발생했습니다.');
      } finally {
        if ($confirmYes) $confirmYes.disabled = false;
      }
    });

    // 상세 모달 데모
    document.querySelectorAll('.order-card .more').forEach(link=>{
      link.addEventListener('click', e=>{
        e.preventDefault();
        const modal = document.getElementById('orderDetailModal');
        modal?.classList.add('is-open');
      });
    });
    document.getElementById('orderDetailClose')?.addEventListener('click', ()=>{
      const modal = document.getElementById('orderDetailModal');
      modal?.classList.remove('is-open');
    });
  </script>

</div>
</html>
