<!-- templates/mypage/orders.html -->
<html layout:decorate="~{layout/layout}">
<div layout:fragment="content">
<style>
  /* 카드: 2행 그리드 (1행: 정보/버튼, 2행: 진행바) */
  .order-card{
    position: relative;
    display: grid;
    grid-template-columns: 1fr auto;   /* 좌:정보 / 우:버튼 */
    grid-template-rows: auto 52px;     /* 2행: 진행바 높이 */
    grid-template-areas:
      "info actions"
      "stepper stepper";
    column-gap: 24px;
    align-items: start;
    padding: 16px 56px 16px 16px;      /* 우측 > 아이콘 공간 */
    border:1px solid #e5e7eb; border-radius:12px; background:#fff;
  }

  /* 영역 배치 */
  .order-info   { grid-area: info; }
  .stepper      { grid-area: stepper; }
  .order-actions{ grid-area: actions; }

  /* 진행바: 카드 하단에 붙이기 */
  .stepper{
    justify-self: stretch;
    align-self: end;
    padding-right: 40px;
    margin: 0;
    display:grid; grid-template-columns:repeat(3,1fr); gap:8px; align-items:center;
  }

  /* 버튼: 우측 상단 가로 배치 */
  .order-actions{
    align-self: start;
    display:flex; flex-direction: row; gap:8px;
  }
  .order-btn, .refund-btn, .cancel-btn{
    border:none; border-radius:12px; padding:8px 14px; cursor:pointer; white-space:nowrap;
  }
  .order-btn{background:#111827;color:#fff}
  .order-btn:hover{opacity:.9}
  .refund-btn{background:#f3f4f6;color:#111827}
  .refund-btn:hover{background:#e5e7eb}
  .cancel-btn{background:#fee2e2;color:#991b1b}
  .cancel-btn:hover{background:#fecaca}

  /* 우측 중앙의 '>' 아이콘 */
  .more{
    position:absolute; right:16px; top:50%; transform:translateY(-50%);
    width:28px; height:28px; display:inline-flex; justify-content:center; align-items:center;
    font-size:20px; font-weight:700; color:#111827; text-decoration:none; z-index:1;
  }
  .more:hover{opacity:.8}

  /* 진행바 기본/활성 스타일 */
  .step{position:relative;text-align:center;font-size:12px;color:#9ca3af}
  .step::before{content:"";position:absolute;top:10px;left:-50%;right:50%;height:2px;background:#e5e7eb}
  .step:first-child::before{display:none}
  .step .dot{width:10px;height:10px;border-radius:50%;background:#e5e7eb;margin:0 auto}
  .step.active{color:#111827}
  .step.active .dot{background:#111827}
  .step.active::before{background:#111827}

  /* 배지 */
  .badge-canceled{display:inline-block;padding:4px 8px;border-radius:8px;background:#fee2e2;color:#991b1b;font-weight:600;font-size:12px;margin-left:8px}
  .order-card.is-canceled{opacity:.9}
  .badge-confirmed{display:inline-block;padding:4px 8px;border-radius:8px;background:#dcfce7;color:#166534;font-weight:600;font-size:12px;margin-left:8px}

  /* 좁은 화면 대응 */
  @media (max-width: 900px){
    .order-card{ grid-template-columns: 1fr auto; grid-template-rows: auto auto; }
    .order-actions{ align-self:center; }
  }

  /* Overlay */
  .cm-modal{
    position: fixed; inset: 0;
    display: none; align-items: center; justify-content: center;
    background: rgba(0,0,0,.45); z-index: 2000;
  }
  .cm-modal.is-open{ display: flex; }

  /* Box */
  .cm-modal__content{
    width: min(92vw, 360px);
    background: #fff; border-radius: 12px;
    box-shadow: 0 12px 30px rgba(0,0,0,.25);
    padding: 20px; text-align: center;
  }

  .cm-modal__actions{ display:flex; gap:8px; justify-content:center; margin-top:12px; }
  .cm-btn{
    display: inline-block; min-width: 96px;
    padding: 10px 14px; border-radius: 10px;
    border: 1px solid #e5e7eb; background:#f9fafb; color:#111827; cursor:pointer;
  }
  .cm-btn--primary{ background:#111827; color:#fff; border-color:#111827; }
  .cm-btn:focus{ outline:2px solid #111827; outline-offset:2px; }

  /* ✅ 모달 열릴 때만 스크롤 잠금 + 우측 패딩 보정 */
  body.lock-scroll{
    overflow:hidden;
    padding-right: var(--sbw, 0px);
  }
</style>

<section>
  <h2>주문내역</h2>

  <div th:if="${orders.content.isEmpty()}">주문 내역이 없습니다.</div>

  <div th:each="o : ${orders.content}"
       class="order-card"
       th:classappend="${o.status=='CANCELED'} ? ' is-canceled'"
       th:attr="data-order-id=${o.orderId}"
       th:with="
         first=${#lists.isEmpty(o.details) ? null : o.details[0]},
         restCnt=${#lists.isEmpty(o.details) ? 0 : #lists.size(o.details)-1},
         step=${
           #strings.equalsIgnoreCase(o.deliveryStatus,'DELIVERED') ? 3 :
           (#strings.equalsIgnoreCase(o.deliveryStatus,'SHIPPING')  ? 2 : 1)
         }">

    <!-- 좌: 주문정보 -->
    <div class="order-info">
      <div class="muted" th:text="${#temporals.format(o.regDate,'yyyy.MM.dd')}"></div>
      <div class="order-title">
        <span th:text="${first != null ? first.product.name : '상품'}">상품명</span>
        <span th:if="${restCnt>0}" th:text="${' 외 ' + restCnt + '건'}"></span>
        <span th:if="${#strings.equalsIgnoreCase(#strings.trim(o.deliveryStatus),'CONFIRMED')}"
              class="badge-confirmed">주문확정</span>
        <span th:if="${o.status=='CANCELED'}" class="badge-canceled">주문취소</span>
      </div>
      <div class="order-amount" th:text="${#numbers.formatInteger(o.totalAmount,0)} + '원'">0원</div>
    </div>

    <!-- 하단 진행바: 취소가 아닌 경우에만 -->
    <div class="stepper"
         th:if="${o.status!='CANCELED' and o.status!='FAILED' and o.deliveryStatus!='CONFIRMED'}"
         th:attr="data-step=${step}, data-max=3, data-autoplay='false'">
      <div class="step"><div class="dot"></div><div>주문접수</div></div>
      <div class="step"><div class="dot"></div><div>배송 중</div></div>
      <div class="step"><div class="dot"></div><div>배송완료</div></div>
    </div>

    <!-- 우측 상단 버튼 -->
    <div class="order-actions">
      <!-- ORDERED & PAID → 주문취소만 -->
      <button th:if="${o.status=='PAID'
        and o.status!='FAILED'
        and #strings.equalsIgnoreCase(#strings.trim(o.deliveryStatus),'ORDERED')}"
        class="cancel-btn btn-cancel" type="button">주문취소</button>

      <!-- DELIVERED & PAID → 주문확정 / 환불요청 -->
      <button th:if="${o.status=='PAID' and o.deliveryStatus=='DELIVERED'}"
              class="order-btn btn-confirm" type="button">주문확정</button>
      <button th:if="${o.status=='PAID' and o.deliveryStatus=='DELIVERED'}"
              class="refund-btn btn-refund" type="button">환불요청</button>
    </div>

    <!-- 우측 중앙 > -->
    <a class="more" th:href="@{/mypage/order/{id}(id=${o.orderId})}">&gt;</a>

    <!-- ✅ 환불 모달로 복사할 숨김 리스트(데이터만 담아두기) -->
    <div class="refund-items-src" th:attr="data-order-id=${o.orderId}" hidden>
      <ul>
        <li th:each="d : ${o.details}"
            th:attr="
              data-od-id=${d.orderDetailId},
              data-name=${d.product.name},
              data-max=${d.quantity},
              data-total=${d.totalPrice},
              data-unit=${d.totalPrice / d.quantity}  ">
          <!-- 화면에는 안 보이고, data-*만 사용 -->
        </li>
      </ul>
    </div>
  </div>

  <!-- 페이지네이션 (경로 주의: 단수 /mypage/order) -->
  <div style="margin-top:12px" th:if="${orders.totalPages > 1}">
    <a th:each="i : ${#numbers.sequence(0, orders.totalPages-1)}"
       th:href="@{/mypage/order(page=${i}, size=${orders.size})}"
       th:text="${i + 1}"
       th:classappend="${i == orders.number} ? ' active' : ''"
       style="margin-right:8px"></a>
  </div>
</section>

<!-- 확인 모달 -->
<div id="confirmModal" class="cm-modal" aria-hidden="true">
  <div class="cm-modal__content">
    <p id="confirmText">확인하시겠습니까?</p>
    <div class="cm-modal__actions">
      <button id="confirmYes" class="cm-btn cm-btn--primary">예</button>
      <button id="confirmNo"  class="cm-btn">아니요</button>
    </div>
  </div>
</div>

<!-- 결과 모달 -->
<div id="resultModal" class="cm-modal" aria-hidden="true">
  <div class="cm-modal__content">
    <p id="resultText">처리가 완료되었습니다.</p>
    <div class="cm-modal__actions">
      <button id="resultOk" class="cm-btn cm-btn--primary">확인</button>
    </div>
  </div>
</div>

<!-- 주문상품 리스트 모달 (">" 클릭 시) -->
<div id="orderItemsModal" class="cm-modal" aria-hidden="true">
  <div class="cm-modal__content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0">주문 상품</h3>
      <button type="button" id="orderItemsClose" class="cm-btn">X</button>
    </div>
    <div id="orderItemsBody">불러오는 중…</div>
  </div>
</div>

<!-- 환불 요청 모달 -->
<div id="refundModal" class="cm-modal" aria-hidden="true">
  <div class="cm-modal__content" style="width:min(92vw, 720px); max-height:88vh; overflow:auto;">
    <h3 style="margin:0 0 16px; text-align:center; font-size:22px">환불 요청</h3>

    <!-- 주문 리스트 -->
    <div style="text-align:left; margin-bottom:12px">
      <div style="font-weight:700; margin-bottom:8px">주문 상품</div>
      <div style="border:1px solid #e5e7eb; border-radius:10px; padding:0;">
        <table id="refundTable" style="width:100%; border-collapse:separate; border-spacing:0;">
          <thead>
            <tr style="background:#f8fafc;">
              <th style="text-align:left; padding:10px 12px;">상품명</th>
              <th style="width:160px; text-align:center; padding:10px 12px;">수량</th>
              <th style="width:160px; text-align:right; padding:10px 12px;">금액</th>
            </tr>
          </thead>
          <tbody id="refundTbody"><tr><td colspan="3" style="padding:14px 12px">불러오는 중…</td></tr></tbody>
          <tfoot>
            <tr>
              <td style="padding:12px"></td>
              <td style="padding:12px; text-align:right; font-weight:700">합계</td>
              <td style="padding:12px; text-align:right; font-weight:800" id="refundGrand">0원</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- 환불 사유 -->
    <div style="text-align:left; margin:12px 0">
      <label for="refundReason" style="display:block; font-weight:700; margin-bottom:6px">환불사유</label>
      <textarea id="refundReason" rows="4" placeholder="환불 사유를 입력하세요"
        style="width:100%; border:1px solid #e5e7eb; border-radius:10px; padding:12px; resize:vertical"></textarea>
    </div>

    <div class="cm-modal__actions" style="position:sticky; bottom:0; background:#fff; padding-top:8px;">
      <button id="refundSubmit" class="cm-btn cm-btn--primary">요청하기</button>
      <button id="refundCancel" class="cm-btn">닫기</button>
    </div>
  </div>
</div>


<script>
/* ===== 스크롤 잠금/보정 유틸 ===== */
function scrollbarWidth(){
  return window.innerWidth - document.documentElement.clientWidth;
}
function lockScroll(){
  const sw = scrollbarWidth();
  if (sw > 0) document.documentElement.style.setProperty('--sbw', sw + 'px');
  document.body.classList.add('lock-scroll');
}
function unlockScroll(){
  document.body.classList.remove('lock-scroll');
  document.documentElement.style.removeProperty('--sbw');
}
function openModal(el){
  el.classList.add('is-open');
  lockScroll();
}
function closeModal(el){
  el.classList.remove('is-open');
  // 열려있는 모달이 더 없으면 스크롤 해제
  if (document.querySelectorAll('.cm-modal.is-open').length === 0) {
    unlockScroll();
  }
}

/* ===== 스텝퍼 표시(고정) ===== */
(function(){
  function render(stepper, n){
    const steps = stepper.querySelectorAll('.step');
    steps.forEach((el, idx) => el.classList.toggle('active', idx < n));
    stepper.dataset.step = String(n);
  }
  document.querySelectorAll('.stepper').forEach(stepper=>{
    const n = parseInt(stepper.dataset.step || '1', 10);
    render(stepper, n);
  });
  window.stepperRender = render;
})();

/* ===== 모달 공통 ===== */
const $confirm     = document.getElementById('confirmModal');
const $confirmText = document.getElementById('confirmText');
const $confirmYes  = document.getElementById('confirmYes');
const $confirmNo   = document.getElementById('confirmNo');

const $result      = document.getElementById('resultModal');
const $resultText  = document.getElementById('resultText');
const $resultOk    = document.getElementById('resultOk');

let targetOrderId = null;
let pendingAction = null; // 'cancel' | 'confirm'

function openConfirm(orderId, action, message){
  targetOrderId = orderId;
  pendingAction = action;
  $confirmText.textContent = message;
  openModal($confirm);
}
function closeConfirm(){ closeModal($confirm); }

function openResult(msg){ $resultText.textContent = msg; openModal($result); }
function closeResult(){ closeModal($result); }

/* 버튼 리스너 */
$confirmNo.addEventListener('click', closeConfirm);
$resultOk.addEventListener('click', closeResult);

/* 카드별 버튼 이벤트 */
document.querySelectorAll('.order-card').forEach(card=>{
  const id = card.dataset.orderId;
  const btnCancel  = card.querySelector('.btn-cancel');
  const btnConfirm = card.querySelector('.btn-confirm');
  const btnRefund  = card.querySelector('.btn-refund');

  btnCancel?.addEventListener('click', ()=>{
    openConfirm(id,'cancel','주문을 취소하시겠습니까?');
  });
  btnConfirm?.addEventListener('click', ()=>{
    openConfirm(id,'confirm','주문을 확정하시겠습니까?');
  });
  // ✅ 환불은 확인모달 대신 전용 모달 사용
  btnRefund?.addEventListener('click', ()=>{
    openRefundModalFromCard(card);
  });
});

/* 확인 모달 '예' 처리 (취소/확정 전용) */
$confirmYes.addEventListener('click', async () => {
  closeConfirm();
  try {
    let url;
    if (pendingAction === 'cancel')  url = `/pay/cancel-paid/${targetOrderId}`;
    if (pendingAction === 'confirm') url = `/pay/${targetOrderId}/confirm`;

    const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:'{}' });
    let data = {};
    try { data = await res.json(); } catch(_) {}
    if (!res.ok) throw new Error(data.message || `HTTP ${res.status}`);

    const card = document.querySelector(`.order-card[data-order-id="${targetOrderId}"]`);

    if (pendingAction === 'cancel') {
      card?.classList.add('is-canceled');
      card?.querySelector('.order-actions')?.remove();
      card?.querySelector('.stepper')?.remove();
      const title = card?.querySelector('.order-title');
      if (title && !title.querySelector('.badge-canceled')) {
        const b = document.createElement('span');
        b.className = 'badge-canceled';
        b.textContent = '주문취소';
        title.appendChild(b);
      }
    } else if (pendingAction === 'confirm') {
      updateCardToConfirmed(card);
    }

    openResult(data.message || '처리가 완료되었습니다.');
  } catch (e) {
    console.error(e);
    openResult('처리 중 오류가 발생했습니다.');
  }
});

function updateCardToConfirmed(card){
  if (!card) return;

  // 버튼/진행바 제거
  card.querySelector('.order-actions')?.remove();
  card.querySelector('.btn-cancel')?.remove();
  card.querySelector('.btn-confirm')?.remove();
  card.querySelector('.btn-refund')?.remove();
  card.querySelector('.stepper')?.remove();

  // "주문확정" 배지 추가
  const title = card.querySelector('.order-title');
  if (title && !title.querySelector('.badge-confirmed')) {
    const b = document.createElement('span');
    b.className = 'badge-confirmed';
    b.textContent = '주문확정';
    title.appendChild(b);
  }
  card.setAttribute('data-delivery-status', 'CONFIRMED');
}

/* ===== ">" 링크: 주문상품 모달 ===== */
(function(){
  const modal = document.getElementById('orderItemsModal');
  const body  = document.getElementById('orderItemsBody');
  const closeBtn = document.getElementById('orderItemsClose');

  function open(){ openModal(modal); }
  function close(){ closeModal(modal); }

  // ">" 링크 클릭 시: 모달 열고 fragment 로딩
  document.addEventListener('click', async (e) => {
    const link = e.target.closest('.order-card .more');
    if (!link) return;
    e.preventDefault();

    const card = link.closest('.order-card');
    const orderId = card?.dataset.orderId;
    if (!orderId) return;

    body.innerHTML = '불러오는 중…';
    open();

    try {
      const res = await fetch(`/mypage/order/${orderId}/fragment`, {
        headers: { 'X-Requested-With':'XMLHttpRequest' }
      });
      if (!res.ok) throw new Error('HTTP '+res.status);
      body.innerHTML = await res.text();
    } catch (err) {
      console.error(err);
      body.innerHTML = '<div style="color:#ef4444">상세를 불러오지 못했습니다.</div>';
    }
  });

  closeBtn?.addEventListener('click', close);
})();

/* ===== 금액 포맷 ===== */
function fmt(n){ return (n||0).toLocaleString() + '원'; }

/* ===== 환불 요청 모달 (동적 테이블) ===== */
(function(){
  const modal  = document.getElementById('refundModal');
  const tbody  = document.getElementById('refundTbody');
  const grand  = document.getElementById('refundGrand');
  const reason = document.getElementById('refundReason');
  const btnOk  = document.getElementById('refundSubmit');
  const btnNo  = document.getElementById('refundCancel');

  function open(){ openModal(modal); }
  function close(){ closeModal(modal); }

  // 행 템플릿 생성
  function makeRow({odId, name, max, unit}){
    const tr = document.createElement('tr');
    tr.dataset.odId = odId;
    tr.dataset.max = String(max);
    tr.dataset.unit = String(unit);

    tr.innerHTML = `
      <td style="padding:10px 12px;">
        <div style="font-weight:600; line-height:1.3">${name}</div>
        <div style="color:#6b7280; font-size:12px">주문수량: ${max}</div>
      </td>
      <td style="padding:10px 12px; text-align:center;">
        <div style="display:inline-flex; align-items:center; gap:6px;">
          <button type="button" class="qminus" style="width:32px; height:32px; border:1px solid #e5e7eb; border-radius:8px;">-</button>
          <input type="number" class="qinput" value="0" min="0" max="${max}" 
                 style="width:64px; text-align:center; border:1px solid #e5e7eb; border-radius:8px; height:32px;">
          <button type="button" class="qplus"  style="width:32px; height:32px; border:1px solid #e5e7eb; border-radius:8px;">+</button>
        </div>
      </td>
      <td style="padding:10px 12px; text-align:right;">
        <span class="lineTotal">0원</span>
      </td>
    `;
    return tr;
  }

  function recalcRow(tr){
    const max  = parseInt(tr.dataset.max, 10);
    const unit = parseInt(tr.dataset.unit, 10);
    const input = tr.querySelector('.qinput');
    let val = parseInt(input.value || '0', 10);
    if (isNaN(val)) val = 0;
    if (val < 0) val = 0;
    if (val > max) val = max;
    input.value = val;
    tr.querySelector('.lineTotal').textContent = fmt(val * unit);
  }

  function recalcGrand(){
    let sum = 0;
    tbody.querySelectorAll('tr').forEach(tr=>{
      const unit = parseInt(tr.dataset.unit, 10);
      const val  = parseInt(tr.querySelector('.qinput').value || '0', 10);
      sum += (isNaN(unit) || isNaN(val)) ? 0 : unit * val;
    });
    grand.textContent = fmt(sum);
    return sum;
  }

  // 외부에서 카드 전달받아 열기
  window.openRefundModalFromCard = function(card){
    const orderId = card?.dataset.orderId;
    if(!orderId) return;

    // src에서 데이터 읽기
    const src = card.querySelector('.refund-items-src ul');
    const items = [...src.querySelectorAll('li')].map(li=>{
      const odId  = li.dataset.odId;
      const name  = li.dataset.name;
      const max   = parseInt(li.dataset.max, 10);
      const total = parseInt(li.dataset.total, 10);
      const unit  = Math.floor(total / (max || 1)); // 단가
      return { odId, name, max, unit };
    });

    // 테이블 렌더
    tbody.innerHTML = '';
    items.forEach(item=>{
      const tr = makeRow(item);
      tbody.appendChild(tr);

      // 이벤트
      const input = tr.querySelector('.qinput');
      const minus = tr.querySelector('.qminus');
      const plus  = tr.querySelector('.qplus');

      input.addEventListener('input', ()=>{ recalcRow(tr); recalcGrand(); });
      minus.addEventListener('click', ()=>{
        input.value = Math.max(0, parseInt(input.value||'0',10) - 1);
        recalcRow(tr); recalcGrand();
      });
      plus.addEventListener('click', ()=>{
        input.value = Math.min(item.max, parseInt(input.value||'0',10) + 1);
        recalcRow(tr); recalcGrand();
      });

      recalcRow(tr);
    });
    recalcGrand();

    // 모달 상태 셋업
    reason.value = '';
    tbody.dataset.orderId = orderId;
    open();
  };

  // 닫기
  btnNo.addEventListener('click', close);

  // 제출
  btnOk.addEventListener('click', async ()=>{
    const orderId = tbody.dataset.orderId;
    const text = reason.value.trim();

    // 수량 수집 (0초과만)
    const items = [...tbody.querySelectorAll('tr')].map(tr=>{
      const qty = parseInt(tr.querySelector('.qinput').value || '0', 10);
      return { orderDetailId: tr.dataset.odId, refundQty: Math.max(0, qty) };
    }).filter(it => it.refundQty > 0);

    if(items.length === 0){
      alert('환불 수량을 1개 이상 선택하세요.');
      return;
    }
    if(!text){
      alert('환불 사유를 입력해주세요.');
      reason.focus();
      return;
    }
    const bodyData = {
      reason: text,
      items: items
    };

    try{
      // 백엔드: reason + items 배열을 받도록 구현(부분환불용)
      const res = await fetch(`/pay/${orderId}/refund`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ reason: text, items })
      });
      let data = {};
      try { data = await res.json(); } catch(_) {}

      if(!res.ok) throw new Error(data.message || `HTTP ${res.status}`);

      // 환불 버튼 비활성
      const card = document.querySelector(`.order-card[data-order-id="${orderId}"]`);
      card?.querySelector('.btn-refund')?.setAttribute('disabled','disabled');

      close();
      if (typeof openResult === 'function') {
        openResult(data.message || '환불 요청이 접수되었습니다.');
      } else {
        alert('환불 요청이 접수되었습니다.');
      }
    }catch(e){
      console.error(e);
      close();
      if (typeof openResult === 'function') {
        openResult('환불 요청 처리 중 오류가 발생했습니다.');
      } else {
        alert('환불 요청 처리 중 오류가 발생했습니다.');
      }
    }
  });
})();
</script>
</div>
</html>
