<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<head>
  <meta charset="UTF-8" />
  <title>마이페이지 - 내 문의</title>
</head>

<th:block layout:fragment="css">
  <link rel="stylesheet" th:href="@{/css/mypage.css}">
  <style>
    /* === 내 문의 페이지 전용 스타일 === */
    .page-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .page-title{margin:0}
    .ctrls{display:flex;gap:8px;align-items:center}
    .ctrls select{border:1px solid var(--border);padding:8px 10px;border-radius:10px;background:#fff}

    .m-table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;border:1px solid var(--border);margin-top:8px}
    .m-table thead{background:#f9fafb}
    .m-table th{padding:12px 16px;text-align:left;font-weight:700;color:#374151;border-bottom:1px solid var(--border);font-size:14px}
    .m-table td{padding:14px 16px;border-bottom:1px solid #f3f4f6;vertical-align:middle;font-size:14px;color:#111827}
    .m-table tbody tr:last-child td{border-bottom:none}
    .m-table tbody tr:hover{background:#f9fafb}

    .m-link{color:#111827;text-decoration:none;font-weight:600;transition:color .15s ease}
    .m-link:hover{color:#2563eb;text-decoration:underline}

    .badge{display:inline-block;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600;text-align:center;white-space:nowrap;color:#111827 !important;}
    .badge--pending{background:#fef3c7;color:#111827 !important;}
    .badge--answered{background:#dcfce7;color:#111827 !important;}

    .m-empty{text-align:center;color:#6b7280;font-style:italic;padding:32px 16px !important}

    #questionModal .field-row{display:grid;grid-template-columns:100px 1fr;gap:12px;align-items:start;padding:8px 0;border-bottom:1px solid #f3f4f6}
    #questionModal .field-row:last-child{border-bottom:none}
    #questionModal .field-row label{font-weight:700;color:#374151;font-size:14px}
    #questionModal .qdetail-content{line-height:1.6;color:#111827;font-size:14px;white-space:pre-wrap}
  </style>
</th:block>

<th:block layout:fragment="content">
  <meta name="context-path" th:content="@{/}" />

  <section class="mypage-wrap">
    <div class="mp-grid">
      <div class="mp-col-left"
           th:replace="~{fragments/mypageSidebox :: mypageSidebox(${section})}"></div>

      <div class="mp-col-right">
        <div class="page-head">
          <h2 class="page-title">내 문의</h2>
          <div class="ctrls">
            <label for="sortSel" class="sr-only">정렬</label>
            <select id="sortSel" aria-label="정렬">
              <option value="all" selected>최신순 (전체)</option>
              <option value="pending">대기중 (최신)</option>
              <option value="answered">완료 (최신)</option>
            </select>
          </div>
        </div>

        <table class="m-table" role="table" aria-label="내 문의 목록">
          <thead>
          <tr>
            <th scope="col">제목</th>
            <th scope="col" style="width:160px">작성일</th>
            <th scope="col" style="width:120px">상태</th>
          </tr>
          </thead>
          <tbody id="q-tbody">
          <!-- JS 렌더링 -->
          </tbody>
        </table>

        <nav id="pager" class="pager" aria-label="페이지네이션" hidden>
          <div id="pagerBtns"></div>
        </nav>
      </div>
    </div>

    <!-- 모달 -->
    <div id="questionModal" class="m-modal" aria-hidden="true">
      <div class="m-modal__backdrop" data-close></div>
      <div class="m-modal__box" role="dialog" aria-modal="true" aria-labelledby="qm-title">
        <div class="m-modal__header">
          <h3 id="qm-title" class="m-modal__title">문의 상세</h3>
          <button type="button" class="m-modal__close" data-close aria-label="닫기">×</button>
        </div>
        <div class="m-modal__body">
          <div class="field-row"><label>제목</label><div id="qd-title"></div></div>
          <div class="field-row"><label>작성일</label><div id="qd-created"></div></div>
          <div class="field-row"><label>문의 내용</label><div id="qd-content" class="qdetail-content"></div></div>
          <div class="field-row"><label>답변</label><div id="qd-answer" class="qdetail-content"></div></div>
          <div class="field-row" id="row-ansAt"><label>답변일</label><div id="qd-answeredAt"></div></div>
        </div>
        <div class="m-modal__footer">
          <button type="button" class="cm-btn cm-btn--primary" data-close>닫기</button>
        </div>
      </div>
    </div>
  </section>
</th:block>

<script layout:fragment="script">
'use strict';
const CTX = (() => (document.querySelector('meta[name="context-path"]')?.content || '').replace(/\/+$/, ''))();
const api = (p) => (CTX ? CTX : '') + (p.startsWith('/') ? p : '/' + p);

const sbw = () => window.innerWidth - document.documentElement.clientWidth;
const lock = () => { const w=sbw(); if(w>0) document.documentElement.style.setProperty('--sbw', w+'px'); document.body.classList.add('lock-scroll'); };
const unlock = () => { document.body.classList.remove('lock-scroll'); document.documentElement.style.removeProperty('--sbw'); };
const openModal = (m) => { if(!m) return; m.classList.add('is-open'); lock(); };
const closeModal = (el) => { const m = el?.classList?.contains('m-modal') ? el : el?.closest('.m-modal'); if(!m) return; m.classList.remove('is-open'); if (!document.querySelector('.m-modal.is-open')) unlock(); };
document.addEventListener('click', (e) => { if (e.target.matches('.m-modal [data-close], .m-modal__backdrop[data-close]')) closeModal(e.target); });
document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { const opened = document.querySelector('.m-modal.is-open'); if (opened) closeModal(opened); }});

const p2 = (n)=>String(n).padStart(2,'0');
const fmt = (ts)=>{ if(!ts) return ''; const d=new Date(ts); if(isNaN(d)) return ts; return `${d.getFullYear()}.${p2(d.getMonth()+1)}.${p2(d.getDate())} ${p2(d.getHours())}:${p2(d.getMinutes())}`; };
const esc = (s)=>String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

/* HTML을 안전한 텍스트로 변환(줄바꿈 유지) */
function setRichFromHtml(el, html) {
  if (!el) return;
  const c = document.createElement('div');
  c.innerHTML = html || '';

  // <br>를 줄바꿈으로
  c.querySelectorAll('br').forEach(br => br.replaceWith('\n'));
  // 블록 요소 뒤에 줄바꿈 하나씩
  c.querySelectorAll('p,div,li,td,th,h1,h2,h3,h4,h5,h6').forEach(node => {
    if (node.lastChild && node.lastChild.nodeType === 3) {
      node.lastChild.textContent += '\n';
    } else {
      node.appendChild(document.createTextNode('\n'));
    }
  });

  const text = (c.textContent || '')
    .replace(/\u00A0/g, ' ')
    .replace(/\s+\n/g, '\n')
    .replace(/\n{3,}/g, '\n\n')
    .trim();

  const safe = String(text).replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
  el.innerHTML = safe.replace(/\n/g, '<br>');
}

const $tbody = document.getElementById('q-tbody');
const $pager = document.getElementById('pager');
const $pagerBtns = document.getElementById('pagerBtns');
const $sortSel = document.getElementById('sortSel');
const state = { page: 0, size: 10, filter: 'all', totalPages: 0 };

function renderRows(items){
  if(!items || !items.length){
    $tbody.innerHTML = `<tr><td colspan="3" class="m-empty">문의 내역이 없습니다.</td></tr>`;
    return;
  }
  $tbody.innerHTML = items.map(it => `
    <tr>
      <td><a href="javascript:void(0)" class="m-link js-open-question" data-id="${it.qId}">${esc(it.title)}</a></td>
      <td>${esc(fmt(it.createDate))}</td>
      <td><span class="badge ${it.answered ? 'badge--answered' : 'badge--pending'}">${it.answered ? '완료' : '대기중'}</span></td>
    </tr>`).join('');
}

function renderPager(pg){
  const total = Math.max(0, Number(pg.totalPages) || 0);
  const page  = Math.min(Math.max(0, Number(pg.page) || 0), Math.max(0, total-1));
  state.totalPages = total;
  if(total <= 1){ $pager.hidden = true; return; }
  $pager.hidden = false;

  const isFirst = page === 0, isLast = page === total-1;
  const pagesHtml = Array.from({length: total}, (_,i)=>`<button type="button" class="page-btn"${i===page?' aria-current="page"':''} data-page="${i}">${i+1}</button>`).join('');
  $pagerBtns.innerHTML = `
    <button type="button" class="page-btn nav-first" data-nav="first" ${isFirst?'disabled':''} aria-label="첫 페이지">«</button>
    <button type="button" class="page-btn nav-prev"  data-nav="prev"  ${isFirst?'disabled':''} aria-label="이전 페이지">‹</button>
    ${pagesHtml}
    <button type="button" class="page-btn nav-next"  data-nav="next"  ${isLast?'disabled':''} aria-label="다음 페이지">›</button>
    <button type="button" class="page-btn nav-last"  data-nav="last"  ${isLast?'disabled':''} aria-label="마지막 페이지">»</button>`;
  $pagerBtns.querySelectorAll('.page-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(btn.disabled) return;
      let next=page;
      if(btn.dataset.nav==='first') next=0;
      else if(btn.dataset.nav==='prev') next=Math.max(0,page-1);
      else if(btn.dataset.nav==='next') next=Math.min(total-1,page+1);
      else if(btn.dataset.nav==='last') next=total-1;
      else if(btn.dataset.page!=null) next=Number(btn.dataset.page);
      if(next===page) return;
      state.page=next; fetchAndRender();
    });
  });
}

async function fetchAndRender(){
  const url = api(`/mypage/myQuestion/page?page=${state.page}&size=${state.size}&filter=${state.filter}`);
  try{
    const res = await fetch(url, { headers:{'Accept':'application/json'}, credentials:'same-origin' });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    renderRows(data.content||[]); renderPager(data);
  }catch(e){
    console.error(e);
    $tbody.innerHTML = `<tr><td colspan="3" class="m-empty">목록을 불러오지 못했습니다.</td></tr>`;
    $pager.hidden = true;
  }
}
$sortSel.addEventListener('change', ()=>{ state.filter=$sortSel.value; state.page=0; fetchAndRender(); });

const $modal=document.getElementById('questionModal');
const $t=document.getElementById('qd-title');
const $created=document.getElementById('qd-created');
const $content=document.getElementById('qd-content');
const $answer=document.getElementById('qd-answer');
const $ansAt=document.getElementById('qd-answeredAt');
const $rowAnsAt=document.getElementById('row-ansAt');

document.addEventListener('click', async (e) => {
  const a=e.target.closest('.js-open-question'); if(!a) return;
  try{
    const id=a.getAttribute('data-id');
    const res=await fetch(api(`/mypage/questionDetail/${id}`), { headers:{'Accept':'application/json'}, credentials:'same-origin' });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data=await res.json();
    $t.textContent=data.title ?? '';
    $created.textContent=fmt(data.createDate) ?? '';
    const hasAnswer=!!(data.answer && String(data.answer).trim());

    /* ▼ 여기서 setRichFromHtml 사용 */
    setRichFromHtml($content, data.content ?? '');
    if(hasAnswer){ setRichFromHtml($answer, data.answer ?? ''); }
    else { $answer.innerHTML='<span class="muted">답변 대기 중</span>'; }

    if(hasAnswer && data.answerCreateDate){ $rowAnsAt.style.display=''; $ansAt.textContent=fmt(data.answerCreateDate); }
    else { $rowAnsAt.style.display='none'; $ansAt.textContent=''; }
    openModal($modal);
  }catch(e1){ console.error(e1); alert('문의 상세를 불러오지 못했습니다.'); }
});

fetchAndRender();
</script>
</html>
