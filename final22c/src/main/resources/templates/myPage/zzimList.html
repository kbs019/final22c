<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout/layout}">

<head>
  <meta charset="UTF-8" />
  <title>ë§ˆì´í˜ì´ì§€ - ìœ„ì‹œë¦¬ìŠ¤íŠ¸</title>

  <!-- âœ… ê³µí†µ ë§ˆì´í˜ì´ì§€ CSS: ì‚¬ì´ë“œë°•ìŠ¤/ê·¸ë¦¬ë“œ/í°íŠ¸/ê°„ê²© í†µì¼ -->
  <link rel="stylesheet" href="/css/mypage.css" th:href="@{/css/mypage.css}">
</head>

<!-- ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ì „ìš© ìŠ¤íƒ€ì¼ë§Œ ë‚¨ê¹€ (ê³µí†µ ë ˆì´ì•„ì›ƒ ì¬ì •ì˜ X) -->
<th:block layout:fragment="css">
  <style>
    /* === ìœ„ì‹œë¦¬ìŠ¤íŠ¸ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ === */
    
    /* ğŸ“Œ ê³µí†µ í˜ì´ì§€ í—¤ë” ìŠ¤íƒ€ì¼ í†µì¼ */
    .page-head {
      margin-bottom: 16px; /* ë‹¤ë¥¸ í˜ì´ì§€ì™€ ë™ì¼í•œ ì—¬ë°± */
    }
    
    /* ğŸ“Œ ë³¸ë¬¸ ì»¨í…Œì´ë„ˆ ìµœëŒ€í­ í†µì¼ */
    .mp-col-right {
      max-width: 100%;
      padding: 0; /* ê¸°ë³¸ íŒ¨ë”© ì œê±° */
    }
    
    /* === ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ì „ìš© ì¹´ë“œ ìŠ¤íƒ€ì¼ === */
    .wl-wrap { 
      max-width: none; /* ê¸°ì¡´ 1100px ì œí•œ ì œê±°í•˜ì—¬ ë³¸ë¬¸ê³¼ í†µì¼ */
      width: 100%;
    }
    
    .wl-title { 
      font-size: 20px; 
      font-weight: 800; 
      margin-bottom: 16px; /* ë‹¤ë¥¸ í˜ì´ì§€ì™€ ë™ì¼í•œ ì—¬ë°± */
    }

    .wl-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px; /* ê°„ê²© ì¡°ì • */
      margin-top: 16px;
    }

    .wl-card {
      display: flex;
      flex-direction: column;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
      text-decoration: none;
      color: #111827;
      transition: background .15s, border-color .15s, transform .06s;
    }
    .wl-card:hover { 
      background: #f9fbff; 
      border-color: #dbe3ff; 
      transform: translateY(-1px); 
    }

    /* ì¹´ë“œ ë‚´ë¶€ ìš”ì†Œë“¤ */
    .wl-thumb { 
      width: 100%; 
      aspect-ratio: 1/1; 
      object-fit: cover; 
      background: #f3f4f6; 
    }
    .wl-body { padding: 12px; }
    .wl-brand { 
      font-size: 12px; 
      color: #6b7280; 
      margin-bottom: 2px; 
    }
    .wl-name { 
      font-weight: 700; 
      white-space: nowrap; 
      overflow: hidden; 
      text-overflow: ellipsis; 
    }
    .wl-price { 
      margin-top: 6px; 
      font-weight: 800; 
    }

    /* ì°œ ì œê±° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .zzim-remove-btn {
      position: absolute; 
      top: 8px; 
      right: 8px;
      border: none; 
      background: rgba(255,255,255,.9);
      border-radius: 50%; 
      padding: 6px; 
      display: flex; 
      align-items: center; 
      justify-content: center;
      cursor: pointer; 
      transition: background .2s ease;
    }
    .zzim-remove-btn:hover { 
      background: rgba(229,231,235,.95); 
    }
    .zzim-remove-btn svg { 
      width: 20px; 
      height: 20px; 
      fill: #555; 
      transition: fill .2s ease; 
    }
    .zzim-remove-btn:hover svg { 
      fill: #111; 
    }

    /* ë¦¬ìŠ¤íŠ¸í˜• ì‚­ì œ ë²„íŠ¼ */
    .zzim-remove-btn-list { 
      position: static; 
      border-radius: 6px; 
      padding: 4px 10px; 
      font-size: 14px; 
    }

    /* ë¶€íŠ¸ìŠ¤íŠ¸ë© ëª¨ë‹¬ ì˜¤ë¥¸ìª½ ìŠ¤í¬ë¡¤ë°”ë¡œ ì¸í•œ í”ë“¤ë¦¼ ë°©ì§€ */
    body.modal-open { 
      padding-right: 0 !important; 
    }
    
    /* ğŸ“Œ ë²„íŠ¼ ê·¸ë£¹ ìŠ¤íƒ€ì¼ í†µì¼ */
    .d-flex.justify-content-between {
      margin-bottom: 16px; /* ë‹¤ë¥¸ í˜ì´ì§€ì™€ ë™ì¼í•œ ì—¬ë°± */
    }

    /* 1) ë¶€íŠ¸ìŠ¤íŠ¸ë© ëª¨ë‹¬ ì»¨í…Œì´ë„ˆ ë¦¬ì…‹ (ë ˆê±°ì‹œ .modal ê·œì¹™ ë¬´ë ¥í™”) */
#zzimRemoveModal,
#appAlertModal {
  position: fixed;         /* Bootstrap ê¸°ë³¸ */
  inset: 0;                /* left/top ì´ˆê¸°í™” ëŒ€ì²´ */
  left: 0 !important;      /* ë ˆê±°ì‹œì˜ left:50%/top:50% ì œê±° */
  top: 0 !important;
  transform: none !important;
  min-width: 0 !important; /* ë ˆê±°ì‹œ min-width:420px ì œê±° */
  max-width: none !important;
  width: auto !important;
  height: auto !important;
  padding: 0 !important;   /* ë ˆê±°ì‹œ padding ì œê±° */
  border-radius: 0 !important;
  box-shadow: none !important;
  background: transparent !important;
  overflow: visible !important; /* ë ˆê±°ì‹œ overflow-y:autoë¡œ ì¸í•œ ì˜ë¦¼ ë°©ì§€ */
  z-index: 1055 !important;     /* Bootstrap ê¸°ë³¸ ê³„ì¸µ ìœ ì§€ */
}

/* 2) ëª¨ë‹¬ ë‹¤ì´ì–¼ë¡œê·¸ëŠ” Bootstrap ê¸°ë³¸ëŒ€ë¡œ */
#zzimRemoveModal .modal-dialog,
#appAlertModal .modal-dialog {
  margin: .5rem auto; /* ë·°í¬íŠ¸ ì¤‘ì•™ ì •ë ¬ ë° ì—¬ë°± */
}

/* 3) ë°±ë“œë¡­ ë¦¬ì…‹: ë ˆê±°ì‹œ .modal-backdrop {display:none} ë®ì–´ì“°ê¸° ë°©ì§€ */
.modal-backdrop {
  display: block !important;
  position: fixed;
  inset: 0;
  z-index: 1050 !important; /* ëª¨ë‹¬(1055) ë°”ë¡œ ì•„ë˜ */
  background-color: rgba(0,0,0,.5);
}

/* 4) ëª¨ë°”ì¼ì—ì„œ ë·°í¬íŠ¸ í”ë“¤ë¦¼/ì˜ë¦¼ ìµœì†Œí™” */
@supports (-webkit-touch-callout: none) {
  #zzimRemoveModal,
  #appAlertModal {
    overscroll-behavior: contain; /* iOS ìŠ¤í¬ë¡¤ íŠ ë°©ì§€ */
  }
}

/* 5) ì´ í˜ì´ì§€ì—ì„œë§Œ ë ˆê±°ì‹œ ì‹¬í”Œ ë ˆì´ì–´ ëª¨ë‹¬ì„ ëª…ì‹œì ìœ¼ë¡œ ì œì™¸(ì¶©ëŒ ì˜ˆë°©)
   (ë ˆê±°ì‹œ .modalì€ idê°€ ì—†ê³  .modal-content ì—†ì´ ì‚¬ìš©ë¨ â†’ Bootstrapê³¼ êµ¬ë¶„) */
#zzimRemoveModal.modal .modal-content,
#appAlertModal.modal .modal-content {
  border-radius: .5rem; /* ë³´ê¸°ë§Œ ë³´ì •, ê¸°ëŠ¥ì—” ì˜í–¥ X */
}
  </style>
</th:block>

<th:block layout:fragment="content">
  <section class="mypage-wrap">
    <div class="mp-grid"><!-- ê³µí†µ ë ˆì´ì•„ì›ƒ: ì™¼ìª½ ì‚¬ì´ë“œ + ì˜¤ë¥¸ìª½ ë³¸ë¬¸ -->
      <!-- ì¢Œì¸¡: ì‚¬ì´ë“œë°•ìŠ¤ (ê³µí†µ íŒŒì…œ / ê¸€ì”¨Â·ê°„ê²© ê³µí†µ CSSê°€ ì ìš©ë¨) -->
      <div class="mp-col-left" th:replace="~{fragments/mypageSidebox :: mypageSidebox(${section})}"></div>

      <!-- ìš°ì¸¡: ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ë³¸ë¬¸ -->
      <div class="mp-col-right">
        <div class="d-flex justify-content-between mb-3">
          <!-- ì™¼ìª½ ë³´ê¸° ì „í™˜ ë²„íŠ¼ -->
          <div>
            <button class="btn btn-outline-dark me-2" id="viewCardBtn">ì¹´ë“œí˜• ë³´ê¸°</button>
            <button class="btn btn-outline-dark" id="viewListBtn">ë¦¬ìŠ¤íŠ¸í˜• ë³´ê¸°</button>
          </div>
          <!-- ì˜¤ë¥¸ìª½: ë¦¬ìŠ¤íŠ¸í˜•ì—ì„œë§Œ ë…¸ì¶œ -->
          <div>
            <button class="btn btn-secondary" id="addToCartBtn" style="display:none;">ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
          </div>
        </div>

        <!-- ì¹´ë“œí˜• -->
        <div class="wl-grid" id="wishlistCardView">
          <div class="wl-card position-relative" th:each="p : ${paging}">
            <!-- ì°œ ì·¨ì†Œ ë²„íŠ¼ -->
            <button type="button" class="btn btn-sm btn-light zzim-remove-btn"
                    th:attr="data-productid=${p.id}">
              <svg class="bm-icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M6 3h12a1 1 0 0 1 1 1v16l-7-4-7 4V4a1 1 0 0 1 1-1z" />
              </svg>
            </button>

            <a th:href="@{|/main/content/${p.id}|}" class="d-block text-decoration-none text-dark">
              <img class="wl-thumb" th:src="@{|${p.imgPath}${p.imgName}|}" th:alt="${p.name}">
              <div class="wl-body">
                <div class="wl-brand" th:text="${p.brand.brandName}">ë¸Œëœë“œ</div>
                <div class="wl-name" th:text="${p.name}">ìƒí’ˆëª…</div>
                <div class="wl-price" th:text="${#numbers.formatInteger(p.sellPrice,3,'COMMA')} + 'ì›'">0ì›</div>
              </div>
            </a>
          </div>
        </div>

        <!-- ë¦¬ìŠ¤íŠ¸í˜• -->
        <div id="wishlistListView" style="display:none;">
          <table class="table align-middle">
            <thead>
              <tr>
                <th><input type="checkbox" id="checkAll"></th>
                <th>ìƒí’ˆì •ë³´</th>
                <th>ìˆ˜ëŸ‰</th>
                <th>ê°€ê²©</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="p : ${paging}">
                <td><input type="checkbox" name="chk" th:value="${p.id}"></td>
                <td>
                  <div class="d-flex align-items-center">
                    <a th:href="@{|/main/content/${p.id}|}" class="d-flex align-items-center text-decoration-none text-dark w-100">
                      <img th:src="@{|${p.imgPath}${p.imgName}|}" width="80" class="me-3">
                      <div>
                        <div th:text="${p.brand.brandName}" class="text-muted small"></div>
                        <div th:text="${p.name}" class="fw-bold"></div>
                      </div>
                    </a>
                  </div>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <button type="button" class="btn btn-sm btn-outline-secondary qty-minus">-</button>
                    <input type="text"
                           class="form-control text-center mx-1 qty-input"
                           style="width:60px;"
                           th:value="${p.count > 0 ? 1 : 0}"
                           th:attr="data-maxcount=${p.count}"
                           th:readonly="${p.count == 0}">
                    <button type="button" class="btn btn-sm btn-outline-secondary qty-plus"
                            th:disabled="${p.count == 0}">+</button>
                  </div>
                </td>
                <td th:text="${#numbers.formatInteger(p.sellPrice,3,'COMMA')} + 'ì›'"></td>
                <td>
                  <button type="button"
                          class="btn btn-sm btn-outline-danger zzim-remove-btn-list"
                          th:attr="data-productid=${p.id}">
                    ì‚­ì œ
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div><!-- /.mp-col-right -->
    </div><!-- /.mp-grid -->

    <!-- ============ ì‚­ì œ í™•ì¸ ëª¨ë‹¬ ============ -->
    <div class="modal fade" id="zzimRemoveModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ê´€ì‹¬ìƒí’ˆ ì‚­ì œ</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
          </div>
          <div class="modal-body">ì´ ìƒí’ˆì„ ê´€ì‹¬ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
            <button type="button" class="btn btn-danger" id="zzimRemoveConfirmBtn">ì‚­ì œ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============ ì¥ë°”êµ¬ë‹ˆ í† ìŠ¤íŠ¸ ============ -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1055">
      <div id="cartToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">ì„ íƒí•œ ìƒí’ˆì´ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê²¼ìŠµë‹ˆë‹¤.</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="ë‹«ê¸°"></button>
        </div>
      </div>
    </div>

    <!-- ============ ê³µí†µ ì•Œë¦¼ ëª¨ë‹¬ ============ -->
    <div class="modal fade" id="appAlertModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header py-2">
            <h5 class="modal-title" id="appAlertTitle">ì•Œë¦¼</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
          </div>
          <div class="modal-body" id="appAlertBody"></div>
          <div class="modal-footer py-2">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="appAlertOkBtn">í™•ì¸</button>
          </div>
        </div>
      </div>
    </div>
  </section>
</th:block>

<!-- ìŠ¤í¬ë¦½íŠ¸ (ê¸°ëŠ¥ ê·¸ëŒ€ë¡œ ìœ ì§€) -->
<script layout:fragment="script">
  // ë·° ì „í™˜
  const viewCardBtn  = document.getElementById('viewCardBtn');
  const viewListBtn  = document.getElementById('viewListBtn');
  const addToCartBtn = document.getElementById('addToCartBtn');
  const cardView     = document.getElementById('wishlistCardView');
  const listView     = document.getElementById('wishlistListView');

  viewCardBtn.addEventListener('click', () => {
    cardView.style.display = 'grid';
    listView.style.display = 'none';
    addToCartBtn.style.display = 'none';
  });
  viewListBtn.addEventListener('click', () => {
    cardView.style.display = 'none';
    listView.style.display = 'block';
    addToCartBtn.style.display = 'inline-block';
  });

  // ì²´í¬ë°•ìŠ¤ ì „ì²´ì„ íƒ
  document.addEventListener('DOMContentLoaded', () => {
    const checkAll  = document.getElementById('checkAll');
    const checks    = document.querySelectorAll("input[name='chk']");
    if (!checkAll) return;
    checkAll.addEventListener('change', () => checks.forEach(cb => cb.checked = checkAll.checked));
    checks.forEach(cb => cb.addEventListener('change', () => {
      checkAll.checked = Array.from(checks).every(c => c.checked);
    }));
  });

  // ìˆ˜ëŸ‰ +/-
  document.addEventListener('click', (e) => {
    if (e.target.closest('.qty-plus')) {
      const row = e.target.closest('tr');
      const input = row.querySelector('.qty-input');
      const max = parseInt(input.getAttribute('data-maxcount')) || 1;
      const cur = parseInt(input.value) || 1;
      if (cur < max) input.value = cur + 1;
      else AppAlert(`ìµœëŒ€ ${max}ê°œê¹Œì§€ ë‹´ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
    }
    if (e.target.closest('.qty-minus')) {
      const row = e.target.closest('tr');
      const input = row.querySelector('.qty-input');
      const cur = parseInt(input.value) || 1;
      if (cur > 1) input.value = cur - 1;
    }
  });
  document.addEventListener('input', (e) => {
    if (!e.target.classList.contains('qty-input')) return;
    const input = e.target;
    const max = parseInt(input.getAttribute('data-maxcount')) || 1;
    let val = parseInt(input.value);
    if (isNaN(val) || val < 1) input.value = 1;
    else if (val > max) { input.value = max; AppAlert(`ìµœëŒ€ ${max}ê°œê¹Œì§€ ë‹´ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`); }
  });

  // ì°œ ì‚­ì œ (ì¹´ë“œ/ë¦¬ìŠ¤íŠ¸ ê³µí†µ)
  let targetProductId = null;
  let targetNode = null;

  document.addEventListener('click', (e) => {
    const cardBtn = e.target.closest('.zzim-remove-btn');
    const listBtn = e.target.closest('.zzim-remove-btn-list');
    if (!cardBtn && !listBtn) return;

    const btn = cardBtn || listBtn;
    targetProductId = btn.getAttribute('data-productid');
    targetNode = cardBtn ? btn.closest('.wl-card') : btn.closest('tr');

    const modal = new bootstrap.Modal(document.getElementById('zzimRemoveModal'));
    modal.show();
  });

  document.getElementById('zzimRemoveConfirmBtn').addEventListener('click', () => {
    if (!targetProductId) return;
    fetch('zzimList/remove', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ productId: targetProductId })
    }).then((res) => {
      if (res.ok) {
        targetNode?.remove();
        bootstrap.Modal.getInstance(document.getElementById('zzimRemoveModal')).hide();
      } else AppAlert('ì‚­ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', { title: 'ì˜¤ë¥˜' });
    });
  });

  // ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°(ë¦¬ìŠ¤íŠ¸í˜• ì„ íƒí’ˆëª©)
  addToCartBtn.addEventListener('click', () => {
    const rows = document.querySelectorAll('#wishlistListView tbody tr');
    const items = [];
    rows.forEach((row) => {
      const chk = row.querySelector("input[name='chk']");
      if (!chk?.checked) return;
      const qty = parseInt(row.querySelector('.qty-input').value) || 1;
      items.push({ productId: chk.value, quantity: qty });
    });
    if (!items.length) { AppAlert('ì¥ë°”êµ¬ë‹ˆì— ë‹´ì„ ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

    fetch('/mypage/addBatch', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(items)
    }).then((res) => {
      if (res.ok) {
        const toast = new bootstrap.Toast(document.getElementById('cartToast'), { delay: 2000 });
        toast.show();

        // âœ… ê°œë³„ ì²´í¬ë°•ìŠ¤ í•´ì œ
        rows.forEach((row) => row.querySelector("input[name='chk']").checked = false);

        // âœ… ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ë„ í•´ì œ
        const checkAll = document.getElementById('checkAll');
        if (checkAll) checkAll.checked = false;
      } else AppAlert('ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', { title: 'ì˜¤ë¥˜' });
    }).catch(() => AppAlert('ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', { title: 'ì˜¤ë¥˜' }));
  });

  /**
   * AppAlert(message, options?)
   * options: { title?: string, delay?: number(ms), onHide?: Function }
   */
  const AppAlert = (() => {
    const el = document.getElementById('appAlertModal');
    const modal = new bootstrap.Modal(el);
    const titleEl = document.getElementById('appAlertTitle');
    const bodyEl  = document.getElementById('appAlertBody');
    let timer = null;

    el.addEventListener('shown.bs.modal', () => document.getElementById('appAlertOkBtn')?.focus());

    return function (message, { title='ì•Œë¦¼', delay=null, onHide=null } = {}) {
      titleEl.textContent = title;
      bodyEl.textContent  = String(message);
      if (timer) { clearTimeout(timer); timer = null; }

      if (typeof onHide === 'function') {
        const handler = () => { el.removeEventListener('hidden.bs.modal', handler); onHide(); };
        el.addEventListener('hidden.bs.modal', handler);
      }
      modal.show();
      if (typeof delay === 'number' && delay > 0) timer = setTimeout(() => modal.hide(), delay);
    };
  })();
</script>
</html>
