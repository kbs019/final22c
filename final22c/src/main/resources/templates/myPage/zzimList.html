<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout/layout}">

<head>
  <meta charset="UTF-8" />
  <title>마이페이지 - 위시리스트</title>

  <!-- CSRF (스프링) -->
  <meta name="_csrf" th:if="${_csrf}" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:if="${_csrf}" th:content="${_csrf.headerName}" />

  <!-- 페이지 전용 CSS (반드시 head 프래그먼트 내부) -->
  <th:block layout:fragment="css">
    <style>
      :root { scrollbar-gutter: stable both-edges; }
      html  { overflow-y: scroll; }

      /* ===== 공통 레이아웃 ===== */
      .mp-grid{
        display:grid;
        grid-template-columns:260px minmax(0,1fr);
        gap:28px;             /* 사이드-본문 여백 살짝 넓힘 */
        align-items:start;
      }
      .mp-col-left{position:sticky; top:24px; align-self:start; z-index:1;}
      .mp-col-right{min-width:0; padding-left:12px;}
      @media (max-width:860px){
        .mp-grid{grid-template-columns:1fr;}
        .mp-col-left{position:static;}
        .mp-col-right{padding-left:0;}
      }

      .mp-sidebox__title{font-size:20px;font-weight:800;margin:0 0 12px;}
      .mp-sidebox__nav{display:flex;flex-direction:column;gap:6px;}
      .mp-sidebox__link{
        display:block;padding:8px 10px;border-radius:10px;text-decoration:none;
        color:#111827;border:1px solid #e5e7eb;background:#fff;
      }
      .mp-sidebox__link:hover{background:#f3f7ff;}
      .mp-sidebox__link.is-active{background:#111827;color:#fff;border-color:#111827;}

      /* 본문 컨테이너(폭/패딩 통일) */
      .mypage-body{max-width:1100px;margin:0 auto;padding:0 12px;}
      @media (max-width:860px){.mypage-body{padding:0;}}

      /* ===== 위시리스트 ===== */
      .wl-wrap{max-width:1100px;}
      .wl-controls{padding-left:12px; margin-bottom:12px;}

      .wl-grid{
        display:grid;
        grid-template-columns:repeat(auto-fill, minmax(220px, 1fr));
        gap:14px;
      }
      .wl-card{
        display:flex;flex-direction:column;background:#fff;
        border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;
        color:#111827;text-decoration:none;
        transition:background .15s,border-color .15s,transform .06s;
      }
      .wl-card:hover{background:#f9fbff;border-color:#dbe3ff;transform:translateY(-1px);}
      .wl-thumb{width:100%;aspect-ratio:1/1;object-fit:cover;background:#f3f4f6;}
      .wl-body{padding:12px;}
      .wl-brand{font-size:12px;color:#6b7280;margin-bottom:2px;}
      .wl-name{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
      .wl-price{margin-top:6px;font-weight:800;}

      /* 카드형 삭제 버튼 */
      .zzim-remove-btn{
        position:absolute;top:8px;right:8px;border:none;
        background:rgba(255,255,255,.9);border-radius:50%;padding:6px;
        display:flex;align-items:center;justify-content:center;cursor:pointer;
        transition:background .2s ease;
      }
      .zzim-remove-btn:hover{background:rgba(229,231,235,.95);}
      .zzim-remove-btn svg{width:20px;height:20px;fill:#555;transition:fill .2s ease;}
      .zzim-remove-btn:hover svg{fill:#111;}

      /* 리스트형 삭제 버튼 */
      .zzim-remove-btn-list{position:static;border-radius:6px;padding:4px 10px;font-size:14px;}
    </style>
  </th:block>
</head>

<body>
<th:block layout:fragment="content">
  <section class="mypage-wrap">
    <div class="mp-grid">
      <!-- 좌측 사이드박스 -->
      <div class="mp-col-left"
           th:replace="~{fragments/mypageSidebox :: mypageSidebox(${section})}"></div>

      <!-- 우측 본문 -->
      <div class="mp-col-right">
        <section class="mypage-body wl-wrap">

          <!-- 보기 전환/액션 -->
          <div class="wl-controls d-flex justify-content-between">
            <div>
              <button class="btn btn-outline-dark me-2" id="viewCardBtn">카드형 보기</button>
              <button class="btn btn-outline-dark" id="viewListBtn">리스트형 보기</button>
            </div>
            <div>
              <button class="btn btn-primary" id="addToCartBtn" style="display:none">장바구니 담기</button>
            </div>
          </div>

          <!-- 카드형 -->
          <div class="wl-grid" id="wishlistCardView">
            <div class="wl-card position-relative" th:each="p : ${paging}">
              <button type="button" class="btn btn-sm btn-light zzim-remove-btn"
                      th:attr="data-productid=${p.id}">
                <svg class="bm-icon" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M6 3h12a1 1 0 0 1 1 1v16l-7-4-7 4V4a1 1 0 0 1 1-1z"/>
                </svg>
              </button>

              <a th:href="@{|/main/content/${p.id}|}" class="d-block text-decoration-none text-dark">
                <img class="wl-thumb" th:src="@{|${p.imgPath}${p.imgName}|}" th:alt="${p.name}">
                <div class="wl-body">
                  <div class="wl-brand" th:text="${p.brand.brandName}">브랜드</div>
                  <div class="wl-name" th:text="${p.name}">상품명</div>
                  <div class="wl-price"
                       th:text="${#numbers.formatInteger(p.sellPrice,3,'COMMA')} + '원'">0원</div>
                </div>
              </a>
            </div>
          </div>

          <!-- 리스트형 -->
          <div id="wishlistListView" style="display:none;">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th><input type="checkbox" id="checkAll"></th>
                  <th>상품정보</th>
                  <th>수량</th>
                  <th>가격</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="p : ${paging}">
                  <td><input type="checkbox" name="chk" th:value="${p.id}"></td>
                  <td>
                    <div class="d-flex align-items-center">
                      <a th:href="@{|/main/content/${p.id}|}"
                         class="d-flex align-items-center text-decoration-none text-dark w-100">
                        <img th:src="@{|${p.imgPath}${p.imgName}|}" width="80" class="me-3" alt="">
                        <div>
                          <div th:text="${p.brand.brandName}" class="text-muted small"></div>
                          <div th:text="${p.name}" class="fw-bold"></div>
                        </div>
                      </a>
                    </div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <button type="button" class="btn btn-sm btn-outline-secondary qty-minus">-</button>
                      <input type="text" class="form-control text-center mx-1 qty-input" style="width:60px;"
                             th:value="${p.count > 0 ? 1 : 0}"
                             th:attr="data-maxcount=${p.count}"
                             th:readonly="${p.count == 0}">
                      <button type="button" class="btn btn-sm btn-outline-secondary qty-plus"
                              th:disabled="${p.count == 0}">+</button>
                    </div>
                  </td>
                  <td th:text="${#numbers.formatInteger(p.sellPrice,3,'COMMA')} + '원'"></td>
                  <td>
                    <button type="button"
                            class="btn btn-sm btn-outline-danger zzim-remove-btn-list"
                            th:attr="data-productid=${p.id}">삭제</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

        </section>
      </div>
    </div>

    <!-- 모달: 관심상품 삭제 -->
    <div class="modal fade" id="zzimRemoveModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">관심상품 삭제</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
          </div>
          <div class="modal-body">이 상품을 관심목록에서 삭제하시겠습니까?</div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
            <button type="button" class="btn btn-danger" id="zzimRemoveConfirmBtn">삭제</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1055">
      <div id="cartToast" class="toast align-items-center text-white bg-success border-0"
           role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">선택한 상품이 장바구니에 담겼습니다.</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto"
                  data-bs-dismiss="toast" aria-label="닫기"></button>
        </div>
      </div>
    </div>
  </section>
</th:block>

<!-- 페이지 전용 스크립트 -->
<script layout:fragment="script">
  // CSRF 메타에서 읽기
  function getCsrf() {
    const token  = document.querySelector('meta[name="_csrf"]')?.content || "";
    const header = document.querySelector('meta[name="_csrf_header"]')?.content || "X-CSRF-TOKEN";
    return { header, token };
  }
  // 부트스트랩 가드
  const hasBS = typeof bootstrap !== "undefined";

  // 보기 전환
  document.getElementById("viewCardBtn").addEventListener("click", () => {
    document.getElementById("wishlistCardView").style.display = "grid";
    document.getElementById("wishlistListView").style.display = "none";
    document.getElementById("addToCartBtn").style.display = "none";
  });
  document.getElementById("viewListBtn").addEventListener("click", () => {
    document.getElementById("wishlistCardView").style.display = "none";
    document.getElementById("wishlistListView").style.display = "block";
    document.getElementById("addToCartBtn").style.display = "inline-block";
  });

  // 체크박스 전체선택
  document.addEventListener("DOMContentLoaded", () => {
    const checkAll = document.getElementById("checkAll");
    const checkboxes = document.querySelectorAll("input[name='chk']");
    checkAll?.addEventListener("change", () =>
      checkboxes.forEach(cb => cb.checked = checkAll.checked)
    );
    checkboxes.forEach(cb => cb.addEventListener("change", () => {
      const allChecked = Array.from(checkboxes).every(c => c.checked);
      if (checkAll) checkAll.checked = allChecked;
    }));
  });

  // 수량 조절
  document.addEventListener("click", (e) => {
    if (e.target.closest(".qty-plus")) {
      const row = e.target.closest("tr");
      const input = row.querySelector(".qty-input");
      const max = parseInt(input.getAttribute("data-maxcount")) || 1;
      const cur = parseInt(input.value) || 1;
      if (cur < max) input.value = cur + 1;
      else alert("최대 " + max + "개까지 담을 수 있습니다.");
    }
    if (e.target.closest(".qty-minus")) {
      const row = e.target.closest("tr");
      const input = row.querySelector(".qty-input");
      const cur = parseInt(input.value) || 1;
      if (cur > 1) input.value = cur - 1;
    }
  });
  document.addEventListener("input", (e) => {
    if (!e.target.classList.contains("qty-input")) return;
    const input = e.target;
    const max = parseInt(input.getAttribute("data-maxcount")) || 1;
    let v = parseInt(input.value);
    if (isNaN(v) || v < 1) input.value = 1;
    else if (v > max) { input.value = max; alert("최대 " + max + "개까지 담을 수 있습니다."); }
  });

  // 찜 삭제 (모달→확정)
  let targetProductId = null, targetCard = null;
  document.addEventListener("click", (e) => {
    if (e.target.closest(".zzim-remove-btn")) {
      const btn = e.target.closest(".zzim-remove-btn");
      targetProductId = btn.getAttribute("data-productid");
      targetCard = btn.closest(".wl-card");
      if (hasBS) new bootstrap.Modal(document.getElementById("zzimRemoveModal")).show();
      else if (confirm("해당 상품을 관심목록에서 삭제할까요?")) triggerZzimRemove();
    }
    if (e.target.closest(".zzim-remove-btn-list")) {
      const btn = e.target.closest(".zzim-remove-btn-list");
      targetProductId = btn.getAttribute("data-productid");
      targetCard = btn.closest("tr");
      if (hasBS) new bootstrap.Modal(document.getElementById("zzimRemoveModal")).show();
      else if (confirm("해당 상품을 관심목록에서 삭제할까요?")) triggerZzimRemove();
    }
  });

  document.getElementById("zzimRemoveConfirmBtn").addEventListener("click", triggerZzimRemove);

  async function triggerZzimRemove() {
    if (!targetProductId) return;
    const { header, token } = getCsrf();
    try {
      const res = await fetch("zzimList/remove", {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          ...(token ? { [header]: token } : {})
        },
        credentials: "same-origin",
        body:JSON.stringify({ productId: targetProductId })
      });
      if (!res.ok) throw new Error();
      if (targetCard) targetCard.remove();
      if (hasBS) bootstrap.Modal.getInstance(document.getElementById("zzimRemoveModal"))?.hide();
    } catch {
      alert("삭제 처리 중 오류가 발생했습니다.");
    } finally {
      targetProductId = null; targetCard = null;
    }
  }

  // 장바구니 담기 (선택 행 일괄)
  document.getElementById("addToCartBtn").addEventListener("click", async () => {
    const rows = document.querySelectorAll("#wishlistListView tbody tr");
    const items = [];
    rows.forEach(row => {
      const cb = row.querySelector("input[name='chk']");
      if (cb?.checked){
        items.push({
          productId: cb.value,
          quantity: parseInt(row.querySelector(".qty-input").value) || 1
        });
      }
    });
    if (items.length === 0){ alert("장바구니에 담을 상품을 선택해주세요."); return; }

    const { header, token } = getCsrf();
    try {
      const res = await fetch("/mypage/addBatch", {
        method:"POST",
        headers:{ 
          "Content-Type":"application/json",
          ...(token ? { [header]: token } : {})
        },
        credentials: "same-origin",
        body:JSON.stringify(items)
      });
      if (!res.ok) throw new Error();
      if (hasBS) {
        new bootstrap.Toast(document.getElementById("cartToast"), { delay:2000 }).show();
      } else {
        alert("선택한 상품이 장바구니에 담겼습니다.");
      }
      rows.forEach(r => { const c = r.querySelector("input[name='chk']"); if (c) c.checked = false; });
    } catch {
      alert("장바구니 담기 중 오류가 발생했습니다.");
    }
  });
</script>
</body>
</html>