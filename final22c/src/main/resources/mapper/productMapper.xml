<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ex.final22c.repository.productMapper.ProductMapper">

  <!-- =========================================================
       공통 WHERE (필터 + 키워드) *Oracle 전용*
     ========================================================= -->
  <sql id="WhereProductFilters">
    WHERE 1=1
      <if test="brandIds != null and brandIds.size() > 0">
        AND p.BRAND_BRANDNO IN
        <foreach collection="brandIds" item="v" open="(" close=")" separator=",">
          #{v}
        </foreach>
      </if>

      <if test="gradeIds != null and gradeIds.size() > 0">
        AND p.GRADE_GRADENO IN
        <foreach collection="gradeIds" item="v" open="(" close=")" separator=",">
          #{v}
        </foreach>
      </if>

      <if test="mainNoteIds != null and mainNoteIds.size() > 0">
        AND p.MAINNOTE_MAINNOTENO IN
        <foreach collection="mainNoteIds" item="v" open="(" close=")" separator=",">
          #{v}
        </foreach>
      </if>

      <if test="volumeIds != null and volumeIds.size() > 0">
        AND p.VOLUME_VOLUMENO IN
        <foreach collection="volumeIds" item="v" open="(" close=")" separator=",">
          #{v}
        </foreach>
      </if>

      <if test="keyword != null and keyword != ''">
        AND INSTR(LOWER(p.NAME), LOWER(#{keyword})) > 0
      </if>
  </sql>

  <!-- =========================================================
       옵션(필터 목록) : 브랜드 / 그레이드 / 메인노트 / 용량
       - 반환 컬럼 키: id, name, count (소문자 고정)
     ========================================================= -->
  <select id="selectBrandOptions" resultType="map">
    SELECT
      b.BRANDNO     AS "id",
      b.BRANDNAME   AS "name",
      COUNT(p.ID)   AS "count"
    FROM BRAND b
    LEFT JOIN PRODUCT p ON p.BRAND_BRANDNO = b.BRANDNO
    GROUP BY b.BRANDNO, b.BRANDNAME
    ORDER BY b.BRANDNAME
  </select>

  <select id="selectGradeOptions" resultType="map">
    SELECT
      g.GRADENO     AS "id",
      g.GRADENAME   AS "name",
      COUNT(p.ID)   AS "count"
    FROM GRADE g
    LEFT JOIN PRODUCT p ON p.GRADE_GRADENO = g.GRADENO
    GROUP BY g.GRADENO, g.GRADENAME
    ORDER BY g.GRADENAME
  </select>

  <select id="selectMainNoteOptions" resultType="map">
    SELECT
      m.MAINNOTENO    AS "id",
      m.MAINNOTENAME  AS "name",
      COUNT(p.ID)     AS "count"
    FROM MAINNOTE m
    LEFT JOIN PRODUCT p ON p.MAINNOTE_MAINNOTENO = m.MAINNOTENO
    GROUP BY m.MAINNOTENO, m.MAINNOTENAME
    ORDER BY m.MAINNOTENAME
  </select>

  <select id="selectVolumeOptions" resultType="map">
    SELECT
      v.VOLUMENO     AS "id",
      v.VOLUMENAME   AS "name",
      COUNT(p.ID)    AS "count"
    FROM VOLUME v
    LEFT JOIN PRODUCT p ON p.VOLUME_VOLUMENO = v.VOLUMENO
    GROUP BY v.VOLUMENO, v.VOLUMENAME
    ORDER BY v.VOLUMENAME
  </select>

  <!-- =========================================================
       카운트(필터 + 키워드 공통)
     ========================================================= -->
  <select id="countProducts" resultType="long">
    SELECT COUNT(1)
    FROM PRODUCT p
    <include refid="WhereProductFilters"/>
  </select>

  <!-- =========================================================
       기본 목록(정렬/페이징 없음)
       - 템플릿 키와 동일: id, name, imgUrl, brandName, price, sellPrice, discount
     ========================================================= -->
  <select id="selectProducts" resultType="map">
    SELECT
      p.ID                                   AS "id",
      p.NAME                                 AS "name",
      NVL(p.IMGPATH,'') || NVL(p.IMGNAME,'') AS "imgUrl",
      b.BRANDNAME                            AS "brandName",
      p.PRICE                                AS "price",
      p.SELLPRICE                            AS "sellPrice",
      p.DISCOUNT                             AS "discount"
    FROM PRODUCT p
    LEFT JOIN BRAND b ON b.BRANDNO = p.BRAND_BRANDNO
    <include refid="WhereProductFilters"/>
    ORDER BY p.ID DESC
  </select>

  <!-- =========================================================
       리스트 전용: 정렬 + 페이징 (Oracle)
       - sort : id | popular | priceAsc | priceDesc | reviewDesc
       - offset, limit 사용
     ========================================================= -->
  <select id="selectProductsPaged" resultType="map">
    <bind name="startRow" value="offset + 1"/>
    <bind name="endRow"   value="offset + limit"/>

    WITH sales AS (
      /* 판매량(확정수량 합계) */
      SELECT od.ID AS pid, SUM(od.CONFIRMQUANTITY) AS qty
      FROM ORDERDETAIL od
      JOIN ORDERS o ON o.ORDERID = od.ORDERID
      WHERE o.STATUS IN ('PAID','CONFIRMED','REFUNDED')
      GROUP BY od.ID
    ),
    rcnt AS (
      /* 리뷰 개수 */
      SELECT r.PRODUCT_ID AS pid, COUNT(1) AS cnt
      FROM REVIEW r
      GROUP BY r.PRODUCT_ID
    ),
    base AS (
      SELECT
        p.ID                                   AS "id",
        p.NAME                                 AS "name",
        NVL(p.IMGPATH,'') || NVL(p.IMGNAME,'') AS "imgUrl",
        b.BRANDNAME                            AS "brandName",
        p.PRICE                                AS "price",
        p.SELLPRICE                            AS "sellPrice",
        p.DISCOUNT                             AS "discount",
        NVL(s.qty, 0)                          AS "sales",
        NVL(r.cnt, 0)                          AS "reviewCnt"
      FROM PRODUCT p
      LEFT JOIN BRAND b ON b.BRANDNO = p.BRAND_BRANDNO
      LEFT JOIN sales s ON s.pid = p.ID
      LEFT JOIN rcnt  r ON r.pid = p.ID
      <include refid="WhereProductFilters"/>
    ),
    ranked AS (
      SELECT
        b.*,
        ROW_NUMBER() OVER(
          <choose>
            <when test="sort == 'popular'">
              ORDER BY b."sales" DESC, b."id" DESC
            </when>
            <when test="sort == 'priceAsc'">
              ORDER BY b."sellPrice" ASC, b."id" DESC
            </when>
            <when test="sort == 'priceDesc'">
              ORDER BY b."sellPrice" DESC, b."id" DESC
            </when>
            <when test="sort == 'reviewDesc'">
              ORDER BY b."reviewCnt" DESC, b."id" DESC
            </when>
            <otherwise>
              ORDER BY b."id" DESC
            </otherwise>
          </choose>
        ) AS rn
      FROM base b
    )
    SELECT
      "id","name","imgUrl","brandName","price","sellPrice","discount"
    FROM ranked
    WHERE rn BETWEEN #{startRow} AND #{endRow}
    ORDER BY rn
  </select>

  <!-- =========================================================
       브랜드 목록/상세
     ========================================================= -->
  <select id="selectBrands" resultType="map">
    SELECT
      b.BRANDNO                              AS "id",
      b.BRANDNAME                            AS "name",
      NVL(b.IMGPATH,'') || NVL(b.IMGNAME,'') AS "imgUrl"
    FROM BRAND b
    ORDER BY b.BRANDNAME
  </select>

  <select id="selectBrandById" parameterType="long" resultType="map">
    SELECT
      b.BRANDNO                              AS "id",
      b.BRANDNAME                            AS "name",
      NVL(b.IMGPATH,'') || NVL(b.IMGNAME,'') AS "imgUrl",
      b.DESCRIPTION                          AS "description"
    FROM BRAND b
    WHERE b.BRANDNO = #{brandNo}
  </select>

</mapper>
